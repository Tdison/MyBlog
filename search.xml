<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>MySQL 备份与恢复</title>
      <link href="/2022/06/11/2022/06/MySQL-%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/"/>
      <url>/2022/06/11/2022/06/MySQL-%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/</url>
      
        <content type="html"><![CDATA[<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><h3 id="备份类型"><a href="#备份类型" class="headerlink" title="备份类型"></a>备份类型</h3><ul><li><p>完全备份，部分备份 </p><p>完全备份：整个数据集<br>部分备份：只备份数据子集，如部分库或表 </p></li><li><p>完全备份、增量备份、差异备份</p><p>增量备份：仅备份最近一次完全备份或增量备份（如果存在增量）以来变化的数据，备份较快，还原复杂</p><p>差异备份：仅备份最近一次完全备份以来变化的数据，备份较慢，还原简单</p></li></ul><p>注意：二进制日志文件不应该与数据文件放在同一磁盘</p><ul><li><p>冷、温、热备份</p><p>冷备：读、写操作均不可进行，数据库停止服务 </p><p>温备：读操作可执行；但写操作不可执行 </p><p>热备：读、写操作均可执行</p><ul><li>MyISAM：温备，不支持热备 </li><li>InnoDB：都支持</li></ul></li><li><p>物理和逻辑备份</p><p>物理备份：直接复制数据文件进行备份，与存储引擎有关，占用较多的空间，速度快</p><p>逻辑备份：从数据库中”导出”数据另存而进行的备份，与存储引擎无关，占用空间少，速度慢，可能丢失精度</p></li></ul><h3 id="备份内容"><a href="#备份内容" class="headerlink" title="备份内容"></a>备份内容</h3><ul><li>数据</li><li>二进制日志、InnoDB的事务日志</li><li>用户帐号，权限设置，程序代码（存储过程、函数、触发器、事件调度器） </li><li>服务器的配置文件</li></ul><h3 id="备份注意要点"><a href="#备份注意要点" class="headerlink" title="备份注意要点"></a>备份注意要点</h3><ul><li>能容忍最多丢失多少数据 </li><li>备份产生的负载</li><li>备份过程的时长 </li><li>温备的持锁多久</li><li>恢复数据需要在多长时间内完成 </li><li>需要备份和恢复哪些数据</li></ul><h3 id="还原要点"><a href="#还原要点" class="headerlink" title="还原要点"></a>还原要点</h3><ul><li><font color=red>**做还原测试，用于测试备份的可用性**</font></li><li>还原演练，写成规范的技术文档</li></ul><h2 id="数据库冷备份和还原"><a href="#数据库冷备份和还原" class="headerlink" title="数据库冷备份和还原"></a>数据库冷备份和还原</h2><p>MySQL8.0</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#备份过程</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#systemctl stop mysqld </span></span><br><span class="line"><span class="comment">#备份数据</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#rsync  -a /var/lib/mysql 10.0.0.28:/data/ </span></span><br><span class="line"><span class="comment">#如果配置及二进制文件相关有特殊设置也需要备份</span></span><br><span class="line"><span class="comment">#还原</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#yum -y install mysql-server</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cp -a /data/mysql/* /var/lib/mysql/ </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#systemctl start mysqld</span></span><br></pre></td></tr></table></figure><p>Mariadb10.3</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在目标服务器（10.0.0.18）安装mariadb-server，不启动服务 </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#dnf install mariadb-server</span></span><br><span class="line"><span class="comment">#在源主机（10.0.0.8）执行</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl  stop mariadb </span></span><br><span class="line"><span class="comment">#复制相关文件</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># scp -r /var/lib/mysql/* 10.0.0.18:/var/lib/mysql/</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># scp /etc/my.cnf.d/mariadb-server.cnf 10.0.0.18:/etc/my.cnf.d/ </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># scp -r /data/logbin/ 10.0.0.18:/data/   #10.0.0.18须事先存在/data/目录</span></span><br><span class="line"><span class="comment">#复制相关文件并保留属性：可以用rsync</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#rsync /etc/my.cnf.d/mariadb-server.cnf 10.0.0.18:/etc/my.cnf.d/ </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#rsync  -av /var/lib/mysql/ 10.0.0.18:/var/lib/mysql/</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#rsync  -av/data/logbin/ 10.0.0.18:/data/   #10.0.0.18 须事先存 </span></span><br><span class="line">在/data/目录</span><br><span class="line"><span class="comment">#在目标主机（10.0.0.18）执行</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#chown -R mysql.mysql /var/lib/mysql/ </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#chown -R mysql.mysql /data/logbin/ </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#systemctl start mariadb</span></span><br></pre></td></tr></table></figure><h2 id="mysqldump-备份"><a href="#mysqldump-备份" class="headerlink" title="mysqldump 备份"></a>mysqldump 备份</h2><p>mysqldump是MySQL的客户端命令，通过mysql协议连接至mysql服务器进行备份</p><p><strong>命令格式：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysqldump [OPTIONS] database [tables]   <span class="comment">#支持指定数据库和指定多表的备份，但数据库本身定义不备份</span></span><br><span class="line">mysqldump [OPTIONS] -B DB1 [DB2 DB3...] <span class="comment">#支持指定数据库备份，包含数据库本身定义也会备份 </span></span><br><span class="line">mysqldump [OPTIONS] -A [OPTIONS]        <span class="comment">#备份所有数据库，包含数据库本身定义也会备份</span></span><br></pre></td></tr></table></figure><p><strong>常用选项：</strong></p><div class="table-container"><table><thead><tr><th>参数名</th><th>缩写</th><th>含义</th><th>默认值</th></tr></thead><tbody><tr><td>—user</td><td>-u</td><td>连接服务器时使用的MySQL用户名</td><td></td></tr><tr><td>—pasword</td><td>-p</td><td>连接所用的用户密码</td><td></td></tr><tr><td>—host</td><td>-h</td><td>MySQL服务端地址</td><td></td></tr><tr><td>—port</td><td>-P</td><td>MySQL端口号</td><td></td></tr><tr><td>—databases</td><td>-B</td><td>指定要备份的数据库</td><td></td></tr><tr><td>—all-databases</td><td>-A</td><td>备份MySQL服务器上的所有数据库</td><td></td></tr><tr><td>—add-drop-database</td><td></td><td>每个数据库创建之前添加drop数据库语句</td><td>未开启</td></tr><tr><td>—add-drop-table</td><td></td><td>创建表之前添加drop表语句</td><td>开启</td></tr><tr><td>—events</td><td>-E</td><td>导出事件</td><td>未开启</td></tr><tr><td>—routines</td><td>-R</td><td>导出存储过程以及自定义函数</td><td>未开启</td></tr><tr><td>—triggers</td><td></td><td>导出触发器</td><td>开启</td></tr><tr><td>—extended-insert</td><td>-e</td><td>使用具有多个VALUES列的INSERT语法</td><td>开启</td></tr><tr><td>—ignore-table</td><td></td><td>不导出指定表。指定忽略多个表时,需要重复多次</td><td></td></tr><tr><td>—no-data</td><td>-d</td><td>不导出任何数据,只导出数据库表结构</td><td></td></tr><tr><td>—no-create-info</td><td>-t</td><td>只导出数据,而不添加CREATE  TABLE 语句</td><td></td></tr><tr><td>—force</td><td>-f</td><td>在导出过程中忽略出现的SQL错误</td><td>未开启</td></tr><tr><td>—tz-utc</td><td></td><td>在导出顶部设置时区TIME_ZONE=’+00:00’</td><td>开启</td></tr><tr><td>—where</td><td>-W</td><td>只转储给定的WHERE条件选择的记录</td><td></td></tr><tr><td>—set-gtid-purged</td><td></td><td>是否添加SET@@GLOBAL.GTID_PURGED  输出</td><td></td></tr><tr><td>—single-transaction</td><td></td><td>通过在一个事务中导出所有表从而创建一个一致性的快照,适用于innodb引擎</td><td></td></tr><tr><td>—master-data</td><td></td><td>该选项将当前服务器的binlog的位置和文件名追加到输出文件中。<br />如果为1,将会输出CHANGE MASTER命令;<br />如果为2,输出的CHANGE MASTER命令前添加注释信息</td></tr></tbody></table></div><p><strong>mysqldump的MyISAM存储引擎相关的备份选项：</strong></p><p>MyISAM不支持事务，只能支持温备；不支持热备，所以必须先锁定要备份的库，而后启动备份操作</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-x,--lock-all-tables <span class="comment">#加全局读锁，锁定所有库的所有表，同时加--single-transaction或--lock-tables选项会关闭此选项功能，注意：数据量大时，可能会导致长时间无法并发访问数据库</span></span><br><span class="line">-l,--lock-tables <span class="comment">#对于需要备份的每个数据库，在启动备份之前分别锁定其所有表，默认为on,--skip-lock-tables选项可禁用,对备份MyISAM的多个库,可能会造成数据不一致</span></span><br><span class="line"><span class="comment">#注：以上选项对InnoDB表一样生效，实现温备，但不推荐使用</span></span><br></pre></td></tr></table></figure><p><strong>mysqldump的InnoDB存储引擎相关的备份选项：</strong></p><p>InnoDB 存储引擎支持事务,可以利用事务的相应的隔离级别,实现热备，也可以实现温备但不建议用</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--single-transaction</span><br><span class="line"><span class="comment">#此选项Innodb中推荐使用，不适用MyISAM，此选项会开始备份前，先执行START TRANSACTION指令开启事务</span></span><br></pre></td></tr></table></figure><h3 id="建议备份策略"><a href="#建议备份策略" class="headerlink" title="建议备份策略"></a>建议备份策略</h3><p><strong>InnoDB建议备份策略</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p -A -F -E -R --triggers --single-transaction --master-data=1 --flush-privileges --default-character-set=utf8 --hex-blob</span><br><span class="line">&gt;<span class="variable">$&#123;BACKUP&#125;</span>/fullbak_<span class="variable">$&#123;BACKUP_TIME&#125;</span>.sql</span><br></pre></td></tr></table></figure><p><strong>MyISAM建议备份策略</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p -A -F -E -R -x --master-data=1 --flush-privileges  --triggers  --default-character-set=utf8  --hex-blob</span><br><span class="line">&gt;<span class="variable">$&#123;BACKUP&#125;</span>/fullbak_<span class="variable">$&#123;BACKUP_TIME&#125;</span>.sql</span><br></pre></td></tr></table></figure><h3 id="特定数据库的备份脚本"><a href="#特定数据库的备份脚本" class="headerlink" title="特定数据库的备份脚本"></a>特定数据库的备份脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cat mysql_backup.sh </span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">TIME=`<span class="built_in">date</span> +%F_%H-%M-%S` </span><br><span class="line">DIR=/backup</span><br><span class="line">DB=hellodb </span><br><span class="line">PASS=123456</span><br><span class="line"></span><br><span class="line">[ -d <span class="variable">$DIR</span> ] || <span class="built_in">mkdir</span> <span class="variable">$DIR</span></span><br><span class="line">mysqldump -uroot -p <span class="string">&quot;<span class="variable">$PASS</span>&quot;</span> -F -E -R --triggers  --single-transaction --master-data=2 --default-character-set=utf8 -q  -B <span class="variable">$DB</span>  | gzip  &gt; <span class="variable">$&#123;DIR&#125;</span>/<span class="variable">$&#123;DB&#125;</span>_<span class="variable">$&#123;TIME&#125;</span>.sql.gz</span><br></pre></td></tr></table></figure><h3 id="分库备份并压缩"><a href="#分库备份并压缩" class="headerlink" title="分库备份并压缩"></a>分库备份并压缩</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#for db in `mysql -uroot  -e &#x27;show databases&#x27;|grep -Ev &#x27;^(Database|information_schema|performance_schema)$&#x27;`;do mysqldump -B $db | gzip &gt; /backup/$db.sql.gz;done</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#mysql -uroot  -e &#x27;show databases&#x27;|grep -Ev &#x27;^(Database|information_schema|performance_schema)$&#x27;|while read db;do mysqldump -B $db | gzip &gt; /backup/$db.sql.gz;done</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#mysql -uroot  -e &#x27;show databases&#x27;|grep -Ev &#x27;^(Database|information_schema|performance_schema)$&#x27; | sed -rn  &#x27;s#(.*)#mysqldump -B \1 | gzip  &gt; /backup/\1.sql.gz#p&#x27; |bash</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#mysql -uroot  -e &#x27;show databases&#x27;|sed -rn &#x27;/^(Database|information_schema|performance_schema)$/!s#(.*)#mysqldump -B \1 | gzip  &gt; /backup/\1.sql.gz#p&#x27; |bash</span></span><br></pre></td></tr></table></figure><h3 id="分库备份的脚本"><a href="#分库备份的脚本" class="headerlink" title="分库备份的脚本"></a>分库备份的脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cat backup_db.sh </span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">TIME=`<span class="built_in">date</span> +%F_%H-%M-%S` </span><br><span class="line">DIR=/backup</span><br><span class="line">PASS=123456</span><br><span class="line"></span><br><span class="line">[ -d <span class="string">&quot;<span class="variable">$DIR</span>&quot;</span> ]  || <span class="built_in">mkdir</span> <span class="variable">$DIR</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> DB <span class="keyword">in</span> `mysql -uroot -p <span class="string">&quot;<span class="variable">$PASS</span>&quot;</span> -e <span class="string">&#x27;show databases&#x27;</span> | grep -Ev <span class="string">&quot;^Database|.*schema$&quot;</span>`;<span class="keyword">do</span></span><br><span class="line">    mysqldump -F --single-transaction --master-data=2 --default-character-set=utf8 -q  -B <span class="variable">$DB</span>  | gzip  &gt;  <span class="variable">$&#123;DIR&#125;</span>/<span class="variable">$&#123;DB&#125;</span>_<span class="variable">$&#123;TIME&#125;</span>.sql.gz</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h3 id="完全备份和还原"><a href="#完全备份和还原" class="headerlink" title="完全备份和还原"></a>完全备份和还原</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#开启二进制日志</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#vim /etc/my.cnf.d/mariadb-server.cnf </span></span><br><span class="line">[mysqld]</span><br><span class="line">log-bin</span><br><span class="line"></span><br><span class="line"><span class="comment">#备份  /backup/为备份文件夹路径</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#mysqldump -uroot -p123456 -A -F --single-transaction --master-data=2 |gzip &gt; /backup/all-`date +%F`.sql.gz</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#还原  /backup/为备份文件夹路径</span></span><br><span class="line">[root@centos8 backup]<span class="comment">#dnf install mariadb-server </span></span><br><span class="line">[root@centos8 backup]<span class="comment">#gzip -d all-2019-11-27.sql.gz </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#mysql</span></span><br><span class="line">MariaDB [(none)]&gt; <span class="built_in">set</span> sql_log_bin=off;</span><br><span class="line">MariaDB [(none)]&gt; <span class="built_in">source</span> /backup/all-2019-11-27.sql</span><br><span class="line">MariaDB [(none)]&gt; <span class="built_in">set</span> sql_log_bin=on;</span><br></pre></td></tr></table></figure><h3 id="利用二进制日志，还原数据库最新状态"><a href="#利用二进制日志，还原数据库最新状态" class="headerlink" title="利用二进制日志，还原数据库最新状态"></a>利用二进制日志，还原数据库最新状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#二进制日志独立存放</span></span><br><span class="line">[mysqld]</span><br><span class="line">log-bin=/data/mysql/mysql-bin </span><br><span class="line"></span><br><span class="line"><span class="comment">#完全备份，并记录备份的二进制位置</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># mysqldump  -uroot -p123456 -A -F --default-character-set=utf8  --single-transaction --master-data=2 | gzip &gt; /backup/all_`date +%F`.sql.gz</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#还原数据库</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cd /backup</span></span><br><span class="line">[root@centos8 backup]<span class="comment"># gzip -d all_2019-11-25.sql.gz</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#CentOS 8 需要事先生成数据库相关文件，CentOS7 不需要执行此步 </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># mysql_install_db  --user=mysql</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl restart mariadb</span></span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; show master logs; </span><br><span class="line">+------------------+-----------+</span><br><span class="line">| Log_name         | File_size | </span><br><span class="line">+------------------+-----------+ </span><br><span class="line">| mysql-bin.000001 |       998 | </span><br><span class="line">| mysql-bin.000002 |     28090 | </span><br><span class="line">| mysql-bin.000003 |       342 | </span><br><span class="line">+------------------+-----------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt;<span class="built_in">set</span> sql_log_bin=0;</span><br><span class="line">MariaDB [(none)]&gt;<span class="built_in">source</span> /data/all_2019-11-25.sql</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#grep &#x27;^-- CHANGE MASTER TO&#x27;  /data/all_2019-11-25.sql</span></span><br><span class="line">-- CHANGE MASTER TO MASTER_LOG_FILE=<span class="string">&#x27;mysql-bin.000001&#x27;</span>, MASTER_LOG_POS=328; </span><br><span class="line"></span><br><span class="line"><span class="comment">#二进制日志还原</span></span><br><span class="line">[root@centos8 mysql]<span class="comment">#mysqlbinlog  mysql-bin.000001 --start-position=328 &gt; /backup/inc.sql</span></span><br><span class="line">[root@centos8 mysql]<span class="comment">#mysqlbinlog  mysql-bin.000002 &gt;&gt; /backup/inc.sql</span></span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt;<span class="built_in">set</span> sql_log_bin=0;</span><br><span class="line">MariaDB [(none)]&gt;<span class="built_in">source</span> /backup/inc.sql</span><br><span class="line">MariaDB [(none)]&gt;<span class="built_in">set</span> sql_log_bin=1;</span><br></pre></td></tr></table></figure><h3 id="mysqldump-和二进制日志结合实现差异-增量-备份"><a href="#mysqldump-和二进制日志结合实现差异-增量-备份" class="headerlink" title="mysqldump 和二进制日志结合实现差异(增量)备份"></a>mysqldump 和二进制日志结合实现差异(增量)备份</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#mysqldump -uroot -p -A -F --single-transaction --master-data=2 |gzip &gt; /backup/all-`date +%F`.sql.gz</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#观察上面备份文件中记录的二进制文件和位置，定期将其之后生成的所有二进制日志进行复制备份 </span></span><br><span class="line"><span class="comment">#假设mariadb-bin.000003是后续生成的二进制日志</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cp /var/lib/mysql/mariadb-bin.000003 /backup </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#mysqlbinlog backup/mariadb-bin.000003 &gt; /backup/inc.sql</span></span><br></pre></td></tr></table></figure><p><strong>案例：恢复误删除的表</strong></p><p>案例说明：每天2：30做完全备份，早上10：00误删除了表students，10：10才发现故障，现需要将数据库还原到10：10的状态，且恢复被删除的students表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">#完全备份</span><br><span class="line">[root<span class="variable">@centos8</span> <span class="operator">~</span>]#mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p <span class="operator">-</span>A <span class="operator">-</span>F <span class="comment">--single-transaction --master-data=2 &gt; /backup/allbackup_`date +%F_%T`.sql</span></span><br><span class="line">[root<span class="variable">@centos8</span> <span class="operator">~</span>]#ll <span class="operator">/</span>backup<span class="operator">/</span> </span><br><span class="line">total <span class="number">2992</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r-- 1 root root 3060921 Nov 27 10:20 allbackup_2019-11-27_10:20:08.sql </span></span><br><span class="line"></span><br><span class="line">#完全备份后数据更新</span><br><span class="line">MariaDB [testdb]<span class="operator">&gt;</span> <span class="keyword">insert</span> students (name,age,gender) <span class="keyword">values</span>(<span class="string">&#x27;rose&#x27;</span>,<span class="number">20</span>,<span class="string">&#x27;f&#x27;</span>); </span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.001</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [testdb]<span class="operator">&gt;</span> <span class="keyword">insert</span> students (name,age,gender) <span class="keyword">values</span>(<span class="string">&#x27;jack&#x27;</span>,<span class="number">22</span>,<span class="string">&#x27;M&#x27;</span>); </span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.001</span> sec)</span><br><span class="line"></span><br><span class="line">#<span class="number">10</span>：<span class="number">00</span>误删除了一个重要的表</span><br><span class="line">MariaDB [testdb]<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">table</span> students; </span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.021</span> sec)</span><br><span class="line"></span><br><span class="line">#后续其它表继续更新</span><br><span class="line">MariaDB [testdb]<span class="operator">&gt;</span> use hellodb;</span><br><span class="line">Reading <span class="keyword">table</span> information <span class="keyword">for</span> completion <span class="keyword">of</span> <span class="keyword">table</span> <span class="keyword">and</span> <span class="keyword">column</span> names </span><br><span class="line">You can turn off this feature <span class="keyword">to</span> <span class="keyword">get</span> a quicker startup <span class="keyword">with</span> <span class="operator">-</span>A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]<span class="operator">&gt;</span> <span class="keyword">insert</span> teachers (name,age,gender)<span class="keyword">values</span>(<span class="string">&#x27;alice&#x27;</span>,<span class="number">30</span>,<span class="string">&#x27;M&#x27;</span>); </span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.002</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]<span class="operator">&gt;</span> <span class="keyword">insert</span> teachers (name,age,gender)<span class="keyword">values</span>(<span class="string">&#x27;bob&#x27;</span>,<span class="number">28</span>,<span class="string">&#x27;M&#x27;</span>); </span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.002</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> teachers; </span><br><span class="line"><span class="operator">+</span><span class="comment">-----+---------------+-----+--------+</span></span><br><span class="line"><span class="operator">|</span> TID <span class="operator">|</span> Name          <span class="operator">|</span> Age <span class="operator">|</span> Gender <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">-----+---------------+-----+--------+ </span></span><br><span class="line"><span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span> Song Jiang    <span class="operator">|</span>  <span class="number">45</span> <span class="operator">|</span> M      <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span> Zhang Sanfeng <span class="operator">|</span>  <span class="number">94</span> <span class="operator">|</span> M      <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span> Miejue Shitai <span class="operator">|</span>  <span class="number">77</span> <span class="operator">|</span> F      <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span> Lin Chaoying  <span class="operator">|</span>  <span class="number">93</span> <span class="operator">|</span> F      <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span>   <span class="number">5</span> <span class="operator">|</span> alice         <span class="operator">|</span>  <span class="number">30</span> <span class="operator">|</span> M      <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span>   <span class="number">6</span> <span class="operator">|</span> bob           <span class="operator">|</span>  <span class="number">28</span> <span class="operator">|</span> M      <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">-----+---------------+-----+--------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.001</span> sec) </span><br><span class="line"></span><br><span class="line">#<span class="number">10</span>：<span class="number">10</span>发现表删除，进行还原</span><br><span class="line">#停止数据库访问</span><br><span class="line"></span><br><span class="line">#从完全备份中，找到二进制位置</span><br><span class="line">[root<span class="variable">@centos8</span> <span class="operator">~</span>]#grep <span class="string">&#x27;\-\- CHANGE MASTER TO&#x27;</span>  <span class="operator">/</span>backup<span class="operator">/</span>allbackup_2019<span class="number">-11</span><span class="number">-27</span>_10\:<span class="number">20</span>\:<span class="number">08.</span><span class="keyword">sql</span></span><br><span class="line"><span class="comment">-- CHANGE MASTER TO MASTER_LOG_FILE=&#x27;mariadb-bin.000003&#x27;, MASTER_LOG_POS=389; </span></span><br><span class="line"></span><br><span class="line">#备份从完全备份后的二进制日志</span><br><span class="line">[root<span class="variable">@centos8</span> <span class="operator">~</span>]#mysqlbinlog <span class="comment">--start-position=389 /var/lib/mysql/mariadb-bin.000003 &gt; /backup/inc.sql</span></span><br><span class="line"></span><br><span class="line">#找到误删除的语句，从备份中删除此语句 </span><br><span class="line">[root<span class="variable">@centos8</span> <span class="operator">~</span>]#vim <span class="operator">/</span>data<span class="operator">/</span>inc.sql</span><br><span class="line">#<span class="keyword">DROP</span> <span class="keyword">TABLE</span> `student_info` <span class="comment">/* generated by server */</span> </span><br><span class="line">#如果文件过大，可以使用sed实现</span><br><span class="line">[root<span class="variable">@centos8</span> <span class="operator">~</span>]#sed <span class="operator">-</span>i.bak  <span class="string">&#x27;/^DROP TABLE/d&#x27;</span>  <span class="operator">/</span>data<span class="operator">/</span>inc.sql </span><br><span class="line"></span><br><span class="line">#利用完全备份和修改过的二进制日志进行还原</span><br><span class="line">[root<span class="variable">@centos8</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p</span><br><span class="line">MariaDB [hellodb]<span class="operator">&gt;</span> <span class="keyword">set</span> sql_log_bin<span class="operator">=</span><span class="number">0</span>;</span><br><span class="line">MariaDB [hellodb]<span class="operator">&gt;</span> source <span class="operator">/</span>backup<span class="operator">/</span>allbackup_2019<span class="number">-11</span><span class="number">-27</span>_10:<span class="number">20</span>:<span class="number">08.</span><span class="keyword">sql</span>;</span><br><span class="line">MariaDB [hellodb]<span class="operator">&gt;</span> source <span class="operator">/</span>backup<span class="operator">/</span>inc.sql</span><br><span class="line">MariaDB [hellodb]<span class="operator">&gt;</span> <span class="keyword">set</span> sql_log_bin<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure><h2 id="xtrabackup-备份"><a href="#xtrabackup-备份" class="headerlink" title="xtrabackup 备份"></a>xtrabackup 备份</h2><h3 id="xtrabackup-安装"><a href="#xtrabackup-安装" class="headerlink" title="xtrabackup 安装"></a>xtrabackup 安装</h3><p>最新版本下载安装：<br><a href="https://www.percona.com/downloads/XtraBackup/LATEST/">https://www.percona.com/downloads/XtraBackup/LATEST/</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#yum -y install percona-xtrabackup-24-2.4.20-1.el8.x86_64.rpm</span></span><br></pre></td></tr></table></figure><h3 id="xtrabackup-用法"><a href="#xtrabackup-用法" class="headerlink" title="xtrabackup 用法"></a>xtrabackup 用法</h3><p>xtrabackup工具备份和还原，需要三步实现</p><ol><li>备份：对数据库做完全或增量备份</li><li>预准备：  还原前，先对备份的数据，整理至一个临时目录</li><li>还原：将整理好的数据，复制回数据库目录中</li></ol><p><strong>xtrabackup 选项参考：</strong></p><p><a href="https://www.percona.com/doc/percona-xtrabackup/LATEST/genindex.html">https://www.percona.com/doc/percona-xtrabackup/LATEST/genindex.html</a></p><h4 id="利用xtrabackup8-0-完全备份和还原MySQL8-0"><a href="#利用xtrabackup8-0-完全备份和还原MySQL8-0" class="headerlink" title="利用xtrabackup8.0 完全备份和还原MySQL8.0"></a>利用xtrabackup8.0 完全备份和还原MySQL8.0</h4><ol><li><p>安装xtrabackup包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#官网下载对应版本</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#yum -y install percona-xtrabackup-80-8.0.23-16.1.el8.x86_64.rpm</span></span><br></pre></td></tr></table></figure></li><li><p>在原主机做完全备份到/backup </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#mkdir /backup</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#xtrabackup  -uroot -p123456 --backup --target-dir=/backup/base </span></span><br><span class="line"><span class="comment">#目标主机无需创建/backup目录,直接复制目录本身</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#scp -r /backup/   目标主机:/</span></span><br></pre></td></tr></table></figure></li><li><p>在目标主机上还原</p><p>1）预准备：确保数据一致，提交完成的事务，回滚未完成的事务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#官网下载对应版本</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#yum -y install percona-xtrabackup-80-8.0.23-16.1.el8.x86_64.rpm </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#xtrabackup --prepare --target-dir=/backup/base</span></span><br></pre></td></tr></table></figure><p>2）复制到数据库目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#xtrabackup --copy-back --target-dir=/backup/base</span></span><br></pre></td></tr></table></figure><p>3）还原属性</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#chown -R mysql:mysql /var/lib/mysql</span></span><br></pre></td></tr></table></figure><p>4）启动服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#service mysqld start</span></span><br></pre></td></tr></table></figure></li></ol><h4 id="利用xtrabackup完全备份和还原MySQL5-7"><a href="#利用xtrabackup完全备份和还原MySQL5-7" class="headerlink" title="利用xtrabackup完全备份和还原MySQL5.7"></a>利用xtrabackup完全备份和还原MySQL5.7</h4><p>MySQL5.5和Mariadb5.5步骤相同</p><ol><li><p>安装xtrabackup包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#官网下载对应版本</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#yum -y install percona-xtrabackup-24-2.4.20-1.el8.x86_64.rpm</span></span><br></pre></td></tr></table></figure></li><li><p>在原主机做完全备份到/backup </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#mkdir /backup</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#xtrabackup  -uroot -p123456 --backup --target-dir=/backup/base </span></span><br><span class="line"><span class="comment">#目标主机无需创建/backup目录,直接复制目录本身</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#scp -r /backup/   目标主机:/</span></span><br></pre></td></tr></table></figure></li><li><p>在目标主机上还原</p><p>1）预准备：确保数据一致，提交完成的事务，回滚未完成的事务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#yum -y install percona-xtrabackup-24-2.4.20-1.el8.x86_64.rpm </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#xtrabackup --prepare --target-dir=/backup/base</span></span><br></pre></td></tr></table></figure><p>2）复制到数据库目录</p><font color=red>注意：数据库目录必须为空，MySQL服务不能启动</font><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#xtrabackup --copy-back --target-dir=/backup/base</span></span><br></pre></td></tr></table></figure><p>3）还原属性</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#chown -R mysql:mysql /var/lib/mysql</span></span><br></pre></td></tr></table></figure><p>4）启动服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#service mysqld start</span></span><br></pre></td></tr></table></figure></li></ol><h4 id="利用xtrabackup8-0-完全，增量备份及还原MySQL8-0"><a href="#利用xtrabackup8-0-完全，增量备份及还原MySQL8-0" class="headerlink" title="利用xtrabackup8.0 完全，增量备份及还原MySQL8.0"></a>利用xtrabackup8.0 完全，增量备份及还原MySQL8.0</h4><ol><li><p>备份过程</p><p>1）完全备份：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#官网下载对应版本</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#yum -y install percona-xtrabackup-24-2.4.20-1.el8.x86_64.rpm </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#mkdir /backup/</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#xtrabackup -uroot -p123456 --backup --target-dir=/backup/base</span></span><br></pre></td></tr></table></figure><p>2）第一次修改数据</p><p>3）第一次增量备份</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#xtrabackup -uroot -p123456 --backup --target-dir=/backup/inc1 --incremental-basedir=/backup/base</span></span><br></pre></td></tr></table></figure><p>4）第二次修改数据</p><p>5）第二次增量</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#xtrabackup -uroot -p123456 --backup --target-dir=/backup/inc2 --incremental-basedir=/backup/inc1</span></span><br></pre></td></tr></table></figure><p>6）数据传输</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#scp -r /backup/* 目标主机:/backup/ </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#备份过程生成三个备份目录</span></span><br><span class="line">/backup/&#123;base，inc1，inc2&#125;</span><br></pre></td></tr></table></figure></li><li><p>还原过程</p><p>1）预准备完成备份，此选项—apply-log-only 阻止回滚未完成的事务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#官网下载对应版本rpm包</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#yum -y install percona-xtrabackup-24-2.4.20-1.el8.x86_64.rpm </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#xtrabackup --prepare --apply-log-only --target-dir=/backup/base</span></span><br></pre></td></tr></table></figure><p>2）合并第1次增量备份到完全备份</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#xtrabackup --prepare --apply-log-only --target-dir=/backup/base--incremental-dir=/backup/inc1</span></span><br></pre></td></tr></table></figure><p>3）合并第2次增量备份到完全备份：最后一次还原不需要加选项—apply-log-only</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#xtrabackup --prepare --target-dir=/backup/base --incremental-dir=/backup/inc2</span></span><br></pre></td></tr></table></figure><p>4）复制到数据库目录，注意数据库目录必须为空，MySQL服务不能启动</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#xtrabackup --copy-back --target-dir=/backup/base</span></span><br></pre></td></tr></table></figure><p>5）还原属性</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#chown -R mysql:mysql /var/lib/mysql</span></span><br></pre></td></tr></table></figure><p>6）启动服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#service mysqld start</span></span><br></pre></td></tr></table></figure></li></ol>]]></content>
      
      
      <categories>
          
          <category> CentOS运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CENTOS </tag>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL 架构</title>
      <link href="/2022/06/05/2022/06/MySQL-%E6%9E%B6%E6%9E%84/"/>
      <url>/2022/06/05/2022/06/MySQL-%E6%9E%B6%E6%9E%84/</url>
      
        <content type="html"><![CDATA[<h2 id="MySQL-中的系统数据库"><a href="#MySQL-中的系统数据库" class="headerlink" title="MySQL 中的系统数据库"></a>MySQL 中的系统数据库</h2><ul><li><p><strong>mysql 数据库</strong></p><p>是mysql的核心数据库，类似于Sql  Server中的master库，主要负责存储数据库的用户、权限设置、关键字等mysql自己需要使用的控制和管理信息</p></li><li><p><strong>information_schema 数据库</strong></p><p>MySQL 5.0之后产生的，一个虚拟数据库，物理上并不存在information_schema数据库类似与”数据字典”，提供了访问数据库元数据的方式，即数据的数据。比如数据库名或表名，列类型，访问权限（更加细化的访问方式）</p></li><li><p><strong>performance_schema 数据库</strong></p><p>MySQL 5.5开始新增的数据库，主要用于收集数据库服务器性能参数,库里表的存储引擎均为PERFORMANCE_SCHEMA，用户不能创建存储引擎为PERFORMANCE_SCHEMA的表</p></li><li><p><strong>sys 数据库</strong></p><p>MySQL5.7之后新增加的数据库，库中所有数据源来自performance_schema。目标是把performance_schema的把复杂度降低，让DBA能更好的阅读这个库里的内容。让DBA更快的了解DataBase的运行情况</p></li></ul><h2 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a>存储引擎</h2><h3 id="MyISAM-存储引擎"><a href="#MyISAM-存储引擎" class="headerlink" title="MyISAM 存储引擎"></a>MyISAM 存储引擎</h3><p><strong>MyISAM 引擎特点</strong></p><ul><li>不支持事务 </li><li>表级锁定</li><li>读写相互阻塞，写入不能读，读时不能写 </li><li>只缓存索引</li><li>不支持外键约束</li><li>不支持聚簇索引</li><li>读取数据较快，占用资源较少</li><li>不支持MVCC（多版本并发控制机制）高并发 </li><li>崩溃恢复性较差</li><li>MySQL5.5.5 前默认的数据库引擎 </li></ul><p><strong>MyISAM 存储引擎适用场景</strong></p><ul><li>只读（或者写较少）</li><li>表较小（可以接受长时间进行修复操作） </li></ul><p><strong>MyISAM 引擎文件</strong></p><ul><li>tbl_name.frm     表格式定义</li><li>tbl_name.MYD  数据文件</li><li>tbl_name.MYI    索引文件</li></ul><h3 id="InnoDB-引擎"><a href="#InnoDB-引擎" class="headerlink" title="InnoDB 引擎"></a>InnoDB 引擎</h3><p><strong>InnoDB引擎特点</strong></p><ul><li>行级锁</li><li>支持事务，适合处理大量短期事务 </li><li>读写阻塞与事务隔离级别相关</li><li>可缓存数据和索引</li><li>支持聚簇索引</li><li>崩溃恢复性更好</li><li>支持MVCC高并发</li><li>从MySQL5.5后支持全文索引</li><li>从MySQL5.5.5开始为默认的数据库引擎 </li></ul><p><strong>InnoDB数据库文件</strong></p><p>在 InnoDB 存储引擎中，所有的数据都被<strong>逻辑地</strong>存放在表空间中，表空间（tablespace）是存储引擎中最高的存储逻辑单位，在表空间的下面又包括段（segment）、区（extent）、页（page）：</p><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2wizlkc3yj21o00u0mzl.jpg" alt=""></p><ul><li><p>所有InnoDB表的数据和索引放置于同一个表空间中</p><ul><li>数据文件：ibdata1, ibdata2,存放在datadir定义的目录下</li><li>表格式定义：tb_name.frm,存放在datadir定义的每个数据库对应的目录下</li></ul></li><li><p>每个表单独使用一个表空间存储表的数据和索引</p><ul><li>两类文件放在对应每个数据库独立目录中 </li><li>数据文件(存储数据和索引)：tb_name.ibd </li><li>表格式定义：tb_name.frm</li></ul></li></ul><h3 id="管理存储引擎"><a href="#管理存储引擎" class="headerlink" title="管理存储引擎"></a>管理存储引擎</h3><p>查看mysql支持的存储引擎</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> engines;</span><br></pre></td></tr></table></figure><p>查看当前默认的存储引擎</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%storage_engine%&#x27;</span>;  </span><br></pre></td></tr></table></figure><p>设置默认的存储引擎</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/my.cnf </span><br><span class="line">[mysqld]</span><br><span class="line">default_storage_engine= InnoDB</span><br></pre></td></tr></table></figure><p>查看库中所有表使用的存储引擎</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">table</span> status <span class="keyword">from</span> db_name;</span><br></pre></td></tr></table></figure><p>查看库中指定表的存储引擎</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">table</span> status <span class="keyword">like</span> <span class="string">&#x27;tb_name&#x27;</span>; </span><br><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> tb_name;</span><br></pre></td></tr></table></figure><p>设置表的存储引擎：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tb_name(... ) ENGINE<span class="operator">=</span>InnoDB; </span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tb_name ENGINE<span class="operator">=</span>InnoDB;</span><br></pre></td></tr></table></figure><h2 id="服务器变量"><a href="#服务器变量" class="headerlink" title="服务器变量"></a>服务器变量</h2><h3 id="服务器系统变量"><a href="#服务器系统变量" class="headerlink" title="服务器系统变量"></a>服务器系统变量</h3><p>服务器系统变量：可以分全局和会话两种</p><p><strong>注意: 系统变量用下划线,不用横线</strong></p><p>获取系统变量</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> variables;      <span class="comment">-- 只查看global变量</span></span><br><span class="line"><span class="keyword">show</span> [session] variables;   <span class="comment">-- 查看所有变量(包括global和session) </span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看指定的系统变量</span></span><br><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;变量名&#x27;</span>; </span><br><span class="line"><span class="keyword">select</span> @@变量名;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看选项和部分变量</span></span><br><span class="line">[root<span class="variable">@centos8</span> <span class="operator">~</span>]#mysqladmin variables</span><br></pre></td></tr></table></figure><p>修改全局变量：仅对修改后新创建的会话有效；对已经建立的会话无效</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> system_var_name<span class="operator">=</span><span class="keyword">value</span>; </span><br><span class="line"><span class="keyword">set</span> @<span class="variable">@global</span>.system_var_name<span class="operator">=</span><span class="keyword">value</span>;</span><br></pre></td></tr></table></figure><p>修改会话变量：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> [session] system_var_name<span class="operator">=</span><span class="keyword">value</span>; </span><br><span class="line"><span class="keyword">set</span> @@[session.]system_var_name<span class="operator">=</span><span class="keyword">value</span>;</span><br></pre></td></tr></table></figure><h3 id="服务器状态变量"><a href="#服务器状态变量" class="headerlink" title="服务器状态变量"></a>服务器状态变量</h3><p>服务器状态变量：分全局和会话两种</p><p>状态变量（只读）：用于保存mysqld运行中的统计数据的变量，不可更改</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status; </span><br><span class="line"><span class="keyword">show</span> [session] status;</span><br></pre></td></tr></table></figure><h2 id="INDEX-索引"><a href="#INDEX-索引" class="headerlink" title="INDEX 索引"></a>INDEX 索引</h2><h3 id="索引概述"><a href="#索引概述" class="headerlink" title="索引概述"></a>索引概述</h3><p>索引：索引是用于快速找出在某个列中拥有特定值的行。</p><p>如果没有索引，MySQL必须从第一条记录开始读完整个表，直到找出相关的行，表越大，查询数据所花费的时间就越多。</p><p>如果拥有索引，MySQL能够快速到达一个位置去搜索数据文件，而不必查看所有数据，那么将会节省很大一部分时间。</p><p><strong><font color=red>优点：</font></strong></p><ul><li>索引可以降低服务需要扫描的数据量，减少了IO次数 </li><li>索引可以帮助服务器避免排序和使用临时表</li><li>索引可以帮助将随机I/O转为顺序I/O </li></ul><p><strong><font color=red>缺点：</font></strong></p><ul><li>占用额外空间，影响插入速度 </li></ul><p><strong><font color=red>索引类型：</font></strong></p><ul><li>B+ TREE、HASH、R TREE、FULL TEXT</li><li>聚簇（集）索引、非聚簇索引：数据和索引是否存储在一起 </li><li>主键索引、二级（辅助）索引</li><li>稠密索引、稀疏索引：是否索引了每一个数据项 </li><li>简单索引、组合索引: 是否是多个字段的索引 </li><li>左前缀索引：取前面的字符做索引</li><li>覆盖索引：从索引中即可取出要查询的数据，性能高</li></ul><p><strong><font color=red>索引的使用原则</font></strong></p><p>通过上面说的优点和缺点，我们可以看出，索引并不是越多越好，而是需要自己合理的使用。那么那些表应该去使用索引呢？</p><p><strong>避免使用过多索引：</strong> 经常更新的表、数据量小的表、相同值少的字段上等</p><p><strong>使用索引：</strong> 经常查询的表、不同值较多的字段上等</p><p>一个表中很够创建多个索引，这些索引会被存放到一个索引文件中(专门存放索引的地方)</p><h3 id="管理索引"><a href="#管理索引" class="headerlink" title="管理索引"></a>管理索引</h3><h4 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">create</span> [<span class="keyword">unique</span>] index 索引名 <span class="keyword">on</span> 表名(字段名[(长度)]); </span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 <span class="keyword">add</span> index 索引名(字段名[(长度)]);</span><br></pre></td></tr></table></figure><p>范例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MySQL [hellodb]<span class="operator">&gt;</span> <span class="keyword">create</span> index idx_name <span class="keyword">on</span> students(name(<span class="number">10</span>));</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected</span><br><span class="line"><span class="type">Time</span>: <span class="number">0.088</span>s</span><br><span class="line"></span><br><span class="line">MySQL [hellodb]<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> teachers <span class="keyword">add</span> index idx_name(name(<span class="number">10</span>));</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected</span><br><span class="line"><span class="type">Time</span>: <span class="number">0.066</span>s</span><br></pre></td></tr></table></figure><h4 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方法一</span></span><br><span class="line"><span class="keyword">drop</span> index 索引名 <span class="keyword">on</span> 表名;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法二</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 <span class="keyword">drop</span> index 索引名;</span><br></pre></td></tr></table></figure><p>范例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MySQL [hellodb]<span class="operator">&gt;</span> <span class="keyword">drop</span> index idx_name <span class="keyword">on</span> students;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected</span><br><span class="line"><span class="type">Time</span>: <span class="number">0.042</span>s</span><br></pre></td></tr></table></figure><h4 id="查看索引"><a href="#查看索引" class="headerlink" title="查看索引"></a>查看索引</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> index <span class="keyword">from</span> [数据库名.]表名;</span><br></pre></td></tr></table></figure><h4 id="优化表空间"><a href="#优化表空间" class="headerlink" title="优化表空间"></a>优化表空间</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">optimize <span class="keyword">table</span> 表名;</span><br></pre></td></tr></table></figure><h4 id="查看索引的使用"><a href="#查看索引的使用" class="headerlink" title="查看索引的使用"></a>查看索引的使用</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> userstat<span class="operator">=</span><span class="number">1</span>;  <span class="comment">-- MySQL无此变量 </span></span><br><span class="line"><span class="keyword">SHOW</span> INDEX_STATISTICS;</span><br></pre></td></tr></table></figure><p>范例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [hellodb]<span class="operator">&gt;</span> <span class="keyword">SET</span> <span class="keyword">GLOBAL</span> userstat<span class="operator">=</span><span class="number">1</span>; </span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.000</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]<span class="operator">&gt;</span> <span class="keyword">SHOW</span> INDEX_STATISTICS; </span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.000</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]<span class="operator">&gt;</span> <span class="keyword">desc</span> students;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------------+------+-----+---------+----------------+ </span></span><br><span class="line"><span class="operator">|</span> Field     <span class="operator">|</span> Type                <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Extra          <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------------+------+-----+---------+----------------+ </span></span><br><span class="line"><span class="operator">|</span> StuID     <span class="operator">|</span> <span class="type">int</span>(<span class="number">10</span>) unsigned    <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> auto_increment <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span> Name      <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">50</span>)         <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>                <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span> Age       <span class="operator">|</span> tinyint(<span class="number">3</span>) unsigned <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>                <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span> Gender    <span class="operator">|</span> enum(<span class="string">&#x27;F&#x27;</span>,<span class="string">&#x27;M&#x27;</span>)       <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>                <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span> ClassID   <span class="operator">|</span> tinyint(<span class="number">3</span>) unsigned <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>                <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span> TeacherID <span class="operator">|</span> <span class="type">int</span>(<span class="number">10</span>) unsigned    <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>                <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.001</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]<span class="operator">&gt;</span> <span class="keyword">show</span> index <span class="keyword">from</span> students\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> </span><br><span class="line">        <span class="keyword">Table</span>: students</span><br><span class="line">   Non_unique: <span class="number">0</span></span><br><span class="line">     Key_name: <span class="keyword">PRIMARY</span> </span><br><span class="line"> Seq_in_index: <span class="number">1</span></span><br><span class="line">  Column_name: StuID </span><br><span class="line">    <span class="keyword">Collation</span>: A</span><br><span class="line">  <span class="keyword">Cardinality</span>: <span class="number">25</span> </span><br><span class="line">     Sub_part: <span class="keyword">NULL</span> </span><br><span class="line">       Packed: <span class="keyword">NULL</span> </span><br><span class="line">         <span class="keyword">Null</span>:</span><br><span class="line">   Index_type: BTREE</span><br><span class="line">      Comment:</span><br><span class="line">Index_comment: </span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.000</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]<span class="operator">&gt;</span> <span class="keyword">SHOW</span> INDEX_STATISTICS; </span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.000</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> students <span class="keyword">where</span> stuid<span class="operator">=</span><span class="number">10</span>; </span><br><span class="line"><span class="operator">+</span><span class="comment">-------+--------------+-----+--------+---------+-----------+ </span></span><br><span class="line"><span class="operator">|</span> StuID <span class="operator">|</span> Name         <span class="operator">|</span> Age <span class="operator">|</span> Gender <span class="operator">|</span> ClassID <span class="operator">|</span> TeacherID <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">-------+--------------+-----+--------+---------+-----------+ </span></span><br><span class="line"><span class="operator">|</span>    <span class="number">10</span> <span class="operator">|</span> Yue Lingshan <span class="operator">|</span>  <span class="number">19</span> <span class="operator">|</span> F      <span class="operator">|</span>       <span class="number">3</span> <span class="operator">|</span>      <span class="keyword">NULL</span> <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">-------+--------------+-----+--------+---------+-----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.000</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]<span class="operator">&gt;</span> <span class="keyword">SHOW</span> INDEX_STATISTICS;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+------------+------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Table_schema <span class="operator">|</span> Table_name <span class="operator">|</span> Index_name <span class="operator">|</span> Rows_read <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+------------+------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> hellodb      <span class="operator">|</span> students   <span class="operator">|</span> <span class="keyword">PRIMARY</span>    <span class="operator">|</span>         <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+------------+------------+-----------+ </span></span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> students <span class="keyword">where</span> stuid<span class="operator">=</span><span class="number">10</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+--------------+-----+--------+---------+-----------+ </span></span><br><span class="line"><span class="operator">|</span> StuID <span class="operator">|</span> Name         <span class="operator">|</span> Age <span class="operator">|</span> Gender <span class="operator">|</span> ClassID <span class="operator">|</span> TeacherID <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">-------+--------------+-----+--------+---------+-----------+ </span></span><br><span class="line"><span class="operator">|</span>    <span class="number">10</span> <span class="operator">|</span> Yue Lingshan <span class="operator">|</span>  <span class="number">19</span> <span class="operator">|</span> F      <span class="operator">|</span>       <span class="number">3</span> <span class="operator">|</span>      <span class="keyword">NULL</span> <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">-------+--------------+-----+--------+---------+-----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.000</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]<span class="operator">&gt;</span> <span class="keyword">SHOW</span> INDEX_STATISTICS;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+------------+------------+-----------+ </span></span><br><span class="line"><span class="operator">|</span> Table_schema <span class="operator">|</span> Table_name <span class="operator">|</span> Index_name <span class="operator">|</span> Rows_read <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+------------+------------+-----------+ </span></span><br><span class="line"><span class="operator">|</span> hellodb      <span class="operator">|</span> students   <span class="operator">|</span> <span class="keyword">PRIMARY</span>    <span class="operator">|</span>         <span class="number">2</span> <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+------------+------------+-----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.000</span> sec)</span><br></pre></td></tr></table></figure><h2 id="锁机制"><a href="#锁机制" class="headerlink" title="锁机制"></a>锁机制</h2><p><strong>锁类型：</strong></p><ul><li>读锁：共享锁，也称为 S 锁,只读不可写（包括当前事务）  ，多个读互不阻塞</li><li>写锁：独占锁，排它锁，也称为 X 锁,写锁会阻塞其它事务（不包括当前事务）的读和写</li><li>S 锁和 S 锁是<strong>兼容</strong>的，X 锁和其它锁都<strong>不兼容</strong>，举个例子，事务 T1 获取了一个行 r1 的 S 锁，另外事务 T2 可以立即获得行 r1 的 S 锁，此时 T1 和 T2 共同获得行 r1 的 S 锁，此种情况称为<strong>锁兼容</strong>，但是另外一个事务 T2 此时如果想获得行 r1 的 X 锁，则必须等待 T1 对行 r1 锁的释放，此种情况也称为<strong>锁冲突</strong></li></ul><p><strong>锁粒度：</strong></p><ul><li>表级锁：MyISAM </li><li>行级锁：InnoDB</li></ul><p><strong>实现</strong></p><ul><li>存储引擎：自行实现其锁策略和锁粒度</li><li>服务器级：实现了锁，表级锁，用户可显式请求 </li></ul><p><strong>分类：</strong></p><ul><li>隐式锁：由存储引擎自动施加锁 </li><li>显式锁：用户手动请求</li></ul><p>锁策略：在锁粒度及数据安全性寻求的平衡机制</p><h2 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h2><p>事务 Transactions：一组原子性的 SQL语句，或一个独立工作单元 </p><p>MySQL 事务主要用于处理操作量大，复杂度高的数据。比如说，在人员管理系统中，你删除一个人员，你既需要删除人员的基本资料，也要删除和该人员相关的信息，如信箱，文章等等，这样，这些数据库操作语句就构成一个事务！</p><p>事务是一个事件处理的完整的过程。比如：存款、取款、转帐等操作都可以称之为一个事务。</p><p>事务日志：记录事务信息，实现undo,redo等故障恢复功能</p><h3 id="事务特性"><a href="#事务特性" class="headerlink" title="事务特性"></a>事务特性</h3><p><strong>ACID特性：</strong></p><ul><li>A：atomicity 原子性；整个事务中的所有操作要么全部成功执行，要么全部失败后回滚</li><li>C：consistency一致性；数据库总是从一个一致性状态转换为另一个一致性状态</li><li>I：Isolation隔离性；一个事务所做出的操作在提交之前，是不能为其它事务所见；隔离有多种隔离级别，实现并发</li><li>D：durability持久性；一旦事务提交，其所做的修改会永久保存于数据库中</li></ul><h3 id="管理事务"><a href="#管理事务" class="headerlink" title="管理事务"></a>管理事务</h3><p><strong>显式启动事务：</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">begin</span> work </span><br><span class="line"><span class="keyword">start</span> transaction</span><br></pre></td></tr></table></figure><p><strong>结束事务：</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 提交,相当于vi中的wq保存退出</span></span><br><span class="line"><span class="keyword">COMMIT</span></span><br><span class="line"><span class="comment">-- 回滚,相当于vi中的q!不保存退出</span></span><br><span class="line"><span class="keyword">ROLLBACK</span></span><br></pre></td></tr></table></figure><p><strong><font color=red>注意：只有事务型存储引擎中的DML语句方能支持此类操作 </font></strong></p><p><strong>自动提交：</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> autocommit<span class="operator">=</span>&#123;<span class="number">1</span><span class="operator">|</span><span class="number">0</span>&#125;</span><br></pre></td></tr></table></figure><p>默认为1，为0时设为非自动提交</p><p>建议：显式请求和提交事务，而不要使用”自动提交”功能 </p><p><strong>查看事务：</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看当前正在进行的事务</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> INFORMATION_SCHEMA.INNODB_TRX; </span><br><span class="line"></span><br><span class="line"><span class="comment">-- 以下两张表在MySQL8.0中已取消</span></span><br><span class="line"><span class="comment">-- 查看当前锁定的事务</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> INFORMATION_SCHEMA.INNODB_LOCKS; </span><br><span class="line"><span class="comment">-- 查看当前等锁的事务</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> INFORMATION_SCHEMA.INNODB_LOCK_WAITS;</span><br></pre></td></tr></table></figure><h3 id="事务隔离级别"><a href="#事务隔离级别" class="headerlink" title="事务隔离级别"></a>事务隔离级别</h3><p>MySQL 支持四种隔离级别，事务隔离级别从上至下更加严格</p><div class="table-container"><table><thead><tr><th>级别</th><th>名称</th><th>隔离级别</th><th>脏读</th><th>不可重复读</th><th>幻读</th><th>加读锁</th></tr></thead><tbody><tr><td>1</td><td>读未提交</td><td>READ UNCOMMITTED</td><td>可以出现</td><td>可以出现</td><td>可以出现</td><td>否</td></tr><tr><td>2</td><td>读提交</td><td>READ COMMITTED</td><td>不允许出现</td><td>可以出现</td><td>可以出现</td><td>否</td></tr><tr><td>3</td><td>可重复读</td><td>REPEATABLE READ</td><td>不允许出现</td><td>不允许出现</td><td>可以出现</td><td>否</td></tr><tr><td>4</td><td>串行化</td><td>SERIALIZABLE</td><td>不允许出现</td><td>不允许出现</td><td>不允许出现</td><td>是</td></tr></tbody></table></div><ul><li><p>READ UNCOMMITTED</p><p>可读取到未提交数据，产生<font color=red>脏读</font></p></li><li><p>READ COMMITTED</p><p>可读取到提交数据，但未提交数据不可读，产生<font color=red>不可重复读 </font>，即可读取到多个提交数据，导致每次读取数据不一致</p></li><li><p>REPEATABLE READ</p><p>可重复读，多次读取数据都一致，产生<font color=red>幻读</font>，即读取过程中，即使有其它提交的事务修改数据，仍只能读取到未修改前的旧数据。此为MySQL默认设置</p></li><li><p>SERIALIZABLE</p><p>可串行化，未提交的读事务阻塞修改事务（加读锁，但不阻塞读事务），或者未提交的修改事务阻塞其它事务的读写（加写锁，其它事务的读，写都不可以执行）。会导致<font color=red>并发性能差</font></p></li></ul><p><strong><font color=red>注意：隔离级别越高，性能越差，安全性越高。</font></strong></p><h3 id="事务隔离命令"><a href="#事务隔离命令" class="headerlink" title="事务隔离命令"></a>事务隔离命令</h3><p>查看隔离级别</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 格式：</span></span><br><span class="line"><span class="keyword">select</span> @<span class="variable">@transaction</span>_isolation;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@transaction</span>_isolation;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@transaction</span>_isolation <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+</span></span><br><span class="line"><span class="operator">|</span> REPEATABLE<span class="operator">-</span>READ         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.000</span> sec)</span><br></pre></td></tr></table></figure><p>设置隔离级别</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 格式：</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> transaction_isolation<span class="operator">=</span>级别字符串</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> <span class="keyword">global</span> transaction_isolation<span class="operator">=</span><span class="string">&#x27;read-committed&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><p>重启客户端，查看</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@transaction</span>_isolation;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@transaction</span>_isolation <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+</span></span><br><span class="line"><span class="operator">|</span> READ<span class="operator">-</span>COMMITTED          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.000</span> sec)</span><br></pre></td></tr></table></figure><h2 id="日志管理"><a href="#日志管理" class="headerlink" title="日志管理"></a>日志管理</h2><p>MySQL 支持丰富的日志类型，如下：</p><ul><li><p>事务日志：transaction log</p><p>事务日志的写入类型为”追加”，因此其操作为”顺序IO”；通常也被称为：预写式日志 write ahead logging</p><p>事务日志文件： ib_logfile0， ib_logfile1 </p></li><li><p>错误日志 error log</p></li><li>通用日志 general log </li><li>慢查询日志 slow query log </li><li>二进制日志 binary log</li><li>中继日志 reley log，在主从复制架构中，从服务器用于保存从主服务器的二进制日志中读取的事件</li></ul><h3 id="事务日志"><a href="#事务日志" class="headerlink" title="事务日志"></a>事务日志</h3><p>事务日志：transaction log</p><ul><li>redo log：实现 WAL（Write Ahead Log) ,数据更新前先记录redo log </li><li>undo log：保存与执行的操作相反的操作,用于实现rollback</li></ul><p>事务型存储引擎自行管理和使用，建议和数据文件分开存放 </p><p><strong>Innodb事务日志相关配置：</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%innodb_log%&#x27;</span>;</span><br><span class="line">innodb_log_file_size   <span class="number">50331648</span>     <span class="comment">-- 每个日志文件大小</span></span><br><span class="line">innodb_log_files_in_group  <span class="number">2</span>        <span class="comment">-- 日志组成员个数</span></span><br><span class="line">innodb_log_group_home_dir  .<span class="operator">/</span>       <span class="comment">-- 事务文件路径</span></span><br></pre></td></tr></table></figure><p><strong>事务日志性能优化</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">innodb_flush_log_at_trx_commit=0|1|2</span><br></pre></td></tr></table></figure><ul><li>1  此为默认值，日志缓冲区将写入日志文件，并在每次事务后执行刷新到磁盘。    这是完全遵守ACID特性 </li><li>0  提交时没有写磁盘的操作; 而是每秒执行一次将日志缓冲区的提交的事务写入刷新到磁盘。    这样可提供更好的性能，但服务器崩溃可能丢失最后一秒的事务</li><li>2  每次提交后都会写入OS的缓冲区，但每秒才会进行一次刷新到磁盘文件中。    性能比0略差一些，但操作系统崩溃或停电可能导致最后一秒的交易丢失</li></ul><p><strong>说明：</strong></p><ul><li>设置为1，同时sync_binlog = 1表示最高级别的容错</li><li>innodb_use_global_flush_log_at_trx_commit=0 时，将不能用SET语句重置此变量（ MariaDB 10.2.6 后废弃）</li></ul><h3 id="错误日志"><a href="#错误日志" class="headerlink" title="错误日志"></a>错误日志</h3><p>错误日志</p><ul><li>mysqld启动和关闭过程中输出的事件信息 </li><li>mysqld运行中产生的错误信息</li><li>event scheduler运行一个event时产生的日志信息</li><li>在主从复制架构中的从服务器上启动从服务器线程时产生的信息 </li></ul><p>错误文件路径</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;log_error&#x27;</span> ;</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [hellodb]<span class="operator">&gt;</span> <span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;log_error&#x27;</span>; </span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span>                        <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+------------------------------+ </span></span><br><span class="line"><span class="operator">|</span> log_error     <span class="operator">|</span> <span class="operator">/</span>var<span class="operator">/</span>log<span class="operator">/</span>mariadb<span class="operator">/</span>mariadb.log <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.001</span> sec)</span><br></pre></td></tr></table></figure><h3 id="通用日志"><a href="#通用日志" class="headerlink" title="通用日志"></a>通用日志</h3><p>通用日志：记录对数据库的通用操作，包括:错误的SQL语句</p><p>通用日志可以保存在：file（默认值）或 table（mysql.general_log表） </p><p>通用日志相关设置</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">general_log=ON|OFF</span><br><span class="line">general_log_file=HOSTNAME.log </span><br><span class="line">log_output=TABLE|FILE|NONE</span><br></pre></td></tr></table></figure><h3 id="慢查询日志"><a href="#慢查询日志" class="headerlink" title="慢查询日志"></a>慢查询日志</h3><p>慢查询日志：记录执行查询时长超出指定时长的操作 </p><p>慢查询相关变量</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">slow_query_log<span class="operator">=</span><span class="keyword">ON</span><span class="operator">|</span>OFF   <span class="comment">-- 开启或关闭慢查询，支持全局和会话，只有全局设置才会生成慢查询文件 </span></span><br><span class="line">long_query_time<span class="operator">=</span>N       <span class="comment">-- 慢查询的阀值，单位秒,默认为10s</span></span><br><span class="line">slow_query_log_file<span class="operator">=</span>HOSTNAME<span class="operator">-</span>slow.log  <span class="comment">-- 慢查询日志文件</span></span><br><span class="line">log_slow_filter <span class="operator">=</span> admin,filesort,filesort_on_disk,full_join,full_scan,query_cache,query_cache_miss,tmp_table,tmp_table_on_disk </span><br><span class="line"><span class="comment">-- 上述查询类型且查询时长超过long_query_time，则记录日志</span></span><br><span class="line">log_queries_not_using_indexes<span class="operator">=</span><span class="keyword">ON</span>        <span class="comment">-- 不使用索引或使用全索引扫描，不论是否达到慢查询阀值的语句是否记录日志，默认OFF，即不记录</span></span><br><span class="line">log_slow_rate_limit <span class="operator">=</span> <span class="number">1</span>                 <span class="comment">-- 多少次查询才记录，mariadb特有</span></span><br><span class="line">log_slow_verbosity<span class="operator">=</span> Query_plan,explain  <span class="comment">-- 记录内容</span></span><br><span class="line">log_slow_queries <span class="operator">=</span> OFF                  <span class="comment">-- 同slow_query_log，MariaDB 10.0/MySQL 5.6.1 版后已删除</span></span><br></pre></td></tr></table></figure><h3 id="二进制日志-备份"><a href="#二进制日志-备份" class="headerlink" title="二进制日志(备份)"></a>二进制日志(备份)</h3><ul><li>记录导致数据改变或潜在导致数据改变的SQL语句 </li><li>记录已提交的日志</li><li>不依赖于存储引擎类型</li></ul><p>功能：通过”重放”日志文件中的事件来生成数据副本 </p><p>注意：建议二进制日志和数据文件分开存放 </p><p><strong>二进制日志记录三种格式</strong></p><ul><li>基于”语句”记录：statement，记录语句，默认模式（ MariaDB 10.2.3 版本以下  ），日志量较少 </li><li>基于”行”记录：row，记录数据，日志量较大，更加安全，<strong>建议使用的格式</strong>,MySQL8.0默认格式 </li><li>混合模式：mixed, 让系统自行判定该基于哪种方式进行，默认模式（ MariaDB 10.2.4及版本以上）</li></ul><p><strong>格式配置</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [hellodb]<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;binlog_format&#x27;</span>; </span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+ </span></span><br><span class="line"><span class="operator">|</span> binlog_format <span class="operator">|</span> MIXED <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.001</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- MySQL 8.0 默认使用ROW方式</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;binlog_format&#x27;</span>; </span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+ </span></span><br><span class="line"><span class="operator">|</span> binlog_format <span class="operator">|</span> <span class="type">ROW</span>   <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.07</span> sec)</span><br></pre></td></tr></table></figure><p><strong>二进制日志文件的构成</strong></p><p>有两类文件</p><ol><li>日志文件：mysql|mariadb-bin.文件名后缀，二进制格式,如： on.000001,mariadb-bin.000002</li><li>索引文件：mysql|mariadb-bin.index，文本格式,记录当前已有的二进制日志文件列表</li></ol><p><strong>二进制日志相关的服务器变量：</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sql_log_bin<span class="operator">=</span><span class="keyword">ON</span><span class="operator">|</span>OFF：        <span class="comment">-- 是否记录二进制日志，默认ON，支持动态修改，系统变量，而非服务器选项 </span></span><br><span class="line">log_bin<span class="operator">=</span><span class="operator">/</span>PATH<span class="operator">/</span>BIN_LOG_FILE：<span class="comment">-- 指定文件位置；默认OFF，表示不启用二进制日志功能，上述两项都开启才可以</span></span><br><span class="line">binlog_format<span class="operator">=</span>STATEMENT<span class="operator">|</span><span class="type">ROW</span><span class="operator">|</span>MIXED：<span class="comment">-- 二进制日志记录的格式，mariadb5.5默认STATEMENT </span></span><br><span class="line">max_binlog_size<span class="operator">=</span><span class="number">1073741824</span>：<span class="comment">-- 单个二进制日志文件的最大体积，到达最大值会自动滚动，默认为1G </span></span><br><span class="line">binlog_cache_size<span class="operator">=</span><span class="number">4</span>m        <span class="comment">-- 此变量确定在每次事务中保存二进制日志更改记录的缓存的大小（每次连接） </span></span><br><span class="line">max_binlog_cache_size<span class="operator">=</span><span class="number">512</span>m  <span class="comment">-- 限制用于缓存多事务查询的字节大小。</span></span><br><span class="line">sync_binlog<span class="operator">=</span><span class="number">1</span><span class="operator">|</span><span class="number">0</span>：           <span class="comment">-- 设定是否启动二进制日志即时同步磁盘功能，默认0，由操作系统负责同步日志到磁盘 </span></span><br><span class="line">expire_logs_days<span class="operator">=</span>N：        <span class="comment">-- 二进制日志可以自动删除的天数。默认为0，即不自动删除</span></span><br></pre></td></tr></table></figure><p><strong>二进制日志相关配置</strong></p><p>查看mariadb自行管理使用中的二进制日志文件列表，及大小</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> &#123;<span class="type">binary</span> <span class="operator">|</span> master&#125; logs</span><br></pre></td></tr></table></figure><p>查看使用中的二进制日志文件</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> master status</span><br></pre></td></tr></table></figure><p>在线查看二进制文件中的指定内容</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> binlog events [<span class="keyword">in</span> <span class="string">&#x27;log_name&#x27;</span>] [<span class="keyword">from</span> pos] [limit [<span class="keyword">offset</span>,] row_count]</span><br></pre></td></tr></table></figure><p>范例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000001&#x27;</span> <span class="keyword">from</span> <span class="number">6516</span> limit <span class="number">2</span>,<span class="number">3</span></span><br></pre></td></tr></table></figure><p><code>mysqlbinlog</code>：二进制日志的客户端命令工具，支持离线查看二进制日志 </p><p>命令格式：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog [OPTIONS] log_file…</span><br><span class="line">        --start-position=     <span class="comment">#指定开始位置 </span></span><br><span class="line">        --stop-position=      <span class="comment">#指定结束位置 </span></span><br><span class="line">        --start-datetime=     <span class="comment">#时间格式：YYYY-MM-DD hh:mm:ss </span></span><br><span class="line">        --stop-datetime=</span><br><span class="line">        --base64-output[=name]</span><br><span class="line">        -v -vvv</span><br></pre></td></tr></table></figure><p>范例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog --start-position=678 --stop-position=752 /var/lib/mysql/mariadb-bin.000003 -v</span><br><span class="line"></span><br><span class="line">mysqlbinlog --start-datetime=<span class="string">&quot;2018-01-30 20:30:10&quot;</span>   --stop-datetime=<span class="string">&quot;2018-01-30 20:35:22&quot;</span> mariadb-bin.000003 -vvv</span><br></pre></td></tr></table></figure><p>二进制日志事件的格式：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># at 328</span><br><span class="line">#151105 16:31:40 server id 1  end_log_pos 431   Query   thread_id=1     exec_time=0     error_code=0</span><br><span class="line">use `mydb`/*!*/;</span><br><span class="line">SET TIMESTAMP=1446712300/*!*/;</span><br><span class="line">CREATE TABLE tb1 (id int, name char(30)) </span><br><span class="line">/*!*/;  </span><br><span class="line">事件发生的日期和时间：151105 16:31:40 </span><br><span class="line">事件发生的服务器标识：server id 1 </span><br><span class="line">事件的结束位置：end_log_pos 431 </span><br><span class="line">事件的类型：Query</span><br><span class="line">事件发生时所在服务器执行此事件的线程的ID：thread_id=1 </span><br><span class="line">语句的时间戳与将其写入二进制文件中的时间差：exec_time=0 </span><br><span class="line">错误代码：error_code=0</span><br><span class="line">事件内容：GTID：Global Transaction ID，mysql5.6以mariadb10以上版本专属属性：GTID</span><br></pre></td></tr></table></figure><p>清除指定二进制日志</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">purge &#123; <span class="type">binary</span> <span class="operator">|</span> master &#125; logs  &#123; <span class="keyword">to</span> <span class="string">&#x27;日志名&#x27;</span> <span class="operator">|</span> before 时间值 &#125;</span><br></pre></td></tr></table></figure><p>范例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">purge <span class="type">binary</span> logs <span class="keyword">to</span> <span class="string">&#x27;mariadb-bin.000003&#x27;</span>;  <span class="comment">-- 删除mariadb-bin.000003之前的日志</span></span><br><span class="line">purge <span class="type">binary</span> logs before <span class="string">&#x27;2017-01-23&#x27;</span>;</span><br><span class="line">purge <span class="type">binary</span> logs before <span class="string">&#x27;2017-03-22 09:25:30&#x27;</span>;</span><br></pre></td></tr></table></figure><p>删除所有二进制日志，index文件重新记数</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 删除所有二进制日志文件，并重新生成日志文件，文件名从#开始记数，默认从1开始，一般是master主机第一次启动时执行，MariaDB 10.1.6开始支持[to #]</span></span><br><span class="line">reset master [<span class="keyword">to</span> #]; </span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CentOS运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CENTOS </tag>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL 用户管理</title>
      <link href="/2022/06/04/2022/06/MySQL-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/"/>
      <url>/2022/06/04/2022/06/MySQL-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h2 id="账户管理的重要性"><a href="#账户管理的重要性" class="headerlink" title="账户管理的重要性"></a>账户管理的重要性</h2><ul><li>在MySQL中可以通过账户控制允许或不允许用户执行操作</li><li>可以精细分配权限给不同职能的账户</li><li>避免使用root账户<ul><li>将root账户改名，应用不要用root</li></ul></li><li>应用不能直接使用root</li><li>防止维护期出错</li><li>限制特定权限账户确保数据完整性</li><li>允许特定授权账户完成期工作</li><li>阻止未经授权的用户访问超出其特权的数据</li></ul><h2 id="相关数据库和表"><a href="#相关数据库和表" class="headerlink" title="相关数据库和表"></a>相关数据库和表</h2><p>元数据数据库：mysql</p><p>系统授权表：db, host, user,columns_priv, tables_priv, procs_priv, proxies_priv</p><h2 id="用户帐号"><a href="#用户帐号" class="headerlink" title="用户帐号"></a>用户帐号</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;USERNAME&#x27;</span>@<span class="string">&#x27;HOST&#x27;</span></span><br><span class="line"></span><br><span class="line">@<span class="string">&#x27;HOST&#x27;</span>: 主机名： user1@<span class="string">&#x27;web1.tdison.ml&#x27;</span> </span><br><span class="line">IP地址或Network</span><br><span class="line">通配符： <span class="operator">%</span>   _</span><br><span class="line">示例：user1<span class="variable">@172</span><span class="number">.16</span>.<span class="operator">%</span>.<span class="operator">%</span>  </span><br><span class="line">         user2@<span class="string">&#x27;192.168.1.%&#x27;</span></span><br><span class="line">         user3@<span class="string">&#x27;10.0.0.0/255.255.0.0&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="创建用户：CREATE-USER"><a href="#创建用户：CREATE-USER" class="headerlink" title="创建用户：CREATE USER"></a>创建用户：CREATE USER</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;用户名&#x27;</span>@<span class="string">&#x27;主机名&#x27;</span> [identified <span class="keyword">by</span> <span class="string">&#x27;密码&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 示例:</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> test@<span class="string">&#x27;10.0.0.0/255.255.255.0&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;123456&#x27;</span>; </span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> test2@<span class="string">&#x27;10.0.0.%&#x27;</span> identified <span class="keyword">by</span> <span class="number">123456</span>;</span><br></pre></td></tr></table></figure><p>新建用户的默认权限：USAGE</p><h2 id="查看用户："><a href="#查看用户：" class="headerlink" title="查看用户："></a>查看用户：</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span>;</span><br></pre></td></tr></table></figure><h2 id="用户重命名：RENAME-USER"><a href="#用户重命名：RENAME-USER" class="headerlink" title="用户重命名：RENAME USER"></a>用户重命名：RENAME USER</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rename <span class="keyword">user</span> <span class="string">&#x27;旧用户名&#x27;</span> <span class="keyword">to</span> <span class="string">&#x27;新用户名&#x27;</span>;</span><br></pre></td></tr></table></figure><h2 id="删除用户："><a href="#删除用户：" class="headerlink" title="删除用户："></a>删除用户：</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">user</span> <span class="string">&#x27;用户名&#x27;</span>@<span class="string">&#x27;主机名&#x27;</span>;</span><br></pre></td></tr></table></figure><p>范例：删除默认的空用户</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">user</span> <span class="string">&#x27;&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br></pre></td></tr></table></figure><h2 id="修改密码："><a href="#修改密码：" class="headerlink" title="修改密码："></a>修改密码：</h2><ul><li>新版mysql中用户密码可以保存在mysql.user表的authentication_string字段中</li><li>如果mysql.user表的authentication_string和password字段都保存密码，authentication_string优先生效</li></ul><p><strong>方法1 用户可以也可通过此方式修改自已的密码</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> PASSWORD <span class="keyword">FOR</span> <span class="string">&#x27;user&#x27;</span>@<span class="string">&#x27;host&#x27;</span> <span class="operator">=</span> PASSWORD(<span class="string">&#x27;password&#x27;</span>);  <span class="comment">-- MySQL8.0 版本不支持此方法,因为password函数被取消</span></span><br><span class="line"><span class="keyword">set</span> password <span class="keyword">for</span> root@<span class="string">&#x27;localhost&#x27;</span><span class="operator">=</span><span class="string">&#x27;123456&#x27;</span> ;  <span class="comment">-- MySQL8.0版本支持此方法,此方式直接将密码123456加密后存放在mysql.user表的authentication_string字段</span></span><br></pre></td></tr></table></figure><p><strong>方法2 <font color=red>推荐使用</font></strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">user</span> <span class="string">&#x27;用户名&#x27;</span>@<span class="string">&#x27;主机名&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;密码&#x27;</span>;  <span class="comment">-- 通用改密码方法, 用户可以也可通过此方式修改自已的密码,MySQL8 版本修改密码</span></span><br></pre></td></tr></table></figure><p><strong>方法3 <font color=red>此方式MySQL8.0不支持,因为password函数被取消</font></strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- MySQL</span></span><br><span class="line"><span class="keyword">UPDATE</span> mysql.user <span class="keyword">SET</span> password<span class="operator">=</span>PASSWORD(<span class="string">&#x27;password&#x27;</span>) <span class="keyword">WHERE</span> clause; </span><br><span class="line"><span class="comment">-- mariadb 10.3</span></span><br><span class="line"><span class="keyword">update</span> mysql.user <span class="keyword">set</span> authentication_string<span class="operator">=</span>password(<span class="string">&#x27;password&#x27;</span>) <span class="keyword">where</span> <span class="keyword">user</span><span class="operator">=</span><span class="string">&#x27;user1&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 此方法需要执行下面指令才能生效： </span></span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure><h3 id="忘记管理员密码的解决办法："><a href="#忘记管理员密码的解决办法：" class="headerlink" title="忘记管理员密码的解决办法："></a>忘记管理员密码的解决办法：</h3><ol><li><p>修改my.cnf文件，添加如下选项并启动MySQL。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">--skip-grant-tables </span><br><span class="line">--skip-networking</span><br></pre></td></tr></table></figure></li><li><p>使用UPDATE命令修改管理员密码</p></li><li>关闭mysqld进程，移除上述两个选项，重启mysqld</li></ol><p><strong>Mariadb 和MySQL5.6版之前破解root密码</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@centos8</span> <span class="operator">~</span>]#vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf </span><br><span class="line">[mysqld]</span><br><span class="line"><span class="keyword">skip</span><span class="operator">-</span><span class="keyword">grant</span><span class="operator">-</span>tables   </span><br><span class="line"><span class="keyword">skip</span><span class="operator">-</span>networking  </span><br><span class="line"></span><br><span class="line">[root<span class="variable">@centos8</span> <span class="operator">~</span>]#systemctl restart mysqld<span class="operator">|</span>mariadb </span><br><span class="line">[root<span class="variable">@centos8</span> <span class="operator">~</span>]#mysql</span><br><span class="line"><span class="comment">-- 方法1</span></span><br><span class="line"><span class="comment">-- mariadb 旧版和MySQL5.6版之前</span></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">update</span> mysql.user <span class="keyword">set</span> password<span class="operator">=</span>password(<span class="string">&#x27;123456&#x27;</span>) <span class="keyword">where</span> <span class="keyword">user</span><span class="operator">=</span><span class="string">&#x27;root&#x27;</span>;</span><br><span class="line"><span class="comment">-- mariadb 新版</span></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">update</span> mysql.user <span class="keyword">set</span> authentication_string<span class="operator">=</span>password(<span class="string">&#x27;123456&#x27;</span>) </span><br><span class="line"><span class="keyword">where</span> <span class="keyword">user</span><span class="operator">=</span><span class="string">&#x27;root&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方法2</span></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> flush privileges;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">user</span> root@<span class="string">&#x27;localhost&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;ubuntu&#x27;</span>; </span><br><span class="line"></span><br><span class="line">[root<span class="variable">@centos8</span> <span class="operator">~</span>]#vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">#<span class="keyword">skip</span><span class="operator">-</span><span class="keyword">grant</span><span class="operator">-</span>tables</span><br><span class="line">#<span class="keyword">skip</span><span class="operator">-</span>networking</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@centos8</span> <span class="operator">~</span>]#systemctl restart mysqld<span class="operator">|</span>mariadb </span><br><span class="line">[root<span class="variable">@centos8</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p123456</span><br></pre></td></tr></table></figure><p><strong>MySQL5.7和8.0 破解root密码</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@centos8</span> <span class="operator">~</span>]#vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf </span><br><span class="line">[mysqld]</span><br><span class="line"><span class="keyword">skip</span><span class="operator">-</span><span class="keyword">grant</span><span class="operator">-</span>tables  </span><br><span class="line"><span class="keyword">skip</span><span class="operator">-</span>networking  <span class="comment">-- MySQL8.0不需要</span></span><br><span class="line">[root<span class="variable">@centos8</span> <span class="operator">~</span>]#systemctl restart mysqld </span><br><span class="line"><span class="comment">-- 方法1</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> mysql.user <span class="keyword">set</span> authentication_string<span class="operator">=</span><span class="string">&#x27;&#x27;</span> <span class="keyword">where</span> <span class="keyword">user</span><span class="operator">=</span><span class="string">&#x27;root&#x27;</span> <span class="keyword">and</span> host<span class="operator">=</span><span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"><span class="comment">-- 方法2</span></span><br><span class="line">mysql<span class="operator">&gt;</span> flush privileges; </span><br><span class="line"><span class="comment">-- 再执行下面任意一个命令</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">user</span> root@<span class="string">&#x27;localhost&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;123456&#x27;</span>; </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> password <span class="keyword">for</span> root@<span class="string">&#x27;localhost&#x27;</span><span class="operator">=</span><span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@centos8</span> <span class="operator">~</span>]#vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf </span><br><span class="line">[mysqld]</span><br><span class="line">#<span class="keyword">skip</span><span class="operator">-</span><span class="keyword">grant</span><span class="operator">-</span>tables                                                               </span><br><span class="line">#<span class="keyword">skip</span><span class="operator">-</span>networking</span><br><span class="line">[root<span class="variable">@centos8</span> <span class="operator">~</span>]#systemctl restart mysqld </span><br><span class="line">[root<span class="variable">@centos8</span> <span class="operator">~</span>]#mysql <span class="operator">-</span>uroot <span class="operator">-</span>p123456</span><br></pre></td></tr></table></figure><h2 id="权限管理和DCL语句"><a href="#权限管理和DCL语句" class="headerlink" title="权限管理和DCL语句"></a>权限管理和DCL语句</h2><h3 id="授权：GRANT"><a href="#授权：GRANT" class="headerlink" title="授权：GRANT"></a>授权：GRANT</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 格式：</span></span><br><span class="line"><span class="keyword">grant</span> 权限 <span class="number">1</span>, 权限 <span class="number">2.</span>.. <span class="keyword">on</span> 数据库名.表名 <span class="keyword">to</span> <span class="string">&#x27;用户名&#x27;</span>@<span class="string">&#x27;主机名&#x27;</span>;</span><br></pre></td></tr></table></figure><p>说明：</p><ul><li><strong>权限：</strong> 如select\insert\update\delete等，如果是所有用all</li><li><strong>‘用户名’@’主机名’ ：</strong> 注意单引号不能省略</li></ul><p>范例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 给&#x27;user1&#x27;分配，增加、删除、修改、查询表的权限</span></span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">insert</span>,<span class="keyword">delete</span>,<span class="keyword">update</span>,<span class="keyword">select</span> <span class="keyword">on</span> hellodb.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;user1&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 给&#x27;user2&#x27;分配所有权限</span></span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;user2&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 范例：wordpress权限设置</span></span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> wordpress.<span class="operator">*</span> <span class="keyword">to</span> wordpress@<span class="string">&#x27;10.0.0.%&#x27;</span> ;</span><br></pre></td></tr></table></figure><h3 id="取消授权：REVOKE"><a href="#取消授权：REVOKE" class="headerlink" title="取消授权：REVOKE"></a>取消授权：REVOKE</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">revoke</span> 权限 <span class="number">1</span>, 权限 <span class="number">2.</span>.. <span class="keyword">on</span> 数据库名.表名 <span class="keyword">from</span> <span class="string">&#x27;用户名&#x27;</span>@<span class="string">&#x27;主机名&#x27;</span>;</span><br></pre></td></tr></table></figure><p>说明：</p><ul><li><strong>权限：</strong> 如select\insert\update\delete等，如果是所有用all</li><li><strong>‘用户名’@’主机名’ ：</strong> 注意单引号不能省略</li></ul><p>范例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">revoke</span> <span class="keyword">delete</span> <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">from</span> <span class="string">&#x27;testuser&#x27;</span>@<span class="string">&#x27;172.16.0.%&#x27;</span>;</span><br></pre></td></tr></table></figure><h3 id="查看用户权限"><a href="#查看用户权限" class="headerlink" title="查看用户权限"></a>查看用户权限</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 格式：</span></span><br><span class="line"><span class="keyword">show</span> grants <span class="keyword">for</span> <span class="string">&#x27;用户名&#x27;</span>@<span class="string">&#x27;主机名&#x27;</span>;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CentOS运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CENTOS </tag>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MYSQL VIEW 视图</title>
      <link href="/2022/06/03/2022/06/MYSQL-VIEW-%E8%A7%86%E5%9B%BE/"/>
      <url>/2022/06/03/2022/06/MYSQL-VIEW-%E8%A7%86%E5%9B%BE/</url>
      
        <content type="html"><![CDATA[<h2 id="VIEW-视图"><a href="#VIEW-视图" class="headerlink" title="VIEW 视图"></a>VIEW 视图</h2><p>视图：虚拟表，保存有实表的查询结果，相当于别名</p><p>利用视图,可以隐藏表的真实结构,在程序中利用视图进行查询,可以避免表结构的变化,而修改程序,降低程序和数据库之间的耦合度</p><h3 id="视图创建"><a href="#视图创建" class="headerlink" title="视图创建"></a>视图创建</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span>  视图名  <span class="keyword">as</span>  <span class="keyword">select</span> 字段名 <span class="keyword">from</span> 表名;</span><br></pre></td></tr></table></figure><p>范例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MariaDB root<span class="variable">@127</span><span class="number">.0</span><span class="number">.0</span><span class="number">.1</span>:hellodb<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">view</span> v_st_co_sc </span><br><span class="line">                             <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">as</span> <span class="keyword">select</span> st.name,co.Course,sc.score </span><br><span class="line">                             <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">from</span> students st </span><br><span class="line">                             <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">inner</span> <span class="keyword">join</span> scores sc <span class="keyword">on</span> st.stuid<span class="operator">=</span>sc.stuid </span><br><span class="line">                             <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">inner</span> <span class="keyword">join</span> courses co <span class="keyword">on</span> sc.courseid<span class="operator">=</span>co.CourseID;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected</span><br><span class="line"><span class="type">Time</span>: <span class="number">0.013</span>s</span><br></pre></td></tr></table></figure><h3 id="查看视图定义"><a href="#查看视图定义" class="headerlink" title="查看视图定义"></a>查看视图定义</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">view</span> 视图名  <span class="comment">-- 只能看视图定义 </span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> 视图名 <span class="comment">-- 可以查看表和视图</span></span><br></pre></td></tr></table></figure><h3 id="删除视图"><a href="#删除视图" class="headerlink" title="删除视图"></a>删除视图</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">view</span> 视图列表;</span><br></pre></td></tr></table></figure><p>注意：视图中的数据事实上存储于”基表”中，因此，其修改操作也会针对基表实现；其修改操作受基表限制</p>]]></content>
      
      
      <categories>
          
          <category> CentOS运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CENTOS </tag>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DML和DQL语句</title>
      <link href="/2022/05/30/2022/05/DML%E5%92%8CDQL%E8%AF%AD%E5%8F%A5/"/>
      <url>/2022/05/30/2022/05/DML%E5%92%8CDQL%E8%AF%AD%E5%8F%A5/</url>
      
        <content type="html"><![CDATA[<h1 id="DML和DQL语句"><a href="#DML和DQL语句" class="headerlink" title="DML和DQL语句"></a>DML和DQL语句</h1><h2 id="数据操纵语言DML"><a href="#数据操纵语言DML" class="headerlink" title="数据操纵语言DML"></a>数据操纵语言DML</h2><p>DML: INSERT, DELETE, UPDATE</p><h3 id="INSERT-语句"><a href="#INSERT-语句" class="headerlink" title="INSERT 语句"></a>INSERT 语句</h3><p>功能：一次插入一行或多行数据 </p><p>语法</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> 数据库表名[(字段名<span class="number">1</span>,...)] <span class="keyword">values</span>(字段值<span class="number">1</span>,...);</span><br></pre></td></tr></table></figure><p>范例: 全值插入</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> student <span class="keyword">values</span>(<span class="number">0</span>,<span class="string">&#x27;Bob&#x27;</span>,<span class="number">18</span>,<span class="keyword">default</span>); </span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student; </span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+--------+ </span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name <span class="operator">|</span> age  <span class="operator">|</span> gender <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+--------+ </span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> Bob  <span class="operator">|</span>   <span class="number">18</span> <span class="operator">|</span> M      <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+--------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>范例: 部分列插入</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> student(name,age)<span class="keyword">values</span>(<span class="string">&#x27;Alice&#x27;</span>,<span class="number">20</span>); </span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student; </span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+------+--------+ </span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name  <span class="operator">|</span> age  <span class="operator">|</span> gender <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+------+--------+ </span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> Bob   <span class="operator">|</span>   <span class="number">18</span> <span class="operator">|</span> M      <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> Alice <span class="operator">|</span>   <span class="number">20</span> <span class="operator">|</span> M      <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+------+--------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h3 id="UPDATE-语句"><a href="#UPDATE-语句" class="headerlink" title="UPDATE 语句"></a>UPDATE 语句</h3><p>语法：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> 数据库表名 </span><br><span class="line"><span class="keyword">set</span> 字段名<span class="number">1</span><span class="operator">=</span>&#123;字段值<span class="number">1</span><span class="operator">|</span><span class="keyword">DEFAULT</span>&#125;,字段名<span class="number">2</span><span class="operator">=</span>&#123;字段值<span class="number">2</span><span class="operator">|</span><span class="keyword">DEFAULT</span>&#125;,...</span><br><span class="line">[<span class="keyword">where</span> 条件表达式]</span><br><span class="line">[<span class="keyword">order</span> <span class="keyword">by</span> ...]</span><br><span class="line">[limit 行数];</span><br></pre></td></tr></table></figure><p><strong>注意：一定要有限制条件，否则将修改所有行的指定字段 </strong></p><p>可利用mysql 选项避免此错误：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">-</span>U <span class="operator">|</span> <span class="comment">--safe-updates| --i-am-a-dummy </span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@centos8</span> <span class="operator">~</span>]#vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">[mysql] </span><br><span class="line">safe<span class="operator">-</span>updates</span><br></pre></td></tr></table></figure><p>范例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> student <span class="keyword">set</span> gender<span class="operator">=</span><span class="string">&#x27;F&#x27;</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">2</span>;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected</span><br><span class="line"><span class="type">Time</span>: <span class="number">0.003</span>s</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+-----+--------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name  <span class="operator">|</span> age <span class="operator">|</span> gender <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+-----+--------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span>  <span class="operator">|</span> Bob   <span class="operator">|</span> <span class="number">18</span>  <span class="operator">|</span> M      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2</span>  <span class="operator">|</span> Alice <span class="operator">|</span> <span class="number">20</span>  <span class="operator">|</span> F      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+-----+--------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span></span><br><span class="line"><span class="type">Time</span>: <span class="number">0.007</span>s</span><br></pre></td></tr></table></figure><h3 id="DELETE-语句"><a href="#DELETE-语句" class="headerlink" title="DELETE 语句"></a>DELETE 语句</h3><p>删除表中数据，但不会自动缩减数据文件的大小。 </p><p>语法:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> 数据库表名</span><br><span class="line">[<span class="keyword">where</span> 条件表达式]</span><br><span class="line">[<span class="keyword">order</span> <span class="keyword">by</span> ...]</span><br><span class="line">[limit 行数];</span><br><span class="line">#可先排序再指定删除的行数</span><br></pre></td></tr></table></figure><p><strong>注意：一定要有限制条件，否则将清空表中的所有数据</strong></p><p>范例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">delete</span> <span class="keyword">from</span> student <span class="keyword">where</span> id<span class="operator">=</span><span class="number">2</span></span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected</span><br><span class="line"><span class="type">Time</span>: <span class="number">0.012</span>s</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+-----+--------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name <span class="operator">|</span> age <span class="operator">|</span> gender <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+-----+--------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span>  <span class="operator">|</span> Bob  <span class="operator">|</span> <span class="number">18</span>  <span class="operator">|</span> M      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+-----+--------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span></span><br><span class="line"><span class="type">Time</span>: <span class="number">0.007</span>s</span><br></pre></td></tr></table></figure><p>如果想清空表，保留表结构，也可以使用下面语句，此语句会自动缩减数据文件的大小。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">truncate</span> <span class="keyword">table</span> 表名;</span><br></pre></td></tr></table></figure><h2 id="数据查询语言DQL"><a href="#数据查询语言DQL" class="headerlink" title="数据查询语言DQL"></a>数据查询语言DQL</h2><h3 id="单表查询"><a href="#单表查询" class="headerlink" title="单表查询"></a>单表查询</h3><p>数据查询语言DQL基本结构是由SELECT子句，FROM子句，WHERE</p><p>子句组成的查询块：</p><ul><li>SELECT &lt;字段名表&gt;</li><li>FROM &lt;表或视图名&gt;</li><li>WHERE &lt;查询条件&gt;</li></ul><h4 id="WHERE子句"><a href="#WHERE子句" class="headerlink" title="WHERE子句"></a>WHERE子句</h4><p>AND、OR、BETWEEN…AND 和  IN</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询年龄大于等于20 小于等于30</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> age <span class="operator">&gt;=</span> <span class="number">20</span> <span class="operator">&amp;&amp;</span>  age <span class="operator">&lt;=</span><span class="number">30</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> age <span class="operator">&gt;=</span> <span class="number">20</span> <span class="keyword">AND</span>  age <span class="operator">&lt;=</span><span class="number">30</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> age <span class="keyword">BETWEEN</span> <span class="number">20</span> <span class="keyword">AND</span> <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询年龄22岁，18岁，25岁的信息</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> age <span class="operator">=</span> <span class="number">22</span> <span class="keyword">OR</span> age <span class="operator">=</span> <span class="number">18</span> <span class="keyword">OR</span> age <span class="operator">=</span> <span class="number">25</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> age <span class="keyword">IN</span> (<span class="number">22</span>,<span class="number">18</span>,<span class="number">25</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p> is null(不为null值) 与 like（模糊查询）、distinct（去除重复值）</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询英语成绩为null</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> english  <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询英语成绩不为null</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> english  <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- _:单个任意字符</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- %:多个任意字符</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询姓可的有哪些？like</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> NAME <span class="keyword">LIKE</span> <span class="string">&#x27;可%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询姓名第二个字是莉的人</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> NAME <span class="keyword">LIKE</span> &quot;_莉%&quot;;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询姓名是3个字的人</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> NAME <span class="keyword">LIKE</span> <span class="string">&#x27;___&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询姓名中包含可莉的人</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> NAME <span class="keyword">LIKE</span> <span class="string">&#x27;%可莉%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 关键词 DISTINCT 用于返回唯一不同的值（去重）。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 语法：SELECT DISTINCT 列名称 FROM 表名称</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> NAME <span class="keyword">FROM</span>  student ;</span><br></pre></td></tr></table></figure><h4 id="分组查询-group-by"><a href="#分组查询-group-by" class="headerlink" title="分组查询 group by"></a>分组查询 group by</h4><p>根据指定的条件把查询结果进行”分组”以用于做”聚合”运算</p><p>一旦分组 group by ，select语句后只跟分组的字段，聚合函数</p><p>语法：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span><span class="operator">/</span>字段列表 <span class="keyword">from</span> 数据库表名 [<span class="keyword">where</span> 条件表达式] [<span class="keyword">group</span> <span class="keyword">by</span> 分组字段名 [<span class="keyword">having</span> 条件表达式]];</span><br></pre></td></tr></table></figure><p>范例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 按照性别分组。分别查询男、女同学的平均分</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> sex , <span class="built_in">AVG</span>(math) <span class="keyword">FROM</span> student <span class="keyword">GROUP</span> <span class="keyword">BY</span> sex;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 按照性别分组。分别查询男、女同学的平均分,人数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> sex , <span class="built_in">AVG</span>(math),<span class="built_in">COUNT</span>(id) <span class="keyword">FROM</span> student <span class="keyword">GROUP</span> <span class="keyword">BY</span> sex;</span><br><span class="line"></span><br><span class="line"><span class="comment">--  按照性别分组。分别查询男、女同学的平均分,人数 要求：分数低于70分的人，不参与分组</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> sex , <span class="built_in">AVG</span>(math),<span class="built_in">COUNT</span>(id) <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> math <span class="operator">&gt;</span> <span class="number">70</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> sex;</span><br><span class="line"></span><br><span class="line"><span class="comment">--  按照性别分组。分别查询男、女同学的平均分,人数 要求：分数低于70分的人，不参与分组,分组之后。人数要大于2个人</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> sex , <span class="built_in">AVG</span>(math),<span class="built_in">COUNT</span>(id) <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> math <span class="operator">&gt;</span> <span class="number">70</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> sex <span class="keyword">HAVING</span> <span class="built_in">COUNT</span>(id) <span class="operator">&gt;</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> sex , <span class="built_in">AVG</span>(math),<span class="built_in">COUNT</span>(id) 人数 <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> math <span class="operator">&gt;</span> <span class="number">70</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> sex <span class="keyword">HAVING</span> 人数 <span class="operator">&gt;</span> <span class="number">2</span>;</span><br></pre></td></tr></table></figure><h4 id="聚合函数"><a href="#聚合函数" class="headerlink" title="聚合函数"></a>聚合函数</h4><p>将一列数据作为一个整体，进行纵向的计算。（注意:聚合函数不对null统计）</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">-- 总数 count()：</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> count <span class="keyword">as</span> totalcount <span class="keyword">from</span> table1</span><br><span class="line"></span><br><span class="line"> <span class="comment">-- 求和 sum()：</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">sum</span>(field1) <span class="keyword">as</span> sumvalue <span class="keyword">from</span> table1</span><br><span class="line"></span><br><span class="line"> <span class="comment">-- 平均 avg()：      </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">avg</span>(field1) <span class="keyword">as</span> avgvalue <span class="keyword">from</span> table1</span><br><span class="line"></span><br><span class="line"> <span class="comment">-- 最大 max()：       </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">max</span>(field1) <span class="keyword">as</span> maxvalue <span class="keyword">from</span> table1</span><br><span class="line"></span><br><span class="line"> <span class="comment">-- 最小 min()：</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">min</span>(field1) <span class="keyword">as</span> minvalue <span class="keyword">from</span> table1        </span><br></pre></td></tr></table></figure><h4 id="排序查询-order-by"><a href="#排序查询-order-by" class="headerlink" title="排序查询 order by"></a>排序查询 order by</h4><p>根据指定的字段对查询结果进行排序</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 例子</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> person <span class="keyword">ORDER</span> <span class="keyword">BY</span> math; <span class="comment">-- 默认升序(ASC)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> person <span class="keyword">ORDER</span> <span class="keyword">BY</span> math <span class="keyword">desc</span>; <span class="comment">-- 降序(DESC)</span></span><br></pre></td></tr></table></figure><h4 id="分页查询limit"><a href="#分页查询limit" class="headerlink" title="分页查询limit"></a>分页查询limit</h4><p>LIMIT [[offset,]row_count]：对查询的结果进行输出行数数量限制,跳过offset,显示row_count行,offset默为值为0</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> person <span class="keyword">ORDER</span> <span class="keyword">BY</span> math LIMIT <span class="number">5</span>; <span class="comment">-- 仅显示前5条</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> person <span class="keyword">ORDER</span> <span class="keyword">BY</span> math LIMIT <span class="number">3</span>,<span class="number">5</span>; <span class="comment">-- 仅显示跳过前3行，后5条内容</span></span><br></pre></td></tr></table></figure><h3 id="多表查询"><a href="#多表查询" class="headerlink" title="多表查询"></a>多表查询</h3><p>多表查询，即查询结果来自于多张表</p><h4 id="子查询-subquery"><a href="#子查询-subquery" class="headerlink" title="子查询 subquery"></a>子查询 subquery</h4><p>子查询 subquery 即SQL语句调用另一个SELECT子句,可以是对同一张表,也可以是对不同表,主要有以下四种常见的用法.</p><ol><li><p>用于比较表达式中的子查询；子查询仅能返回单个值</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">-- 显示student表年龄大于平均值的姓名和年龄</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> Name,Age <span class="keyword">FROM</span> students <span class="keyword">WHERE</span> Age<span class="operator">&gt;</span>(<span class="keyword">SELECT</span> <span class="built_in">avg</span>(Age) <span class="keyword">FROM</span> students); </span><br><span class="line"></span><br><span class="line"> <span class="comment">-- 修改student表中stuid为25号学生的年龄为teacher表中年龄的平均值</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> students <span class="keyword">set</span> Age<span class="operator">=</span>(<span class="keyword">SELECT</span> <span class="built_in">avg</span>(Age) <span class="keyword">FROM</span> teachers) <span class="keyword">where</span> stuid<span class="operator">=</span><span class="number">25</span>;</span><br></pre></td></tr></table></figure></li></ol><h4 id="联合查询-Union（纵向连接）"><a href="#联合查询-Union（纵向连接）" class="headerlink" title="联合查询 Union（纵向连接）"></a>联合查询 Union（纵向连接）</h4><p>联合查询 Union 实现的条件,多个表的字段数量相同,字段名和数据类型可以不同,但一般数据类型是相同的。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">-- 多个表之间用UNION连接</span></span><br><span class="line"><span class="keyword">SELECT</span> Name,Age <span class="keyword">FROM</span> students <span class="keyword">UNION</span> <span class="keyword">SELECT</span> Name,Age <span class="keyword">FROM</span> teachers;</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">#多表纵向合并<span class="keyword">union</span></span><br><span class="line">MariaDB [hellodb]<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> teachers <span class="keyword">union</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> students; </span><br><span class="line">MariaDB [hellodb]<span class="operator">&gt;</span> <span class="keyword">select</span> tid <span class="keyword">as</span> id,name,age,gender <span class="keyword">from</span> teachers <span class="keyword">union</span> <span class="keyword">select</span> </span><br><span class="line">stuid,name,age,gender <span class="keyword">from</span> students;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+---------------+-----+--------+ </span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name          <span class="operator">|</span> age <span class="operator">|</span> gender <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">----+---------------+-----+--------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> Song Jiang    <span class="operator">|</span>  <span class="number">45</span> <span class="operator">|</span> M      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> Zhang Sanfeng <span class="operator">|</span>  <span class="number">94</span> <span class="operator">|</span> M      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> Miejue Shitai <span class="operator">|</span>  <span class="number">77</span> <span class="operator">|</span> F      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span> Lin Chaoying  <span class="operator">|</span>  <span class="number">26</span> <span class="operator">|</span> F      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> Shi Zhongyu   <span class="operator">|</span>  <span class="number">22</span> <span class="operator">|</span> M      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> Shi Potian    <span class="operator">|</span>  <span class="number">22</span> <span class="operator">|</span> M      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> Xie Yanke     <span class="operator">|</span>  <span class="number">53</span> <span class="operator">|</span> M      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span> Ding Dian     <span class="operator">|</span>  <span class="number">32</span> <span class="operator">|</span> M      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+---------------+-----+--------+ </span></span><br><span class="line"><span class="number">8</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.001</span> sec)</span><br><span class="line">MariaDB [hellodb]<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> teachers <span class="keyword">union</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> teachers; </span><br><span class="line"><span class="operator">+</span><span class="comment">-----+---------------+-----+--------+</span></span><br><span class="line"><span class="operator">|</span> TID <span class="operator">|</span> Name          <span class="operator">|</span> Age <span class="operator">|</span> Gender <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">-----+---------------+-----+--------+ </span></span><br><span class="line"><span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span> Song Jiang    <span class="operator">|</span>  <span class="number">45</span> <span class="operator">|</span> M      <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span> Zhang Sanfeng <span class="operator">|</span>  <span class="number">94</span> <span class="operator">|</span> M      <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span> Miejue Shitai <span class="operator">|</span>  <span class="number">77</span> <span class="operator">|</span> F      <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span> Lin Chaoying  <span class="operator">|</span>  <span class="number">93</span> <span class="operator">|</span> F      <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">-----+---------------+-----+--------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line">MariaDB [hellodb]<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> teachers <span class="keyword">union</span> <span class="keyword">all</span>  <span class="keyword">select</span> <span class="operator">*</span><span class="keyword">from</span> teachers; </span><br><span class="line"><span class="operator">+</span><span class="comment">-----+---------------+-----+--------+</span></span><br><span class="line"><span class="operator">|</span> TID <span class="operator">|</span> Name          <span class="operator">|</span> Age <span class="operator">|</span> Gender <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">-----+---------------+-----+--------+</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span> Song Jiang    <span class="operator">|</span>  <span class="number">45</span> <span class="operator">|</span> M      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span> Zhang Sanfeng <span class="operator">|</span>  <span class="number">94</span> <span class="operator">|</span> M      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span> Miejue Shitai <span class="operator">|</span>  <span class="number">77</span> <span class="operator">|</span> F      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span> Lin Chaoying  <span class="operator">|</span>  <span class="number">93</span> <span class="operator">|</span> F      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span> Song Jiang    <span class="operator">|</span>  <span class="number">45</span> <span class="operator">|</span> M      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span> Zhang Sanfeng <span class="operator">|</span>  <span class="number">94</span> <span class="operator">|</span> M      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span> Miejue Shitai <span class="operator">|</span>  <span class="number">77</span> <span class="operator">|</span> F      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span> Lin Chaoying  <span class="operator">|</span>  <span class="number">93</span> <span class="operator">|</span> F      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+---------------+-----+--------+</span></span><br><span class="line"><span class="number">8</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h4 id="交叉连接cross-join"><a href="#交叉连接cross-join" class="headerlink" title="交叉连接cross join"></a>交叉连接cross join</h4><p>cross join 即多表的记录之间做笛卡尔乘积组合，并且多个表的列横向合并相加, “雨露均沾” </p><p>比如: 第一个表3行4列,第二个表5行6列,cross join后的结果为3*5=15行,4+6=10列交叉连接生成的记录可能会非常多,建议慎用 </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> students <span class="keyword">cross</span> <span class="keyword">join</span> teachers;</span><br></pre></td></tr></table></figure><h4 id="内连接inner-join"><a href="#内连接inner-join" class="headerlink" title="内连接inner join"></a>内连接inner join</h4><p>inner join 内连接取多个表的交集<br>范例：内连接</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [hellodb]<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> students <span class="keyword">inner</span> <span class="keyword">join</span> teachers <span class="keyword">on</span> students.teacherid<span class="operator">=</span>teachers.tid;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span></span><br><span class="line"><span class="operator">|</span> StuID <span class="operator">|</span> Name        <span class="operator">|</span> Age <span class="operator">|</span> Gender <span class="operator">|</span> ClassID <span class="operator">|</span> TeacherID <span class="operator">|</span> TID <span class="operator">|</span> Name          <span class="operator">|</span> Age <span class="operator">|</span> Gender <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">5</span> <span class="operator">|</span> Yu Yutong   <span class="operator">|</span>  <span class="number">26</span> <span class="operator">|</span> M      <span class="operator">|</span>       <span class="number">3</span> <span class="operator">|</span>         <span class="number">1</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span> Song Jiang    <span class="operator">|</span>  <span class="number">45</span> <span class="operator">|</span> M      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span> Shi Zhongyu <span class="operator">|</span>  <span class="number">22</span> <span class="operator">|</span> M      <span class="operator">|</span>       <span class="number">2</span> <span class="operator">|</span>         <span class="number">3</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span> Miejue Shitai <span class="operator">|</span>  <span class="number">77</span> <span class="operator">|</span> F      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">4</span> <span class="operator">|</span> Ding Dian   <span class="operator">|</span>  <span class="number">32</span> <span class="operator">|</span> M      <span class="operator">|</span>       <span class="number">4</span> <span class="operator">|</span>         <span class="number">4</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span> Lin Chaoying  <span class="operator">|</span>  <span class="number">93</span> <span class="operator">|</span> F      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span></span><br><span class="line"></span><br><span class="line">#如果表定义了别名，原表名将无法使用</span><br><span class="line">MariaDB [hellodb]<span class="operator">&gt;</span> <span class="keyword">select</span> stuid,s.name <span class="keyword">as</span> student_name ,tid,t.name <span class="keyword">as</span> teacher_name <span class="keyword">from</span> students <span class="keyword">as</span> s <span class="keyword">inner</span> <span class="keyword">join</span> teachers <span class="keyword">as</span> t <span class="keyword">on</span> s.teacherid<span class="operator">=</span>t.tid; </span><br><span class="line"><span class="operator">+</span><span class="comment">-------+--------------+-----+---------------+</span></span><br><span class="line"><span class="operator">|</span> stuid <span class="operator">|</span> student_name <span class="operator">|</span> tid <span class="operator">|</span> teacher_name  <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">-------+--------------+-----+---------------+ </span></span><br><span class="line"><span class="operator">|</span>     <span class="number">5</span> <span class="operator">|</span> Yu Yutong    <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span> Song Jiang    <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span> Shi Zhongyu  <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span> Miejue Shitai <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span>     <span class="number">4</span> <span class="operator">|</span> Ding Dian    <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span> Lin Chaoying  <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">-------+--------------+-----+---------------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h4 id="左外连接-left-join-和右外连接-right-join"><a href="#左外连接-left-join-和右外连接-right-join" class="headerlink" title="左外连接(left join)和右外连接(right join)"></a>左外连接(left join)和右外连接(right join)</h4><p>左连接: 以左表为主根据条件查询右表数据﹐如果根据条件查询右表数据不存在使用null值填充 </p><p>右连接: 以右表为主根据条件查询左表数据﹐如果根据条件查询左表数据不存在使用null值填充 </p><p>范例：左，右外连接</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">#左外连接</span><br><span class="line">MariaDB [hellodb]<span class="operator">&gt;</span> <span class="keyword">select</span> s.stuid,s.name,s.age,s.teacherid,t.tid,t.name,t.age <span class="keyword">from</span> students <span class="keyword">as</span> s <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> teachers <span class="keyword">as</span> t <span class="keyword">on</span> s.teacherid<span class="operator">=</span>t.tid;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+---------------+-----+-----------+------+---------------+------+ </span></span><br><span class="line"><span class="operator">|</span> stuid <span class="operator">|</span> name          <span class="operator">|</span> age <span class="operator">|</span> teacherid <span class="operator">|</span> tid  <span class="operator">|</span> name          <span class="operator">|</span> age  <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">-------+---------------+-----+-----------+------+---------------+------+</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span> Shi Zhongyu   <span class="operator">|</span>  <span class="number">22</span> <span class="operator">|</span>         <span class="number">3</span> <span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span> Miejue Shitai <span class="operator">|</span>   <span class="number">77</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">2</span> <span class="operator">|</span> Shi Potian    <span class="operator">|</span>  <span class="number">22</span> <span class="operator">|</span>         <span class="number">7</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">3</span> <span class="operator">|</span> Xie Yanke     <span class="operator">|</span>  <span class="number">53</span> <span class="operator">|</span>        <span class="number">16</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">4</span> <span class="operator">|</span> Ding Dian     <span class="operator">|</span>  <span class="number">32</span> <span class="operator">|</span>         <span class="number">4</span> <span class="operator">|</span>    <span class="number">4</span> <span class="operator">|</span> Lin Chaoying  <span class="operator">|</span>   <span class="number">93</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">5</span> <span class="operator">|</span> Yu Yutong     <span class="operator">|</span>  <span class="number">26</span> <span class="operator">|</span>         <span class="number">1</span> <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> Song Jiang    <span class="operator">|</span>   <span class="number">45</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">6</span> <span class="operator">|</span> Shi Qing      <span class="operator">|</span>  <span class="number">46</span> <span class="operator">|</span>      <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">7</span> <span class="operator">|</span> Xi Ren        <span class="operator">|</span>  <span class="number">19</span> <span class="operator">|</span>      <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">8</span> <span class="operator">|</span> Lin Daiyu     <span class="operator">|</span>  <span class="number">17</span> <span class="operator">|</span>      <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">9</span> <span class="operator">|</span> Ren Yingying  <span class="operator">|</span>  <span class="number">20</span> <span class="operator">|</span>      <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">10</span> <span class="operator">|</span> Yue Lingshan  <span class="operator">|</span>  <span class="number">19</span> <span class="operator">|</span>      <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">11</span> <span class="operator">|</span> Yuan Chengzhi <span class="operator">|</span>  <span class="number">23</span> <span class="operator">|</span>      <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">12</span> <span class="operator">|</span> Wen Qingqing  <span class="operator">|</span>  <span class="number">19</span> <span class="operator">|</span>      <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">13</span> <span class="operator">|</span> Tian Boguang  <span class="operator">|</span>  <span class="number">33</span> <span class="operator">|</span>      <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">14</span> <span class="operator">|</span> Lu Wushuang   <span class="operator">|</span>  <span class="number">17</span> <span class="operator">|</span>      <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">15</span> <span class="operator">|</span> Duan Yu       <span class="operator">|</span>  <span class="number">19</span> <span class="operator">|</span>      <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">16</span> <span class="operator">|</span> Xu Zhu        <span class="operator">|</span>  <span class="number">21</span> <span class="operator">|</span>      <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">17</span> <span class="operator">|</span> Lin Chong     <span class="operator">|</span>  <span class="number">25</span> <span class="operator">|</span>      <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">18</span> <span class="operator">|</span> Hua Rong      <span class="operator">|</span>  <span class="number">23</span> <span class="operator">|</span>      <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">19</span> <span class="operator">|</span> Xue Baochai   <span class="operator">|</span>  <span class="number">18</span> <span class="operator">|</span>      <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">20</span> <span class="operator">|</span> Diao Chan     <span class="operator">|</span>  <span class="number">19</span> <span class="operator">|</span>      <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">21</span> <span class="operator">|</span> Huang Yueying <span class="operator">|</span>  <span class="number">22</span> <span class="operator">|</span>      <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">22</span> <span class="operator">|</span> Xiao Qiao     <span class="operator">|</span>  <span class="number">20</span> <span class="operator">|</span>      <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">23</span> <span class="operator">|</span> Ma Chao       <span class="operator">|</span>  <span class="number">23</span> <span class="operator">|</span>      <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">24</span> <span class="operator">|</span> Xu Xian       <span class="operator">|</span>  <span class="number">27</span> <span class="operator">|</span>      <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">25</span> <span class="operator">|</span> Sun Dasheng   <span class="operator">|</span> <span class="number">100</span> <span class="operator">|</span>      <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+---------------+-----+-----------+------+---------------+------+ </span></span><br><span class="line"><span class="number">25</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">#右外连接</span><br><span class="line">MariaDB [hellodb]<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> students s <span class="keyword">right</span> <span class="keyword">outer</span> <span class="keyword">join</span> teachers t  <span class="keyword">on</span> s.teacherid<span class="operator">=</span>t.tid  ;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------------+------+--------+---------+-----------+-----+---------------+-----+--------+</span></span><br><span class="line"><span class="operator">|</span> StuID <span class="operator">|</span> Name        <span class="operator">|</span> Age  <span class="operator">|</span> Gender <span class="operator">|</span> ClassID <span class="operator">|</span> TeacherID <span class="operator">|</span> TID <span class="operator">|</span> Name          <span class="operator">|</span> Age <span class="operator">|</span> Gender <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------------+------+--------+---------+-----------+-----+---------------+-----+--------+</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span> Shi Zhongyu <span class="operator">|</span>   <span class="number">22</span> <span class="operator">|</span> M      <span class="operator">|</span>       <span class="number">2</span> <span class="operator">|</span>         <span class="number">3</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span> Miejue Shitai <span class="operator">|</span>  <span class="number">77</span> <span class="operator">|</span> F      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">4</span> <span class="operator">|</span> Ding Dian   <span class="operator">|</span>   <span class="number">32</span> <span class="operator">|</span> M      <span class="operator">|</span>       <span class="number">4</span> <span class="operator">|</span>         <span class="number">4</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span> Lin Chaoying  <span class="operator">|</span>  <span class="number">26</span> <span class="operator">|</span> F      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">5</span> <span class="operator">|</span> Yu Yutong   <span class="operator">|</span>   <span class="number">26</span> <span class="operator">|</span> M      <span class="operator">|</span>       <span class="number">3</span> <span class="operator">|</span>         <span class="number">1</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span> Song Jiang    <span class="operator">|</span>  <span class="number">45</span> <span class="operator">|</span> M      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">25</span> <span class="operator">|</span> Sun Dasheng <span class="operator">|</span>  <span class="number">100</span> <span class="operator">|</span> M      <span class="operator">|</span>    <span class="keyword">NULL</span> <span class="operator">|</span>         <span class="number">1</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span> Song Jiang    <span class="operator">|</span>  <span class="number">45</span> <span class="operator">|</span> M      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>        <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>   <span class="operator">|</span>    <span class="keyword">NULL</span> <span class="operator">|</span>      <span class="keyword">NULL</span> <span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span> Zhang Sanfeng <span class="operator">|</span>  <span class="number">94</span> <span class="operator">|</span> M      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------------+------+--------+---------+-----------+-----+---------------+-----+--------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.001</span> sec) </span><br></pre></td></tr></table></figure><h4 id="自连接"><a href="#自连接" class="headerlink" title="自连接"></a>自连接</h4><p>自连接, 即表自身连接自身</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">#自连接</span><br><span class="line">MariaDB [hellodb]<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp; </span><br><span class="line"><span class="operator">+</span><span class="comment">------+----------+----------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span> name     <span class="operator">|</span> leaderid <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">------+----------+----------+ </span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> mage     <span class="operator">|</span>     <span class="keyword">NULL</span> <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> zhangsir <span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span> wang     <span class="operator">|</span>        <span class="number">2</span> <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span>    <span class="number">4</span> <span class="operator">|</span> zhang    <span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">------+----------+----------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]<span class="operator">&gt;</span> <span class="keyword">select</span> e.name,l.name <span class="keyword">from</span> emp <span class="keyword">as</span> e <span class="keyword">inner</span> <span class="keyword">join</span> emp <span class="keyword">as</span> l <span class="keyword">on</span> e.leaderid<span class="operator">=</span>l.id;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------+ </span></span><br><span class="line"><span class="operator">|</span> name     <span class="operator">|</span> name     <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------+ </span></span><br><span class="line"><span class="operator">|</span> zhangsir <span class="operator">|</span> mage     <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span> wang     <span class="operator">|</span> zhangsir <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span> zhang    <span class="operator">|</span> wang     <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]<span class="operator">&gt;</span> <span class="keyword">select</span> e.name,IFNULL(l.name,<span class="string">&#x27;无上级&#x27;</span>) <span class="keyword">from</span> emp <span class="keyword">as</span> e <span class="keyword">left</span> <span class="keyword">join</span> emp <span class="keyword">as</span> l <span class="keyword">on</span> e.leaderid<span class="operator">=</span>l.id;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------+ </span></span><br><span class="line"><span class="operator">|</span> name     <span class="operator">|</span> name     <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------+ </span></span><br><span class="line"><span class="operator">|</span> zhangsir <span class="operator">|</span> mage     <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span> wang     <span class="operator">|</span> zhangsir <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span> zhang    <span class="operator">|</span> wang     <span class="operator">|</span> </span><br><span class="line"><span class="operator">|</span> mage     <span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> </span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="SELECT-语句处理的顺序"><a href="#SELECT-语句处理的顺序" class="headerlink" title="SELECT 语句处理的顺序"></a>SELECT 语句处理的顺序</h4><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2qiiax0v6j20qn0bqmxt.jpg" alt=""></p><p>SELECT语句的执行流程：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> Clause <span class="comment">--&gt; WHERE Clause --&gt; GROUP BY --&gt; HAVING Clause --&gt;SELECT --&gt; ORDER BY --&gt;  LIMIT</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CentOS运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CENTOS </tag>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SQL语言</title>
      <link href="/2022/05/30/2022/05/SQL%E8%AF%AD%E8%A8%80/"/>
      <url>/2022/05/30/2022/05/SQL%E8%AF%AD%E8%A8%80/</url>
      
        <content type="html"><![CDATA[<h2 id="关系型数据库的常见组件"><a href="#关系型数据库的常见组件" class="headerlink" title="关系型数据库的常见组件"></a>关系型数据库的常见组件</h2><ul><li>数据库：database</li><li>表：table，行：row   列：column </li><li>索引：index</li><li>视图：view</li><li>存储过程：procedure </li><li>存储函数：function </li><li>触发器：trigger</li><li>事件调度器：event scheduler，任务计划 </li><li>用户：user</li><li>权限：privilege</li></ul><h2 id="SQL-语言规范"><a href="#SQL-语言规范" class="headerlink" title="SQL 语言规范"></a>SQL 语言规范</h2><p>在数据库系统中，SQL 语句不区分大小写，建议用大写 </p><p>SQL语句可单行或多行书写，默认以 “ ; “  结尾</p><p>关键词不能跨多行或简写</p><p>用空格和TAB 缩进来提高语句的可读性 </p><p>子句通常位于独立行，便于编辑，提高可读性</p><p><strong>注释：</strong></p><ul><li>SQL标准：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#单行注释，注意有空格 </span></span><br><span class="line">-- 注释内容  </span><br><span class="line"></span><br><span class="line"><span class="comment">#多行注释</span></span><br><span class="line">/*注释内容 </span><br><span class="line">注释内容 </span><br><span class="line">注释内容*/  </span><br></pre></td></tr></table></figure><ul><li><p>MySQL注释：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注释内容</span></span><br></pre></td></tr></table></figure></li></ul><h2 id="数据库对象和命名"><a href="#数据库对象和命名" class="headerlink" title="数据库对象和命名"></a>数据库对象和命名</h2><p><strong>数据库的组件(对象)：</strong></p><p>数据库、表、索引、视图、用户、存储过程、函数、触发器、事件调度器等 </p><p><strong>命名规则：</strong></p><ul><li><p>必须以字母开头，后续可以包括字母,数字和三个特殊字符（# _ $） </p></li><li><p>不要使用MySQL的保留字</p></li></ul><h2 id="SQL语句构成"><a href="#SQL语句构成" class="headerlink" title="SQL语句构成"></a>SQL语句构成</h2><p>关健字Keyword组成子句clause，多条clause组成语句</p><p>示例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span>                    #<span class="keyword">SELECT</span>子句 </span><br><span class="line"><span class="keyword">FROM</span> products               #<span class="keyword">FROM</span>子句 </span><br><span class="line"><span class="keyword">WHERE</span> price<span class="operator">&gt;</span><span class="number">666</span>             #<span class="keyword">WHERE</span>子句</span><br></pre></td></tr></table></figure><p>说明：一组SQL语句由三个子句构成，SELECT，FROM和WHERE是关键字</p><h2 id="字符集和排序"><a href="#字符集和排序" class="headerlink" title="字符集和排序"></a>字符集和排序</h2><p>早期MySQL版本默认为latin1，从MySQL8.0开始默认字符集已经为 utf8mb4</p><p><strong>设置服务器默认的字符集</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/my.cnf </span><br><span class="line">[mysqld]</span><br><span class="line">character-set-server=utf8mb4</span><br></pre></td></tr></table></figure><p><strong>设置mysql客户端默认的字符集</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/my.cnf </span><br><span class="line"><span class="comment">#针对mysql客户端 </span></span><br><span class="line">[mysql]</span><br><span class="line">default-character-set=utf8mb4 </span><br><span class="line"></span><br><span class="line"><span class="comment">#针对所有MySQL客户端</span></span><br><span class="line">[client]</span><br><span class="line">default-character-set=utf8mb4</span><br></pre></td></tr></table></figure><h2 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h2><h3 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">MariaDB root<span class="variable">@127</span><span class="number">.0</span><span class="number">.0</span><span class="number">.1</span>:(<span class="keyword">none</span>)<span class="operator">&gt;</span> <span class="keyword">create</span> database db1;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected</span><br><span class="line"><span class="type">Time</span>: <span class="number">0.001</span>s</span><br><span class="line"></span><br><span class="line">MariaDB root<span class="variable">@127</span><span class="number">.0</span><span class="number">.0</span><span class="number">.1</span>:(<span class="keyword">none</span>)<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> database db1;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Database <span class="operator">|</span> <span class="keyword">Create</span> Database                                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> db1      <span class="operator">|</span> <span class="keyword">CREATE</span> DATABASE `db1` <span class="comment">/*!40100 DEFAULT CHARACTER SET utf8mb4 */</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span></span><br><span class="line"><span class="type">Time</span>: <span class="number">0.006</span>s</span><br></pre></td></tr></table></figure><p><strong>指定字符集创建新数据库</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#方法一</span><br><span class="line">MariaDB root<span class="variable">@127</span><span class="number">.0</span><span class="number">.0</span><span class="number">.1</span>:(<span class="keyword">none</span>)<span class="operator">&gt;</span> <span class="keyword">create</span> database IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> db2 <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="string">&#x27;utf8&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected</span><br><span class="line"><span class="type">Time</span>: <span class="number">0.002</span>s</span><br><span class="line"></span><br><span class="line">MariaDB root<span class="variable">@127</span><span class="number">.0</span><span class="number">.0</span><span class="number">.1</span>:(<span class="keyword">none</span>)<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> database db2;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+--------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Database <span class="operator">|</span> <span class="keyword">Create</span> Database                                              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+--------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> db2      <span class="operator">|</span> <span class="keyword">CREATE</span> DATABASE `db2` <span class="comment">/*!40100 DEFAULT CHARACTER SET utf8 */</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+--------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span></span><br><span class="line"><span class="type">Time</span>: <span class="number">0.007</span>s</span><br><span class="line"></span><br><span class="line">#方法二</span><br><span class="line">MariaDB root<span class="variable">@127</span><span class="number">.0</span><span class="number">.0</span><span class="number">.1</span>:(<span class="keyword">none</span>)<span class="operator">&gt;</span> <span class="keyword">create</span> database db3 charset<span class="operator">=</span>utf8;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected</span><br><span class="line"><span class="type">Time</span>: <span class="number">0.001</span>s</span><br><span class="line"></span><br><span class="line">MariaDB root<span class="variable">@127</span><span class="number">.0</span><span class="number">.0</span><span class="number">.1</span>:(<span class="keyword">none</span>)<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> database db3;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+--------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Database <span class="operator">|</span> <span class="keyword">Create</span> Database                                              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+--------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> db3      <span class="operator">|</span> <span class="keyword">CREATE</span> DATABASE `db3` <span class="comment">/*!40100 DEFAULT CHARACTER SET utf8 */</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+--------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span></span><br><span class="line"><span class="type">Time</span>: <span class="number">0.006</span>s</span><br></pre></td></tr></table></figure><h3 id="修改数据库"><a href="#修改数据库" class="headerlink" title="修改数据库"></a>修改数据库</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#实际生产中可能会破坏数据库数据，不建议使用</span><br><span class="line">MariaDB root<span class="variable">@127</span><span class="number">.0</span><span class="number">.0</span><span class="number">.1</span>:(<span class="keyword">none</span>)<span class="operator">&gt;</span> <span class="keyword">alter</span> database db1 <span class="type">character</span> <span class="keyword">set</span> <span class="string">&#x27;utf8&#x27;</span>;</span><br><span class="line">You<span class="string">&#x27;re about to run a destructive command.</span></span><br><span class="line"><span class="string">Do you want to proceed? (y/n): y</span></span><br><span class="line"><span class="string">Your call!</span></span><br><span class="line"><span class="string">Query OK, 1 row affected</span></span><br><span class="line"><span class="string">Time: 0.001s</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MariaDB root@127.0.0.1:(none)&gt; show create database db1;</span></span><br><span class="line"><span class="string">+----------+--------------------------------------------------------------+</span></span><br><span class="line"><span class="string">| Database | Create Database                                              |</span></span><br><span class="line"><span class="string">+----------+--------------------------------------------------------------+</span></span><br><span class="line"><span class="string">| db1      | CREATE DATABASE `db1` /*!40100 DEFAULT CHARACTER SET utf8 */ |</span></span><br><span class="line"><span class="string">+----------+--------------------------------------------------------------+</span></span><br><span class="line"><span class="string">1 row in set</span></span><br><span class="line"><span class="string">Time: 0.006s</span></span><br></pre></td></tr></table></figure><h3 id="删除数据库"><a href="#删除数据库" class="headerlink" title="删除数据库"></a>删除数据库</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">MariaDB root<span class="variable">@127</span><span class="number">.0</span><span class="number">.0</span><span class="number">.1</span>:(<span class="keyword">none</span>)<span class="operator">&gt;</span> <span class="keyword">drop</span> database db1;</span><br><span class="line">You<span class="string">&#x27;re about to run a destructive command.</span></span><br><span class="line"><span class="string">Do you want to proceed? (y/n): y</span></span><br><span class="line"><span class="string">Your call!</span></span><br><span class="line"><span class="string">Query OK, 0 rows affected</span></span><br><span class="line"><span class="string">Time: 0.001s</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MariaDB root@127.0.0.1:(none)&gt; show databases;</span></span><br><span class="line"><span class="string">+--------------------+</span></span><br><span class="line"><span class="string">| Database           |</span></span><br><span class="line"><span class="string">+--------------------+</span></span><br><span class="line"><span class="string">| db2                |</span></span><br><span class="line"><span class="string">| db3                |</span></span><br><span class="line"><span class="string">| information_schema |</span></span><br><span class="line"><span class="string">| mysql              |</span></span><br><span class="line"><span class="string">| performance_schema |</span></span><br><span class="line"><span class="string">| test               |</span></span><br><span class="line"><span class="string">+--------------------+</span></span><br><span class="line"><span class="string">6 rows in set</span></span><br><span class="line"><span class="string">Time: 0.007s</span></span><br></pre></td></tr></table></figure><h3 id="查看数据库列表"><a href="#查看数据库列表" class="headerlink" title="查看数据库列表"></a>查看数据库列表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">MariaDB root<span class="variable">@127</span><span class="number">.0</span><span class="number">.0</span><span class="number">.1</span>:(<span class="keyword">none</span>)<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> db2                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> db3                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> test               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span></span><br><span class="line"><span class="type">Time</span>: <span class="number">0.007</span>s</span><br></pre></td></tr></table></figure><h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2p4e7v2rtj20j60ejgmn.jpg" alt=""></p><h3 id="整数型"><a href="#整数型" class="headerlink" title="整数型"></a>整数型</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tinyint(m)      1个字节  范围(-128~127)</span><br><span class="line">smallint(m)     2个字节  范围(-32768~32767) </span><br><span class="line">mediumint(m)    3个字节  范围(-8388608~8388607) </span><br><span class="line">int(m)          4个字节  范围(-2147483648~2147483647) </span><br><span class="line">bigint(m)       8个字节  范围(+-9.22*10的18次方)</span><br></pre></td></tr></table></figure><p>上述数据类型，如果加修饰符unsigned后，则最大值翻倍 </p><p>如：tinyint unsigned的取值范围为(0~255)</p><p>int(m)里的m是表示SELECT查询结果集中的显示宽度，并不影响实际的取值范围，规定了MySQL的一些交互工具（例如MySQL命令行客户端）用来显示字符的个数。对于存储和计算来说，Int(1)和Int(20)是相同的</p><p>BOOL，BOOLEAN：布尔型，是TINYINT(1)的同义词。zero值被视为假，非zero值视为真</p><h3 id="浮点型-float和double-，近似值"><a href="#浮点型-float和double-，近似值" class="headerlink" title="浮点型(float和double)，近似值"></a>浮点型(float和double)，近似值</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">float(m,d) 单精度浮点型 8位精度(4字节) m总个数，d小数位, 注意: 小数点不占用总个数</span><br><span class="line">double(m,d) 双精度浮点型16位精度(8字节) m总个数，d小数位, 注意: 小数点不占用总个数</span><br></pre></td></tr></table></figure><p>设一个字段定义为float(6,3)，如果插入一个数123.45678,实际数据库里存的是123.457，但总个数还以实际为准，即6位</p><h3 id="定点数"><a href="#定点数" class="headerlink" title="定点数"></a>定点数</h3><p>在数据库中存放的是精确值,存为十进制</p><p>格式 decimal(m,d)   表示  最多 m 位数字,其中 d 个小数,小数点不算在长度内</p><p>比如: DECIMAL(6,2) 总共能存6位数字，末尾2位是小数，字段最大值 9999.99 （小数点不算在长度内） </p><p>参数m&lt;65 是总个数，d&lt;30且 d&lt;m 是小数位</p><p>MySQL5.0和更高版本将数字打包保存到一个二进制字符串中（每4个字节存9个数字）。</p><p>例如: decimal(18,9)小数点两边将各存储9个数字，一共使用9个字节：其中，小数点前的9个数字用4个字节，小数点后的9个数字用4个字节，小数点本身占1个字节</p><p>浮点类型在存储同样范围的值时，通常比decimal使用更少的空间。float使用4个字节存储。double占用8个字节</p><p>因为需要额外的空间和计算开销，所以应该尽量只在对小数进行精确计算时才使用decimal，例如存储财务数据。但在数据量比较大的时候，可以考虑使用bigint代替decimal</p><h3 id="字符串-char-varchar-text"><a href="#字符串-char-varchar-text" class="headerlink" title="字符串(char,varchar,text)"></a>字符串(char,varchar,text)</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">char(n)       固定长度，最多255个字符,注意不是字节 </span><br><span class="line">varchar(n)    可变长度，最多65535个字符</span><br><span class="line">tinytext      可变长度，最多255个字符</span><br><span class="line">text          可变长度，最多65535个字符 </span><br><span class="line">mediumtext    可变长度，最多2的24次方-1个字符 </span><br><span class="line">longtext      可变长度，最多2的32次方-1个字符</span><br><span class="line">BINARY(M)     固定长度，可存二进制或字符，长度为0-M字节 </span><br><span class="line">VARBINARY(M)  可变长度，可存二进制或字符，允许长度为0-M字节</span><br><span class="line"></span><br><span class="line">内建类型：</span><br><span class="line">ENUM   枚举 </span><br><span class="line">SET    集合</span><br></pre></td></tr></table></figure><p><strong>char和varchar的比较：</strong></p><p>1.char(n) 若存入字符数小于n，则以空格补于其后，查询之时再将空格去掉，所以char类型存储的字符串末尾不能有空格，varchar不限于此</p><p>2.char(n) 固定长度，char(4)不管是存入几个字符，都将占用4个字节，varchar是存入的实际字符数+1个字节（n&lt; n&gt;255)，所以varchar(4),存入3个字符将占用4个字节</p><p>3.char类型的字符串检索速度要比varchar类型的快</p><p><strong>varchar 和 text：</strong></p><p>1.varchar可指定n，text不能指定，内部存储varchar是存入的实际字符数+1个字节（n&lt; n&gt;255)，text是实际字符数+2个字节。</p><p>2.text类型不能有默认值</p><p>3.varchar可直接创建索引，text创建索引要指定前多少个字符。varchar查询速度快于text</p><h3 id="二进制数据BLOB"><a href="#二进制数据BLOB" class="headerlink" title="二进制数据BLOB"></a>二进制数据BLOB</h3><p>BLOB和text存储方式不同，TEXT以文本方式存储，英文存储区分大小写，而Blob以二进制方式存储，不分大小写</p><p>BLOB存储的数据只能整体读出</p><p>TEXT可以指定字符集，BLOB不用指定字符集</p><h3 id="日期时间类型"><a href="#日期时间类型" class="headerlink" title="日期时间类型"></a>日期时间类型</h3><p>date   日期 ‘2008-12-2’ </p><p>time   时间 ‘12:25:36’</p><p>datetime   日期时间 ‘2008-12-2 22:06:44’ </p><p>timestamp 自动存储记录修改时间 </p><p>YEAR(2), YEAR(4)：年份</p><p>timestamp    此字段里的时间数据会随其他字段修改的时候自动刷新，这个数据类型的字段可以存放这条记录最后被修改的时间</p><h3 id="修饰符"><a href="#修饰符" class="headerlink" title="修饰符"></a>修饰符</h3><p><strong>适用所有类型的修饰符：</strong></p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NULL                 数据列可包含NULL值，默认值</span><br><span class="line">NOT NULL             数据列不允许包含NULL值，相当于网站注册表中的 * 为必填选项 </span><br><span class="line">DEFAULT              默认值</span><br><span class="line">PRIMARY KEY          主键，所有记录中此字段的值不能重复，且不能为NULL </span><br><span class="line">UNIQUE KEY           唯一键，所有记录中此字段的值不能重复，但可以为NULL</span><br><span class="line">CHARACTER SET name   指定一个字符集 </span><br></pre></td></tr></table></figure><p><strong>适用数值型的修饰符：</strong></p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AUTO_INCREMENT 自动递增，适用于整数类型, 必须作用于某个 key 的字段,比如primary key</span><br><span class="line">UNSIGNED       无符号</span><br></pre></td></tr></table></figure><h2 id="表"><a href="#表" class="headerlink" title="表"></a>表</h2><h3 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h3><p>创建表：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br></pre></td></tr></table></figure><p>创建表的方法 </p><p>(1) 直接创建</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] <span class="string">&#x27;tbl_name&#x27;</span> (col1 type1 修饰符, col2 type2 修饰符, ...) </span><br><span class="line"></span><br><span class="line">#字段信息</span><br><span class="line">col type1</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY(col1,...) </span><br><span class="line">INDEX(col1, ...) </span><br><span class="line"><span class="keyword">UNIQUE</span> KEY(col1, ...) </span><br><span class="line"></span><br><span class="line">#表选项：</span><br><span class="line">ENGINE [<span class="operator">=</span>] engine_name</span><br><span class="line">ROW_FORMAT [<span class="operator">=</span>] &#123;<span class="keyword">DEFAULT</span><span class="operator">|</span><span class="keyword">DYNAMIC</span><span class="operator">|</span>FIXED<span class="operator">|</span>COMPRESSED<span class="operator">|</span>REDUNDANT<span class="operator">|</span>COMPACT&#125;</span><br></pre></td></tr></table></figure><p>范例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">MariaDB root<span class="variable">@127</span><span class="number">.0</span><span class="number">.0</span><span class="number">.1</span>:db1<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> stud(</span><br><span class="line">                         <span class="operator">-</span><span class="operator">&gt;</span> id <span class="type">smallint</span> unsigned <span class="keyword">primary</span> key auto_increment,</span><br><span class="line">                         <span class="operator">-</span><span class="operator">&gt;</span> name <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">                         <span class="operator">-</span><span class="operator">&gt;</span> age tinyint unsigned,</span><br><span class="line">                         <span class="operator">-</span><span class="operator">&gt;</span> gender enum(<span class="string">&#x27;M&#x27;</span>,<span class="string">&#x27;F&#x27;</span>) <span class="keyword">default</span> <span class="string">&#x27;M&#x27;</span></span><br><span class="line">                         <span class="operator">-</span><span class="operator">&gt;</span> );</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected</span><br><span class="line"><span class="type">Time</span>: <span class="number">0.012</span>s</span><br><span class="line"></span><br><span class="line">MariaDB root<span class="variable">@127</span><span class="number">.0</span><span class="number">.0</span><span class="number">.1</span>:db1<span class="operator">&gt;</span> <span class="keyword">desc</span> stud;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+----------------------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="operator">|</span> Field  <span class="operator">|</span> Type                 <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Extra          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+----------------------+------+-----+---------+----------------+</span></span><br><span class="line"><span class="operator">|</span> id     <span class="operator">|</span> <span class="type">smallint</span>(<span class="number">5</span>) unsigned <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span> <span class="operator">&lt;</span><span class="keyword">null</span><span class="operator">&gt;</span>  <span class="operator">|</span> auto_increment <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> name   <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">20</span>)          <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="operator">&lt;</span><span class="keyword">null</span><span class="operator">&gt;</span>  <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> age    <span class="operator">|</span> tinyint(<span class="number">3</span>) unsigned  <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="operator">&lt;</span><span class="keyword">null</span><span class="operator">&gt;</span>  <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gender <span class="operator">|</span> enum(<span class="string">&#x27;M&#x27;</span>,<span class="string">&#x27;F&#x27;</span>)        <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> M       <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+----------------------+------+-----+---------+----------------+</span></span><br><span class="line"></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span></span><br><span class="line"><span class="type">Time</span>: <span class="number">0.012</span>s</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="查看表"><a href="#查看表" class="headerlink" title="查看表"></a>查看表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> TABLES [<span class="keyword">FROM</span> db_name]</span><br></pre></td></tr></table></figure><p>查看表创建命令:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tbl_name</span><br></pre></td></tr></table></figure><p>查看表结构：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DESC</span> [db_name.]tb_name</span><br><span class="line"><span class="keyword">SHOW</span> COLUMNS <span class="keyword">FROM</span> [db_name.]tb_name</span><br></pre></td></tr></table></figure><p>查看表状态：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">TABLE</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;tbl_name&#x27;</span></span><br></pre></td></tr></table></figure><p>查看支持的engine类型:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> ENGINES;</span><br></pre></td></tr></table></figure><p>查看库中所有表状态</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">TABLE</span> STATUS <span class="keyword">FROM</span> db_name</span><br></pre></td></tr></table></figure><h3 id="修改和删除表"><a href="#修改和删除表" class="headerlink" title="修改和删除表"></a>修改和删除表</h3><p>修改表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">&#x27;tbl_name&#x27;</span> </span><br><span class="line">#字段：</span><br><span class="line">#添加字段：<span class="keyword">add</span></span><br><span class="line"><span class="keyword">ADD</span> col1 data_type [<span class="keyword">FIRST</span><span class="operator">|</span>AFTER col_name] </span><br><span class="line">#删除字段：<span class="keyword">drop</span></span><br><span class="line">#修改字段：</span><br><span class="line"><span class="keyword">alter</span>（默认值）, change（字段名）, modify（字段属性）</span><br></pre></td></tr></table></figure><p>删除表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> [IF <span class="keyword">EXISTS</span>] <span class="string">&#x27;tbl_name&#x27;</span>;</span><br></pre></td></tr></table></figure><p>修改表范例</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">#修改表名</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> students RENAME s1; </span><br><span class="line"></span><br><span class="line">#添加字段</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> s1 <span class="keyword">ADD</span> phone <span class="type">varchar</span>(<span class="number">11</span>) AFTER name; </span><br><span class="line"></span><br><span class="line">#修改字段类型</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> s1 MODIFY phone <span class="type">int</span>; </span><br><span class="line"></span><br><span class="line">#修改字段名称和类型</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> s1 CHANGE <span class="keyword">COLUMN</span> phone mobile <span class="type">char</span>(<span class="number">11</span>); </span><br><span class="line"></span><br><span class="line">#删除字段</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> s1 <span class="keyword">DROP</span> <span class="keyword">COLUMN</span> mobile; </span><br><span class="line"></span><br><span class="line">#修改字符集</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> s1 <span class="type">character</span> <span class="keyword">set</span> utf8; </span><br><span class="line"></span><br><span class="line">#修改数据类型和字符集</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span>  s1 change name name <span class="type">varchar</span>(<span class="number">20</span>) <span class="type">character</span> <span class="keyword">set</span> utf8; </span><br><span class="line"></span><br><span class="line">#添加字段</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> students <span class="keyword">ADD</span> gender ENUM(<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;f&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> student modify  is_del bool <span class="keyword">default</span> <span class="literal">false</span>; </span><br><span class="line"></span><br><span class="line">#修改字段名和类型</span><br><span class="line">ALETR <span class="keyword">TABLE</span> students CHANGE id sid <span class="type">int</span> UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">PRIMARY</span> KEY; </span><br><span class="line"></span><br><span class="line">#删除字段</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> students <span class="keyword">DROP</span> age; </span><br><span class="line"></span><br><span class="line">#查看表结构</span><br><span class="line"><span class="keyword">DESC</span> students;</span><br><span class="line"></span><br><span class="line">#新建表无主键，添加和删除主键</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t1 <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> students;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> t1 <span class="keyword">add</span> <span class="keyword">primary</span> key (stuid); </span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> t1 <span class="keyword">drop</span> <span class="keyword">primary</span> key ;</span><br><span class="line"></span><br><span class="line">#添加外键</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> students <span class="keyword">add</span> <span class="keyword">foreign</span> key(TeacherID) <span class="keyword">references</span> teachers(tid); </span><br><span class="line"></span><br><span class="line">#删除外键</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> students #查看外键名</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> students <span class="keyword">drop</span> <span class="keyword">foreign</span> key <span class="operator">&lt;</span>外键名<span class="operator">&gt;</span>;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CentOS运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CENTOS </tag>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多实例安装MySQL及常用客户端命令</title>
      <link href="/2022/05/27/2022/05/%E5%A4%9A%E5%AE%9E%E4%BE%8B%E5%AE%89%E8%A3%85MySQL%E5%8F%8A%E5%B8%B8%E7%94%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%91%BD%E4%BB%A4/"/>
      <url>/2022/05/27/2022/05/%E5%A4%9A%E5%AE%9E%E4%BE%8B%E5%AE%89%E8%A3%85MySQL%E5%8F%8A%E5%B8%B8%E7%94%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%91%BD%E4%BB%A4/</url>
      
        <content type="html"><![CDATA[<h2 id="实验目的"><a href="#实验目的" class="headerlink" title="实验目的"></a>实验目的</h2><font color=red>CentOS 8 yum安装mariadb-10.3.17并实现三个实例</font><h2 id="环境要求"><a href="#环境要求" class="headerlink" title="环境要求"></a>环境要求</h2><font color=red>一台系统CentOS 8.X主机</font><h2 id="前提准备"><a href="#前提准备" class="headerlink" title="前提准备"></a>前提准备</h2><ul><li><font color=red>关闭SElinux </font></li><li><font color=red>关闭防火墙  </font></li><li><font color=red>时间同步</font></li></ul><h2 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h2><h3 id="安装mariadb"><a href="#安装mariadb" class="headerlink" title="安装mariadb"></a>安装mariadb</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># yum -y install mariadb-server</span></span><br></pre></td></tr></table></figure><h3 id="准备三个实例的目录"><a href="#准备三个实例的目录" class="headerlink" title="准备三个实例的目录"></a>准备三个实例的目录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># mkdir  -pv /mysql/&#123;3306,3307,3308&#125;/&#123;data,etc,socket,log,bin,pid&#125; </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># chown  -R mysql.mysql /mysql</span></span><br></pre></td></tr></table></figure><h3 id="生成数据库文件"><a href="#生成数据库文件" class="headerlink" title="生成数据库文件"></a>生成数据库文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># mysql_install_db  --user=mysql --datadir=/mysql/3306/data </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># mysql_install_db  --user=mysql --datadir=/mysql/3307/data </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># mysql_install_db  --user=mysql --datadir=/mysql/3308/data</span></span><br></pre></td></tr></table></figure><h3 id="准备配置文件"><a href="#准备配置文件" class="headerlink" title="准备配置文件"></a>准备配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># vim  /mysql/3306/etc/my.cnf </span></span><br><span class="line">[mysqld]</span><br><span class="line">port=3306</span><br><span class="line">datadir=/mysql/3306/data</span><br><span class="line">socket=/mysql/3306/socket/mysql.sock </span><br><span class="line">log-error=/mysql/3306/log/mysql.log </span><br><span class="line">pid-file=/mysql/3306/pid/mysql.pid</span><br><span class="line"></span><br><span class="line"><span class="comment">#重复上面步骤设置3307，3308</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># sed &#x27;s/3306/3307/&#x27;  /mysql/3306/etc/my.cnf &gt; /mysql/3307/etc/my.cnf</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># sed &#x27;s/3306/3308/&#x27;  /mysql/3306/etc/my.cnf &gt; /mysql/3308/etc/my.cnf</span></span><br></pre></td></tr></table></figure><h3 id="准备启动脚本"><a href="#准备启动脚本" class="headerlink" title="准备启动脚本"></a>准备启动脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># vim /mysql/3306/bin/mysqld</span></span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line">mysql_user=<span class="string">&quot;root&quot;</span> </span><br><span class="line">mysql_pwd=<span class="string">&quot;123456&quot;</span></span><br><span class="line">cmd_path=<span class="string">&quot;/usr/bin&quot;</span></span><br><span class="line">port=3306</span><br><span class="line">mysql_basedir=<span class="string">&quot;/mysql&quot;</span></span><br><span class="line"></span><br><span class="line">. /etc/init.d/functions</span><br><span class="line">[ <span class="variable">$#</span> -ne 1 ] &amp;&amp; &#123;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;USAGE:&#123;start|stop|restart&#125;&quot;</span></span><br><span class="line"><span class="built_in">exit</span> 1</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">start</span></span>()&#123;</span><br><span class="line"><span class="keyword">if</span> [ -e <span class="variable">$&#123;mysql_basedir&#125;</span>/<span class="variable">$&#123;port&#125;</span>/socket/mysql.sock ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;MySQL is running.&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="variable">$&#123;cmd_path&#125;</span>/mysqld_safe --defaults-file=<span class="variable">$&#123;mysql_basedir&#125;</span>/<span class="variable">$&#123;port&#125;</span>/etc/my.cnf &amp;&gt;/dev/null &amp;</span><br><span class="line">  action  <span class="string">&quot;MySQL is starting&quot;</span> /bin/true</span><br><span class="line">  <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">stop</span></span>()&#123;</span><br><span class="line"><span class="keyword">if</span> [ -e <span class="variable">$&#123;mysql_basedir&#125;</span>/<span class="variable">$&#123;port&#125;</span>/socket/mysql.sock ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">  <span class="variable">$&#123;cmd_path&#125;</span>/mysqladmin -u <span class="variable">$&#123;mysql_user&#125;</span> -p <span class="variable">$&#123;mysql_pwd&#125;</span> -S <span class="variable">$&#123;mysql_basedir&#125;</span>/<span class="variable">$&#123;port&#125;</span>/socket/mysql.sock shutdown &amp;&gt;/dev/null</span><br><span class="line">  action <span class="string">&quot;MySQL is stoping&quot;</span> /bin/true</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  action <span class="string">&quot;MySQL is stoping&quot;</span> /bin/false</span><br><span class="line">  <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">restart</span></span>()&#123;</span><br><span class="line">  stop</span><br><span class="line">  <span class="built_in">sleep</span> 2</span><br><span class="line">  start</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> == <span class="string">&quot;start&quot;</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">  start</span><br><span class="line"><span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> == <span class="string">&quot;stop&quot;</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">  stop</span><br><span class="line"><span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> == <span class="string">&quot;restart&quot;</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">  restart</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;USAGE:&#123;start|stop|restart&#125;&quot;</span> </span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># chmod +x /mysql/3306/bin/mysqld</span></span><br><span class="line"><span class="comment">#重复上述过程，分别建立3307，3308的启动脚本</span></span><br></pre></td></tr></table></figure><h3 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># /mysql/3306/bin/mysqld  start </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># /mysql/3307/bin/mysqld  start </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># /mysql/3308/bin/mysqld  start </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ss -ntl</span></span><br><span class="line">State         Recv-Q        Send-Q               Local Address:Port               Peer Address:Port       Process        </span><br><span class="line">LISTEN        0             128                        0.0.0.0:22                      0.0.0.0:*                         </span><br><span class="line">LISTEN        0             80                               *:3306                          *:*                         </span><br><span class="line">LISTEN        0             80                               *:3307                          *:*                         </span><br><span class="line">LISTEN        0             80                               *:3308                          *:*                         </span><br><span class="line">LISTEN        0             128                           [::]:22                         [::]:*        </span><br></pre></td></tr></table></figure><h3 id="登录实例"><a href="#登录实例" class="headerlink" title="登录实例"></a>登录实例</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># /mysql/3308/bin/mysqld  start </span></span><br><span class="line"><span class="comment">#两种连接方法</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># mysql -h127.0.0.1 -uroot -P3306</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># mysql -uroot -S /mysqldb/3306/socket/mysql.sock </span></span><br><span class="line"><span class="comment">#确认连接的端口</span></span><br><span class="line">MariaDB [(none)]&gt; show variables like <span class="string">&#x27;port&#x27;</span>;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| port          | 3306  |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.001 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">#关闭数据库，需要手动输入root的密码</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># /mysql/3308/bin/mysqld stop </span></span><br><span class="line">Stoping MySQL...</span><br><span class="line">Enter password:</span><br><span class="line">[root@centos8 ~]<span class="comment"># /mysql/3308/bin/mysqld start </span></span><br><span class="line">Starting MySQL...</span><br></pre></td></tr></table></figure><h3 id="修改root密码"><a href="#修改root密码" class="headerlink" title="修改root密码"></a>修改root密码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#加上root的口令</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># mysqladmin -uroot -S /mysql/3306/socket/mysql.sock  password &#x27;123456&#x27;</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># mysqladmin -uroot -S /mysql/3307/socket/mysql.sock  password &#x27;123456&#x27;</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># mysqladmin -uroot -S /mysql/3308/socket/mysql.sock  password &#x27;123456&#x27;</span></span><br><span class="line"><span class="comment">#重复步骤，分别修改别外两个实例3307，3308对应root口令</span></span><br></pre></td></tr></table></figure><h3 id="测试连接"><a href="#测试连接" class="headerlink" title="测试连接"></a>测试连接</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># mysql -uroot -p -S /mysql/3306/socket/mysql.sock #提示输入口令才能登录</span></span><br></pre></td></tr></table></figure><h3 id="开机启动"><a href="#开机启动" class="headerlink" title="开机启动"></a>开机启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># echo &quot;for i in &#123;3306..3308&#125;;do /mysql/$i/bin/mysqld start;done&quot; &gt;&gt; /etc/rc.d/rc.local </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># chmod +x /etc/rc.d/rc.local</span></span><br></pre></td></tr></table></figure><h2 id="mysql-客户端命令"><a href="#mysql-客户端命令" class="headerlink" title="mysql 客户端命令"></a>mysql 客户端命令</h2><h3 id="mysql命令使用格式"><a href="#mysql命令使用格式" class="headerlink" title="mysql命令使用格式"></a>mysql命令使用格式</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql [OPTIONS] [database]</span><br></pre></td></tr></table></figure><p>mysql客户端常用选项：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-A, --no-auto-rehash 禁止补全</span><br><span class="line">-u, --user=     用户名,默认为root</span><br><span class="line">-h, --host=     服务器主机,默认为localhost</span><br><span class="line">-p, --passowrd= 用户密码,建议使用-p,默认为空密码</span><br><span class="line">-P, --port=     服务器端口</span><br><span class="line">-S, --socket=   指定连接socket文件路径</span><br><span class="line">-D, --database=     指定默认数据库</span><br><span class="line">-C, --compress  启用压缩</span><br><span class="line">-e   <span class="string">&quot;SQL&quot;</span>  执行SQL命令</span><br><span class="line">-V, --version   显示版本</span><br><span class="line">-v  --verbose   显示详细信息</span><br><span class="line">--print-defaults    获取程序默认使用的配置</span><br></pre></td></tr></table></figure><h3 id="安装mycli"><a href="#安装mycli" class="headerlink" title="安装mycli"></a>安装mycli</h3><p>MyCLI 是 MySQL，MariaDB 和 Percona 的命令行界面，具有自动完成和语法突出显示功能</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##安装依赖包</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># yum install -y epel-release zlib-devel bzip2-devel openssl-devel ncurses-devel sqlite-devel readline-devel tk-devel libffi-devel gcc make</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##下载Python3.8安装包</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># wget https://www.python.org/ftp/python/3.8.0/Python-3.8.0b3.tgz </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#解压安装包</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># tar -xf Python-3.8.0b3.tgz</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#进入Python目录,指定安装目录并编译安装</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cd Python-3.8.0b3</span></span><br><span class="line">[root@centos8 Python-3.8.0b3]<span class="comment"># ./configure --prefix=/app/python/python3.8</span></span><br><span class="line">[root@centos8 Python-3.8.0b3]<span class="comment"># make &amp;&amp; make install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建python3.8和pip3.8的软连接</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ln -s /app/python/python3.8/bin/python3.8 /usr/bin/python3.8</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ln -s /app/python/python3.8/bin/pip3.8 /usr/bin/pip3.8</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#升级pip包管理器版本至最新版,安装Mycli</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># pip3.8 install --upgrade pip</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># pip3.8 install --ignore-installed mycli</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Mycli所在目录</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cd /app/python/python3.8/bin/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#追加环境变量,注意要使用单引号</span></span><br><span class="line">[root@centos8 bin]<span class="comment"># echo -e &#x27;PATH=$PATH:/app/python/python3.8/bin/\nexport PATH&#x27; &gt;&gt; /etc/profile</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#生效环境变量</span></span><br><span class="line">[root@centos8 bin]<span class="comment"># source /etc/profile</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动方法</span></span><br><span class="line">[root@centos8 bin]<span class="comment"># ./mycli -u root</span></span><br><span class="line">Password:</span><br><span class="line"><span class="comment">##至此安装全部完成</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CentOS运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CENTOS </tag>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OpenVPN的高级功能</title>
      <link href="/2022/05/27/2022/05/OpenVPN%E7%9A%84%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD/"/>
      <url>/2022/05/27/2022/05/OpenVPN%E7%9A%84%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD/</url>
      
        <content type="html"><![CDATA[<h2 id="启用防止DOS攻击的安全增强配置"><a href="#启用防止DOS攻击的安全增强配置" class="headerlink" title="启用防止DOS攻击的安全增强配置"></a>启用防止DOS攻击的安全增强配置</h2><p><strong>服务器配置</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># openvpn --genkey --secret /etc/openvpn/certs/ta.key</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /etc/openvpn/certs/ta.key</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 2048 bit OpenVPN static key</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">-----BEGIN OpenVPN Static key V1-----</span><br><span class="line">6e978f0ee0a3ef80ee1108cd741b8481</span><br><span class="line">46ff819b5044a99497540edc39b9203a</span><br><span class="line">14b5637b14b5312482f83ad868b88abd</span><br><span class="line">f15b36c8440804ea6aa4e937b394ce66</span><br><span class="line">87d21e70e5dba4ac0331e6b4624f9b74</span><br><span class="line">d55422726cd7563d726dc09aa4da4493</span><br><span class="line">94a0f21f1a57c517d6e6a7a09ef8dcda</span><br><span class="line">92273326212b0d83e050bd30ebf3d5e5</span><br><span class="line">3042b740b732ffcf366a999c02959464</span><br><span class="line">275475e89453722a022ba390199ecc2b</span><br><span class="line">3f2caf44aaa8239f601f1b415fd06ae7</span><br><span class="line">4a574ad61f8eeae55a772cd76ac701e0</span><br><span class="line">85d4b6aaab86809c70467493c9510c4c</span><br><span class="line">ef4ae8b3f704adaa97e8ac98e74270a4</span><br><span class="line">7ccee3bccea3dba34083a302c9fc400a</span><br><span class="line">403f0c0529162da22b7db24fb27c377b</span><br><span class="line">-----END OpenVPN Static key V1-----</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /etc/openvpn/server.conf</span></span><br><span class="line"><span class="comment">#添加以下内容</span></span><br><span class="line">tls-auth /etc/openvpn/certs/ta.key 0 <span class="comment">#客户端为1,服务器端为0</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl restart openvpn@server.service</span></span><br></pre></td></tr></table></figure><p><strong>将ta.key 传到客户端相关目录下</strong></p><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2ltmfmfbrj20ww0buta7.jpg" alt=""></p><p><strong>修改客户端配置文件<code>clent.ovpn</code>,添加一行</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tls-auth ta.key 1   <span class="comment">#客户端为1,服务器端为0</span></span><br></pre></td></tr></table></figure><p>客户端重新建立连接</p><h2 id="设置客户端的私钥密码增强安全性"><a href="#设置客户端的私钥密码增强安全性" class="headerlink" title="设置客户端的私钥密码增强安全性"></a>设置客户端的私钥密码增强安全性</h2><h3 id="创建新用户-生成对应的有密码的私钥和证书申请"><a href="#创建新用户-生成对应的有密码的私钥和证书申请" class="headerlink" title="创建新用户,生成对应的有密码的私钥和证书申请"></a>创建新用户,生成对应的有密码的私钥和证书申请</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># cd /etc/openvpn/easy-rsa-client/3</span></span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa gen-req USERNAME</span></span><br><span class="line"></span><br><span class="line">Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-client/3.0.7/vars</span><br><span class="line">Using SSL: openssl OpenSSL 1.1.1k  FIPS 25 Mar 2021</span><br><span class="line">Generating a RSA private key</span><br><span class="line">...............................................................+++++</span><br><span class="line">................+++++</span><br><span class="line">writing new private key to <span class="string">&#x27;/etc/openvpn/easy-rsa-client/3/pki/easy-rsa- 35371.iJfHbs/tmp.9lGUMy&#x27;</span></span><br><span class="line">Enter PEM pass phrase:</span><br><span class="line"><span class="comment">#输入两遍密码</span></span><br><span class="line">Verifying - Enter PEM pass phrase:</span><br><span class="line"><span class="comment">#输入两遍密码</span></span><br><span class="line">-----</span><br><span class="line">You are about to be asked to enter information that will be incorporated into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter <span class="string">&#x27;.&#x27;</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Common Name (eg: your user, host, or server name) [USERNAME]:</span><br><span class="line">Keypair and certificate request completed. Your files are:</span><br><span class="line">req: /etc/openvpn/easy-rsa-client/3/pki/reqs/USERNAME.req</span><br><span class="line">key: /etc/openvpn/easy-rsa-client/3/pki/private/USERNAME.key</span><br></pre></td></tr></table></figure><h3 id="导入用户证书申请并颁发证书"><a href="#导入用户证书申请并颁发证书" class="headerlink" title="导入用户证书申请并颁发证书"></a>导入用户证书申请并颁发证书</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 3]<span class="comment">#cd /etc/openvpn/easy-rsa-server/3</span></span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa import-req /etc/openvpn/easy-rsa-client/3/pki/reqs/USERNAME.req   USERNAME</span></span><br><span class="line"></span><br><span class="line">Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.8/vars</span><br><span class="line">Using SSL: openssl OpenSSL 1.1.1k  FIPS 25 Mar 2021</span><br><span class="line"></span><br><span class="line">The request has been successfully imported with a short name of: USERNAME</span><br><span class="line">You may now use this name to perform signing operations on this request.</span><br><span class="line"></span><br><span class="line"><span class="comment">#确保证书有效期是合理值</span></span><br><span class="line">[root@centos8 3]<span class="comment">#grep EASYRSA_CERT_EXPIRE vars</span></span><br><span class="line">set_var EASYRSA_CERT_EXPIRE 90</span><br><span class="line"></span><br><span class="line"><span class="comment">#颁发证书</span></span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa sign client USERNAME</span></span><br><span class="line"></span><br><span class="line">Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.8/vars</span><br><span class="line">Using SSL: openssl OpenSSL 1.1.1k  FIPS 25 Mar 2021</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">You are about to sign the following certificate.</span><br><span class="line">Please check over the details shown below <span class="keyword">for</span> accuracy. Note that this request</span><br><span class="line">has not been cryptographically verified. Please be sure it came from a trusted</span><br><span class="line"><span class="built_in">source</span> or that you have verified the request checksum with the sender.</span><br><span class="line"></span><br><span class="line">Request subject, to be signed as a client certificate <span class="keyword">for</span> 90 days:</span><br><span class="line"></span><br><span class="line">subject=</span><br><span class="line">    commonName                = USERNAME</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Type the word <span class="string">&#x27;yes&#x27;</span> to <span class="built_in">continue</span>, or any other input to abort.</span><br><span class="line">  Confirm request details: <span class="built_in">yes</span>              <span class="comment">#输入yes</span></span><br><span class="line">Using configuration from /etc/openvpn/easy-rsa-server/3/pki/easy-rsa-33479.B9Jp6u/tmp.7WmZA9</span><br><span class="line">Check that the request matches the signature</span><br><span class="line">Signature ok</span><br><span class="line">The Subject<span class="string">&#x27;s Distinguished Name is as follows</span></span><br><span class="line"><span class="string">commonName            :ASN.1 12:&#x27;</span>USERNAME<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Certificate is to be certified until Aug 24 07:25:47 2022 GMT (90 days)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Write out database with 1 new entries</span></span><br><span class="line"><span class="string">Data Base Updated</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Certificate created at: /etc/openvpn/easy-rsa-server/3/pki/issued/USERNAME.crt</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure><h3 id="将用户的证书相关文件放在指定的目录中"><a href="#将用户的证书相关文件放在指定的目录中" class="headerlink" title="将用户的证书相关文件放在指定的目录中"></a>将用户的证书相关文件放在指定的目录中</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#mkdir  /etc/openvpn/client/USERNAME</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cp /etc/openvpn/easy-rsa-server/3/pki/issued/USERNAME.crt /etc/openvpn/client/USERNAME</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cp /etc/openvpn/easy-rsa-client/3/pki/private/USERNAME.key /etc/openvpn/client/USERNAME</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cp /etc/openvpn/certs/&#123;ca.crt,dh.pem,ta.key&#125; /etc/openvpn/client/USERNAME/</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cp /etc/openvpn/client/tdison/client.ovpn /etc/openvpn/client/USERNAME/</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#ll /etc/openvpn/client/USERNAME/</span></span><br><span class="line">total 28</span><br><span class="line">-rw------- 1 root root 1204 Aug  4 16:41 ca.crt</span><br><span class="line">-rw-r--r-- 1 root root  231 Aug  4 16:44 client.ovpn</span><br><span class="line">-rw------- 1 root root  424 Aug  4 16:41 dh.pem</span><br><span class="line">-rw------- 1 root root 4492 Aug  4 16:38 USERNAME.crt</span><br><span class="line">-rw------- 1 root root 1854 Aug  4 16:38 USERNAME.key</span><br><span class="line">-rw------- 1 root root  636 Aug  4 16:41 ta.key</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#cd /etc/openvpn/client/USERNAME/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#根据服务器端修改下面配置,需要和服务器同步</span></span><br><span class="line">[root@centos8 USERNAME]<span class="comment">#vim client.ovpn</span></span><br><span class="line">[root@centos8 USERNAME]<span class="comment">#cat client.ovpn client</span></span><br><span class="line">client</span><br><span class="line">dev tun </span><br><span class="line">proto tcp</span><br><span class="line">remote  10.10.0.81  1194</span><br><span class="line">resolv-retry infinite</span><br><span class="line">nobind</span><br><span class="line">ca ca.crt</span><br><span class="line">cert USERNAME.crt </span><br><span class="line">key USERNAME.key            </span><br><span class="line">remote-cert-tls server</span><br><span class="line">tls-auth ta.key 1</span><br><span class="line">cipher AES-256-CBC</span><br><span class="line">verb 3</span><br><span class="line">compress lz4-v2</span><br><span class="line">[root@centos8 USERNAME]<span class="comment">#tar cf USERNAME.tar *</span></span><br></pre></td></tr></table></figure><h3 id="将相关文件传给客户端主机相应目录"><a href="#将相关文件传给客户端主机相应目录" class="headerlink" title="将相关文件传给客户端主机相应目录"></a>将相关文件传给客户端主机相应目录</h3><p>放置到windows客户端的<code>C:\Program Files\OpenVPN\config</code>目录下</p><h3 id="Windows-客户端连接"><a href="#Windows-客户端连接" class="headerlink" title="Windows 客户端连接"></a>Windows 客户端连接</h3><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2luzjhzxrj20l70cs75r.jpg" alt=""></p><h2 id="账户证书管理"><a href="#账户证书管理" class="headerlink" title="账户证书管理"></a>账户证书管理</h2><h3 id="证书手动注销"><a href="#证书手动注销" class="headerlink" title="证书手动注销"></a>证书手动注销</h3><p>查看当前证书的有效性,有效为V,无效为R</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#cat /etc/openvpn/easy-rsa-server/3/pki/index.txt</span><br><span class="line">V       320523065024Z           738AF442248F8317BA9C6247E37AF69E        unknown /CN=server</span><br><span class="line">V       220824065048Z           D087EA0E573DE2DB7C88B809D71AD1E2        unknown /CN=tdison</span><br></pre></td></tr></table></figure><p>吊销指定的用户的证书</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8  ~]<span class="comment"># cd /etc/openvpn/easy-rsa-server/3 </span></span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa  revoke tdison</span></span><br><span class="line"></span><br><span class="line">Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.8/vars</span><br><span class="line">Using SSL: openssl OpenSSL 1.1.1k  FIPS 25 Mar 2021</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Please confirm you wish to revoke the certificate with the following subject:</span><br><span class="line"></span><br><span class="line">subject=</span><br><span class="line">    commonName                = tdison</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Type the word <span class="string">&#x27;yes&#x27;</span> to <span class="built_in">continue</span>, or any other input to abort.</span><br><span class="line">  Continue with revocation: <span class="built_in">yes</span></span><br><span class="line">Using configuration from /etc/openvpn/easy-rsa-server/3/pki/easy-rsa-33553.Yy7wkH/tmp.5NIJyp</span><br><span class="line">Revoking Certificate D087EA0E573DE2DB7C88B809D71AD1E2.</span><br><span class="line">Data Base Updated</span><br><span class="line"></span><br><span class="line">IMPORTANT!!!</span><br><span class="line"></span><br><span class="line">Revocation was successful. You must run gen-crl and upload a CRL to your</span><br><span class="line">infrastructure <span class="keyword">in</span> order to prevent the revoked cert from being accepted.</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看当前证书的有效性,有效为V,无效为R</span></span><br><span class="line">[root@centos8 3]<span class="comment">#cat /etc/openvpn/easy-rsa-server/3/pki/index.txt</span></span><br><span class="line">V       320523065024Z           738AF442248F8317BA9C6247E37AF69E        unknown /CN=server</span><br><span class="line">R       220824065048Z   220526075757Z   D087EA0E573DE2DB7C88B809D71AD1E2        unknown /CN=tdison</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成证书吊销列表。每次吊销证书后都需要更新证书吊销列表文件,并且需要重启OpenVPN服务</span></span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa gen-crl</span></span><br><span class="line"></span><br><span class="line">Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.8/vars</span><br><span class="line">Using SSL: openssl OpenSSL 1.1.1k  FIPS 25 Mar 2021</span><br><span class="line">Using configuration from /etc/openvpn/easy-rsa-server/3/pki/easy-rsa-33597.fICkX8/tmp.zrgs7o</span><br><span class="line"></span><br><span class="line">An updated CRL has been created.</span><br><span class="line">CRL file: /etc/openvpn/easy-rsa-server/3/pki/crl.pem</span><br><span class="line"></span><br><span class="line"><span class="comment">#第一次吊销证时需要编辑配置文件调用吊销证书的文件,后续吊销无需此步 </span></span><br><span class="line">[root@openvpn-server 3.0.3]<span class="comment"># vim /etc/openvpn/server.conf </span></span><br><span class="line">crl-verify /etc/openvpn/easy-rsa-server/3/pki/crl.pem</span><br><span class="line"><span class="comment">#每次吊销证书后,都需要重新启动才能生效</span></span><br><span class="line">[root@centos8 3]<span class="comment">#systemctl restart openvpn@server.service</span></span><br></pre></td></tr></table></figure><h3 id="账户重名证书签发"><a href="#账户重名证书签发" class="headerlink" title="账户重名证书签发"></a>账户重名证书签发</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#删除准备撤销的账户证书</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cd /etc/openvpn/easy-rsa-client/3/</span></span><br><span class="line">[root@centos8 3]<span class="comment">#rm -f pki/private/tdison.key</span></span><br><span class="line">[root@centos8 3]<span class="comment">#rm -f pki/reqs/tdison.req</span></span><br><span class="line">[root@centos8 3]<span class="comment">#rm -rf /etc/openvpn/client/tdison/*</span></span><br><span class="line">[root@centos8 3]<span class="comment">#rm -f /etc/openvpn/easy-rsa-server/3/pki/reqs/tdison.req</span></span><br><span class="line">[root@centos8 3]<span class="comment">#rm -f /etc/openvpn/easy-rsa-server/3/pki/issued/tdison.crt</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#删除之前的带R的吊销记录</span></span><br><span class="line">[root@centos8 3]<span class="comment">#vim  /etc/openvpn/easy-rsa-server/3/pki/index.txt</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#重新生成新的账户证书申请和私钥</span></span><br><span class="line">[root@centos8 3]<span class="comment">#cd /etc/openvpn/easy-rsa-client/3</span></span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa gen-req tdison</span></span><br><span class="line">......</span><br><span class="line">Common Name (eg: your user, host, or server name) [tdison]:<span class="comment">#直接回车 </span></span><br><span class="line">Keypair and certificate request completed. Your files are:</span><br><span class="line">req: /etc/openvpn/easy-rsa-client/3/pki/reqs/tdison.req </span><br><span class="line">key: /etc/openvpn/easy-rsa-client/3/pki/private/tdison.key</span><br><span class="line"></span><br><span class="line"><span class="comment">#CA导入证书并签发</span></span><br><span class="line">[root@centos8 3]<span class="comment">#cd /etc/openvpn/easy-rsa-server/3</span></span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa import-req /etc/openvpn/easy-rsa-client/3/pki/reqs/tdison.req tdison</span></span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa  sign client tdison</span></span><br><span class="line">......</span><br><span class="line">Type the word <span class="string">&#x27;yes&#x27;</span> to <span class="built_in">continue</span>, or any other input to abort. </span><br><span class="line">  Confirm request details: <span class="built_in">yes</span>  <span class="comment">#输入yes</span></span><br><span class="line">......</span><br><span class="line">Write out database with 1 new entries </span><br><span class="line">Data Base Updated</span><br><span class="line"></span><br><span class="line">Certificate created at: /etc/openvpn/easy-rsa-server/3/pki/issued/tdison.crt</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成相关文件</span></span><br><span class="line">[root@centos8 3]<span class="comment">#cp /etc/openvpn/easy-rsa-server/3/pki/issued/tdison.crt /etc/openvpn/client/tdison/</span></span><br><span class="line">[root@centos8 3]<span class="comment">#cp /etc/openvpn/easy-rsa-client/3/pki/private/tdison.key /etc/openvpn/client/tdison/</span></span><br><span class="line">[root@centos8 3]<span class="comment">#cp /etc/openvpn/certs/&#123;ca.crt,dh.pem,ta.key&#125; /etc/openvpn/client/tdison/</span></span><br><span class="line">[root@centos8 3]<span class="comment">#cp /etc/openvpn/client/USERNAME/client.ovpn /etc/openvpn/client/tdison/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改客户端配置文件</span></span><br><span class="line">[root@centos8 3]<span class="comment">#vim /etc/openvpn/client/tdison/client.ovpn</span></span><br><span class="line">client</span><br><span class="line">dev tun </span><br><span class="line">proto tcp</span><br><span class="line">remote  10.10.0.81  1194</span><br><span class="line">resolv-retry infinite</span><br><span class="line">nobind</span><br><span class="line">ca ca.crt</span><br><span class="line">cert tdison.crt </span><br><span class="line">key tdison.key            </span><br><span class="line">remote-cert-tls server</span><br><span class="line">tls-auth ta.key 1</span><br><span class="line">cipher AES-256-CBC</span><br><span class="line">verb 3</span><br><span class="line">compress lz4-v2</span><br><span class="line"></span><br><span class="line"><span class="comment">#将/etc/openvpn/client/tdison所有文件打包传到客户端用</span></span><br></pre></td></tr></table></figure><h3 id="自动化的证书颁发脚本"><a href="#自动化的证书颁发脚本" class="headerlink" title="自动化的证书颁发脚本"></a>自动化的证书颁发脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">. /etc/init.d/functions</span><br><span class="line"></span><br><span class="line">OPENVPN_SERVER=&lt;OpenVPN Server 公网IP&gt;</span><br><span class="line">PASS=123456</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">remove_cert</span></span> () &#123;</span><br><span class="line">    <span class="built_in">rm</span> -rf /etc/openvpn/client/<span class="variable">$&#123;NAME&#125;</span> </span><br><span class="line">    find /etc/openvpn/ -name <span class="string">&quot;<span class="variable">$NAME</span>.*&quot;</span> -delete</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">create_cert</span></span> () &#123;</span><br><span class="line">    <span class="built_in">cd</span> /etc/openvpn/easy-rsa-client/3</span><br><span class="line">    ./easyrsa  gen-req <span class="variable">$&#123;NAME&#125;</span> nopass &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">cd</span> /etc/openvpn/easy-rsa-server/3</span><br><span class="line">    ./easyrsa import-req /etc/openvpn/easy-rsa-client/3/pki/reqs/<span class="variable">$&#123;NAME&#125;</span>.req <span class="variable">$&#123;NAME&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ./easyrsa sign client <span class="variable">$&#123;NAME&#125;</span> &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">yes</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">mkdir</span>  /etc/openvpn/client/<span class="variable">$&#123;NAME&#125;</span></span><br><span class="line">    <span class="built_in">cp</span> /etc/openvpn/easy-rsa-server/3/pki/issued/<span class="variable">$&#123;NAME&#125;</span>.crt /etc/openvpn/client/<span class="variable">$&#123;NAME&#125;</span></span><br><span class="line">    <span class="built_in">cp</span> /etc/openvpn/easy-rsa-client/3/pki/private/<span class="variable">$&#123;NAME&#125;</span>.key  /etc/openvpn/client/<span class="variable">$&#123;NAME&#125;</span></span><br><span class="line">    <span class="built_in">cp</span> /etc/openvpn/certs/&#123;ca.crt,dh.pem,ta.key&#125; /etc/openvpn/client/<span class="variable">$&#123;NAME&#125;</span></span><br><span class="line">    <span class="built_in">cat</span> &gt;  /etc/openvpn/client/<span class="variable">$&#123;NAME&#125;</span>/client.ovpn &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">client</span></span><br><span class="line"><span class="string">dev tun</span></span><br><span class="line"><span class="string">proto tcp</span></span><br><span class="line"><span class="string">remote $OPENVPN_SERVER 1194</span></span><br><span class="line"><span class="string">resolv-retry infinite</span></span><br><span class="line"><span class="string">nobind</span></span><br><span class="line"><span class="string">#persist-key</span></span><br><span class="line"><span class="string">#persist-tun</span></span><br><span class="line"><span class="string">ca ca.crt</span></span><br><span class="line"><span class="string">cert $NAME.crt</span></span><br><span class="line"><span class="string">key $NAME.key</span></span><br><span class="line"><span class="string">remote-cert-tls server</span></span><br><span class="line"><span class="string">tls-auth ta.key 1</span></span><br><span class="line"><span class="string">cipher AES-256-CBC</span></span><br><span class="line"><span class="string">verb 3</span></span><br><span class="line"><span class="string">compress lz4-v2</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;证书存放路径:/etc/openvpn/client/<span class="variable">$&#123;NAME&#125;</span>,证书文件如下:&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\E[1;32m******************************************************************\E[0m&quot;</span></span><br><span class="line">    <span class="built_in">ls</span> -l /etc/openvpn/client/<span class="variable">$&#123;NAME&#125;</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\E[1;32m******************************************************************\E[0m&quot;</span></span><br><span class="line">    <span class="built_in">cd</span> /etc/openvpn/client/<span class="variable">$&#123;NAME&#125;</span> </span><br><span class="line">    zip -qP <span class="string">&quot;<span class="variable">$PASS</span>&quot;</span> /root/<span class="variable">$&#123;NAME&#125;</span>.zip * </span><br><span class="line">    action  <span class="string">&quot;证书的打包文件已生成: /root/<span class="variable">$&#123;NAME&#125;</span>.zip&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">read</span> -p <span class="string">&quot;请输入用户的姓名拼音: &quot;</span> NAME</span><br><span class="line"></span><br><span class="line">remove_cert</span><br><span class="line">create_cert</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CentOS运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CENTOS </tag>
            
            <tag> OpenVPN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mac终端美化</title>
      <link href="/2022/05/26/2022/05/Mac%E7%BB%88%E7%AB%AF%E7%BE%8E%E5%8C%96/"/>
      <url>/2022/05/26/2022/05/Mac%E7%BB%88%E7%AB%AF%E7%BE%8E%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h3 id="安装OneHalfDark主题"><a href="#安装OneHalfDark主题" class="headerlink" title="安装OneHalfDark主题"></a>安装OneHalfDark主题</h3><ul><li><p>下载OneHalfDark：</p><p>作者Github地址：<a href="https://github.com/sonph/onehalf">https://github.com/sonph/onehalf</a></p></li><li><p>解压后打开<code>./terminal/OneHalfDark.terminal</code>文件</p></li></ul><p><strong>自定义配置</strong></p><ul><li>在终端界面按下<code>⌘+,</code>打开终端偏好设置。</li></ul><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2lm1p2novj20wk0u0tbz.jpg" alt=""></p><h3 id="安装oh-my-zsh"><a href="#安装oh-my-zsh" class="headerlink" title="安装oh-my-zsh"></a>安装oh-my-zsh</h3><p><strong>curl 安装</strong></p><p><strong>GitHub</strong>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh -c &quot;$(curl -fsSL https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh)&quot;</span><br></pre></td></tr></table></figure><p><strong>Gitee ( 国内镜像 )</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh -c &quot;$(curl -fsSL https://gitee.com/mirrors/oh-my-zsh/raw/master/tools/install.sh)&quot;</span><br></pre></td></tr></table></figure><p><strong>wget 安装</strong></p><p><strong>GitHub</strong>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh -c &quot;$(wget https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh -O -)&quot;</span><br></pre></td></tr></table></figure><p><strong>Gitee ( 国内镜像 )</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh -c &quot;$(wget -O- https://gitee.com/pocmon/mirrors/raw/master/tools/install.sh)&quot;</span><br></pre></td></tr></table></figure><h3 id="安装powerlevel10k"><a href="#安装powerlevel10k" class="headerlink" title="安装powerlevel10k"></a>安装powerlevel10k</h3><p><strong>GitHub地址：<a href="https://github.com/romkatv/powerlevel10k">https://github.com/romkatv/powerlevel10k</a></strong></p><ol><li><p>安装字体</p><ul><li><a href="https://github.com/romkatv/powerlevel10k-media/raw/master/MesloLGS%20NF%20Regular.ttf">MesloLGS NF Regular.ttf</a></li><li><a href="https://github.com/romkatv/powerlevel10k-media/raw/master/MesloLGS%20NF%20Bold.ttf">MesloLGS NF Bold.ttf</a></li><li><a href="https://github.com/romkatv/powerlevel10k-media/raw/master/MesloLGS%20NF%20Italic.ttf">MesloLGS NF 斜体.ttf</a></li><li><a href="https://github.com/romkatv/powerlevel10k-media/raw/master/MesloLGS%20NF%20Bold%20Italic.ttf">MesloLGS NF 粗体斜体.ttf</a></li></ul></li><li><p>安装powerlevel10k：</p><p><strong>GitHub</strong>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone --depth=1 https://github.com/romkatv/powerlevel10k.git $&#123;ZSH\_CUSTOM:-$HOME/.oh-my-zsh/custom&#125;/themes/powerlevel10k</span><br></pre></td></tr></table></figure><p><strong>Gitee ( 国内镜像 )</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone --depth=1 https://gitee.com/romkatv/powerlevel10k.git $&#123;ZSH\_CUSTOM:-$HOME/.oh-my-zsh/custom&#125;/themes/powerlevel10k</span><br></pre></td></tr></table></figure></li><li><p>在<code>~/.zshrc</code>中设置<code>ZSH_THEME=&quot;powerlevel10k/powerlevel10k&quot;</code>.</p></li><li><p>配置字体</p><ul><li><strong>iTerm2</strong>: 当被问及是否安装Meslo Nerd字体时，键入 <code>p10k configure</code> 并回答 <code>Yes</code> 。或者，打开iTerm2→首选项→配置文件→文本，并将字体设置为 <code>MesloLGS NF</code>。</li><li><strong>Apple Terminal</strong>: 打开终端→首选项→配置文件→文本，单击字体下的更改，然后选择 <code>MesloLGS NF</code> 系列。</li></ul></li><li><p>配置powerlevel10k</p><ul><li><p>重启终端后，Powerlevel10k配置向导会自动运行。如果没有自动运行，手动输入<code>p10k configure</code>运行。</p></li><li><p>修改<code>~/.p10k.zsh</code>文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">typeset</span> -g POWERLEVEL9K_LEFT_PROMPT_ELEMENTS=(   <span class="comment">#搜索此行</span></span><br><span class="line">  os_icon                 <span class="comment"># os identifier</span></span><br><span class="line">  context                 <span class="comment"># user@hostname        #添加此行</span></span><br><span class="line">  <span class="built_in">dir</span>                     <span class="comment"># current directory</span></span><br></pre></td></tr></table></figure></li></ul></li></ol><h3 id="安装Zsh-autosuggestions插件"><a href="#安装Zsh-autosuggestions插件" class="headerlink" title="安装Zsh-autosuggestions插件"></a>安装<code>Zsh-autosuggestions</code>插件</h3><ul><li><p>根据历史记录和完成建议您键入的命令</p><p><strong>GitHub地址：<a href="https://github.com/zsh-users/zsh-autosuggestions">https://github.com/zsh-users/zsh-autosuggestions</a></strong></p><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2lm2wsqm6g20oq01879r.gif" alt=""></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/zsh-users/zsh-autosuggestions ~/.zsh/zsh-autosuggestions</span><br></pre></td></tr></table></figure></li><li><p>将插件添加到 Oh My Zsh 加载的插件列表（<code>~/.zshrc</code>）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">plugins=( </span><br><span class="line">    <span class="comment"># other plugins...</span></span><br><span class="line">    zsh-autosuggestions</span><br><span class="line">)</span><br></pre></td></tr></table></figure></li></ul><h3 id="安装zsh-syntax-highlighting插件"><a href="#安装zsh-syntax-highlighting插件" class="headerlink" title="安装zsh-syntax-highlighting插件"></a>安装<code>zsh-syntax-highlighting</code>插件</h3><ul><li><p>语法高亮。当命令在 zsh 提示符下输入交互式终端时，它可以突出显示命令。这有助于在运行命令之前检查命令错误。</p><p><strong>GitHub地址：<a href="https://github.com/zsh-users/zsh-syntax-highlighting">https://github.com/zsh-users/zsh-syntax-highlighting</a></strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/zsh-users/zsh-syntax-highlighting.git $&#123;ZSH_CUSTOM:-~/.oh-my-zsh/custom&#125;/plugins/zsh-syntax-highlighting</span><br></pre></td></tr></table></figure><p>将插件添加到 Oh My Zsh 加载的插件列表（<code>~/.zshrc</code>）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">plugins=( </span><br><span class="line">    <span class="comment"># other plugins...</span></span><br><span class="line">    zsh-syntax-highlighting</span><br><span class="line">)</span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      <categories>
          
          <category> MacOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MacOS </tag>
            
            <tag> zsh </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OpenVPN部署</title>
      <link href="/2022/05/22/2022/05/OpenVPN%E9%83%A8%E7%BD%B2/"/>
      <url>/2022/05/22/2022/05/OpenVPN%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<h3 id="实验环境："><a href="#实验环境：" class="headerlink" title="实验环境："></a>实验环境：</h3><p><strong>1 openvpn server：</strong><br>CentOS 8<br>eth0:10.10.0.81/24  桥接模式,模拟公网IP<br>eth1:10.0.1.1/24 仅主机模式,私网IP</p><p><strong>2 内网主机两台</strong><br>第一台主机<br>eth0:10.0.1.100/24 仅主机模式,私网IP，无需网关<br>第二台主机<br>eth0:10.0.1.200/24 仅主机模式,私网IP，无需网关 </p><p><strong>3 Windows 客户端</strong><br>Windows 10</p><h3 id="关闭系统安全模式："><a href="#关闭系统安全模式：" class="headerlink" title="关闭系统安全模式："></a>关闭系统安全模式：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># vim /etc/sysconfig/selinux</span></span><br><span class="line">SELINUX=<span class="built_in">disable</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># setenforce 0</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># echo 1 &gt; /proc/sys/net/ipv4/ip_forward     #临时开启路由转发</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># vi  /etc/sysctl.conf   #编辑配置文件，添加以下配置，设置永久路由转发</span></span><br><span class="line">net.ipv4.ip_forward = 1</span><br></pre></td></tr></table></figure><h3 id="安装-OpenVPN"><a href="#安装-OpenVPN" class="headerlink" title="安装 OpenVPN"></a>安装 OpenVPN</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#OpenVPN服务器端</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#yum -y install openvpn </span></span><br><span class="line"><span class="comment">#证书管理工具</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#yum -y install easy-rsa</span></span><br></pre></td></tr></table></figure><h3 id="准备相关配置文件"><a href="#准备相关配置文件" class="headerlink" title="准备相关配置文件"></a>准备相关配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#生成服务器配置文件</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cp /usr/share/doc/openvpn/sample/sample-config-files/server.conf /etc/openvpn/</span></span><br><span class="line"><span class="comment">#准备证书签发相关文件</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cp -r /usr/share/easy-rsa/ /etc/openvpn/easy-rsa-server </span></span><br><span class="line"><span class="comment">#准备签发证书相关变量的配置文件</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cp /usr/share/doc/easy-rsa/vars.example  /etc/openvpn/easy-rsa-server/3/vars</span></span><br><span class="line"><span class="comment">#建议修改给CA和OpenVPN服务器颁发的证书的有效期,可适当加长 </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#vim /etc/openvpn/easy-rsa-server/3/vars </span></span><br><span class="line"><span class="comment">#CA的证书有效期默为为10年,可以适当延长,比如:36500天</span></span><br><span class="line"><span class="comment">#set_var EASYRSA_CA_EXPIRE      3650 </span></span><br><span class="line">set_var EASYRSA_CA_EXPIRE      36500</span><br><span class="line"><span class="comment">#服务器证书默为为825天,可适当加长,比如:3650天 </span></span><br><span class="line"><span class="comment">#set_var EASYRSA_CERT_EXPIRE    825 </span></span><br><span class="line"><span class="comment">#将上面行修改为下面</span></span><br><span class="line">set_var EASYRSA_CERT_EXPIRE    3650 </span><br><span class="line">[root@centos8 ~]<span class="comment">#tree /etc/openvpn/</span></span><br><span class="line">/etc/openvpn/</span><br><span class="line">├── client</span><br><span class="line">├── easy-rsa-server</span><br><span class="line">│   ├── 3 -&gt; 3.0.7</span><br><span class="line">│   ├── 3.0 -&gt; 3.0.7</span><br><span class="line">│   └── 3.0.7</span><br><span class="line">│       ├── easyrsa</span><br><span class="line">│       ├── openssl-easyrsa.cnf</span><br><span class="line">│       ├── vars</span><br><span class="line">│       └── x509-types</span><br><span class="line">│           ├── ca</span><br><span class="line">│           ├── client</span><br><span class="line">│           ├── code-signing</span><br><span class="line">│           ├── COMMON</span><br><span class="line">│           ├── email</span><br><span class="line">│           ├── kdc</span><br><span class="line">│           ├── server</span><br><span class="line">│           └── serverClient </span><br><span class="line">├── server</span><br><span class="line">└── server.conf</span><br><span class="line">7 directories, 12 files</span><br></pre></td></tr></table></figure><h3 id="初始化PKI生成PKI相关目录和文件"><a href="#初始化PKI生成PKI相关目录和文件" class="headerlink" title="初始化PKI生成PKI相关目录和文件"></a>初始化PKI生成PKI相关目录和文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cd /etc/openvpn/easy-rsa-server/3/ </span></span><br><span class="line">[root@centos8 3]<span class="comment">#ls</span></span><br><span class="line">easyrsa  openssl-easyrsa.cnf  vars  x509-types</span><br><span class="line"><span class="comment">#初始化数据,在当前目录下生成pki目录及相关文件 </span></span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa  init-pki</span></span><br><span class="line">Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars </span><br><span class="line">init-pki complete; you may now create a CA or requests.</span><br><span class="line">Your newly created PKI <span class="built_in">dir</span> is: /etc/openvpn/easy-rsa-server/3/pki </span><br><span class="line">[root@centos8 3]<span class="comment">#tree</span></span><br><span class="line">.</span><br><span class="line">├── easyrsa</span><br><span class="line">├── openssl-easyrsa.cnf</span><br><span class="line">├── pki          <span class="comment">#生成一个新目录及相关文件 </span></span><br><span class="line">│   ├── openssl-easyrsa.cnf</span><br><span class="line">│   ├── private </span><br><span class="line">│   ├── reqs</span><br><span class="line">│   └── safessl-easyrsa.cnf </span><br><span class="line">├── vars</span><br><span class="line">└── x509-types</span><br><span class="line">    ├── ca</span><br><span class="line">    ├── client</span><br><span class="line">    ├── code-signing</span><br><span class="line">    ├── COMMON</span><br><span class="line">    ├── email</span><br><span class="line">    ├── kdc</span><br><span class="line">    ├── server</span><br><span class="line">    └── serverClient</span><br><span class="line">4 directories, 13 files</span><br></pre></td></tr></table></figure><h3 id="创建CA机构"><a href="#创建CA机构" class="headerlink" title="创建CA机构"></a>创建CA机构</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cd /etc/openvpn/easy-rsa-server/3 </span></span><br><span class="line">[root@centos8 3]<span class="comment">#tree pki</span></span><br><span class="line">pki</span><br><span class="line">├── openssl-easyrsa.cnf </span><br><span class="line">├── private</span><br><span class="line">├── reqs</span><br><span class="line">└── safessl-easyrsa.cnf </span><br><span class="line">2 directories, 2 files</span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa build-ca nopass</span></span><br><span class="line">Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars</span><br><span class="line">Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019 </span><br><span class="line">Generating RSA private key, 2048 bit long modulus (2 primes)</span><br><span class="line">...................................................+++++</span><br><span class="line">........+++++</span><br><span class="line">e is 65537 (0x010001)</span><br><span class="line">You are about to be asked to enter information that will be incorporated </span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN. </span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value, </span><br><span class="line">If you enter <span class="string">&#x27;.&#x27;</span>, the field will be left blank. </span><br><span class="line">-----</span><br><span class="line">Common Name (eg: your user, host, or server name) [Easy-RSA CA]: <span class="comment">#接受默认值,直接回车</span></span><br><span class="line">CA creation complete and you may now import and sign cert requests. </span><br><span class="line">Your new CA certificate file <span class="keyword">for</span> publishing is at: </span><br><span class="line">/etc/openvpn/easy-rsa-server/3/pki/ca.crt  <span class="comment">#生成自签名的证书文件</span></span><br><span class="line">[root@centos8 3]<span class="comment">#tree pki </span></span><br><span class="line">pki</span><br><span class="line">├── ca.crt                  <span class="comment">#生成自签名的证书文件</span></span><br><span class="line">├── certs_by_serial</span><br><span class="line">├── index.txt</span><br><span class="line">├── index.txt.attr </span><br><span class="line">├── issued</span><br><span class="line">├── openssl-easyrsa.cnf</span><br><span class="line">├── private</span><br><span class="line">│   └── ca.key              <span class="comment">#生成私钥文件 </span></span><br><span class="line">├── renewed</span><br><span class="line">│   ├── certs_by_serial </span><br><span class="line">│   ├── private_by_serial </span><br><span class="line">│   └── reqs_by_serial </span><br><span class="line">├── reqs</span><br><span class="line">├── revoked</span><br><span class="line">│   ├── certs_by_serial </span><br><span class="line">│   ├── private_by_serial </span><br><span class="line">│   └── reqs_by_serial </span><br><span class="line">├── safessl-easyrsa.cnf </span><br><span class="line">└── serial</span><br><span class="line">12 directories, 7 files </span><br></pre></td></tr></table></figure><h3 id="创建服务端证书申请"><a href="#创建服务端证书申请" class="headerlink" title="创建服务端证书申请"></a>创建服务端证书申请</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cd /etc/openvpn/easy-rsa-server/3 </span></span><br><span class="line">[root@centos8 3]<span class="comment">#pwd</span></span><br><span class="line">/etc/openvpn/easy-rsa-server/3</span><br><span class="line"><span class="comment">#创建服务器证书申请文件，其中server是文件前缀</span></span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa gen-req server nopass</span></span><br><span class="line">Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars </span><br><span class="line">Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019</span><br><span class="line">Generating a RSA private key</span><br><span class="line">..................+++++</span><br><span class="line">................................................................................</span><br><span class="line">....................................................+++++</span><br><span class="line">writing new private key to <span class="string">&#x27;/etc/openvpn/easy-rsa-server/3/pki/easy-rsa- </span></span><br><span class="line"><span class="string">2135.JNDCBg/tmp.6nXb8b&#x27;</span></span><br><span class="line">-----</span><br><span class="line">You are about to be asked to enter information that will be incorporated </span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN. </span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value, </span><br><span class="line">If you enter <span class="string">&#x27;.&#x27;</span>, the field will be left blank. </span><br><span class="line">-----</span><br><span class="line">Common Name (eg: your user, host, or server name) [server]: <span class="comment">#接受Common Name的默认值,直接回车</span></span><br><span class="line">Keypair and certificate request completed. Your files are:</span><br><span class="line">req: /etc/openvpn/easy-rsa-server/3/pki/reqs/server.req          <span class="comment">#生成请求文件 </span></span><br><span class="line">key: /etc/openvpn/easy-rsa-server/3/pki/private/server.key       <span class="comment">#生成私钥文件</span></span><br><span class="line">[root@centos8 3]<span class="comment">#tree pki </span></span><br><span class="line">pki</span><br><span class="line">├── ca.crt</span><br><span class="line">├── certs_by_serial </span><br><span class="line">├── index.txt</span><br><span class="line">├── index.txt.attr </span><br><span class="line">├── issued</span><br><span class="line">├── openssl-easyrsa.cnf </span><br><span class="line">├── private</span><br><span class="line">│   ├── ca.key</span><br><span class="line">│   └── server.key       <span class="comment">#生成私钥文件 </span></span><br><span class="line">├── renewed</span><br><span class="line">│   ├── certs_by_serial </span><br><span class="line">│   ├── private_by_serial </span><br><span class="line">│   └── reqs_by_serial </span><br><span class="line">├── reqs</span><br><span class="line">│   └── server.req      <span class="comment">#生成请求文件 </span></span><br><span class="line">├── revoked</span><br><span class="line">│   ├── certs_by_serial </span><br><span class="line">│   ├── private_by_serial </span><br><span class="line">│   └── reqs_by_serial </span><br><span class="line">├── safessl-easyrsa.cnf </span><br><span class="line">└── serial</span><br><span class="line">12 directories, 9 files</span><br></pre></td></tr></table></figure><h3 id="颁发服务端证书"><a href="#颁发服务端证书" class="headerlink" title="颁发服务端证书"></a>颁发服务端证书</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#将上面server.req的申请,颁发server类型的证书</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cd /etc/openvpn/easy-rsa-server/3 </span></span><br><span class="line">  [root@centos8 3]<span class="comment">#./easyrsa sign server server</span></span><br><span class="line">Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars</span><br><span class="line">Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019</span><br><span class="line">You are about to sign the following certificate.</span><br><span class="line">Please check over the details shown below <span class="keyword">for</span> accuracy. Note that this request </span><br><span class="line">has not been cryptographically verified. Please be sure it came from a trusted </span><br><span class="line"><span class="built_in">source</span> or that you have verified the request checksum with the sender.</span><br><span class="line">Request subject, to be signed as a server certificate <span class="keyword">for</span> 3650 days:   <span class="comment">#可以看到vars文件指定的有效期</span></span><br><span class="line">subject=</span><br><span class="line">    commonName                = server</span><br><span class="line">Type the word <span class="string">&#x27;yes&#x27;</span> to <span class="built_in">continue</span>, or any other input to abort. </span><br><span class="line">  Confirm request details: <span class="built_in">yes</span> <span class="comment">#输入yes回车</span></span><br><span class="line">Using configuration from /etc/openvpn/easy-rsa-server/3/pki/easy-rsa- </span><br><span class="line">2334.MEAQFE/tmp.SIdgaC</span><br><span class="line">Check that the request matches the signature </span><br><span class="line">Signature ok</span><br><span class="line">The Subject<span class="string">&#x27;s Distinguished Name is as follows </span></span><br><span class="line"><span class="string">commonName            :ASN.1 12:&#x27;</span>server<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Certificate is to be certified until Oct 31 09:19:43 2020 GMT (90 days) </span></span><br><span class="line"><span class="string">Write out database with 1 new entries</span></span><br><span class="line"><span class="string">Data Base Updated</span></span><br><span class="line"><span class="string">Certificate created at: /etc/openvpn/easy-rsa-server/3/pki/issued/server.crt #生成服务器证书文件</span></span><br></pre></td></tr></table></figure><h3 id="创建-Diffie-Hellman-密钥"><a href="#创建-Diffie-Hellman-密钥" class="headerlink" title="创建 Diffie-Hellman 密钥"></a>创建 Diffie-Hellman 密钥</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cd /etc/openvpn/easy-rsa-server/3 </span></span><br><span class="line">[root@centos8 3]<span class="comment">#pwd</span></span><br><span class="line">/etc/openvpn/easy-rsa-server/3</span><br><span class="line"><span class="comment">#方法1</span></span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa gen-dh</span></span><br><span class="line">Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars </span><br><span class="line">Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019</span><br><span class="line">Generating DH parameters, 2048 bit long safe prime, generator 2 </span><br><span class="line">This is going to take a long time</span><br><span class="line">................+..................................+............................</span><br><span class="line">..........................++*++*++*++*</span><br><span class="line">.......<span class="comment">#需要等待一会儿</span></span><br><span class="line">DH parameters of size 2048 created at /etc/openvpn/easy-rsa-sever/3/pki/dh.pem </span><br><span class="line"></span><br><span class="line"><span class="comment">#方法2</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#openssl dhparam -out /etc/openvpn/dh2048.pem 2048 </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#ll /etc/openvpn/dh2048.pem</span></span><br><span class="line">-rw-r--r-- 1 root root 424 Aug  3 20:50 /etc/openvpn/dh2048.pem</span><br></pre></td></tr></table></figure><p>服务端证书配置完成</p><h3 id="准备客户端证书环境"><a href="#准备客户端证书环境" class="headerlink" title="准备客户端证书环境"></a>准备客户端证书环境</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cp -r /usr/share/easy-rsa/ /etc/openvpn/easy-rsa-client </span></span><br><span class="line"><span class="comment">#可选</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cp /usr/share/doc/easy-rsa/vars.example /etc/openvpn/easy-rsa-client/3/vars</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cd /etc/openvpn/easy-rsa-client/3/ </span></span><br><span class="line">[root@centos8 3]<span class="comment">#tree</span></span><br><span class="line">.</span><br><span class="line">├── easyrsa</span><br><span class="line">├── openssl-easyrsa.cnf </span><br><span class="line">├── vars</span><br><span class="line">└── x509-types</span><br><span class="line">    ├── ca</span><br><span class="line">    ├── client</span><br><span class="line">    ├── code-signing</span><br><span class="line">    ├── COMMON</span><br><span class="line">    ├── email</span><br><span class="line">    ├── kdc</span><br><span class="line">    ├── server</span><br><span class="line">    └── serverClient</span><br><span class="line">1 directory, 11 files</span><br><span class="line"><span class="comment">#生成证书申请所需目录pki和文件</span></span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa init-pki</span></span><br><span class="line">Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-client/3.0.7/vars </span><br><span class="line">init-pki complete; you may now create a CA or requests.</span><br><span class="line">Your newly created PKI <span class="built_in">dir</span> is: /etc/openvpn/easy-rsa-client/3/pki  <span class="comment">#生成新目录 </span></span><br><span class="line">[root@centos8 3]<span class="comment">#tree</span></span><br><span class="line">.</span><br><span class="line">├── easyrsa</span><br><span class="line">├── openssl-easyrsa.cnf</span><br><span class="line">├── pki                                 <span class="comment">#生成新目录 </span></span><br><span class="line">│   ├── openssl-easyrsa.cnf</span><br><span class="line">│   ├── private </span><br><span class="line">│   ├── reqs</span><br><span class="line">│   └── safessl-easyrsa.cnf </span><br><span class="line">├── vars</span><br><span class="line">└── x509-types</span><br><span class="line">    ├── ca</span><br><span class="line">    ├── client</span><br><span class="line">    ├── code-signing </span><br><span class="line">    ├── COMMON</span><br><span class="line">    ├── email</span><br><span class="line">    ├── kdc</span><br><span class="line">    ├── server</span><br><span class="line">    └── serverClient </span><br><span class="line">4 directories, 13 files</span><br></pre></td></tr></table></figure><h3 id="创建客户端证书申请"><a href="#创建客户端证书申请" class="headerlink" title="创建客户端证书申请"></a>创建客户端证书申请</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cd /etc/openvpn/easy-rsa-client/3 </span></span><br><span class="line"><span class="comment">#生成客户端用户的证书申请</span></span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa  gen-req USERNAME nopass</span></span><br><span class="line">Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-client/3.0.7/vars </span><br><span class="line">Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019</span><br><span class="line">Generating a RSA private key</span><br><span class="line">.......................................................+++++</span><br><span class="line">................................................................................</span><br><span class="line">.........................+++++</span><br><span class="line">writing new private key to <span class="string">&#x27;/etc/openvpn/easy-rsa-client/3/pki/easy-rsa- </span></span><br><span class="line"><span class="string">3467.v5FPPS/tmp.GsttV6&#x27;</span></span><br><span class="line">-----</span><br><span class="line">You are about to be asked to enter information that will be incorporated </span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN. </span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value, </span><br><span class="line">If you enter <span class="string">&#x27;.&#x27;</span>, the field will be left blank. </span><br><span class="line">-----</span><br><span class="line">Common Name (eg: your user, host, or server name) [USERNAME]:  <span class="comment">#接受默认值,直接回车</span></span><br><span class="line">Keypair and certificate request completed. Your files are:</span><br><span class="line">req: /etc/openvpn/easy-rsa-client/3/pki/reqs/USERNAME.req      <span class="comment">#私钥文件 </span></span><br><span class="line">key: /etc/openvpn/easy-rsa-client/3/pki/private/USERNAME.key    <span class="comment">#证书申请文件</span></span><br><span class="line"><span class="comment">#生成两个新文件</span></span><br><span class="line">[root@centos8 3]<span class="comment">#tree</span></span><br><span class="line">.</span><br><span class="line">├── easyrsa</span><br><span class="line">├── openssl-easyrsa.cnf </span><br><span class="line">├── pki</span><br><span class="line">│   ├── openssl-easyrsa.cnf </span><br><span class="line">│   ├── private</span><br><span class="line">│   │   └── USERNAME.key  <span class="comment">#私钥文件 </span></span><br><span class="line">│   ├── reqs</span><br><span class="line">│   │   └── USERNAME.req  <span class="comment">#证书申请文件 </span></span><br><span class="line">│   └── safessl-easyrsa.cnf</span><br><span class="line">├── vars</span><br><span class="line">└── x509-types </span><br><span class="line">    ├── ca</span><br><span class="line">    ├── client</span><br><span class="line">    ├── code-signing </span><br><span class="line">    ├── COMMON</span><br><span class="line">    ├── email</span><br><span class="line">    ├── kdc</span><br><span class="line">    ├── server</span><br><span class="line">    └── serverClient </span><br><span class="line">4 directories, 15 files</span><br></pre></td></tr></table></figure><h3 id="签发客户端证书"><a href="#签发客户端证书" class="headerlink" title="签发客户端证书"></a>签发客户端证书</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cd /etc/openvpn/easy-rsa-server/3 </span></span><br><span class="line"><span class="comment">#将客户端证书请求文件复制到CA的工作目录</span></span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa import-req /etc/openvpn/easy-rsa-client/3/pki/reqs/USERNAME.req USERNAME</span></span><br><span class="line">Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars </span><br><span class="line">Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019</span><br><span class="line">The request has been successfully imported with a short name of: USERNAME </span><br><span class="line">You may now use this name to perform signing operations on this request.</span><br><span class="line">[root@centos8 3]<span class="comment">#tree pki </span></span><br><span class="line">pki</span><br><span class="line">├── ca.crt</span><br><span class="line">├── certs_by_serial</span><br><span class="line">│   └── EDAEBAB8D65066D307AE58ADC1A56682.pem </span><br><span class="line">├── dh.pem</span><br><span class="line">├── index.txt</span><br><span class="line">├── index.txt.attr</span><br><span class="line">├── index.txt.attr.old </span><br><span class="line">├── index.txt.old</span><br><span class="line">├── issued</span><br><span class="line">│   └── server.crt</span><br><span class="line">├── openssl-easyrsa.cnf </span><br><span class="line">├── private</span><br><span class="line">│   ├── ca.key </span><br><span class="line">│   └── server.key </span><br><span class="line">├── renewed</span><br><span class="line">│   ├── certs_by_serial </span><br><span class="line">│   ├── private_by_serial </span><br><span class="line">│   └── reqs_by_serial </span><br><span class="line">├── reqs</span><br><span class="line">│   ├── server.req</span><br><span class="line">│   └── USERNAME.req   <span class="comment">#导入文件 </span></span><br><span class="line">├── revoked</span><br><span class="line">│   ├── certs_by_serial </span><br><span class="line">│   ├── private_by_serial </span><br><span class="line">│   └── reqs_by_serial </span><br><span class="line">├── safessl-easyrsa.cnf </span><br><span class="line">├── serial</span><br><span class="line">└── serial.old</span><br><span class="line">12 directories, 16 files</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改给客户端颁发的证书的有效期</span></span><br><span class="line">[root@centos8 3]<span class="comment">#vim vars</span></span><br><span class="line"><span class="comment">#建议修改给客户端颁发证书的有效期,可适当减少,比如:90天 </span></span><br><span class="line"><span class="comment">#set_var EASYRSA_CERT_EXPIRE    825</span></span><br><span class="line"><span class="comment">#将上面行修改为下面</span></span><br><span class="line">set_var EASYRSA_CERT_EXPIRE 90 </span><br><span class="line"><span class="comment">#签发客户端证书</span></span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa sign client USERNAME</span></span><br><span class="line">Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars </span><br><span class="line">Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019</span><br><span class="line">You are about to sign the following certificate.</span><br><span class="line">Please check over the details shown below <span class="keyword">for</span> accuracy. Note that this request </span><br><span class="line">has not been cryptographically verified. Please be sure it came from a trusted </span><br><span class="line"><span class="built_in">source</span> or that you have verified the request checksum with the sender.</span><br><span class="line">Request subject, to be signed as a client certificate <span class="keyword">for</span> 90 days: </span><br><span class="line">subject=</span><br><span class="line">    commonName                = USERNAME</span><br><span class="line">Type the word <span class="string">&#x27;yes&#x27;</span> to <span class="built_in">continue</span>, or any other input to abort.</span><br><span class="line">  Confirm request details: <span class="built_in">yes</span>                      <span class="comment">#输入yes后回车 </span></span><br><span class="line">Using configuration from /etc/openvpn/easy-rsa-server/3/pki/easy-rsa- </span><br><span class="line">3617.XN7fIU/tmp.P7NKo8</span><br><span class="line">Check that the request matches the signature </span><br><span class="line">Signature ok</span><br><span class="line">The Subject<span class="string">&#x27;s Distinguished Name is as follows </span></span><br><span class="line"><span class="string">commonName            :ASN.1 12:&#x27;</span>USERNAME<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Certificate is to be certified until Oct 31 15:38:15 2020 GMT (90 days) </span></span><br><span class="line"><span class="string">Write out database with 1 new entries</span></span><br><span class="line"><span class="string">Data Base Updated</span></span><br><span class="line"><span class="string">Certificate created at: /etc/openvpn/easy-rsa- </span></span><br><span class="line"><span class="string">server/3/pki/issued/USERNAME.crt #证书文件</span></span><br><span class="line"><span class="string">[root@centos8 3]#tree pki </span></span><br><span class="line"><span class="string">pki</span></span><br><span class="line"><span class="string">├── ca.crt</span></span><br><span class="line"><span class="string">├── certs_by_serial</span></span><br><span class="line"><span class="string">│   ├── 5FE114ACC4FE6AB89D17E1B0EECF2B78.pem </span></span><br><span class="line"><span class="string">│   └── EDAEBAB8D65066D307AE58ADC1A56682.pem </span></span><br><span class="line"><span class="string">├── dh.pem</span></span><br><span class="line"><span class="string">├── index.txt</span></span><br><span class="line"><span class="string">├── index.txt.attr </span></span><br><span class="line"><span class="string">├── index.txt.attr.old</span></span><br><span class="line"><span class="string">├── index.txt.old </span></span><br><span class="line"><span class="string">├── issued</span></span><br><span class="line"><span class="string">│   ├── server.crt</span></span><br><span class="line"><span class="string">│   └── USERNAME.crt          #生成客户端证书</span></span><br><span class="line"><span class="string">├── openssl-easyrsa.cnf</span></span><br><span class="line"><span class="string">├── private</span></span><br><span class="line"><span class="string">│   ├── ca.key </span></span><br><span class="line"><span class="string">│   └── server.key </span></span><br><span class="line"><span class="string">├── renewed</span></span><br><span class="line"><span class="string">│   ├── certs_by_serial </span></span><br><span class="line"><span class="string">│   ├── private_by_serial </span></span><br><span class="line"><span class="string">│   └── reqs_by_serial </span></span><br><span class="line"><span class="string">├── reqs</span></span><br><span class="line"><span class="string">│   ├── server.req</span></span><br><span class="line"><span class="string">│   └── USERNAME.req </span></span><br><span class="line"><span class="string">├── revoked</span></span><br><span class="line"><span class="string">│   ├── certs_by_serial </span></span><br><span class="line"><span class="string">│   ├── private_by_serial </span></span><br><span class="line"><span class="string">│   └── reqs_by_serial </span></span><br><span class="line"><span class="string">├── safessl-easyrsa.cnf </span></span><br><span class="line"><span class="string">├── serial</span></span><br><span class="line"><span class="string">└── serial.old</span></span><br><span class="line"><span class="string">12 directories, 18 files</span></span><br></pre></td></tr></table></figure><p>如果需要颁发的客户端证书较多,可以使用下面脚本实现客户端证书的批量颁发 </p><p><strong>客户端证书自动颁发脚本</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cat openvpn-user-crt.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="built_in">read</span> -p <span class="string">&quot;请输入用户的姓名拼音(如:<span class="variable">$&#123;NAME&#125;</span>): &quot;</span> NAME</span><br><span class="line"><span class="built_in">cd</span> /etc/openvpn/easy-rsa-client/3</span><br><span class="line">./easyrsa  gen-req <span class="variable">$&#123;NAME&#125;</span> nopass &lt;&lt;<span class="string">EOF </span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="built_in">cd</span> /etc/openvpn/easy-rsa-server/3</span><br><span class="line">./easyrsa import-req /etc/openvpn/easy-rsa-client/3/pki/reqs/<span class="variable">$&#123;NAME&#125;</span>.req <span class="variable">$&#123;NAME&#125;</span> </span><br><span class="line">./easyrsa sign client <span class="variable">$&#123;NAME&#125;</span> &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">yes</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h3 id="将CA和服务器证书相关文件复制到服务器相应的目录"><a href="#将CA和服务器证书相关文件复制到服务器相应的目录" class="headerlink" title="将CA和服务器证书相关文件复制到服务器相应的目录"></a>将CA和服务器证书相关文件复制到服务器相应的目录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#mkdir /etc/openvpn/certs</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cp /etc/openvpn/easy-rsa-server/3/pki/ca.crt /etc/openvpn/certs/</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cp /etc/openvpn/easy-rsa-server/3/pki/issued/server.crt /etc/openvpn/certs/</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cp /etc/openvpn/easy-rsa-server/3/pki/private/server.key /etc/openvpn/certs/        </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cp /etc/openvpn/easy-rsa-server/3/pki/dh.pem /etc/openvpn/certs/</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#ll /etc/openvpn/certs/ </span></span><br><span class="line">total 20</span><br><span class="line">-rw------- 1 root root 1204 Aug  3 20:34 ca.crt </span><br><span class="line">-rw------- 1 root root  424 Aug  3 20:35 dh.pem </span><br><span class="line">-rw------- 1 root root 4608 Aug  3 20:34 server.crt </span><br><span class="line">-rw------- 1 root root 1704 Aug  3 20:35 server.key</span><br></pre></td></tr></table></figure><h3 id="将客户端私钥与证书相关文件复制到服务器相关的目录"><a href="#将客户端私钥与证书相关文件复制到服务器相关的目录" class="headerlink" title="将客户端私钥与证书相关文件复制到服务器相关的目录"></a>将客户端私钥与证书相关文件复制到服务器相关的目录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#mkdir /etc/openvpn/client/USERNAME/</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#find /etc/openvpn/  -name &quot;USERNAME.key&quot; -o -name &quot;USERNAME.crt&quot; -o -name ca.crt</span></span><br><span class="line">/etc/openvpn/easy-rsa-client/3.0.7/pki/private/USERNAME.key </span><br><span class="line">/etc/openvpn/easy-rsa-server/3.0.7/pki/issued/USERNAME.crt </span><br><span class="line">/etc/openvpn/easy-rsa-server/3.0.7/pki/ca.crt </span><br><span class="line">/etc/openvpn/certs/ca.crt</span><br><span class="line">[root@centos8 ~]<span class="comment">#find /etc/openvpn/ \( -name &quot;USERNAME.key&quot; -o -name &quot;USERNAME.crt&quot; -o -name ca.crt \) -exec cp &#123;&#125; /etc/openvpn/client/USERNAME \;</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#ll /etc/openvpn/client/USERNAME/ </span></span><br><span class="line">total 16</span><br><span class="line">-rw------- 1 root root 1204 Aug  3 21:05 ca.crt</span><br><span class="line">-rw------- 1 root root 4506 Aug  3 21:05 USERNAME.crt </span><br><span class="line">-rw------- 1 root root 1704 Aug  3 21:05 USERNAME.key</span><br></pre></td></tr></table></figure><h3 id="准备-OpenVPN-服务器配置文件"><a href="#准备-OpenVPN-服务器配置文件" class="headerlink" title="准备 OpenVPN 服务器配置文件"></a>准备 OpenVPN 服务器配置文件</h3><p><strong>修改服务器端配置文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#vim /etc/openvpn/server.conf</span></span><br></pre></td></tr></table></figure><p><strong>服务器端配置文件说明</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#server.conf文件中以#或;开头的行都为注释</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#grep -Ev &quot;^#|^$&quot; /etc/openvpn/server.conf </span></span><br><span class="line">;<span class="built_in">local</span> a.b.c.d  <span class="comment">#本机监听IP,默认为本机所有IP</span></span><br><span class="line">port 1194       <span class="comment">#端口</span></span><br><span class="line">;proto tcp      <span class="comment">#协议,生产推荐使用TCP </span></span><br><span class="line">proto udp       <span class="comment">#默认协议</span></span><br><span class="line">;dev tap   <span class="comment">#创建一个以太网隧道，以太网使用tap,一个tap设备允许完整的以太网帧通过Openvpn隧道，可提供非ip协议的支持，比如IPX协议和AppleTalk协议,tap等同于一个以太网设备，它操作第二层数据包如以太网数据帧。</span></span><br><span class="line">dev tun    <span class="comment">#创建一个路由IP隧道，生产推存使用tun.互联网使用tun,一个tun设备大多时候，被用于基于IP协议的通讯。tun模拟了网络层设备，操作第三层数据包比如IP数据封包。</span></span><br><span class="line">;dev-node MyTap  <span class="comment">#TAP-Win32适配器。非windows不需要配置 </span></span><br><span class="line">ca  ca.crt       <span class="comment">#ca证书文件</span></span><br><span class="line">cert server.crt  <span class="comment">#服务器证书文件 </span></span><br><span class="line">key server.key   <span class="comment">#服务器私钥文件 </span></span><br><span class="line">dh dh2048.pem    <span class="comment">#dh参数文件 </span></span><br><span class="line">;topology subnet</span><br><span class="line">server 10.8.0.0 255.255.255.0  <span class="comment">#客户端连接后分配IP的地址池，服务器默认会占用第一个IP10.8.0.1将做为客户端的网关</span></span><br><span class="line">ifconfig-pool-persist ipp.txt  <span class="comment">#为客户端分配固定IP，不需要配置,建议注释</span></span><br><span class="line">;server-bridge 10.8.0.4 255.255.255.0 10.8.0.50 10.8.0.100  <span class="comment">#配置网桥模式，不需要配置,建议注释</span></span><br><span class="line">;server-bridge</span><br><span class="line">;push <span class="string">&quot;route 192.168.10.0 255.255.255.0&quot;</span>  <span class="comment">#给客户端生成的到达服务器后面网段的静态路由，下一跳为openvpn服务器的10.8.0.1</span></span><br><span class="line">;push <span class="string">&quot;route 192.168.20.0 255.255.255.0&quot;</span>  <span class="comment">#推送路由信息到客户端，以允许客户端能够连接到服务器背后的其它私有子网</span></span><br><span class="line">;client-config-dir ccd              <span class="comment">#为指定的客户端添加路由，此路由通常是客户端后面的内网网段而不是服务端的，也不需要设置</span></span><br><span class="line">;route 192.168.40.128 255.255.255.248 </span><br><span class="line">;client-config-dir ccd    </span><br><span class="line">;route 10.9.0.0 255.255.255.252</span><br><span class="line">;learn-address ./script                <span class="comment">#运行外部脚本，创建不同组的iptables规则，无需配置</span></span><br><span class="line">;push <span class="string">&quot;redirect-gateway def1 bypass-dhcp&quot;</span> <span class="comment">#启用后，客户端所有流量都将通过VPN服务器，因此生产一般无需配置此项</span></span><br><span class="line">;push <span class="string">&quot;dhcp-option DNS 208.67.222.222&quot;</span>   <span class="comment">#推送DNS服务器，不需要配置 </span></span><br><span class="line">;push <span class="string">&quot;dhcp-option DNS 208.67.220.220&quot;</span></span><br><span class="line">;client-to-client                       <span class="comment">#允许不同的client直接通信,不安全,生产环境一般无需要配置</span></span><br><span class="line">;duplicate-cn                           <span class="comment">#多个用户共用一个证书，一般用于测试环境，生产环境都是一个用户一个证书,无需开启</span></span><br><span class="line">keepalive 10 120         <span class="comment">#设置服务端检测的间隔和超时时间，默认为每10秒ping一次，如果120秒没有回应则认为对方已经down</span></span><br><span class="line">tls-auth ta.key 0       <span class="comment">#访止DoS等攻击的安全增强配置,可以使用以下命令来生成：openvpn -- </span></span><br><span class="line">genkey --secret ta.key <span class="comment">#服务器和每个客户端都需要拥有该密钥的一个拷贝。第二个参数在服务器端应该为’0’，在客户端应该为’1’</span></span><br><span class="line">cipher AES-256-CBC  <span class="comment">#加密算法</span></span><br><span class="line">;compress lz4-v2    <span class="comment">#启用Openvpn2.4.X新版压缩算法</span></span><br><span class="line">;push <span class="string">&quot;compress lz4-v2&quot;</span>   <span class="comment">#推送客户端使用新版压缩算法,和下面的comp-lzo不要同时使用</span></span><br><span class="line">;comp-lzo          <span class="comment">#旧户端兼容的压缩配置，需要客户端配置开启压缩,openvpn2.4.X等新版可以不用开启</span></span><br><span class="line">;max-clients 100   <span class="comment">#最大客户端数</span></span><br><span class="line">;user nobody         <span class="comment">#运行openvpn服务的用户和组 </span></span><br><span class="line">;group nobody</span><br><span class="line">persist-key          <span class="comment">#重启VPN服务时默认会重新读取key文件，开启此配置后保留使用第一次的key文件,生产环境无需开启</span></span><br><span class="line">persist-tun          <span class="comment">#启用此配置后,当重启vpn服务时，一直保持tun或者tap设备是up的，否则会先down然后再up,生产环境无需开启</span></span><br><span class="line">status openvpn-status.log <span class="comment">#openVPN状态记录文件，每分钟会记录一次</span></span><br><span class="line">;<span class="built_in">log</span>         openvpn.log   <span class="comment">#第一种日志记录方式,并指定日志路径，log会在openvpn启动的时候清空日志文件,不建议使用</span></span><br><span class="line">;log-append  openvpn.log   <span class="comment">#第二种日志记录方式,并指定日志路径，重启openvpn后在之前的日志后面追加新的日志,生产环境建议使用</span></span><br><span class="line">verb 3                   <span class="comment">#设置日志级别，0-9，级别越高记录的内容越详细,0 表示静默运行，只记录致命错误,4 表示合理的常规用法,5 和 6 可以帮助调试连接错误。9 表示极度冗余，输出非常详细的日志信息</span></span><br><span class="line">;mute 20                 <span class="comment">#相同类别的信息只有前20条会输出到日志文件中</span></span><br><span class="line">explicit-exit-notify 1   <span class="comment">#通知客户端，在服务端重启后自动重新连接，仅能用于udp模式，tcp模式不需要配置即可实现断开重新连接,且开启此项后tcp配置后将导致openvpn服务无法启动,所以tcp时必须不能开启此项</span></span><br></pre></td></tr></table></figure><p><strong>修改服务器端配置文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#vim /etc/openvpn/server.conf</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#grep &#x27;^[a-Z].*&#x27; /etc/openvpn/server.conf </span></span><br><span class="line">port 1194</span><br><span class="line">proto tcp</span><br><span class="line">dev tun</span><br><span class="line">ca /etc/openvpn/certs/ca.crt</span><br><span class="line">cert /etc/openvpn/certs/server.crt</span><br><span class="line">key /etc/openvpn/certs/server.key  <span class="comment"># This file should be kept secret</span></span><br><span class="line">dh /etc/openvpn/certs/dh.pem</span><br><span class="line">server 10.8.0.0 255.255.255.0</span><br><span class="line">push <span class="string">&quot;route 10.10.0.0 255.255.255.0&quot;</span></span><br><span class="line">keepalive 10 120</span><br><span class="line">cipher AES-256-CBC</span><br><span class="line">compress lz4-v2</span><br><span class="line">push <span class="string">&quot;compress lz4-v2&quot;</span></span><br><span class="line">max-clients 2048</span><br><span class="line">user openvpn</span><br><span class="line">group openvpn</span><br><span class="line">status /var/log/openvpn/openvpn-status.log</span><br><span class="line">log-append   /var/log/openvpn/openvpn.log</span><br><span class="line">verb 3</span><br><span class="line">mute 20</span><br><span class="line"><span class="comment">#准备目志相关目录</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#getent passwd openvpn</span></span><br><span class="line">openvpn:x:993:990:OpenVPN:/etc/openvpn:/sbin/nologin </span><br><span class="line">[root@centos8 ~]<span class="comment">#mkdir /var/log/openvpn</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#chown openvpn.openvpn /var/log/openvpn </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#ll -d /var/log/openvpn</span></span><br><span class="line">drwxr-xr-x 2 openvpn openvpn 6 Aug  3 23:07 /var/log/openvpn</span><br></pre></td></tr></table></figure><h3 id="准备-iptables-规则和内核参数"><a href="#准备-iptables-规则和内核参数" class="headerlink" title="准备 iptables 规则和内核参数"></a>准备 iptables 规则和内核参数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在服务器开启ip_forward转发功能</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#echo net.ipv4.ip_forward = 1 &gt;&gt; /etc/sysctl.conf </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#sysctl -p</span></span><br><span class="line">net.ipv4.ip_forward = 1 </span><br><span class="line"><span class="comment">#添加SNAT规则</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#echo &#x27;iptables -t nat -A POSTROUTING -s 10.10.0.0/24  -j MASQUERADE&#x27; &gt;&gt; /etc/rc.d/rc.local</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#chmod +x /etc/rc.d/rc.local </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#/etc/rc.d/rc.local</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#iptables -vnL</span></span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination </span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination </span><br><span class="line">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination</span><br><span class="line">[root@centos8 ~]<span class="comment">#iptables -vnL -t nat</span></span><br><span class="line">Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination </span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination </span><br><span class="line">Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination </span><br><span class="line">    0     0 MASQUERADE  all  --  *      *       10.10.0.0/24          0.0.0.0/0  </span><br><span class="line">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination</span><br></pre></td></tr></table></figure><h3 id="启动-OpenVPN-服务"><a href="#启动-OpenVPN-服务" class="headerlink" title="启动 OpenVPN 服务"></a>启动 OpenVPN 服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment">#rpm -ql openvpn|grep systemd </span></span><br><span class="line">/usr/lib/systemd/system/openvpn-client@.service </span><br><span class="line">/usr/lib/systemd/system/openvpn-server@.service </span><br><span class="line">/usr/lib/systemd/system/openvpn@.service </span><br><span class="line">/usr/share/doc/openvpn-2.4.9/README.systemd</span><br><span class="line"><span class="comment">#CentOS8 缺失unit文件,从CentOS7复制文件</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#rpm -ql openvpn|grep systemd </span></span><br><span class="line">/usr/lib/systemd/system/openvpn-client@.service </span><br><span class="line">/usr/lib/systemd/system/openvpn-server@.service </span><br><span class="line">/usr/share/doc/openvpn/README.systemd</span><br><span class="line">[root@centos7 ~]<span class="comment">#cat /usr/lib/systemd/system/openvpn@.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=OpenVPN Robust And Highly Flexible Tunneling Application On %I </span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=notify </span><br><span class="line">PrivateTmp=<span class="literal">true</span></span><br><span class="line">ExecStart=/usr/sbin/openvpn --<span class="built_in">cd</span> /etc/openvpn/ --config %i.conf </span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">[root@centos7 ~]<span class="comment">#scp /lib/systemd/system/openvpn@.service 10.10.0.81:/lib/systemd/system/</span></span><br><span class="line"><span class="comment">#启动OpenVPN服务,注意service名称和文件名不一致 </span></span><br><span class="line">[root@centos8 openvpn]<span class="comment">#systemctl daemon-reload</span></span><br><span class="line">[root@centos8 openvpn]<span class="comment">#systemctl enable --now openvpn@server</span></span><br></pre></td></tr></table></figure><h3 id="查看服务状态"><a href="#查看服务状态" class="headerlink" title="查看服务状态"></a>查看服务状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 openvpn]<span class="comment">#systemctl status openvpn@server</span></span><br><span class="line">● openvpn@server.service - OpenVPN Robust And Highly Flexible Tunneling Application On server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/openvpn@.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Thu 2022-05-19 16:25:43 CST; 3min 49s ago</span><br><span class="line"> Main PID: 7696 (openvpn)</span><br><span class="line">   Status: <span class="string">&quot;Initialization Sequence Completed&quot;</span></span><br><span class="line">    Tasks: 1 (<span class="built_in">limit</span>: 4724)</span><br><span class="line">   Memory: 2.0M</span><br><span class="line">   CGroup: /system.slice/system-openvpn.slice/openvpn@server.service</span><br><span class="line">           └─7696 /usr/sbin/openvpn --<span class="built_in">cd</span> /etc/openvpn/ --config server.conf</span><br><span class="line">Aug 04 00:30:12 centos8.localdomain systemd[1]: Starting OpenVPN Robust And Highly Flexible Tunneling Application &gt;</span><br><span class="line">Aug 04 00:30:12 centos8.localdomain systemd[1]: Started OpenVPN Robust And Highly Flexible Tunneling Application</span><br><span class="line"><span class="comment">#注意端口号</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#ss -ntlp</span></span><br><span class="line">State  Recv-Q  Send-Q   Local Address:Port   Peer Address:Port Process                                                   </span><br><span class="line">LISTEN 0       32             0.0.0.0:1194        0.0.0.0:*     <span class="built_in">users</span>:((<span class="string">&quot;openvpn&quot;</span>,pid=7696,fd=8))                        </span><br><span class="line">LISTEN 0       128            0.0.0.0:111         0.0.0.0:*     <span class="built_in">users</span>:((<span class="string">&quot;rpcbind&quot;</span>,pid=887,fd=4),(<span class="string">&quot;systemd&quot;</span>,pid=1,fd=34)) </span><br><span class="line">LISTEN 0       128            0.0.0.0:22          0.0.0.0:*     <span class="built_in">users</span>:((<span class="string">&quot;sshd&quot;</span>,pid=938,fd=4))                            </span><br><span class="line">LISTEN 0       128               [::]:111            [::]:*     <span class="built_in">users</span>:((<span class="string">&quot;rpcbind&quot;</span>,pid=887,fd=6),(<span class="string">&quot;systemd&quot;</span>,pid=1,fd=36)) </span><br><span class="line">LISTEN 0       128               [::]:22             [::]:*     <span class="built_in">users</span>:((<span class="string">&quot;sshd&quot;</span>,pid=938,fd=6))     </span><br><span class="line">[root@centos8 ~]<span class="comment">#ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 </span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever </span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:8a:51:21 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.0.0.8/24 brd 10.0.0.255 scope global noprefixroute eth0 </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fe8a:5121/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: tun0: &lt;POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state </span><br><span class="line">UNKNOWN group default qlen 100</span><br><span class="line">    <span class="built_in">link</span>/none</span><br><span class="line">    inet 10.8.0.1 peer 10.8.0.2/32 scope global tun0 </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::c8db:a8ca:b492:a3e0/64 scope <span class="built_in">link</span> stable-privacy </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[root@centos8 ~]<span class="comment">#route -n </span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         172.30.0.253    0.0.0.0         UG    100    0        0 eth0</span><br><span class="line">10.8.0.0        10.8.0.2        255.255.255.0   UG    0      0        0 tun0</span><br><span class="line">10.8.0.2        0.0.0.0         255.255.255.255 UH    0      0        0 tun0</span><br><span class="line">172.30.0.0      0.0.0.0         255.255.255.0   U     100    0        0 eth0</span><br></pre></td></tr></table></figure><h3 id="准备-OpenVPN-客户端配置文件"><a href="#准备-OpenVPN-客户端配置文件" class="headerlink" title="准备 OpenVPN 客户端配置文件"></a>准备 OpenVPN 客户端配置文件</h3><p><strong>客户端默认范例配置文件说明</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#grep &#x27;^[[:alpha:]].*&#x27; /usr/share/doc/openvpn/sample/sample-config-files/client.conf</span></span><br><span class="line">client     <span class="comment">#声明自己是个客户端</span></span><br><span class="line">dev tun    <span class="comment">#接口类型，必须和服务端保持一致 </span></span><br><span class="line">proto udp  <span class="comment">#协议类型，必须和服务端保持一致</span></span><br><span class="line">remote my-server-1 1194 <span class="comment">#server端的ip和端口，可以写域名但是需要可以解析成IP</span></span><br><span class="line">resolv-retry infinite   <span class="comment">#如果是写的server端的域名，那么就始终解析，如果域名发生变化，会重新连接到新的域名对应的IP</span></span><br><span class="line">nobind                  <span class="comment">#本机不绑定监听端口，客户端是随机打开端口连接到服务端的1194 </span></span><br><span class="line">persist-key</span><br><span class="line">persist-tun </span><br><span class="line">ca ca.crt </span><br><span class="line">cert client.crt </span><br><span class="line">key client.key</span><br><span class="line">remote-cert-tls server  <span class="comment">#指定采用服务器证书校验方式 </span></span><br><span class="line">tls-auth ta.key 1</span><br><span class="line">cipher AES-256-CBC </span><br><span class="line">verb 3</span><br></pre></td></tr></table></figure><p><strong>生成客户端用户的配置文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#生成客户端文件,文件后缀必须为.ovpn</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#grep &#x27;^[[:alpha:]].*&#x27; /usr/share/doc/openvpn/sample/sample-config-files/client.conf &gt; /etc/openvpn/client/USERNAME/client.ovpn</span></span><br><span class="line"><span class="comment">#修改配置文件,内容如下</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#vim /etc/openvpn/client/USERNAME/client.ovpn </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cat /etc/openvpn/client/USERNAME/client.ovpn </span></span><br><span class="line">client</span><br><span class="line">dev tun </span><br><span class="line">proto tcp</span><br><span class="line">remote  10.10.0.81  1194              <span class="comment">#生产中为OpenVPN公网IP </span></span><br><span class="line">resolv-retry infinite</span><br><span class="line">nobind</span><br><span class="line"><span class="comment">#persist-key </span></span><br><span class="line"><span class="comment">#persist-tun</span></span><br><span class="line">ca ca.crt</span><br><span class="line">cert USERNAME.crt </span><br><span class="line">key USERNAME.key </span><br><span class="line">remote-cert-tls server</span><br><span class="line"><span class="comment">#tls-auth ta.key 1</span></span><br><span class="line">cipher AES-256-CBC</span><br><span class="line">verb 3                              <span class="comment">#此值不能随意指定,否则无法通信</span></span><br><span class="line">compress lz4-v2                     <span class="comment">#此项在OpenVPN2.4.X版本使用,需要和服务器端保持一致,如不指定,默认使用comp-lz压缩</span></span><br></pre></td></tr></table></figure><h3 id="完整安装脚本"><a href="#完整安装脚本" class="headerlink" title="完整安装脚本"></a>完整安装脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#================================================================</span></span><br><span class="line"><span class="comment">#   </span></span><br><span class="line"><span class="comment">#   文件名称：openvpn-install.sh</span></span><br><span class="line"><span class="comment">#   创 建 者：Tdison</span></span><br><span class="line"><span class="comment">#   创建日期：2022年05月22日</span></span><br><span class="line"><span class="comment">#   描    述：</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#================================================================</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;正在运行openvpn安装脚本。&quot;</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line">sudo sed -i.bak <span class="string">&#x27;s/SELINUX=enforcing/SELINUX=disabled/&#x27;</span> /etc/selinux/config</span><br><span class="line">setenforce 0 &gt; /dev/null</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;net.ipv4.ip_forward = 1&#x27;</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line">yum install openvpn -y </span><br><span class="line">yum install easy-rsa -y </span><br><span class="line"></span><br><span class="line"><span class="comment">#修改服务端配置</span></span><br><span class="line"><span class="built_in">cp</span> /usr/share/doc/openvpn/sample/sample-config-files/server.conf /etc/openvpn/</span><br><span class="line"><span class="built_in">cp</span> -r /usr/share/easy-rsa/ /etc/openvpn/easy-rsa-server </span><br><span class="line"><span class="built_in">cp</span> /usr/share/doc/easy-rsa/vars.example /etc/openvpn/easy-rsa-server/3/vars</span><br><span class="line">sed -ri <span class="string">&#x27;s/#set_var EASYRSA_CA_EXPIRE[[:space:]]+3650/set_var EASYRSA_CA_EXPIRE       36500/&#x27;</span> /etc/openvpn/easy-rsa-server/3/vars</span><br><span class="line">sed -ri <span class="string">&#x27;s/#set_var EASYRSA_CERT_EXPIRE[[:space:]]+825/set_var EASYRSA_CERT_EXPIRE       3650/&#x27;</span> /etc/openvpn/easy-rsa-server/3/vars </span><br><span class="line"><span class="built_in">cd</span> /etc/openvpn/easy-rsa-server/3/ &amp;&amp; ./easyrsa init-pki &amp;&amp; ./easyrsa build-ca nopass &amp;&amp; ./easyrsa gen-req server nopass &amp;&amp; ./easyrsa sign server server &amp;&amp; ./easyrsa gen-dh &amp;&amp; ./easyrsa gen-crl</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改客户端配置</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">read</span> -p <span class="string">&quot;请输入用户名: &quot;</span> USERNAME</span><br><span class="line"><span class="built_in">cp</span> -r /usr/share/easy-rsa/ /etc/openvpn/easy-rsa-client </span><br><span class="line"><span class="built_in">cp</span> /usr/share/doc/easy-rsa/vars.example /etc/openvpn/easy-rsa-client/3/vars</span><br><span class="line"><span class="built_in">cd</span> /etc/openvpn/easy-rsa-client/3/ &amp;&amp; ./easyrsa init-pki &amp;&amp; ./easyrsa  gen-req <span class="variable">$USERNAME</span> nopass </span><br><span class="line"><span class="built_in">cd</span> /etc/openvpn/easy-rsa-server/3/ &amp;&amp; ./easyrsa import-req /etc/openvpn/easy-rsa-client/3/pki/reqs/<span class="variable">$USERNAME</span>.req <span class="variable">$USERNAME</span></span><br><span class="line">sed -ri <span class="string">&#x27;s/set_var EASYRSA_CERT_EXPIRE[[:space:]]+3650/set_var EASYRSA_CERT_EXPIRE       90/&#x27;</span> /etc/openvpn/easy-rsa-server/3/vars </span><br><span class="line"><span class="built_in">cd</span> /etc/openvpn/easy-rsa-server/3/ &amp;&amp; ./easyrsa sign client <span class="variable">$USERNAME</span> </span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> /etc/openvpn/certs</span><br><span class="line"><span class="built_in">cp</span> /etc/openvpn/easy-rsa-server/3/pki/ca.crt /etc/openvpn/certs/</span><br><span class="line"><span class="built_in">cp</span> /etc/openvpn/easy-rsa-server/3/pki/issued/server.crt /etc/openvpn/certs/</span><br><span class="line"><span class="built_in">cp</span> /etc/openvpn/easy-rsa-server/3/pki/private/server.key /etc/openvpn/certs/</span><br><span class="line"><span class="built_in">cp</span> /etc/openvpn/easy-rsa-server/3/pki/dh.pem /etc/openvpn/certs/</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> /etc/openvpn/client/<span class="variable">$USERNAME</span>/</span><br><span class="line">find /etc/openvpn/ \( -name <span class="string">&quot;<span class="variable">$USERNAME</span>.key&quot;</span> -o -name <span class="string">&quot;<span class="variable">$USERNAME</span>.crt&quot;</span> -o -name ca.crt \) -<span class="built_in">exec</span> <span class="built_in">cp</span> &#123;&#125; /etc/openvpn/client/<span class="variable">$USERNAME</span> \;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果系统只有一个IPv4，它将自动被选中。否则，请让用户选择。</span></span><br><span class="line"><span class="keyword">if</span> [[ $(ip -4 addr | grep inet | grep -vEc <span class="string">&#x27;127(\.[0-9]&#123;1,3&#125;)&#123;3&#125;&#x27;</span>) -eq 1 ]]; <span class="keyword">then</span></span><br><span class="line">  ip=$(ip -4 addr | grep inet | grep -vE <span class="string">&#x27;127(\.[0-9]&#123;1,3&#125;)&#123;3&#125;&#x27;</span> | <span class="built_in">cut</span> -d <span class="string">&#x27;/&#x27;</span> -f 1 | grep -oE <span class="string">&#x27;[0-9]&#123;1,3&#125;(\.[0-9]&#123;1,3&#125;)&#123;3&#125;&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  number_of_ip=$(ip -4 addr | grep inet | grep -vEc <span class="string">&#x27;127(\.[0-9]&#123;1,3&#125;)&#123;3&#125;&#x27;</span>)</span><br><span class="line">  <span class="built_in">echo</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;使用哪个公网IPv4地址？&quot;</span></span><br><span class="line">  ip -4 addr | grep inet | grep -vE <span class="string">&#x27;127(\.[0-9]&#123;1,3&#125;)&#123;3&#125;&#x27;</span> | <span class="built_in">cut</span> -d <span class="string">&#x27;/&#x27;</span> -f 1 | grep -oE <span class="string">&#x27;[0-9]&#123;1,3&#125;(\.[0-9]&#123;1,3&#125;)&#123;3&#125;&#x27;</span> | <span class="built_in">nl</span> -s <span class="string">&#x27;) &#x27;</span></span><br><span class="line">  <span class="built_in">read</span> -p <span class="string">&quot;IPv4 address [1]: &quot;</span> ip_number</span><br><span class="line">  until [[ -z <span class="string">&quot;<span class="variable">$ip_number</span>&quot;</span> || <span class="string">&quot;<span class="variable">$ip_number</span>&quot;</span> =~ ^[0-9]+$ &amp;&amp; <span class="string">&quot;<span class="variable">$ip_number</span>&quot;</span> -le <span class="string">&quot;<span class="variable">$number_of_ip</span>&quot;</span> ]]; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$ip_number</span>: invalid selection.&quot;</span></span><br><span class="line">    <span class="built_in">read</span> -p <span class="string">&quot;IPv4 address [1]: &quot;</span> ip_number</span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  [[ -z <span class="string">&quot;<span class="variable">$ip_number</span>&quot;</span> ]] &amp;&amp; ip_number=<span class="string">&quot;1&quot;</span></span><br><span class="line">  ip=$(ip -4 addr | grep inet | grep -vE <span class="string">&#x27;127(\.[0-9]&#123;1,3&#125;)&#123;3&#125;&#x27;</span> | <span class="built_in">cut</span> -d <span class="string">&#x27;/&#x27;</span> -f 1 | grep -oE <span class="string">&#x27;[0-9]&#123;1,3&#125;(\.[0-9]&#123;1,3&#125;)&#123;3&#125;&#x27;</span> | sed -n <span class="string">&quot;<span class="variable">$ip_number</span>&quot;</span>p)</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果系统只有一个网关，它将自动被选中。否则，请让用户选择。</span></span><br><span class="line"><span class="keyword">if</span> [[ $(route | <span class="built_in">cut</span> -d <span class="string">&#x27; &#x27;</span> -f 1 | grep -Ec <span class="string">&#x27;([0-9]&#123;1,3&#125;.)&#123;3&#125;[0-9]&#123;1,3&#125;&#x27;</span>) -eq 1 ]]; <span class="keyword">then</span></span><br><span class="line">  Genmask=$(route | awk -F<span class="string">&quot;[[:space:]]+&quot;</span> <span class="string">&#x27;&#123;print $3&#125;&#x27;</span> | grep -E <span class="string">&#x27;([0-9]&#123;1,3&#125;.)&#123;3&#125;[0^C]&#123;1,3&#125;&#x27;</span> | grep -vE <span class="string">&#x27;0.0.0.0&#x27;</span>)</span><br><span class="line">  Gateway=$(route | <span class="built_in">cut</span> -d <span class="string">&#x27; &#x27;</span> -f 1 | grep -E <span class="string">&#x27;([0-9]&#123;1,3&#125;.)&#123;3&#125;[0-9]&#123;1,3&#125;&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  number_of_Gateway=$(route | <span class="built_in">cut</span> -d <span class="string">&#x27; &#x27;</span> -f 1 | grep -Ec <span class="string">&#x27;([0-9]&#123;1,3&#125;.)&#123;3&#125;[0-9]&#123;1,3&#125;&#x27;</span>)</span><br><span class="line">  <span class="built_in">echo</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;使用哪个私网网关地址？&quot;</span></span><br><span class="line">  route | <span class="built_in">cut</span> -d <span class="string">&#x27; &#x27;</span> -f 1 | grep -E <span class="string">&#x27;([0-9]&#123;1,3&#125;.)&#123;3&#125;[0-9]&#123;1,3&#125;&#x27;</span> | <span class="built_in">cut</span> -d <span class="string">&#x27;/&#x27;</span> -f 1 | grep -oE <span class="string">&#x27;[0-9]&#123;1,3&#125;(\.[0-9]&#123;1,3&#125;)&#123;3&#125;&#x27;</span> | <span class="built_in">nl</span> -s <span class="string">&#x27;) &#x27;</span></span><br><span class="line">  <span class="built_in">read</span> -p <span class="string">&quot;Gateway [1]: &quot;</span> Gateway_number</span><br><span class="line">  until [[ -z <span class="string">&quot;<span class="variable">$Gateway_number</span>&quot;</span> || <span class="string">&quot;<span class="variable">$Gateway_number</span>&quot;</span> =~ ^[0-9]+$ &amp;&amp; <span class="string">&quot;<span class="variable">$Gateway_number</span>&quot;</span> -le <span class="string">&quot;<span class="variable">$number_of_Gateway</span>&quot;</span> ]]; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$Gateway_number</span>: invalid selection.&quot;</span></span><br><span class="line">    <span class="built_in">read</span> -p <span class="string">&quot;Gateway [1]: &quot;</span> Gateway_number</span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  [[ -z <span class="string">&quot;<span class="variable">$Gateway_number</span>&quot;</span> ]] &amp;&amp; Gateway_number=<span class="string">&quot;1&quot;</span></span><br><span class="line"></span><br><span class="line">  Genmask=$(route | awk -F<span class="string">&quot;[[:space:]]+&quot;</span> <span class="string">&#x27;&#123;print $3&#125;&#x27;</span> | grep -E <span class="string">&#x27;([0-9]&#123;1,3&#125;.)&#123;3&#125;[0^C]&#123;1,3&#125;&#x27;</span> | grep -vE <span class="string">&#x27;0.0.0.0&#x27;</span> | <span class="built_in">cut</span> -d <span class="string">&#x27;/&#x27;</span> -f 1 | grep -oE <span class="string">&#x27;[0-9]&#123;1,3&#125;(\.[0-9]&#123;1,3&#125;)&#123;3&#125;&#x27;</span> | sed -n <span class="string">&quot;<span class="variable">$Gateway_number</span>&quot;</span>p)</span><br><span class="line">  Gateway=$(route | <span class="built_in">cut</span> -d <span class="string">&#x27; &#x27;</span> -f 1 | grep -E <span class="string">&#x27;([0-9]&#123;1,3&#125;.)&#123;3&#125;[0-9]&#123;1,3&#125;&#x27;</span> | <span class="built_in">cut</span> -d <span class="string">&#x27;/&#x27;</span> -f 1 | grep -oE <span class="string">&#x27;[0-9]&#123;1,3&#125;(\.[0-9]&#123;1,3&#125;)&#123;3&#125;&#x27;</span> | sed -n <span class="string">&quot;<span class="variable">$Gateway_number</span>&quot;</span>p)</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#选择协议</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;OpenVPN应该使用哪种协议？&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;   1) UDP (推荐)&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;   2) TCP&quot;</span></span><br><span class="line"><span class="built_in">read</span> -p <span class="string">&quot;Protocol [1]: &quot;</span> protocol</span><br><span class="line">until [[ -z <span class="string">&quot;<span class="variable">$protocol</span>&quot;</span> || <span class="string">&quot;<span class="variable">$protocol</span>&quot;</span> =~ ^[12]$ ]]; <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$protocol</span>: 选择无效。&quot;</span></span><br><span class="line">  <span class="built_in">read</span> -p <span class="string">&quot;Protocol [1]: &quot;</span> protocol</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;<span class="variable">$protocol</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">  1|<span class="string">&quot;&quot;</span>) </span><br><span class="line">  protocol=udp</span><br><span class="line">  ;;</span><br><span class="line">  2) </span><br><span class="line">  protocol=tcp</span><br><span class="line">  ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#选择端口</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;OpenVPN应该监听哪个端口？&quot;</span></span><br><span class="line">  <span class="built_in">read</span> -p <span class="string">&quot;Port [1194]: &quot;</span> port</span><br><span class="line">  until [[ -z <span class="string">&quot;<span class="variable">$port</span>&quot;</span> || <span class="string">&quot;<span class="variable">$port</span>&quot;</span> =~ ^[0-9]+$ &amp;&amp; <span class="string">&quot;<span class="variable">$port</span>&quot;</span> -le 65535 ]]; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$port</span>: 端口无效。&quot;</span></span><br><span class="line">    <span class="built_in">read</span> -p <span class="string">&quot;Port [1194]: &quot;</span> port</span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  [[ -z <span class="string">&quot;<span class="variable">$port</span>&quot;</span> ]] &amp;&amp; port=<span class="string">&quot;1194&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;服务器配置文件&quot;</span></span><br><span class="line"><span class="built_in">tee</span> /etc/openvpn/server.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">port $port</span></span><br><span class="line"><span class="string">proto $protocol</span></span><br><span class="line"><span class="string">dev tun</span></span><br><span class="line"><span class="string">ca /etc/openvpn/certs/ca.crt</span></span><br><span class="line"><span class="string">cert /etc/openvpn/certs/server.crt</span></span><br><span class="line"><span class="string">key /etc/openvpn/certs/server.key  # This file should be kept secret</span></span><br><span class="line"><span class="string">dh /etc/openvpn/certs/dh.pem</span></span><br><span class="line"><span class="string">server 10.8.0.0 255.255.255.0</span></span><br><span class="line"><span class="string">push &quot;route $Gateway $Genmask&quot;</span></span><br><span class="line"><span class="string">keepalive 10 120</span></span><br><span class="line"><span class="string">cipher AES-256-CBC</span></span><br><span class="line"><span class="string">compress lz4-v2</span></span><br><span class="line"><span class="string">push &quot;compress lz4-v2&quot;</span></span><br><span class="line"><span class="string">max-clients 2048</span></span><br><span class="line"><span class="string">user openvpn</span></span><br><span class="line"><span class="string">group openvpn</span></span><br><span class="line"><span class="string">status /var/log/openvpn/openvpn-status.log</span></span><br><span class="line"><span class="string">log-append   /var/log/openvpn/openvpn.log</span></span><br><span class="line"><span class="string">verb 3</span></span><br><span class="line"><span class="string">mute 20</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line">yum install iptables-services iptables -y</span><br><span class="line">systemctl <span class="built_in">enable</span> iptables --now </span><br><span class="line">iptables -F</span><br><span class="line">iptables -X</span><br><span class="line">iptables -Z</span><br><span class="line">iptables -t nat -F</span><br><span class="line">iptables -t nat -X</span><br><span class="line">iptables -t nat -Z</span><br><span class="line">iptables -t nat -A POSTROUTING -s 10.8.0.0/16 -j MASQUERADE</span><br><span class="line">iptables -A INPUT -p TCP --dport 1194 -j ACCEPT</span><br><span class="line">iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line">service iptables save &gt;&gt; /dev/null</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> /var/log/openvpn</span><br><span class="line"><span class="built_in">chown</span> openvpn.openvpn /var/log/openvpn</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;客户端配置文件&quot;</span></span><br><span class="line"><span class="built_in">tee</span> /etc/openvpn/client/<span class="variable">$USERNAME</span>/client.ovpn &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">client</span></span><br><span class="line"><span class="string">dev tun </span></span><br><span class="line"><span class="string">proto $protocol</span></span><br><span class="line"><span class="string">remote  $ip  $port</span></span><br><span class="line"><span class="string">resolv-retry infinite</span></span><br><span class="line"><span class="string">nobind</span></span><br><span class="line"><span class="string">ca ca.crt</span></span><br><span class="line"><span class="string">cert $USERNAME.crt </span></span><br><span class="line"><span class="string">key $USERNAME.key </span></span><br><span class="line"><span class="string">remote-cert-tls server</span></span><br><span class="line"><span class="string">cipher AES-256-CBC</span></span><br><span class="line"><span class="string">verb 3</span></span><br><span class="line"><span class="string">compress lz4-v2</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;[Unit]</span></span><br><span class="line"><span class="string">Description=OpenVPN Robust And Highly Flexible Tunneling Application On %I </span></span><br><span class="line"><span class="string">After=network.target</span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Type=notify </span></span><br><span class="line"><span class="string">PrivateTmp=true</span></span><br><span class="line"><span class="string">ExecStart=/usr/sbin/openvpn --cd /etc/openvpn/ --config %i.conf </span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target&#x27;</span> &gt; /usr/lib/systemd/system/openvpn@.service </span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> --now openvpn@server </span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /etc/openvpn/client/<span class="variable">$USERNAME</span>/</span><br><span class="line">tar cf ~/<span class="variable">$USERNAME</span>.tar  ./ </span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;客户端配置在: ~/<span class="variable">$USERNAME</span>.tar&quot;</span></span><br></pre></td></tr></table></figure><h3 id="Windows-配置部署-OpenVPN-客户端"><a href="#Windows-配置部署-OpenVPN-客户端" class="headerlink" title="Windows 配置部署 OpenVPN 客户端"></a>Windows 配置部署 OpenVPN 客户端</h3><p>下载并安装OpenVPN 客户端：<a href="https://openvpn.net/community-downloads/">https://openvpn.net/community-downloads/</a></p><h3 id="Windows-客户端配置准备"><a href="#Windows-客户端配置准备" class="headerlink" title="Windows 客户端配置准备"></a>Windows 客户端配置准备</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在服务器打包证书并下载发送给windows客户端</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cd /etc/openvpn/client/USERNAME/ </span></span><br><span class="line">[root@centos8 USERNAME]<span class="comment">#tar cf USERNAME.tar  ./ </span></span><br><span class="line">tar: ./USERNAME.tar: file is the archive; not dumped </span><br><span class="line">[root@centos8 USERNAME]<span class="comment">#ll</span></span><br><span class="line">total 40</span><br><span class="line">-rw------- 1 root root  1204 Aug  3 21:05 ca.crt</span><br><span class="line">-rw-r--r-- 1 root root   231 Aug  3 23:31 client.ovpn</span><br><span class="line">-rw------- 1 root root  4506 Aug  3 21:05 USERNAME.crt </span><br><span class="line">-rw------- 1 root root  1704 Aug  3 21:05 USERNAME.key </span><br><span class="line">-rw-r--r-- 1 root root 20480 Aug  4 10:48 USERNAME.tar</span><br><span class="line">[root@centos8 USERNAME]<span class="comment">#tar tf USERNAME.tar </span></span><br><span class="line">./</span><br><span class="line">./USERNAME.key </span><br><span class="line">./USERNAME.crt </span><br><span class="line">./ca.crt</span><br><span class="line">./client.ovpn</span><br></pre></td></tr></table></figure><p>解压到windows客户端的<code>C:\Program Files\OpenVPN\config</code>目录下</p><h3 id="Windows-客户端建立OpenVPN连接"><a href="#Windows-客户端建立OpenVPN连接" class="headerlink" title="Windows 客户端建立OpenVPN连接"></a>Windows 客户端建立OpenVPN连接</h3><p>在windows 程序中打开<code>OpenVPN GUI</code>工具,右键状态栏图标,点连接</p>]]></content>
      
      
      <categories>
          
          <category> CentOS运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CENTOS </tag>
            
            <tag> OpenVPN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DNS测试和管理工具</title>
      <link href="/2022/05/21/2022/05/DNS%E6%B5%8B%E8%AF%95%E5%92%8C%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/"/>
      <url>/2022/05/21/2022/05/DNS%E6%B5%8B%E8%AF%95%E5%92%8C%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/</url>
      
        <content type="html"><![CDATA[<h3 id="安装工具包"><a href="#安装工具包" class="headerlink" title="安装工具包"></a>安装工具包</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y bind-utils</span><br></pre></td></tr></table></figure><h3 id="1-host"><a href="#1-host" class="headerlink" title="1. host"></a>1. host</h3><p>常用的分析域名查询工具</p><p>常见用法：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]# host www.baidu.com//查询域名信息，显示别名和ip</span><br><span class="line">www.baidu.com is an alias for www.a.shifen.com.</span><br><span class="line">www.a.shifen.com has address 110.242.68.4</span><br><span class="line">www.a.shifen.com has address 110.242.68.3</span><br><span class="line">[root@CentOS7 ~]# host -a www.baidu.com//查询域名的所有信息</span><br><span class="line">Trying &quot;www.baidu.com&quot;</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 31187</span><br><span class="line">;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;www.baidu.com.                 IN      ANY</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">www.baidu.com.          576     IN      CNAME   www.a.shifen.com.</span><br><span class="line"></span><br><span class="line">Received 58 bytes from 192.168.164.227#53 in 13 ms</span><br></pre></td></tr></table></figure><h3 id="2-dig"><a href="#2-dig" class="headerlink" title="2. dig"></a>2. dig</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig www.baidu.com</span><br></pre></td></tr></table></figure><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h20qhi3vbpj21540qsdm0.jpg" alt=""></p><p>第一部分显示 dig 命令的版本和输入的参数。<br>第二部分显示服务返回的一些技术详情，比较重要的是 status。如果 status 的值为 NOERROR 则说明本次查询成功结束。<br>第三部分中的 “QUESTION SECTION” 显示我们要查询的域名。<br>第四部分的 “ANSWER SECTION” 是查询到的结果。<br>第五部分则是本次查询的一些统计信息，比如用了多长时间，查询了哪个 DNS 服务器，在什么时间进行的查询等等。<br>参考：<a href="https://www.cnblogs.com/sparkdev/p/7777871.html">https://www.cnblogs.com/sparkdev/p/7777871.html</a></p><p>使用指定DNS查询</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig www.baidu.com @119.29.29.29</span><br></pre></td></tr></table></figure><p>使用119.29.29.29 DNS解析www.baidu.com</p><h3 id="3-nslookup"><a href="#3-nslookup" class="headerlink" title="3. nslookup"></a>3. nslookup</h3><p>nslookup 可以支持交互和非交互式两种方式执行</p><p>非交互式：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]<span class="comment"># nslookup www.baidu.com       //使用默认dns解析域名</span></span><br><span class="line">Server:         223.5.5.5</span><br><span class="line">Address:        223.5.5.5<span class="comment">#53</span></span><br><span class="line"></span><br><span class="line">Non-authoritative answer:</span><br><span class="line">www.baidu.com   canonical name = www.a.shifen.com.</span><br><span class="line">Name:   www.a.shifen.com</span><br><span class="line">Address: 110.242.68.3</span><br><span class="line">Name:   www.a.shifen.com</span><br><span class="line">Address: 110.242.68.4</span><br><span class="line"></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># nslookup www.baidu.com 119.29.29.29       //使用指定dns解析域名</span></span><br><span class="line">Server:         119.29.29.29</span><br><span class="line">Address:        119.29.29.29<span class="comment">#53</span></span><br><span class="line"></span><br><span class="line">Non-authoritative answer:</span><br><span class="line">www.baidu.com   canonical name = www.a.shifen.com.</span><br><span class="line">Name:   www.a.shifen.com</span><br><span class="line">Address: 110.242.68.4</span><br><span class="line">Name:   www.a.shifen.com</span><br><span class="line">Address: 110.242.68.3</span><br></pre></td></tr></table></figure><p>交互式</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]# slookup </span><br><span class="line">&gt; www.baidu.com             //解析域名</span><br><span class="line">Server:         10.10.0.51</span><br><span class="line">Address:        10.10.0.51#53</span><br><span class="line"></span><br><span class="line">Non-authoritative answer:</span><br><span class="line">www.baidu.com   canonical name = www.a.shifen.com.</span><br><span class="line">Name:   www.a.shifen.com</span><br><span class="line">Address: 110.242.68.4</span><br><span class="line">Name:   www.a.shifen.com</span><br><span class="line">Address: 110.242.68.3</span><br><span class="line">&gt; server 119.29.29.29       //修改使用的dns</span><br><span class="line">Default server: 119.29.29.29</span><br><span class="line">Address: 119.29.29.29#53</span><br><span class="line">&gt; www.baidu.com             //解析域名</span><br><span class="line">Server:         119.29.29.29</span><br><span class="line">Address:        119.29.29.29#53</span><br><span class="line"></span><br><span class="line">Non-authoritative answer:</span><br><span class="line">www.baidu.com   canonical name = www.a.shifen.com.</span><br><span class="line">Name:   www.a.shifen.com</span><br><span class="line">Address: 110.242.68.3</span><br><span class="line">Name:   www.a.shifen.com</span><br><span class="line">Address: 110.242.68.4</span><br></pre></td></tr></table></figure><p>更多用法</p><ol><li>set type</li></ol><p>默认情况下，nslookup是查询域名所对应的A记录，而如果你想查询其他信息时，就需要专门设置type值。<br>常用type值：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">A：查看主机的IPv4地址</span><br><span class="line">AAAA：查看主机的IPv6地址</span><br><span class="line">ANY：查看关于主机域的所有信息</span><br><span class="line">CNAME：查找与别名对应的正式名字</span><br><span class="line">HINFO：查找主机的CPU与操作系统类型</span><br><span class="line">MINFO：查找邮箱信息</span><br><span class="line">MX：查找邮件交换信息</span><br><span class="line">NS：查找主机域的域名服务器</span><br><span class="line">PTR：查找与给定IP地址匹配的主机名</span><br><span class="line">RP：查找域负责人记录</span><br><span class="line">SOA：查找域内的SOA地址</span><br><span class="line">UINFO：查找用户信息</span><br></pre></td></tr></table></figure><p>范例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]# nslookup </span><br><span class="line">&gt; set type=MX</span><br><span class="line">&gt; www.baidu.com</span><br><span class="line">Server:         10.10.0.51</span><br><span class="line">Address:        10.10.0.51#53</span><br><span class="line"></span><br><span class="line">Non-authoritative answer:</span><br><span class="line">www.baidu.com   canonical name = www.a.shifen.com.</span><br><span class="line"></span><br><span class="line">Authoritative answers can be found from:</span><br><span class="line">a.shifen.com</span><br><span class="line">        origin = ns1.a.shifen.com</span><br><span class="line">        mail addr = baidu_dns_master.baidu.com</span><br><span class="line">        serial = 2205090004</span><br><span class="line">        refresh = 5</span><br><span class="line">        retry = 5</span><br><span class="line">        expire = 2592000</span><br><span class="line">        minimum = 3600</span><br><span class="line">&gt; exit</span><br><span class="line"></span><br><span class="line">[root@CentOS7 ~]# nslookup -type=MX www.baidu.com</span><br><span class="line">Server:         10.10.0.51</span><br><span class="line">Address:        10.10.0.51#53</span><br><span class="line"></span><br><span class="line">Non-authoritative answer:</span><br><span class="line">www.baidu.com   canonical name = www.a.shifen.com.</span><br><span class="line"></span><br><span class="line">Authoritative answers can be found from:</span><br><span class="line">a.shifen.com</span><br><span class="line">        origin = ns1.a.shifen.com</span><br><span class="line">        mail addr = baidu_dns_master.baidu.com</span><br><span class="line">        serial = 2205090004</span><br><span class="line">        refresh = 5</span><br><span class="line">        retry = 5</span><br><span class="line">        expire = 2592000</span><br><span class="line">        minimum = 3600</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol><li>set port</li></ol><p>如果需要更改DNS服务端口（默认的是53），可以通过本命令来设置</p><p>范例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]# nslookup -port=50 www.baidu.com</span><br><span class="line">Server:         10.10.0.51</span><br><span class="line">Address:        10.10.0.51#50</span><br><span class="line"></span><br><span class="line">Non-authoritative answer:</span><br><span class="line">www.baidu.com   canonical name = www.a.shifen.com.</span><br><span class="line">Name:   www.a.shifen.com</span><br><span class="line">Address: 110.242.68.4</span><br><span class="line">Name:   www.a.shifen.com</span><br><span class="line">Address: 110.242.68.3</span><br><span class="line"></span><br><span class="line">[root@CentOS7 ~]# nslookup</span><br><span class="line">&gt; set port=50</span><br><span class="line">&gt; www.baidu.com</span><br><span class="line">Server:         10.10.0.51</span><br><span class="line">Address:        10.10.0.51#50</span><br><span class="line"></span><br><span class="line">Non-authoritative answer:</span><br><span class="line">www.baidu.com   canonical name = www.a.shifen.com.</span><br><span class="line">Name:   www.a.shifen.com</span><br><span class="line">Address: 110.242.68.4</span><br><span class="line">Name:   www.a.shifen.com</span><br><span class="line">Address: 110.242.68.3</span><br></pre></td></tr></table></figure><ol><li>set all</li></ol><p>列出常用选项的当前设置值。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]# nslookup</span><br><span class="line">&gt; set all</span><br><span class="line">Default server: 10.10.0.51</span><br><span class="line">Address: 10.10.0.51#53</span><br><span class="line">Default server: 223.5.5.5</span><br><span class="line">Address: 223.5.5.5#53</span><br><span class="line"></span><br><span class="line">Set options:</span><br><span class="line">  novc                  nodebug         nod2</span><br><span class="line">  search                recurse</span><br><span class="line">  timeout = 0           retry = 3       port = 53       ndots = 1</span><br><span class="line">  querytype = A         class = IN</span><br><span class="line">  srchlist = localdomain</span><br></pre></td></tr></table></figure><h3 id="4-rndc"><a href="#4-rndc" class="headerlink" title="4. rndc"></a>4. rndc</h3><p>利用rndc工具可以实现管理DNS功能<br>rndc 监听端口: 953/tcp</p><p>用法：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">rndc COMMAND</span><br><span class="line">COMMAND:</span><br><span class="line">    status: 查看状态</span><br><span class="line">    reload: 重载主配置文件和区域解析库文件 </span><br><span class="line">    reload zonename: 重载区域解析库文件</span><br><span class="line">    retransfer zonename: 手动启动区域传送，而不管序列号是否增加 </span><br><span class="line">    notify zonename: 重新对区域传送发通知</span><br><span class="line">    reconfig: 重载主配置文件</span><br><span class="line">    querylog: 开启或关闭查询日志文件/var/log/message </span><br><span class="line">    trace: 递增debug一个级别</span><br><span class="line">    trace LEVEL: 指定使用的级别 </span><br><span class="line">    notrace：将调试级别设置为 0</span><br><span class="line">    flush：清空DNS服务器的所有缓存记录</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CentOS运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CENTOS </tag>
            
            <tag> DNS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CentOS配置网卡文件</title>
      <link href="/2022/05/10/2022/05/CentOS%E9%85%8D%E7%BD%AE%E7%BD%91%E5%8D%A1%E6%96%87%E4%BB%B6/"/>
      <url>/2022/05/10/2022/05/CentOS%E9%85%8D%E7%BD%AE%E7%BD%91%E5%8D%A1%E6%96%87%E4%BB%B6/</url>
      
        <content type="html"><![CDATA[<h3 id="Linux网卡常用配置"><a href="#Linux网卡常用配置" class="headerlink" title="Linux网卡常用配置"></a>Linux网卡常用配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysconfig/network-scripts/ifcfg-eth0       //eth0修改成设备名</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">TYPE=Ethernet               //接口类型</span><br><span class="line">DEVICE=eth1                 //设备名</span><br><span class="line">NAME=eth1                   //此配置文件应用到的设备</span><br><span class="line">BOOTPROTO=static            //激活此设备时使用的地址配置协议，常用的dhcp, static, none, bootp</span><br><span class="line">IPADDR=10.10.0.51           //指明IP地址（dhcp可忽略）</span><br><span class="line">PREFIX=24                   //网络ID的位数, 如:24（dhcp可忽略）</span><br><span class="line">DNS1=10.0.0.1               //DNS服务器地址（dhcp可忽略）</span><br><span class="line">DNS2=223.5.5.5              //DNS服务器地址（dhcp可忽略）</span><br><span class="line">GATEWAY=10.10.0.1           //默认网关（dhcp可忽略）</span><br><span class="line">ONBOOT=yes                  //在系统引导时是否激活此设备</span><br><span class="line">UUID=cd3d4bc1-3499-397a-98f6-188560209932        //设备的惟一标识</span><br></pre></td></tr></table></figure><h3 id="UUID查询方法"><a href="#UUID查询方法" class="headerlink" title="UUID查询方法"></a>UUID查询方法</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]# nmcli connection </span><br><span class="line">NAME  UUID                                  TYPE      DEVICE </span><br><span class="line">eth0  48c87a52-20b1-308e-addd-386999dd94ed  ethernet  eth0   </span><br><span class="line">eth1  a8e6aa0e-0098-3ee8-82d1-99f12efb6aff  ethernet  eth1</span><br></pre></td></tr></table></figure><h3 id="使修改后的配置生效"><a href="#使修改后的配置生效" class="headerlink" title="使修改后的配置生效"></a>使修改后的配置生效</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]# nmcli connection reload</span><br><span class="line">[root@CentOS7 ~]# nmcli connection up eth0       //eth0修改成设备名</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CentOS运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CENTOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DNS服务器配置</title>
      <link href="/2022/05/10/2022/05/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE/"/>
      <url>/2022/05/10/2022/05/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<h3 id="操作环境"><a href="#操作环境" class="headerlink" title="操作环境"></a>操作环境</h3><ol><li>3台CentOS7主机<ul><li>10.10.0.51   主DNS服务器</li><li>10.10.0.52   从DNS服务器</li><li>10.10.0.53   WEB服务器</li></ul></li><li>关闭SElinux </li><li>关闭防火墙 </li><li>时间同步</li></ol><h3 id="安装band软件"><a href="#安装band软件" class="headerlink" title="安装band软件"></a>安装band软件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]<span class="comment"># yum  -y install bind  bind-utils</span></span><br></pre></td></tr></table></figure><h3 id="主DNS服务器配置"><a href="#主DNS服务器配置" class="headerlink" title="主DNS服务器配置"></a>主DNS服务器配置</h3><p><strong>配置主配置文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]<span class="comment"># vim /etc/named.conf</span></span><br></pre></td></tr></table></figure><p>配置文件其中两行需要注释掉</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">options &#123;                                                                                                            </span><br><span class="line">//  listen-on port 53 &#123; 127.0.0.1; &#125;;       // 此行前面加注释</span><br><span class="line">    listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">    directory   <span class="string">&quot;/var/named&quot;</span>;</span><br><span class="line">    dump-file   <span class="string">&quot;/var/named/data/cache_dump.db&quot;</span>;</span><br><span class="line">    statistics-file <span class="string">&quot;/var/named/data/named_stats.txt&quot;</span>;</span><br><span class="line">    memstatistics-file <span class="string">&quot;/var/named/data/named_mem_stats.txt&quot;</span>;</span><br><span class="line">    recursing-file  <span class="string">&quot;/var/named/data/named.recursing&quot;</span>;</span><br><span class="line">    secroots-file   <span class="string">&quot;/var/named/data/named.secroots&quot;</span>;</span><br><span class="line">//  allow-query     &#123; localhost; &#125;;         // 此行前面加注释</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>修改配置文件<code>/etc/named.rfc1912.zones</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]<span class="comment"># vim /etc/named.rfc1912.zones</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#文本末尾加上下面内容</span></span><br><span class="line">zone <span class="string">&quot;tdison.local&quot;</span> IN &#123; </span><br><span class="line">    <span class="built_in">type</span> master;</span><br><span class="line">    file <span class="string">&quot;tdison.local.zone&quot;</span>; </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="修改DNS区域数据库文件"><a href="#修改DNS区域数据库文件" class="headerlink" title="修改DNS区域数据库文件"></a>修改DNS区域数据库文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]<span class="comment"># cp -p /var/named/named.localhost /var/named/tdison.local.zone</span></span><br><span class="line"><span class="comment">#需要加上-p选项保留所有者和所有组权限，如下所示。若没有添加-p选项，需要手动修改权限。</span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># ll /var/named/tdison.local.zone</span></span><br><span class="line">-rw-r----- 1 root named 152 Jun 21  2007 /var/named/tdison.local.zone</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]<span class="comment"># vim /var/named/tdison.local.zone</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$TTL</span> 1D</span><br><span class="line">@   IN SOA  master admin.tdison.local. (</span><br><span class="line">            2022050810  ; serial        //每次修改后需要更新此序号，建议使用日期+小时方式</span><br><span class="line">                    1D  ; refresh       //设置服务器同步拉取时间</span><br><span class="line">                    1H  ; retry         //设置拉取错误时的重试时间</span><br><span class="line">                    1W  ; expire        //设置从dns服务器的信息过期时间</span><br><span class="line">                    3H )    ; minimum   //设置错误查询记录缓存的保留时间</span><br><span class="line">            NS   master</span><br><span class="line">master      A    10.10.0.51      //此行作用将master.tdison.local解析成10.10.0.51</span><br><span class="line">www         A    10.10.0.53</span><br></pre></td></tr></table></figure><p>此条配置文件可以简写成</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$TTL</span> 1D</span><br><span class="line">@   IN SOA  master admin.tdison.local. (2022050810 1D 1H 1W 3H )</span><br><span class="line">NS   master</span><br><span class="line">master      A    10.10.0.51</span><br><span class="line">www         A    10.10.0.53</span><br></pre></td></tr></table></figure><p>区域解析库的记录类型：A, AAAA, PTR, SOA, NS, CNAME, MX</p><ul><li>SOA：Start Of Authority，起始授权记录；一个区域解析库有且仅能有一个SOA记录，<strong>必须位于解析库的第一条记录</strong></li><li>A：internet Address，作用：FQDN解析成IPv4地址 </li><li>AAAA：作用：FQDN解析成IPv6地址</li><li>PTR：PoinTeR，反向解析，IP —&gt; FQDN</li><li>NS：Name Server，专用于标明当前区域的DNS服务器 </li><li>CNAME ： Canonical Name，别名记录</li><li>MX：Mail eXchanger，邮件交换器</li><li>TXT：对域名进行标识和说明的一种方式，一般做验证记录时会使用此项，如：SPF（反垃圾邮件）记录，https验证等</li></ul><h3 id="检查配置文件和数据库文件格式，并启动服务"><a href="#检查配置文件和数据库文件格式，并启动服务" class="headerlink" title="检查配置文件和数据库文件格式，并启动服务"></a>检查配置文件和数据库文件格式，并启动服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]<span class="comment"># named-checkconf</span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># named-checkzone tdison.local /var/named/tdison.local.zone</span></span><br><span class="line">zone tdison.local/IN: loaded serial 2022050810</span><br><span class="line">OK</span><br><span class="line">[root@CentOS7 ~]<span class="comment"># systemctl start named     //第一次启动服务</span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># rndc reload               //不是第一次启动服务</span></span><br></pre></td></tr></table></figure><h3 id="启用DNS客户端缓存"><a href="#启用DNS客户端缓存" class="headerlink" title="启用DNS客户端缓存"></a>启用DNS客户端缓存</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]<span class="comment"># yum -y install nscd</span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># systemctl enable --now nscd</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看缓存统计信息</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># nscd -g</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#清除DNS客户端缓存</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># nscd -i hosts</span></span><br></pre></td></tr></table></figure><h3 id="实现从服务器"><a href="#实现从服务器" class="headerlink" title="实现从服务器"></a>实现从服务器</h3><p><strong>主DNS服务端配置</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/named.conf</span></span><br><span class="line">...</span><br><span class="line">options &#123;</span><br><span class="line">//  listen-on port 53 &#123; 127.0.0.1; &#125;;</span><br><span class="line">    listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">    directory   <span class="string">&quot;/var/named&quot;</span>;</span><br><span class="line">    dump-file   <span class="string">&quot;/var/named/data/cache_dump.db&quot;</span>;</span><br><span class="line">    statistics-file <span class="string">&quot;/var/named/data/named_stats.txt&quot;</span>;</span><br><span class="line">    memstatistics-file <span class="string">&quot;/var/named/data/named_mem_stats.txt&quot;</span>;</span><br><span class="line">    recursing-file  <span class="string">&quot;/var/named/data/named.recursing&quot;</span>;</span><br><span class="line">    secroots-file   <span class="string">&quot;/var/named/data/named.secroots&quot;</span>;</span><br><span class="line">//  allow-query     &#123; localhost; &#125;;</span><br><span class="line">    allow-transfer &#123; 10.10.0.52;&#125;;          //添加此行，仅允许该IP抓取dns数据库，IP修改成从dns服务器地址</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># vim /var/named/tdison.local.zone</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$TTL</span> 1D</span><br><span class="line">@   IN SOA  master admin.tdison.local. (</span><br><span class="line">            2022050810  ; serial</span><br><span class="line">                    1D  ; refresh</span><br><span class="line">                    1H  ; retry</span><br><span class="line">                    1W  ; expire</span><br><span class="line">                    3H )    ; minimum</span><br><span class="line">        NS  master</span><br><span class="line">        NS  slave//添加此行</span><br><span class="line">master  A   10.10.0.51</span><br><span class="line">slave   A   10.10.0.52//添加此行</span><br><span class="line">www     A   10.10.0.53</span><br><span class="line"></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># systemctl start named     //第一次启动服务</span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># rndc reload               //不是第一次启动服务</span></span><br></pre></td></tr></table></figure><p><strong>从DNS服务器配置</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]<span class="comment"># yum  -y install bind  bind-utils</span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># vim /etc/named.conf</span></span><br><span class="line">...</span><br><span class="line">options &#123;</span><br><span class="line">//  listen-on port 53 &#123; 127.0.0.1; &#125;;</span><br><span class="line">    listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">    directory   <span class="string">&quot;/var/named&quot;</span>;</span><br><span class="line">    dump-file   <span class="string">&quot;/var/named/data/cache_dump.db&quot;</span>;</span><br><span class="line">    statistics-file <span class="string">&quot;/var/named/data/named_stats.txt&quot;</span>;</span><br><span class="line">    memstatistics-file <span class="string">&quot;/var/named/data/named_mem_stats.txt&quot;</span>;</span><br><span class="line">    recursing-file  <span class="string">&quot;/var/named/data/named.recursing&quot;</span>;</span><br><span class="line">    secroots-file   <span class="string">&quot;/var/named/data/named.secroots&quot;</span>;</span><br><span class="line">//  allow-query     &#123; localhost; &#125;;</span><br><span class="line">    allow-transfer &#123; none;&#125;;  </span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># vim /etc/named.rfc1912.zones</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#文本末尾加上下面内容</span></span><br><span class="line">zone <span class="string">&quot;tdison.local&quot;</span> IN &#123;</span><br><span class="line">    <span class="built_in">type</span> slave;</span><br><span class="line">    masters &#123; 10.10.0.51;&#125;;//IP改成主DNS服务器地址</span><br><span class="line">    file <span class="string">&quot;slaves/tdison.local.zone&quot;</span>;                                                                                 </span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line"><span class="comment">#检查配置文件格式是否错误</span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># named-checkconf</span></span><br><span class="line"></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># systemctl start named          #第一次启动服务 </span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># rndc reload                    #不是第一次启动服务</span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># ls  /var/named/slaves/tdison.local.zone #查看区域数据库文件是否生成</span></span><br></pre></td></tr></table></figure><h3 id="WEB服务器上实现WEB服务"><a href="#WEB服务器上实现WEB服务" class="headerlink" title="WEB服务器上实现WEB服务"></a>WEB服务器上实现WEB服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装http服务</span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># yum install -y httpd                        </span></span><br><span class="line"><span class="comment">#配置主页面</span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># echo hello  &gt; /var/www/html/index.html </span></span><br><span class="line"><span class="comment">#启动服务</span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># systemctl start httpd                    </span></span><br></pre></td></tr></table></figure><h3 id="在客户端实现测试"><a href="#在客户端实现测试" class="headerlink" title="在客户端实现测试"></a>在客户端实现测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]<span class="comment"># vim /etc/sysconfig/network-scripts/ifcfg-eth0 </span></span><br><span class="line">...</span><br><span class="line">DNS1=10.10.0.51</span><br><span class="line">DNS2=10.10.0.52</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># nmcli con reload </span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># nmcli con up eth0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#测试DNS服务器</span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># dig www.tdison.local @10.10.0.51</span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># dig www.tdison.local @10.10.0.52</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#测试网页</span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># curl www.tdison.local</span></span><br><span class="line">hello</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CentOS运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CENTOS </tag>
            
            <tag> DNS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>建立CentOS局域网源并与清华源同步</title>
      <link href="/2022/05/04/2022/05/%E5%BB%BA%E7%AB%8BCentOS%E5%B1%80%E5%9F%9F%E7%BD%91%E6%BA%90%E5%B9%B6%E4%B8%8E%E6%B8%85%E5%8D%8E%E6%BA%90%E5%90%8C%E6%AD%A5/"/>
      <url>/2022/05/04/2022/05/%E5%BB%BA%E7%AB%8BCentOS%E5%B1%80%E5%9F%9F%E7%BD%91%E6%BA%90%E5%B9%B6%E4%B8%8E%E6%B8%85%E5%8D%8E%E6%BA%90%E5%90%8C%E6%AD%A5/</url>
      
        <content type="html"><![CDATA[<h2 id="禁止SELINUX"><a href="#禁止SELINUX" class="headerlink" title="禁止SELINUX"></a>禁止SELINUX</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sudo sed -i.bak &#x27;s/SELINUX=enforcing/SELINUX=disabled/&#x27; /etc/selinux/config</span></span><br><span class="line"><span class="comment"># setenforce 0</span></span><br></pre></td></tr></table></figure><h2 id="修改防火墙策略"><a href="#修改防火墙策略" class="headerlink" title="修改防火墙策略"></a>修改防火墙策略</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># firewall-cmd --zone=public --add-port=80/tcp --permanent //--permanent 永久生效，没有此参数重启后失效，默认为80端口。</span></span><br><span class="line"><span class="comment"># systemctl restart firewalld</span></span><br></pre></td></tr></table></figure><h2 id="安装httpd服务"><a href="#安装httpd服务" class="headerlink" title="安装httpd服务"></a>安装httpd服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum install -y httpd</span></span><br></pre></td></tr></table></figure><h2 id="创建目录"><a href="#创建目录" class="headerlink" title="创建目录"></a>创建目录</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /var/www/html/centos/&#123;6,7&#125;/os/x86_64/</span></span><br><span class="line"><span class="comment"># mkdir -p /var/www/html/centos/&#123;6,7&#125;/updates/x86_64/</span></span><br><span class="line"><span class="comment"># mkdir -p /var/www/html/centos/&#123;6,7&#125;/extras/x86_64/</span></span><br><span class="line"><span class="comment"># mkdir -p /var/www/html/centos-vault/8.5.2111/BaseOS/x86_64/os/</span></span><br><span class="line"><span class="comment"># mkdir -p /var/www/html/centos-vault/8.5.2111/extras/x86_64/os/</span></span><br><span class="line"><span class="comment"># mkdir -p /var/www/html/centos-vault/8.5.2111/AppStream/x86_64/os/</span></span><br><span class="line"><span class="comment"># mkdir -p /var/www/html/epel/&#123;6,7&#125;/x86_64</span></span><br><span class="line"><span class="comment"># mkdir -p /var/www/html/epel/8/Everything/x86_64/</span></span><br></pre></td></tr></table></figure><h2 id="同步镜像"><a href="#同步镜像" class="headerlink" title="同步镜像"></a>同步镜像</h2><p><strong>新建文件</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ cat /usr/local/local_mirror/exclude.list</span><br><span class="line"></span><br><span class="line">#填入以下内容</span><br><span class="line"></span><br><span class="line">SRPMS</span><br><span class="line">aarch64</span><br><span class="line">ppc64</span><br><span class="line">ppc64le</span><br><span class="line">debug</span><br><span class="line">repodata</span><br><span class="line">EFI</span><br><span class="line">LiveOS</span><br><span class="line">images</span><br><span class="line">isolinux</span><br><span class="line">CentOS_BuildTag</span><br><span class="line">EULA</span><br><span class="line">GPL</span><br><span class="line">drpms</span><br></pre></td></tr></table></figure><p><strong>新建运行脚本</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ cat /usr/local/sbin/sync.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">#</span><br><span class="line"># 此脚本用于同步&quot;http://mirrors.tuna.tsinghua.edu.cn&quot;的镜像到本地</span><br><span class="line"># 如果还需要其它系统那么直接往后面加上去</span><br><span class="line">#</span><br><span class="line">rsync -avrt --exclude-from=/usr/local/local_mirror/exclude.list rsync://mirrors.tuna.tsinghua.edu.cn/centos/RPM-GPG-KEY-* /var/www/html/centos/ &amp;&amp; \</span><br><span class="line">rsync -avrt --exclude-from=/usr/local/local_mirror/exclude.list rsync://mirrors.tuna.tsinghua.edu.cn/centos-vault/RPM-GPG-KEY-* /var/www/html/centos-vault/ &amp;&amp; \</span><br><span class="line">rsync -avrt --exclude-from=/usr/local/local_mirror/exclude.list rsync://mirrors.tuna.tsinghua.edu.cn/epel/RPM-GPG-KEY-* /var/www/html/epel/ &amp;&amp; \</span><br><span class="line">rsync -avrt --exclude-from=/usr/local/local_mirror/exclude.list rsync://mirrors.tuna.tsinghua.edu.cn/epel/7/x86_64/ /var/www/html/epel/7/x86_64/ &amp;&amp; \</span><br><span class="line">rsync -avrt --exclude-from=/usr/local/local_mirror/exclude.list rsync://mirrors.tuna.tsinghua.edu.cn/centos/7/extras/x86_64/ /var/www/html/centos/7/extras/x86_64 &amp;&amp; \</span><br><span class="line">rsync -avrt --exclude-from=/usr/local/local_mirror/exclude.list rsync://mirrors.tuna.tsinghua.edu.cn/centos/7/updates/x86_64/ /var/www/html/centos/7/updates/x86_64 &amp;&amp; \</span><br><span class="line">rsync -avrt --exclude-from=/usr/local/local_mirror/exclude.list rsync://mirrors.tuna.tsinghua.edu.cn/centos/7/os/x86_64/ /var/www/html/centos/7/os/x86_64 &amp;&amp; \</span><br><span class="line">rsync -avrt --exclude-from=/usr/local/local_mirror/exclude.list rsync://mirrors.tuna.tsinghua.edu.cn/centos-vault/8.5.2111/BaseOS/x86_64/os/ /var/www/html/centos-vault/8.5.2111/BaseOS/x86_64/os/ &amp;&amp; \</span><br><span class="line">rsync -avrt --exclude-from=/usr/local/local_mirror/exclude.list rsync://mirrors.tuna.tsinghua.edu.cn/centos-vault/8.5.2111/extras/x86_64/os/ /var/www/html/centos-vault/8.5.2111/extras/x86_64/os/ &amp;&amp; \</span><br><span class="line">rsync -avrt --exclude-from=/usr/local/local_mirror/exclude.list rsync://mirrors.tuna.tsinghua.edu.cn/centos-vault/8.5.2111/AppStream/x86_64/os/ /var/www/html/centos-vault/8.5.2111/AppStream/x86_64/os/ &amp;&amp; \</span><br><span class="line">rsync -avrt --exclude-from=/usr/local/local_mirror/exclude.list rsync://mirrors.tuna.tsinghua.edu.cn/epel/8/Everything/x86_64/ /var/www/html/epel/8/Everything/x86_64/ &amp;&amp; \</span><br><span class="line">rsync -avrt --exclude-from=/usr/local/local_mirror/exclude.list rsync://mirrors.tuna.tsinghua.edu.cn/centos-vault/6.10/extras/x86_64/ /var/www/html/centos/6/extras/x86_64 &amp;&amp; \</span><br><span class="line">rsync -avrt --exclude-from=/usr/local/local_mirror/exclude.list rsync://mirrors.tuna.tsinghua.edu.cn/centos-vault/6.10/updates/x86_64/ /var/www/html/centos/6/updates/x86_64 &amp;&amp; \</span><br><span class="line">rsync -avrt --exclude-from=/usr/local/local_mirror/exclude.list rsync://mirrors.tuna.tsinghua.edu.cn/centos-vault/6.10/os/x86_64/ /var/www/html/centos/6/os/x86_64</span><br></pre></td></tr></table></figure><h2 id="加入计划任务"><a href="#加入计划任务" class="headerlink" title="加入计划任务"></a>加入计划任务</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 1 * * * sh /usr/local/sbin/sync.sh &amp;&gt; /tmp/yum.log</span><br></pre></td></tr></table></figure><h2 id="客户端repo配置"><a href="#客户端repo配置" class="headerlink" title="客户端repo配置"></a>客户端repo配置</h2><p><strong>Centos-vault-6.10.repo</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># CentOS-Base.repo</span><br><span class="line">#</span><br><span class="line"># The mirror system uses the connecting IP address of the client and the</span><br><span class="line"># update status of each mirror to pick mirrors that are updated to and</span><br><span class="line"># geographically close to the client.  You should use this for CentOS updates</span><br><span class="line"># unless you are manually picking other mirrors.</span><br><span class="line">#</span><br><span class="line"># If the mirrorlist= does not work for you, as a fall back you can try the </span><br><span class="line"># remarked out baseurl= line instead.</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line"> </span><br><span class="line">[base]</span><br><span class="line">name=CentOS-vault-6.10 - Base - 10.10.0.2</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://10.10.0.2/centos-vault/6.10/os/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://10.10.0.2/centos-vault/RPM-GPG-KEY-CentOS-6</span><br><span class="line"> </span><br><span class="line">#released updates </span><br><span class="line">[updates]</span><br><span class="line">name=CentOS-vault-6.10 - Updates - 10.10.0.2</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://10.10.0.2/centos-vault/6.10/updates/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://10.10.0.2/centos-vault/RPM-GPG-KEY-CentOS-6</span><br><span class="line"> </span><br><span class="line">#additional packages that may be useful</span><br><span class="line">[extras]</span><br><span class="line">name=CentOS-vault-6.10 - Extras - 10.10.0.2</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://10.10.0.2/centos-vault/6.10/extras/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://10.10.0.2/centos-vault/RPM-GPG-KEY-CentOS-6</span><br></pre></td></tr></table></figure><p><strong>Centos-7.repo</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># CentOS-Base.repo</span><br><span class="line">#</span><br><span class="line"># The mirror system uses the connecting IP address of the client and the</span><br><span class="line"># update status of each mirror to pick mirrors that are updated to and</span><br><span class="line"># geographically close to the client.  You should use this for CentOS updates</span><br><span class="line"># unless you are manually picking other mirrors.</span><br><span class="line">#</span><br><span class="line"># If the mirrorlist= does not work for you, as a fall back you can try the </span><br><span class="line"># remarked out baseurl= line instead.</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line"> </span><br><span class="line">[base]</span><br><span class="line">name=CentOS-$releasever - Base - 10.10.0.2</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://10.10.0.2/centos/$releasever/os/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://10.10.0.2/centos/RPM-GPG-KEY-CentOS-7</span><br><span class="line"> </span><br><span class="line">#released updates </span><br><span class="line">[updates]</span><br><span class="line">name=CentOS-$releasever - Updates - 10.10.0.2</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://10.10.0.2/centos/$releasever/updates/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://10.10.0.2/centos/RPM-GPG-KEY-CentOS-7</span><br><span class="line"> </span><br><span class="line">#additional packages that may be useful</span><br><span class="line">[extras]</span><br><span class="line">name=CentOS-$releasever - Extras - 10.10.0.2</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://10.10.0.2/centos/$releasever/extras/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://10.10.0.2/centos/RPM-GPG-KEY-CentOS-7</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>Centos-vault-8.5.2111.repo</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># CentOS-Base.repo</span><br><span class="line">#</span><br><span class="line"># The mirror system uses the connecting IP address of the client and the</span><br><span class="line"># update status of each mirror to pick mirrors that are updated to and</span><br><span class="line"># geographically close to the client.  You should use this for CentOS updates</span><br><span class="line"># unless you are manually picking other mirrors.</span><br><span class="line">#</span><br><span class="line"># If the mirrorlist= does not work for you, as a fall back you can try the </span><br><span class="line"># remarked out baseurl= line instead.</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line"> </span><br><span class="line">[base]</span><br><span class="line">name=CentOS-8.5.2111 - Base - 10.10.0.2</span><br><span class="line">baseurl=http://10.10.0.2/centos-vault/8.5.2111/BaseOS/$basearch/os/</span><br><span class="line">gpgcheck=0</span><br><span class="line">gpgkey=http://10.10.0.2/centos/RPM-GPG-KEY-CentOS-Official</span><br><span class="line"> </span><br><span class="line">#additional packages that may be useful</span><br><span class="line">[extras]</span><br><span class="line">name=CentOS-8.5.2111 - Extras - 10.10.0.2</span><br><span class="line">baseurl=http://10.10.0.2/centos-vault/8.5.2111/extras/$basearch/os/</span><br><span class="line">gpgcheck=0</span><br><span class="line">gpgkey=http://10.10.0.2/centos/RPM-GPG-KEY-CentOS-Official</span><br><span class="line"></span><br><span class="line">[AppStream]</span><br><span class="line">name=CentOS-8.5.2111 - AppStream - 10.10.0.2</span><br><span class="line">baseurl=http://10.10.0.2/centos-vault/8.5.2111/AppStream/$basearch/os/</span><br><span class="line">gpgcheck=0</span><br><span class="line">gpgkey=http://10.10.0.2/centos/RPM-GPG-KEY-CentOS-Official</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>epel-7.repo</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[epel]</span><br><span class="line">name=Extra Packages for Enterprise Linux 7 - $basearch</span><br><span class="line">baseurl=http://10.10.0.2/epel/7/$basearch</span><br><span class="line">failovermethod=priority</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">gpgkey=http://10.10.0.2/epel/RPM-GPG-KEY-EPEL-7</span><br></pre></td></tr></table></figure><p><strong>epel-8.repo</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[epel]</span><br><span class="line">name=Extra Packages for Enterprise Linux $releasever - $basearch</span><br><span class="line"># It is much more secure to use the metalink, but if you wish to use a local mirror</span><br><span class="line"># place it&#x27;s address here.</span><br><span class="line">baseurl=https://10.10.0.2/epel/$releasever/Everything/$basearch</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">countme=1</span><br><span class="line">gpgkey=http://10.10.0.2/epel/RPM-GPG-KEY-EPEL-8</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CentOS运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CENTOS </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
