<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>CentOS 8多实例安装MySQL</title>
      <link href="/2022/05/27/CentOS-8%E5%A4%9A%E5%AE%9E%E4%BE%8B%E5%AE%89%E8%A3%85MySQL/"/>
      <url>/2022/05/27/CentOS-8%E5%A4%9A%E5%AE%9E%E4%BE%8B%E5%AE%89%E8%A3%85MySQL/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="实验目的"><a href="#实验目的" class="headerlink" title="实验目的"></a>实验目的</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CentOS 8 yum安装mariadb-10.3.17并实现三个实例</span><br></pre></td></tr></table></figure><h2 id="环境要求"><a href="#环境要求" class="headerlink" title="环境要求"></a>环境要求</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">一台系统CentOS 8.X主机</span><br></pre></td></tr></table></figure><h2 id="前提准备"><a href="#前提准备" class="headerlink" title="前提准备"></a>前提准备</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">关闭SElinux </span><br><span class="line">关闭防火墙 </span><br><span class="line">时间同步</span><br></pre></td></tr></table></figure><h2 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h2><h3 id="安装mariadb"><a href="#安装mariadb" class="headerlink" title="安装mariadb"></a>安装mariadb</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#yum -y install mariadb-server</span><br></pre></td></tr></table></figure><h3 id="准备三个实例的目录"><a href="#准备三个实例的目录" class="headerlink" title="准备三个实例的目录"></a>准备三个实例的目录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#mkdir  -pv /mysql/&#123;3306,3307,3308&#125;/&#123;data,etc,socket,log,bin,pid&#125; </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#chown  -R mysql.mysql /mysql</span></span><br></pre></td></tr></table></figure><h3 id="生成数据库文件"><a href="#生成数据库文件" class="headerlink" title="生成数据库文件"></a>生成数据库文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#mysql_install_db  --user=mysql --datadir=/mysql/3306/data </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#mysql_install_db  --user=mysql --datadir=/mysql/3307/data </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#mysql_install_db  --user=mysql --datadir=/mysql/3308/data</span></span><br></pre></td></tr></table></figure><h3 id="准备配置文件"><a href="#准备配置文件" class="headerlink" title="准备配置文件"></a>准备配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#vim  /mysql/3306/etc/my.cnf </span></span><br><span class="line">[mysqld]</span><br><span class="line">port=3306</span><br><span class="line">datadir=/mysql/3306/data</span><br><span class="line">socket=/mysql/3306/socket/mysql.sock </span><br><span class="line">log-error=/mysql/3306/log/mysql.log </span><br><span class="line">pid-file=/mysql/3306/pid/mysql.pid</span><br><span class="line"></span><br><span class="line"><span class="comment">#重复上面步骤设置3307，3308</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#sed &#x27;s/3306/3307/&#x27;  /mysql/3306/etc/my.cnf &gt; </span></span><br><span class="line">/mysql/3307/etc/my.cnf</span><br><span class="line">[root@centos8 ~]<span class="comment">#sed &#x27;s/3306/3308/&#x27;  /mysql/3306/etc/my.cnf &gt; </span></span><br><span class="line">/mysql/3308/etc/my.cnf</span><br></pre></td></tr></table></figure><h3 id="准备启动脚本"><a href="#准备启动脚本" class="headerlink" title="准备启动脚本"></a>准备启动脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#vim /mysql/3306/bin/mysqld</span></span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line">mysql_user=<span class="string">&quot;root&quot;</span> </span><br><span class="line">mysql_pwd=<span class="string">&quot;123456&quot;</span></span><br><span class="line">cmd_path=<span class="string">&quot;/usr/bin&quot;</span></span><br><span class="line">port=3306</span><br><span class="line">mysql_basedir=<span class="string">&quot;/mysql&quot;</span></span><br><span class="line"></span><br><span class="line">. /etc/init.d/functions</span><br><span class="line">[ <span class="variable">$#</span> -ne 1 ] &amp;&amp; &#123;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;USAGE:&#123;start|stop|restart&#125;&quot;</span></span><br><span class="line"><span class="built_in">exit</span> 1</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">start</span></span>()&#123;</span><br><span class="line"><span class="keyword">if</span> [ -e <span class="variable">$&#123;mysql_basedir&#125;</span>/<span class="variable">$&#123;port&#125;</span>/socket/mysql.sock ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;MySQL is running.&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="variable">$&#123;cmd_path&#125;</span>/mysqld_safe --defaults-file=<span class="variable">$&#123;mysql_basedir&#125;</span>/<span class="variable">$&#123;port&#125;</span>/etc/my.cnf &amp;&gt;/dev/null &amp;</span><br><span class="line">  action  <span class="string">&quot;MySQL is starting&quot;</span> /bin/true</span><br><span class="line">  <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">stop</span></span>()&#123;</span><br><span class="line"><span class="keyword">if</span> [ -e <span class="variable">$&#123;mysql_basedir&#125;</span>/<span class="variable">$&#123;port&#125;</span>/socket/mysql.sock ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">  <span class="variable">$&#123;cmd_path&#125;</span>/mysqladmin -u <span class="variable">$&#123;mysql_user&#125;</span> -p <span class="variable">$&#123;mysql_pwd&#125;</span> -S <span class="variable">$&#123;mysql_basedir&#125;</span>/<span class="variable">$&#123;port&#125;</span>/socket/mysql.sock shutdown &amp;&gt;/dev/null</span><br><span class="line">  action <span class="string">&quot;MySQL is stoping&quot;</span> /bin/true</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  action <span class="string">&quot;MySQL is stoping&quot;</span> /bin/false</span><br><span class="line">  <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">restart</span></span>()&#123;</span><br><span class="line">  stop</span><br><span class="line">  <span class="built_in">sleep</span> 2</span><br><span class="line">  start</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> == <span class="string">&quot;start&quot;</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">  start</span><br><span class="line"><span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> == <span class="string">&quot;stop&quot;</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">  stop</span><br><span class="line"><span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> == <span class="string">&quot;restart&quot;</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">  restart</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;USAGE:&#123;start|stop|restart&#125;&quot;</span> </span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#chmod +x /mysql/3306/bin/mysqld</span></span><br><span class="line"><span class="comment">#重复上述过程，分别建立3307，3308的启动脚本</span></span><br></pre></td></tr></table></figure><h3 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#/mysql/3306/bin/mysqld  start </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#/mysql/3307/bin/mysqld  start </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#/mysql/3308/bin/mysqld  start </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#ss -ntl</span></span><br><span class="line">State         Recv-Q        Send-Q               Local Address:Port               Peer Address:Port       Process        </span><br><span class="line">LISTEN        0             128                        0.0.0.0:22                      0.0.0.0:*                         </span><br><span class="line">LISTEN        0             80                               *:3306                          *:*                         </span><br><span class="line">LISTEN        0             80                               *:3307                          *:*                         </span><br><span class="line">LISTEN        0             80                               *:3308                          *:*                         </span><br><span class="line">LISTEN        0             128                           [::]:22                         [::]:*        </span><br></pre></td></tr></table></figure><h3 id="登录实例"><a href="#登录实例" class="headerlink" title="登录实例"></a>登录实例</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#/mysql/3308/bin/mysqld  start </span></span><br><span class="line"><span class="comment">#两种连接方法</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#mysql -h127.0.0.1 -uroot -P3306</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#mysql -uroot -S /mysqldb/3306/socket/mysql.sock </span></span><br><span class="line"><span class="comment">#确认连接的端口</span></span><br><span class="line">MariaDB [(none)]&gt; show variables like <span class="string">&#x27;port&#x27;</span>;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| port          | 3306  |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.001 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">#关闭数据库，需要手动输入root的密码</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#/mysql/3308/bin/mysqld stop </span></span><br><span class="line">Stoping MySQL...</span><br><span class="line">Enter password:</span><br><span class="line">[root@centos8 ~]<span class="comment">#/mysql/3308/bin/mysqld start </span></span><br><span class="line">Starting MySQL...</span><br></pre></td></tr></table></figure><h3 id="修改root密码"><a href="#修改root密码" class="headerlink" title="修改root密码"></a>修改root密码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#加上root的口令</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#mysqladmin -uroot -S /mysql/3306/socket/mysql.sock  password &#x27;123456&#x27;</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#mysqladmin -uroot -S /mysql/3307/socket/mysql.sock  password &#x27;123456&#x27;</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#mysqladmin -uroot -S /mysql/3308/socket/mysql.sock  password &#x27;123456&#x27;</span></span><br><span class="line"><span class="comment">#重复步骤，分别修改别外两个实例3307，3308对应root口令</span></span><br></pre></td></tr></table></figure><h3 id="测试连接"><a href="#测试连接" class="headerlink" title="测试连接"></a>测试连接</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#mysql -uroot -p -S /mysql/3306/socket/mysql.sock #提示输入口令才能登录</span></span><br></pre></td></tr></table></figure><h3 id="开机启动"><a href="#开机启动" class="headerlink" title="开机启动"></a>开机启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#echo &quot;for i in &#123;3306..3308&#125;;do /mysql/$i/bin/mysqld start;done&quot; &gt;&gt; /etc/rc.d/rc.local </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#chmod +x /etc/rc.d/rc.local</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CentOS运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CENTOS </tag>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OpenVPN的高级功能</title>
      <link href="/2022/05/27/OpenVPN%E7%9A%84%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD/"/>
      <url>/2022/05/27/OpenVPN%E7%9A%84%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="启用防止DOS攻击的安全增强配置"><a href="#启用防止DOS攻击的安全增强配置" class="headerlink" title="启用防止DOS攻击的安全增强配置"></a>启用防止DOS攻击的安全增强配置</h2><p><strong>服务器配置</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># openvpn --genkey --secret /etc/openvpn/certs/ta.key</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /etc/openvpn/certs/ta.key</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 2048 bit OpenVPN static key</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">-----BEGIN OpenVPN Static key V1-----</span><br><span class="line">6e978f0ee0a3ef80ee1108cd741b8481</span><br><span class="line">46ff819b5044a99497540edc39b9203a</span><br><span class="line">14b5637b14b5312482f83ad868b88abd</span><br><span class="line">f15b36c8440804ea6aa4e937b394ce66</span><br><span class="line">87d21e70e5dba4ac0331e6b4624f9b74</span><br><span class="line">d55422726cd7563d726dc09aa4da4493</span><br><span class="line">94a0f21f1a57c517d6e6a7a09ef8dcda</span><br><span class="line">92273326212b0d83e050bd30ebf3d5e5</span><br><span class="line">3042b740b732ffcf366a999c02959464</span><br><span class="line">275475e89453722a022ba390199ecc2b</span><br><span class="line">3f2caf44aaa8239f601f1b415fd06ae7</span><br><span class="line">4a574ad61f8eeae55a772cd76ac701e0</span><br><span class="line">85d4b6aaab86809c70467493c9510c4c</span><br><span class="line">ef4ae8b3f704adaa97e8ac98e74270a4</span><br><span class="line">7ccee3bccea3dba34083a302c9fc400a</span><br><span class="line">403f0c0529162da22b7db24fb27c377b</span><br><span class="line">-----END OpenVPN Static key V1-----</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /etc/openvpn/server.conf</span></span><br><span class="line"><span class="comment">#添加以下内容</span></span><br><span class="line">tls-auth /etc/openvpn/certs/ta.key 0 <span class="comment">#客户端为1,服务器端为0</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl restart openvpn@server.service</span></span><br></pre></td></tr></table></figure><p><strong>将ta.key 传到客户端相关目录下</strong></p><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2ltmfmfbrj20ww0buta7.jpg"></p><p><strong>修改客户端配置文件<code>clent.ovpn</code>,添加一行</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tls-auth ta.key 1   <span class="comment">#客户端为1,服务器端为0</span></span><br></pre></td></tr></table></figure><p>客户端重新建立连接</p><h2 id="设置客户端的私钥密码增强安全性"><a href="#设置客户端的私钥密码增强安全性" class="headerlink" title="设置客户端的私钥密码增强安全性"></a>设置客户端的私钥密码增强安全性</h2><h3 id="创建新用户-生成对应的有密码的私钥和证书申请"><a href="#创建新用户-生成对应的有密码的私钥和证书申请" class="headerlink" title="创建新用户,生成对应的有密码的私钥和证书申请"></a>创建新用户,生成对应的有密码的私钥和证书申请</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># cd /etc/openvpn/easy-rsa-client/3</span></span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa gen-req USERNAME</span></span><br><span class="line"></span><br><span class="line">Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-client/3.0.7/vars</span><br><span class="line">Using SSL: openssl OpenSSL 1.1.1k  FIPS 25 Mar 2021</span><br><span class="line">Generating a RSA private key</span><br><span class="line">...............................................................+++++</span><br><span class="line">................+++++</span><br><span class="line">writing new private key to <span class="string">&#x27;/etc/openvpn/easy-rsa-client/3/pki/easy-rsa- 35371.iJfHbs/tmp.9lGUMy&#x27;</span></span><br><span class="line">Enter PEM pass phrase:</span><br><span class="line"><span class="comment">#输入两遍密码</span></span><br><span class="line">Verifying - Enter PEM pass phrase:</span><br><span class="line"><span class="comment">#输入两遍密码</span></span><br><span class="line">-----</span><br><span class="line">You are about to be asked to enter information that will be incorporated into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter <span class="string">&#x27;.&#x27;</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Common Name (eg: your user, host, or server name) [USERNAME]:</span><br><span class="line">Keypair and certificate request completed. Your files are:</span><br><span class="line">req: /etc/openvpn/easy-rsa-client/3/pki/reqs/USERNAME.req</span><br><span class="line">key: /etc/openvpn/easy-rsa-client/3/pki/private/USERNAME.key</span><br></pre></td></tr></table></figure><h3 id="导入用户证书申请并颁发证书"><a href="#导入用户证书申请并颁发证书" class="headerlink" title="导入用户证书申请并颁发证书"></a>导入用户证书申请并颁发证书</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 3]<span class="comment">#cd /etc/openvpn/easy-rsa-server/3</span></span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa import-req /etc/openvpn/easy-rsa-client/3/pki/reqs/USERNAME.req   USERNAME</span></span><br><span class="line"></span><br><span class="line">Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.8/vars</span><br><span class="line">Using SSL: openssl OpenSSL 1.1.1k  FIPS 25 Mar 2021</span><br><span class="line"></span><br><span class="line">The request has been successfully imported with a short name of: USERNAME</span><br><span class="line">You may now use this name to perform signing operations on this request.</span><br><span class="line"></span><br><span class="line"><span class="comment">#确保证书有效期是合理值</span></span><br><span class="line">[root@centos8 3]<span class="comment">#grep EASYRSA_CERT_EXPIRE vars</span></span><br><span class="line">set_var EASYRSA_CERT_EXPIRE 90</span><br><span class="line"></span><br><span class="line"><span class="comment">#颁发证书</span></span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa sign client USERNAME</span></span><br><span class="line"></span><br><span class="line">Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.8/vars</span><br><span class="line">Using SSL: openssl OpenSSL 1.1.1k  FIPS 25 Mar 2021</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">You are about to sign the following certificate.</span><br><span class="line">Please check over the details shown below <span class="keyword">for</span> accuracy. Note that this request</span><br><span class="line">has not been cryptographically verified. Please be sure it came from a trusted</span><br><span class="line"><span class="built_in">source</span> or that you have verified the request checksum with the sender.</span><br><span class="line"></span><br><span class="line">Request subject, to be signed as a client certificate <span class="keyword">for</span> 90 days:</span><br><span class="line"></span><br><span class="line">subject=</span><br><span class="line">    commonName                = USERNAME</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Type the word <span class="string">&#x27;yes&#x27;</span> to <span class="built_in">continue</span>, or any other input to abort.</span><br><span class="line">  Confirm request details: <span class="built_in">yes</span>              <span class="comment">#输入yes</span></span><br><span class="line">Using configuration from /etc/openvpn/easy-rsa-server/3/pki/easy-rsa-33479.B9Jp6u/tmp.7WmZA9</span><br><span class="line">Check that the request matches the signature</span><br><span class="line">Signature ok</span><br><span class="line">The Subject<span class="string">&#x27;s Distinguished Name is as follows</span></span><br><span class="line"><span class="string">commonName            :ASN.1 12:&#x27;</span>USERNAME<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Certificate is to be certified until Aug 24 07:25:47 2022 GMT (90 days)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Write out database with 1 new entries</span></span><br><span class="line"><span class="string">Data Base Updated</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Certificate created at: /etc/openvpn/easy-rsa-server/3/pki/issued/USERNAME.crt</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure><h3 id="将用户的证书相关文件放在指定的目录中"><a href="#将用户的证书相关文件放在指定的目录中" class="headerlink" title="将用户的证书相关文件放在指定的目录中"></a>将用户的证书相关文件放在指定的目录中</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#mkdir  /etc/openvpn/client/USERNAME</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cp /etc/openvpn/easy-rsa-server/3/pki/issued/USERNAME.crt /etc/openvpn/client/USERNAME</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cp /etc/openvpn/easy-rsa-client/3/pki/private/USERNAME.key /etc/openvpn/client/USERNAME</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cp /etc/openvpn/certs/&#123;ca.crt,dh.pem,ta.key&#125; /etc/openvpn/client/USERNAME/</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cp /etc/openvpn/client/tdison/client.ovpn /etc/openvpn/client/USERNAME/</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#ll /etc/openvpn/client/USERNAME/</span></span><br><span class="line">total 28</span><br><span class="line">-rw------- 1 root root 1204 Aug  4 16:41 ca.crt</span><br><span class="line">-rw-r--r-- 1 root root  231 Aug  4 16:44 client.ovpn</span><br><span class="line">-rw------- 1 root root  424 Aug  4 16:41 dh.pem</span><br><span class="line">-rw------- 1 root root 4492 Aug  4 16:38 USERNAME.crt</span><br><span class="line">-rw------- 1 root root 1854 Aug  4 16:38 USERNAME.key</span><br><span class="line">-rw------- 1 root root  636 Aug  4 16:41 ta.key</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#cd /etc/openvpn/client/USERNAME/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#根据服务器端修改下面配置,需要和服务器同步</span></span><br><span class="line">[root@centos8 USERNAME]<span class="comment">#vim client.ovpn</span></span><br><span class="line">[root@centos8 USERNAME]<span class="comment">#cat client.ovpn client</span></span><br><span class="line">client</span><br><span class="line">dev tun </span><br><span class="line">proto tcp</span><br><span class="line">remote  10.10.0.81  1194</span><br><span class="line">resolv-retry infinite</span><br><span class="line">nobind</span><br><span class="line">ca ca.crt</span><br><span class="line">cert USERNAME.crt </span><br><span class="line">key USERNAME.key            </span><br><span class="line">remote-cert-tls server</span><br><span class="line">tls-auth ta.key 1</span><br><span class="line">cipher AES-256-CBC</span><br><span class="line">verb 3</span><br><span class="line">compress lz4-v2</span><br><span class="line">[root@centos8 USERNAME]<span class="comment">#tar cf USERNAME.tar *</span></span><br></pre></td></tr></table></figure><h3 id="将相关文件传给客户端主机相应目录"><a href="#将相关文件传给客户端主机相应目录" class="headerlink" title="将相关文件传给客户端主机相应目录"></a>将相关文件传给客户端主机相应目录</h3><p>放置到windows客户端的<code>C:\Program Files\OpenVPN\config</code>目录下</p><h3 id="Windows-客户端连接"><a href="#Windows-客户端连接" class="headerlink" title="Windows 客户端连接"></a>Windows 客户端连接</h3><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2luzjhzxrj20l70cs75r.jpg"></p><h2 id="账户证书管理"><a href="#账户证书管理" class="headerlink" title="账户证书管理"></a>账户证书管理</h2><h3 id="证书手动注销"><a href="#证书手动注销" class="headerlink" title="证书手动注销"></a>证书手动注销</h3><p>查看当前证书的有效性,有效为V,无效为R</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#cat /etc/openvpn/easy-rsa-server/3/pki/index.txt</span><br><span class="line">V       320523065024Z           738AF442248F8317BA9C6247E37AF69E        unknown /CN=server</span><br><span class="line">V       220824065048Z           D087EA0E573DE2DB7C88B809D71AD1E2        unknown /CN=tdison</span><br></pre></td></tr></table></figure><p>吊销指定的用户的证书</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8  ~]<span class="comment"># cd /etc/openvpn/easy-rsa-server/3 </span></span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa  revoke tdison</span></span><br><span class="line"></span><br><span class="line">Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.8/vars</span><br><span class="line">Using SSL: openssl OpenSSL 1.1.1k  FIPS 25 Mar 2021</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Please confirm you wish to revoke the certificate with the following subject:</span><br><span class="line"></span><br><span class="line">subject=</span><br><span class="line">    commonName                = tdison</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Type the word <span class="string">&#x27;yes&#x27;</span> to <span class="built_in">continue</span>, or any other input to abort.</span><br><span class="line">  Continue with revocation: <span class="built_in">yes</span></span><br><span class="line">Using configuration from /etc/openvpn/easy-rsa-server/3/pki/easy-rsa-33553.Yy7wkH/tmp.5NIJyp</span><br><span class="line">Revoking Certificate D087EA0E573DE2DB7C88B809D71AD1E2.</span><br><span class="line">Data Base Updated</span><br><span class="line"></span><br><span class="line">IMPORTANT!!!</span><br><span class="line"></span><br><span class="line">Revocation was successful. You must run gen-crl and upload a CRL to your</span><br><span class="line">infrastructure <span class="keyword">in</span> order to prevent the revoked cert from being accepted.</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看当前证书的有效性,有效为V,无效为R</span></span><br><span class="line">[root@centos8 3]<span class="comment">#cat /etc/openvpn/easy-rsa-server/3/pki/index.txt</span></span><br><span class="line">V       320523065024Z           738AF442248F8317BA9C6247E37AF69E        unknown /CN=server</span><br><span class="line">R       220824065048Z   220526075757Z   D087EA0E573DE2DB7C88B809D71AD1E2        unknown /CN=tdison</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成证书吊销列表。每次吊销证书后都需要更新证书吊销列表文件,并且需要重启OpenVPN服务</span></span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa gen-crl</span></span><br><span class="line"></span><br><span class="line">Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.8/vars</span><br><span class="line">Using SSL: openssl OpenSSL 1.1.1k  FIPS 25 Mar 2021</span><br><span class="line">Using configuration from /etc/openvpn/easy-rsa-server/3/pki/easy-rsa-33597.fICkX8/tmp.zrgs7o</span><br><span class="line"></span><br><span class="line">An updated CRL has been created.</span><br><span class="line">CRL file: /etc/openvpn/easy-rsa-server/3/pki/crl.pem</span><br><span class="line"></span><br><span class="line"><span class="comment">#第一次吊销证时需要编辑配置文件调用吊销证书的文件,后续吊销无需此步 </span></span><br><span class="line">[root@openvpn-server 3.0.3]<span class="comment"># vim /etc/openvpn/server.conf </span></span><br><span class="line">crl-verify /etc/openvpn/easy-rsa-server/3/pki/crl.pem</span><br><span class="line"><span class="comment">#每次吊销证书后,都需要重新启动才能生效</span></span><br><span class="line">[root@centos8 3]<span class="comment">#systemctl restart openvpn@server.service</span></span><br></pre></td></tr></table></figure><h3 id="账户重名证书签发"><a href="#账户重名证书签发" class="headerlink" title="账户重名证书签发"></a>账户重名证书签发</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#删除准备撤销的账户证书</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cd /etc/openvpn/easy-rsa-client/3/</span></span><br><span class="line">[root@centos8 3]<span class="comment">#rm -f pki/private/tdison.key</span></span><br><span class="line">[root@centos8 3]<span class="comment">#rm -f pki/reqs/tdison.req</span></span><br><span class="line">[root@centos8 3]<span class="comment">#rm -rf /etc/openvpn/client/tdison/*</span></span><br><span class="line">[root@centos8 3]<span class="comment">#rm -f /etc/openvpn/easy-rsa-server/3/pki/reqs/tdison.req</span></span><br><span class="line">[root@centos8 3]<span class="comment">#rm -f /etc/openvpn/easy-rsa-server/3/pki/issued/tdison.crt</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#删除之前的带R的吊销记录</span></span><br><span class="line">[root@centos8 3]<span class="comment">#vim  /etc/openvpn/easy-rsa-server/3/pki/index.txt</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#重新生成新的账户证书申请和私钥</span></span><br><span class="line">[root@centos8 3]<span class="comment">#cd /etc/openvpn/easy-rsa-client/3</span></span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa gen-req tdison</span></span><br><span class="line">......</span><br><span class="line">Common Name (eg: your user, host, or server name) [tdison]:<span class="comment">#直接回车 </span></span><br><span class="line">Keypair and certificate request completed. Your files are:</span><br><span class="line">req: /etc/openvpn/easy-rsa-client/3/pki/reqs/tdison.req </span><br><span class="line">key: /etc/openvpn/easy-rsa-client/3/pki/private/tdison.key</span><br><span class="line"></span><br><span class="line"><span class="comment">#CA导入证书并签发</span></span><br><span class="line">[root@centos8 3]<span class="comment">#cd /etc/openvpn/easy-rsa-server/3</span></span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa import-req /etc/openvpn/easy-rsa-client/3/pki/reqs/tdison.req tdison</span></span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa  sign client tdison</span></span><br><span class="line">......</span><br><span class="line">Type the word <span class="string">&#x27;yes&#x27;</span> to <span class="built_in">continue</span>, or any other input to abort. </span><br><span class="line">  Confirm request details: <span class="built_in">yes</span>  <span class="comment">#输入yes</span></span><br><span class="line">......</span><br><span class="line">Write out database with 1 new entries </span><br><span class="line">Data Base Updated</span><br><span class="line"></span><br><span class="line">Certificate created at: /etc/openvpn/easy-rsa-server/3/pki/issued/tdison.crt</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成相关文件</span></span><br><span class="line">[root@centos8 3]<span class="comment">#cp /etc/openvpn/easy-rsa-server/3/pki/issued/tdison.crt /etc/openvpn/client/tdison/</span></span><br><span class="line">[root@centos8 3]<span class="comment">#cp /etc/openvpn/easy-rsa-client/3/pki/private/tdison.key /etc/openvpn/client/tdison/</span></span><br><span class="line">[root@centos8 3]<span class="comment">#cp /etc/openvpn/certs/&#123;ca.crt,dh.pem,ta.key&#125; /etc/openvpn/client/tdison/</span></span><br><span class="line">[root@centos8 3]<span class="comment">#cp /etc/openvpn/client/USERNAME/client.ovpn /etc/openvpn/client/tdison/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改客户端配置文件</span></span><br><span class="line">[root@centos8 3]<span class="comment">#vim /etc/openvpn/client/tdison/client.ovpn</span></span><br><span class="line">client</span><br><span class="line">dev tun </span><br><span class="line">proto tcp</span><br><span class="line">remote  10.10.0.81  1194</span><br><span class="line">resolv-retry infinite</span><br><span class="line">nobind</span><br><span class="line">ca ca.crt</span><br><span class="line">cert tdison.crt </span><br><span class="line">key tdison.key            </span><br><span class="line">remote-cert-tls server</span><br><span class="line">tls-auth ta.key 1</span><br><span class="line">cipher AES-256-CBC</span><br><span class="line">verb 3</span><br><span class="line">compress lz4-v2</span><br><span class="line"></span><br><span class="line"><span class="comment">#将/etc/openvpn/client/tdison所有文件打包传到客户端用</span></span><br></pre></td></tr></table></figure><h3 id="自动化的证书颁发脚本"><a href="#自动化的证书颁发脚本" class="headerlink" title="自动化的证书颁发脚本"></a>自动化的证书颁发脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">. /etc/init.d/functions</span><br><span class="line"></span><br><span class="line">OPENVPN_SERVER=&lt;OpenVPN Server 公网IP&gt;</span><br><span class="line">PASS=123456</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">remove_cert</span></span> () &#123;</span><br><span class="line">    <span class="built_in">rm</span> -rf /etc/openvpn/client/<span class="variable">$&#123;NAME&#125;</span> </span><br><span class="line">    find /etc/openvpn/ -name <span class="string">&quot;<span class="variable">$NAME</span>.*&quot;</span> -delete</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">create_cert</span></span> () &#123;</span><br><span class="line">    <span class="built_in">cd</span> /etc/openvpn/easy-rsa-client/3</span><br><span class="line">    ./easyrsa  gen-req <span class="variable">$&#123;NAME&#125;</span> nopass &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">cd</span> /etc/openvpn/easy-rsa-server/3</span><br><span class="line">    ./easyrsa import-req /etc/openvpn/easy-rsa-client/3/pki/reqs/<span class="variable">$&#123;NAME&#125;</span>.req <span class="variable">$&#123;NAME&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ./easyrsa sign client <span class="variable">$&#123;NAME&#125;</span> &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">yes</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">mkdir</span>  /etc/openvpn/client/<span class="variable">$&#123;NAME&#125;</span></span><br><span class="line">    <span class="built_in">cp</span> /etc/openvpn/easy-rsa-server/3/pki/issued/<span class="variable">$&#123;NAME&#125;</span>.crt /etc/openvpn/client/<span class="variable">$&#123;NAME&#125;</span></span><br><span class="line">    <span class="built_in">cp</span> /etc/openvpn/easy-rsa-client/3/pki/private/<span class="variable">$&#123;NAME&#125;</span>.key  /etc/openvpn/client/<span class="variable">$&#123;NAME&#125;</span></span><br><span class="line">    <span class="built_in">cp</span> /etc/openvpn/certs/&#123;ca.crt,dh.pem,ta.key&#125; /etc/openvpn/client/<span class="variable">$&#123;NAME&#125;</span></span><br><span class="line">    <span class="built_in">cat</span> &gt;  /etc/openvpn/client/<span class="variable">$&#123;NAME&#125;</span>/client.ovpn &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">client</span></span><br><span class="line"><span class="string">dev tun</span></span><br><span class="line"><span class="string">proto tcp</span></span><br><span class="line"><span class="string">remote $OPENVPN_SERVER 1194</span></span><br><span class="line"><span class="string">resolv-retry infinite</span></span><br><span class="line"><span class="string">nobind</span></span><br><span class="line"><span class="string">#persist-key</span></span><br><span class="line"><span class="string">#persist-tun</span></span><br><span class="line"><span class="string">ca ca.crt</span></span><br><span class="line"><span class="string">cert $NAME.crt</span></span><br><span class="line"><span class="string">key $NAME.key</span></span><br><span class="line"><span class="string">remote-cert-tls server</span></span><br><span class="line"><span class="string">tls-auth ta.key 1</span></span><br><span class="line"><span class="string">cipher AES-256-CBC</span></span><br><span class="line"><span class="string">verb 3</span></span><br><span class="line"><span class="string">compress lz4-v2</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;证书存放路径:/etc/openvpn/client/<span class="variable">$&#123;NAME&#125;</span>,证书文件如下:&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\E[1;32m******************************************************************\E[0m&quot;</span></span><br><span class="line">    <span class="built_in">ls</span> -l /etc/openvpn/client/<span class="variable">$&#123;NAME&#125;</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\E[1;32m******************************************************************\E[0m&quot;</span></span><br><span class="line">    <span class="built_in">cd</span> /etc/openvpn/client/<span class="variable">$&#123;NAME&#125;</span> </span><br><span class="line">    zip -qP <span class="string">&quot;<span class="variable">$PASS</span>&quot;</span> /root/<span class="variable">$&#123;NAME&#125;</span>.zip * </span><br><span class="line">    action  <span class="string">&quot;证书的打包文件已生成: /root/<span class="variable">$&#123;NAME&#125;</span>.zip&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">read</span> -p <span class="string">&quot;请输入用户的姓名拼音: &quot;</span> NAME</span><br><span class="line"></span><br><span class="line">remove_cert</span><br><span class="line">create_cert</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CentOS运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CENTOS </tag>
            
            <tag> OpenVPN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mac终端美化</title>
      <link href="/2022/05/26/Mac%E7%BB%88%E7%AB%AF%E7%BE%8E%E5%8C%96/"/>
      <url>/2022/05/26/Mac%E7%BB%88%E7%AB%AF%E7%BE%8E%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="安装OneHalfDark主题"><a href="#安装OneHalfDark主题" class="headerlink" title="安装OneHalfDark主题"></a>安装OneHalfDark主题</h3><ul><li><p>下载OneHalfDark：</p><p>作者Github地址：<a href="https://github.com/sonph/onehalf">https://github.com/sonph/onehalf</a></p></li><li><p>解压后打开<code>./terminal/OneHalfDark.terminal</code>文件</p></li></ul><p><strong>自定义配置</strong></p><ul><li>在终端界面按下<code>⌘+,</code>打开终端偏好设置。</li></ul><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2lm1p2novj20wk0u0tbz.jpg"></p><h3 id="安装oh-my-zsh"><a href="#安装oh-my-zsh" class="headerlink" title="安装oh-my-zsh"></a>安装oh-my-zsh</h3><p><strong>curl 安装</strong></p><p><strong>GitHub</strong>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh -c &quot;$(curl -fsSL https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh)&quot;</span><br></pre></td></tr></table></figure><p><strong>Gitee ( 国内镜像 )</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh -c &quot;$(curl -fsSL https://gitee.com/mirrors/oh-my-zsh/raw/master/tools/install.sh)&quot;</span><br></pre></td></tr></table></figure><p><strong>wget 安装</strong></p><p><strong>GitHub</strong>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh -c &quot;$(wget https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh -O -)&quot;</span><br></pre></td></tr></table></figure><p><strong>Gitee ( 国内镜像 )</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh -c &quot;$(wget -O- https://gitee.com/pocmon/mirrors/raw/master/tools/install.sh)&quot;</span><br></pre></td></tr></table></figure><h3 id="安装powerlevel10k"><a href="#安装powerlevel10k" class="headerlink" title="安装powerlevel10k"></a>安装powerlevel10k</h3><p><strong>GitHub地址：<a href="https://github.com/romkatv/powerlevel10k">https://github.com/romkatv/powerlevel10k</a></strong></p><ol><li><p>安装字体</p><ul><li><a href="https://github.com/romkatv/powerlevel10k-media/raw/master/MesloLGS%20NF%20Regular.ttf">MesloLGS NF Regular.ttf</a></li><li><a href="https://github.com/romkatv/powerlevel10k-media/raw/master/MesloLGS%20NF%20Bold.ttf">MesloLGS NF Bold.ttf</a></li><li><a href="https://github.com/romkatv/powerlevel10k-media/raw/master/MesloLGS%20NF%20Italic.ttf">MesloLGS NF 斜体.ttf</a></li><li><a href="https://github.com/romkatv/powerlevel10k-media/raw/master/MesloLGS%20NF%20Bold%20Italic.ttf">MesloLGS NF 粗体斜体.ttf</a></li></ul></li><li><p>安装powerlevel10k：</p><p><strong>GitHub</strong>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone --depth=1 https://github.com/romkatv/powerlevel10k.git $&#123;ZSH\_CUSTOM:-$HOME/.oh-my-zsh/custom&#125;/themes/powerlevel10k</span><br></pre></td></tr></table></figure><p><strong>Gitee ( 国内镜像 )</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone --depth=1 https://gitee.com/romkatv/powerlevel10k.git $&#123;ZSH\_CUSTOM:-$HOME/.oh-my-zsh/custom&#125;/themes/powerlevel10k</span><br></pre></td></tr></table></figure></li><li><p>在<code>~/.zshrc</code>中设置<code>ZSH_THEME=&quot;powerlevel10k/powerlevel10k&quot;</code>.</p></li><li><p>配置字体</p><ul><li><strong>iTerm2</strong>: 当被问及是否安装Meslo Nerd字体时，键入 <code>p10k configure</code> 并回答 <code>Yes</code> 。或者，打开iTerm2→首选项→配置文件→文本，并将字体设置为 <code>MesloLGS NF</code>。</li><li><strong>Apple Terminal</strong>: 打开终端→首选项→配置文件→文本，单击字体下的更改，然后选择 <code>MesloLGS NF</code> 系列。</li></ul></li><li><p>配置powerlevel10k</p><ul><li><p>重启终端后，Powerlevel10k配置向导会自动运行。如果没有自动运行，手动输入<code>p10k configure</code>运行。</p></li><li><p>修改<code>~/.p10k.zsh</code>文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">typeset</span> -g POWERLEVEL9K_LEFT_PROMPT_ELEMENTS=(   <span class="comment">#搜索此行</span></span><br><span class="line">  os_icon                 <span class="comment"># os identifier</span></span><br><span class="line">  context                 <span class="comment"># user@hostname        #添加此行</span></span><br><span class="line">  <span class="built_in">dir</span>                     <span class="comment"># current directory</span></span><br></pre></td></tr></table></figure></li></ul></li></ol><h3 id="安装Zsh-autosuggestions插件"><a href="#安装Zsh-autosuggestions插件" class="headerlink" title="安装Zsh-autosuggestions插件"></a>安装<code>Zsh-autosuggestions</code>插件</h3><ul><li><p>根据历史记录和完成建议您键入的命令</p><p><strong>GitHub地址：<a href="https://github.com/zsh-users/zsh-autosuggestions">https://github.com/zsh-users/zsh-autosuggestions</a></strong></p><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2lm2wsqm6g20oq01879r.gif"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/zsh-users/zsh-autosuggestions ~/.zsh/zsh-autosuggestions</span><br></pre></td></tr></table></figure></li><li><p>将插件添加到 Oh My Zsh 加载的插件列表（<code>~/.zshrc</code>）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">plugins=( </span><br><span class="line">    <span class="comment"># other plugins...</span></span><br><span class="line">    zsh-autosuggestions</span><br><span class="line">)</span><br></pre></td></tr></table></figure></li></ul><h3 id="安装zsh-syntax-highlighting插件"><a href="#安装zsh-syntax-highlighting插件" class="headerlink" title="安装zsh-syntax-highlighting插件"></a>安装<code>zsh-syntax-highlighting</code>插件</h3><ul><li><p>语法高亮。当命令在 zsh 提示符下输入交互式终端时，它可以突出显示命令。这有助于在运行命令之前检查命令错误。</p><p><strong>GitHub地址：<a href="https://github.com/zsh-users/zsh-syntax-highlighting">https://github.com/zsh-users/zsh-syntax-highlighting</a></strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/zsh-users/zsh-syntax-highlighting.git $&#123;ZSH_CUSTOM:-~/.oh-my-zsh/custom&#125;/plugins/zsh-syntax-highlighting</span><br></pre></td></tr></table></figure><p>将插件添加到 Oh My Zsh 加载的插件列表（<code>~/.zshrc</code>）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">plugins=( </span><br><span class="line">    <span class="comment"># other plugins...</span></span><br><span class="line">    zsh-syntax-highlighting</span><br><span class="line">)</span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      <categories>
          
          <category> MacOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MacOS </tag>
            
            <tag> zsh </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OpenVPN部署</title>
      <link href="/2022/05/22/OpenVPN%E9%83%A8%E7%BD%B2/"/>
      <url>/2022/05/22/OpenVPN%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="实验环境："><a href="#实验环境：" class="headerlink" title="实验环境："></a>实验环境：</h3><p><strong>1 openvpn server：</strong><br>CentOS 8<br>eth0:10.10.0.81&#x2F;24  桥接模式,模拟公网IP<br>eth1:10.0.1.1&#x2F;24 仅主机模式,私网IP</p><p><strong>2 内网主机两台</strong><br>第一台主机<br>eth0:10.0.1.100&#x2F;24 仅主机模式,私网IP，无需网关<br>第二台主机<br>eth0:10.0.1.200&#x2F;24 仅主机模式,私网IP，无需网关 </p><p><strong>3 Windows 客户端</strong><br>Windows 10</p><h3 id="关闭系统安全模式："><a href="#关闭系统安全模式：" class="headerlink" title="关闭系统安全模式："></a>关闭系统安全模式：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># vim /etc/sysconfig/selinux</span></span><br><span class="line">SELINUX=<span class="built_in">disable</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># setenforce 0</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># echo 1 &gt; /proc/sys/net/ipv4/ip_forward     #临时开启路由转发</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># vi  /etc/sysctl.conf   #编辑配置文件，添加以下配置，设置永久路由转发</span></span><br><span class="line">net.ipv4.ip_forward = 1</span><br></pre></td></tr></table></figure><h3 id="安装-OpenVPN"><a href="#安装-OpenVPN" class="headerlink" title="安装 OpenVPN"></a>安装 OpenVPN</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#OpenVPN服务器端</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#yum -y install openvpn </span></span><br><span class="line"><span class="comment">#证书管理工具</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#yum -y install easy-rsa</span></span><br></pre></td></tr></table></figure><h3 id="准备相关配置文件"><a href="#准备相关配置文件" class="headerlink" title="准备相关配置文件"></a>准备相关配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#生成服务器配置文件</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cp /usr/share/doc/openvpn/sample/sample-config-files/server.conf /etc/openvpn/</span></span><br><span class="line"><span class="comment">#准备证书签发相关文件</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cp -r /usr/share/easy-rsa/ /etc/openvpn/easy-rsa-server </span></span><br><span class="line"><span class="comment">#准备签发证书相关变量的配置文件</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cp /usr/share/doc/easy-rsa/vars.example  /etc/openvpn/easy-rsa-server/3/vars</span></span><br><span class="line"><span class="comment">#建议修改给CA和OpenVPN服务器颁发的证书的有效期,可适当加长 </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#vim /etc/openvpn/easy-rsa-server/3/vars </span></span><br><span class="line"><span class="comment">#CA的证书有效期默为为10年,可以适当延长,比如:36500天</span></span><br><span class="line"><span class="comment">#set_var EASYRSA_CA_EXPIRE      3650 </span></span><br><span class="line">set_var EASYRSA_CA_EXPIRE      36500</span><br><span class="line"><span class="comment">#服务器证书默为为825天,可适当加长,比如:3650天 </span></span><br><span class="line"><span class="comment">#set_var EASYRSA_CERT_EXPIRE    825 </span></span><br><span class="line"><span class="comment">#将上面行修改为下面</span></span><br><span class="line">set_var EASYRSA_CERT_EXPIRE    3650 </span><br><span class="line">[root@centos8 ~]<span class="comment">#tree /etc/openvpn/</span></span><br><span class="line">/etc/openvpn/</span><br><span class="line">├── client</span><br><span class="line">├── easy-rsa-server</span><br><span class="line">│   ├── 3 -&gt; 3.0.7</span><br><span class="line">│   ├── 3.0 -&gt; 3.0.7</span><br><span class="line">│   └── 3.0.7</span><br><span class="line">│       ├── easyrsa</span><br><span class="line">│       ├── openssl-easyrsa.cnf</span><br><span class="line">│       ├── vars</span><br><span class="line">│       └── x509-types</span><br><span class="line">│           ├── ca</span><br><span class="line">│           ├── client</span><br><span class="line">│           ├── code-signing</span><br><span class="line">│           ├── COMMON</span><br><span class="line">│           ├── email</span><br><span class="line">│           ├── kdc</span><br><span class="line">│           ├── server</span><br><span class="line">│           └── serverClient </span><br><span class="line">├── server</span><br><span class="line">└── server.conf</span><br><span class="line">7 directories, 12 files</span><br></pre></td></tr></table></figure><h3 id="初始化PKI生成PKI相关目录和文件"><a href="#初始化PKI生成PKI相关目录和文件" class="headerlink" title="初始化PKI生成PKI相关目录和文件"></a>初始化PKI生成PKI相关目录和文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cd /etc/openvpn/easy-rsa-server/3/ </span></span><br><span class="line">[root@centos8 3]<span class="comment">#ls</span></span><br><span class="line">easyrsa  openssl-easyrsa.cnf  vars  x509-types</span><br><span class="line"><span class="comment">#初始化数据,在当前目录下生成pki目录及相关文件 </span></span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa  init-pki</span></span><br><span class="line">Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars </span><br><span class="line">init-pki complete; you may now create a CA or requests.</span><br><span class="line">Your newly created PKI <span class="built_in">dir</span> is: /etc/openvpn/easy-rsa-server/3/pki </span><br><span class="line">[root@centos8 3]<span class="comment">#tree</span></span><br><span class="line">.</span><br><span class="line">├── easyrsa</span><br><span class="line">├── openssl-easyrsa.cnf</span><br><span class="line">├── pki          <span class="comment">#生成一个新目录及相关文件 </span></span><br><span class="line">│   ├── openssl-easyrsa.cnf</span><br><span class="line">│   ├── private </span><br><span class="line">│   ├── reqs</span><br><span class="line">│   └── safessl-easyrsa.cnf </span><br><span class="line">├── vars</span><br><span class="line">└── x509-types</span><br><span class="line">    ├── ca</span><br><span class="line">    ├── client</span><br><span class="line">    ├── code-signing</span><br><span class="line">    ├── COMMON</span><br><span class="line">    ├── email</span><br><span class="line">    ├── kdc</span><br><span class="line">    ├── server</span><br><span class="line">    └── serverClient</span><br><span class="line">4 directories, 13 files</span><br></pre></td></tr></table></figure><h3 id="创建CA机构"><a href="#创建CA机构" class="headerlink" title="创建CA机构"></a>创建CA机构</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cd /etc/openvpn/easy-rsa-server/3 </span></span><br><span class="line">[root@centos8 3]<span class="comment">#tree pki</span></span><br><span class="line">pki</span><br><span class="line">├── openssl-easyrsa.cnf </span><br><span class="line">├── private</span><br><span class="line">├── reqs</span><br><span class="line">└── safessl-easyrsa.cnf </span><br><span class="line">2 directories, 2 files</span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa build-ca nopass</span></span><br><span class="line">Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars</span><br><span class="line">Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019 </span><br><span class="line">Generating RSA private key, 2048 bit long modulus (2 primes)</span><br><span class="line">...................................................+++++</span><br><span class="line">........+++++</span><br><span class="line">e is 65537 (0x010001)</span><br><span class="line">You are about to be asked to enter information that will be incorporated </span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN. </span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value, </span><br><span class="line">If you enter <span class="string">&#x27;.&#x27;</span>, the field will be left blank. </span><br><span class="line">-----</span><br><span class="line">Common Name (eg: your user, host, or server name) [Easy-RSA CA]: <span class="comment">#接受默认值,直接回车</span></span><br><span class="line">CA creation complete and you may now import and sign cert requests. </span><br><span class="line">Your new CA certificate file <span class="keyword">for</span> publishing is at: </span><br><span class="line">/etc/openvpn/easy-rsa-server/3/pki/ca.crt  <span class="comment">#生成自签名的证书文件</span></span><br><span class="line">[root@centos8 3]<span class="comment">#tree pki </span></span><br><span class="line">pki</span><br><span class="line">├── ca.crt                  <span class="comment">#生成自签名的证书文件</span></span><br><span class="line">├── certs_by_serial</span><br><span class="line">├── index.txt</span><br><span class="line">├── index.txt.attr </span><br><span class="line">├── issued</span><br><span class="line">├── openssl-easyrsa.cnf</span><br><span class="line">├── private</span><br><span class="line">│   └── ca.key              <span class="comment">#生成私钥文件 </span></span><br><span class="line">├── renewed</span><br><span class="line">│   ├── certs_by_serial </span><br><span class="line">│   ├── private_by_serial </span><br><span class="line">│   └── reqs_by_serial </span><br><span class="line">├── reqs</span><br><span class="line">├── revoked</span><br><span class="line">│   ├── certs_by_serial </span><br><span class="line">│   ├── private_by_serial </span><br><span class="line">│   └── reqs_by_serial </span><br><span class="line">├── safessl-easyrsa.cnf </span><br><span class="line">└── serial</span><br><span class="line">12 directories, 7 files </span><br></pre></td></tr></table></figure><h3 id="创建服务端证书申请"><a href="#创建服务端证书申请" class="headerlink" title="创建服务端证书申请"></a>创建服务端证书申请</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cd /etc/openvpn/easy-rsa-server/3 </span></span><br><span class="line">[root@centos8 3]<span class="comment">#pwd</span></span><br><span class="line">/etc/openvpn/easy-rsa-server/3</span><br><span class="line"><span class="comment">#创建服务器证书申请文件，其中server是文件前缀</span></span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa gen-req server nopass</span></span><br><span class="line">Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars </span><br><span class="line">Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019</span><br><span class="line">Generating a RSA private key</span><br><span class="line">..................+++++</span><br><span class="line">................................................................................</span><br><span class="line">....................................................+++++</span><br><span class="line">writing new private key to <span class="string">&#x27;/etc/openvpn/easy-rsa-server/3/pki/easy-rsa- </span></span><br><span class="line"><span class="string">2135.JNDCBg/tmp.6nXb8b&#x27;</span></span><br><span class="line">-----</span><br><span class="line">You are about to be asked to enter information that will be incorporated </span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN. </span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value, </span><br><span class="line">If you enter <span class="string">&#x27;.&#x27;</span>, the field will be left blank. </span><br><span class="line">-----</span><br><span class="line">Common Name (eg: your user, host, or server name) [server]: <span class="comment">#接受Common Name的默认值,直接回车</span></span><br><span class="line">Keypair and certificate request completed. Your files are:</span><br><span class="line">req: /etc/openvpn/easy-rsa-server/3/pki/reqs/server.req          <span class="comment">#生成请求文件 </span></span><br><span class="line">key: /etc/openvpn/easy-rsa-server/3/pki/private/server.key       <span class="comment">#生成私钥文件</span></span><br><span class="line">[root@centos8 3]<span class="comment">#tree pki </span></span><br><span class="line">pki</span><br><span class="line">├── ca.crt</span><br><span class="line">├── certs_by_serial </span><br><span class="line">├── index.txt</span><br><span class="line">├── index.txt.attr </span><br><span class="line">├── issued</span><br><span class="line">├── openssl-easyrsa.cnf </span><br><span class="line">├── private</span><br><span class="line">│   ├── ca.key</span><br><span class="line">│   └── server.key       <span class="comment">#生成私钥文件 </span></span><br><span class="line">├── renewed</span><br><span class="line">│   ├── certs_by_serial </span><br><span class="line">│   ├── private_by_serial </span><br><span class="line">│   └── reqs_by_serial </span><br><span class="line">├── reqs</span><br><span class="line">│   └── server.req      <span class="comment">#生成请求文件 </span></span><br><span class="line">├── revoked</span><br><span class="line">│   ├── certs_by_serial </span><br><span class="line">│   ├── private_by_serial </span><br><span class="line">│   └── reqs_by_serial </span><br><span class="line">├── safessl-easyrsa.cnf </span><br><span class="line">└── serial</span><br><span class="line">12 directories, 9 files</span><br></pre></td></tr></table></figure><h3 id="颁发服务端证书"><a href="#颁发服务端证书" class="headerlink" title="颁发服务端证书"></a>颁发服务端证书</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#将上面server.req的申请,颁发server类型的证书</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cd /etc/openvpn/easy-rsa-server/3 </span></span><br><span class="line">  [root@centos8 3]<span class="comment">#./easyrsa sign server server</span></span><br><span class="line">Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars</span><br><span class="line">Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019</span><br><span class="line">You are about to sign the following certificate.</span><br><span class="line">Please check over the details shown below <span class="keyword">for</span> accuracy. Note that this request </span><br><span class="line">has not been cryptographically verified. Please be sure it came from a trusted </span><br><span class="line"><span class="built_in">source</span> or that you have verified the request checksum with the sender.</span><br><span class="line">Request subject, to be signed as a server certificate <span class="keyword">for</span> 3650 days:   <span class="comment">#可以看到vars文件指定的有效期</span></span><br><span class="line">subject=</span><br><span class="line">    commonName                = server</span><br><span class="line">Type the word <span class="string">&#x27;yes&#x27;</span> to <span class="built_in">continue</span>, or any other input to abort. </span><br><span class="line">  Confirm request details: <span class="built_in">yes</span> <span class="comment">#输入yes回车</span></span><br><span class="line">Using configuration from /etc/openvpn/easy-rsa-server/3/pki/easy-rsa- </span><br><span class="line">2334.MEAQFE/tmp.SIdgaC</span><br><span class="line">Check that the request matches the signature </span><br><span class="line">Signature ok</span><br><span class="line">The Subject<span class="string">&#x27;s Distinguished Name is as follows </span></span><br><span class="line"><span class="string">commonName            :ASN.1 12:&#x27;</span>server<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Certificate is to be certified until Oct 31 09:19:43 2020 GMT (90 days) </span></span><br><span class="line"><span class="string">Write out database with 1 new entries</span></span><br><span class="line"><span class="string">Data Base Updated</span></span><br><span class="line"><span class="string">Certificate created at: /etc/openvpn/easy-rsa-server/3/pki/issued/server.crt #生成服务器证书文件</span></span><br></pre></td></tr></table></figure><h3 id="创建-Diffie-Hellman-密钥"><a href="#创建-Diffie-Hellman-密钥" class="headerlink" title="创建 Diffie-Hellman 密钥"></a>创建 Diffie-Hellman 密钥</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cd /etc/openvpn/easy-rsa-server/3 </span></span><br><span class="line">[root@centos8 3]<span class="comment">#pwd</span></span><br><span class="line">/etc/openvpn/easy-rsa-server/3</span><br><span class="line"><span class="comment">#方法1</span></span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa gen-dh</span></span><br><span class="line">Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars </span><br><span class="line">Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019</span><br><span class="line">Generating DH parameters, 2048 bit long safe prime, generator 2 </span><br><span class="line">This is going to take a long time</span><br><span class="line">................+..................................+............................</span><br><span class="line">..........................++*++*++*++*</span><br><span class="line">.......<span class="comment">#需要等待一会儿</span></span><br><span class="line">DH parameters of size 2048 created at /etc/openvpn/easy-rsa-sever/3/pki/dh.pem </span><br><span class="line"></span><br><span class="line"><span class="comment">#方法2</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#openssl dhparam -out /etc/openvpn/dh2048.pem 2048 </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#ll /etc/openvpn/dh2048.pem</span></span><br><span class="line">-rw-r--r-- 1 root root 424 Aug  3 20:50 /etc/openvpn/dh2048.pem</span><br></pre></td></tr></table></figure><p>服务端证书配置完成</p><h3 id="准备客户端证书环境"><a href="#准备客户端证书环境" class="headerlink" title="准备客户端证书环境"></a>准备客户端证书环境</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cp -r /usr/share/easy-rsa/ /etc/openvpn/easy-rsa-client </span></span><br><span class="line"><span class="comment">#可选</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cp /usr/share/doc/easy-rsa/vars.example /etc/openvpn/easy-rsa-client/3/vars</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cd /etc/openvpn/easy-rsa-client/3/ </span></span><br><span class="line">[root@centos8 3]<span class="comment">#tree</span></span><br><span class="line">.</span><br><span class="line">├── easyrsa</span><br><span class="line">├── openssl-easyrsa.cnf </span><br><span class="line">├── vars</span><br><span class="line">└── x509-types</span><br><span class="line">    ├── ca</span><br><span class="line">    ├── client</span><br><span class="line">    ├── code-signing</span><br><span class="line">    ├── COMMON</span><br><span class="line">    ├── email</span><br><span class="line">    ├── kdc</span><br><span class="line">    ├── server</span><br><span class="line">    └── serverClient</span><br><span class="line">1 directory, 11 files</span><br><span class="line"><span class="comment">#生成证书申请所需目录pki和文件</span></span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa init-pki</span></span><br><span class="line">Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-client/3.0.7/vars </span><br><span class="line">init-pki complete; you may now create a CA or requests.</span><br><span class="line">Your newly created PKI <span class="built_in">dir</span> is: /etc/openvpn/easy-rsa-client/3/pki  <span class="comment">#生成新目录 </span></span><br><span class="line">[root@centos8 3]<span class="comment">#tree</span></span><br><span class="line">.</span><br><span class="line">├── easyrsa</span><br><span class="line">├── openssl-easyrsa.cnf</span><br><span class="line">├── pki                                 <span class="comment">#生成新目录 </span></span><br><span class="line">│   ├── openssl-easyrsa.cnf</span><br><span class="line">│   ├── private </span><br><span class="line">│   ├── reqs</span><br><span class="line">│   └── safessl-easyrsa.cnf </span><br><span class="line">├── vars</span><br><span class="line">└── x509-types</span><br><span class="line">    ├── ca</span><br><span class="line">    ├── client</span><br><span class="line">    ├── code-signing </span><br><span class="line">    ├── COMMON</span><br><span class="line">    ├── email</span><br><span class="line">    ├── kdc</span><br><span class="line">    ├── server</span><br><span class="line">    └── serverClient </span><br><span class="line">4 directories, 13 files</span><br></pre></td></tr></table></figure><h3 id="创建客户端证书申请"><a href="#创建客户端证书申请" class="headerlink" title="创建客户端证书申请"></a>创建客户端证书申请</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cd /etc/openvpn/easy-rsa-client/3 </span></span><br><span class="line"><span class="comment">#生成客户端用户的证书申请</span></span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa  gen-req USERNAME nopass</span></span><br><span class="line">Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-client/3.0.7/vars </span><br><span class="line">Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019</span><br><span class="line">Generating a RSA private key</span><br><span class="line">.......................................................+++++</span><br><span class="line">................................................................................</span><br><span class="line">.........................+++++</span><br><span class="line">writing new private key to <span class="string">&#x27;/etc/openvpn/easy-rsa-client/3/pki/easy-rsa- </span></span><br><span class="line"><span class="string">3467.v5FPPS/tmp.GsttV6&#x27;</span></span><br><span class="line">-----</span><br><span class="line">You are about to be asked to enter information that will be incorporated </span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN. </span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value, </span><br><span class="line">If you enter <span class="string">&#x27;.&#x27;</span>, the field will be left blank. </span><br><span class="line">-----</span><br><span class="line">Common Name (eg: your user, host, or server name) [USERNAME]:  <span class="comment">#接受默认值,直接回车</span></span><br><span class="line">Keypair and certificate request completed. Your files are:</span><br><span class="line">req: /etc/openvpn/easy-rsa-client/3/pki/reqs/USERNAME.req      <span class="comment">#私钥文件 </span></span><br><span class="line">key: /etc/openvpn/easy-rsa-client/3/pki/private/USERNAME.key    <span class="comment">#证书申请文件</span></span><br><span class="line"><span class="comment">#生成两个新文件</span></span><br><span class="line">[root@centos8 3]<span class="comment">#tree</span></span><br><span class="line">.</span><br><span class="line">├── easyrsa</span><br><span class="line">├── openssl-easyrsa.cnf </span><br><span class="line">├── pki</span><br><span class="line">│   ├── openssl-easyrsa.cnf </span><br><span class="line">│   ├── private</span><br><span class="line">│   │   └── USERNAME.key  <span class="comment">#私钥文件 </span></span><br><span class="line">│   ├── reqs</span><br><span class="line">│   │   └── USERNAME.req  <span class="comment">#证书申请文件 </span></span><br><span class="line">│   └── safessl-easyrsa.cnf</span><br><span class="line">├── vars</span><br><span class="line">└── x509-types </span><br><span class="line">    ├── ca</span><br><span class="line">    ├── client</span><br><span class="line">    ├── code-signing </span><br><span class="line">    ├── COMMON</span><br><span class="line">    ├── email</span><br><span class="line">    ├── kdc</span><br><span class="line">    ├── server</span><br><span class="line">    └── serverClient </span><br><span class="line">4 directories, 15 files</span><br></pre></td></tr></table></figure><h3 id="签发客户端证书"><a href="#签发客户端证书" class="headerlink" title="签发客户端证书"></a>签发客户端证书</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cd /etc/openvpn/easy-rsa-server/3 </span></span><br><span class="line"><span class="comment">#将客户端证书请求文件复制到CA的工作目录</span></span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa import-req /etc/openvpn/easy-rsa-client/3/pki/reqs/USERNAME.req USERNAME</span></span><br><span class="line">Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars </span><br><span class="line">Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019</span><br><span class="line">The request has been successfully imported with a short name of: USERNAME </span><br><span class="line">You may now use this name to perform signing operations on this request.</span><br><span class="line">[root@centos8 3]<span class="comment">#tree pki </span></span><br><span class="line">pki</span><br><span class="line">├── ca.crt</span><br><span class="line">├── certs_by_serial</span><br><span class="line">│   └── EDAEBAB8D65066D307AE58ADC1A56682.pem </span><br><span class="line">├── dh.pem</span><br><span class="line">├── index.txt</span><br><span class="line">├── index.txt.attr</span><br><span class="line">├── index.txt.attr.old </span><br><span class="line">├── index.txt.old</span><br><span class="line">├── issued</span><br><span class="line">│   └── server.crt</span><br><span class="line">├── openssl-easyrsa.cnf </span><br><span class="line">├── private</span><br><span class="line">│   ├── ca.key </span><br><span class="line">│   └── server.key </span><br><span class="line">├── renewed</span><br><span class="line">│   ├── certs_by_serial </span><br><span class="line">│   ├── private_by_serial </span><br><span class="line">│   └── reqs_by_serial </span><br><span class="line">├── reqs</span><br><span class="line">│   ├── server.req</span><br><span class="line">│   └── USERNAME.req   <span class="comment">#导入文件 </span></span><br><span class="line">├── revoked</span><br><span class="line">│   ├── certs_by_serial </span><br><span class="line">│   ├── private_by_serial </span><br><span class="line">│   └── reqs_by_serial </span><br><span class="line">├── safessl-easyrsa.cnf </span><br><span class="line">├── serial</span><br><span class="line">└── serial.old</span><br><span class="line">12 directories, 16 files</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改给客户端颁发的证书的有效期</span></span><br><span class="line">[root@centos8 3]<span class="comment">#vim vars</span></span><br><span class="line"><span class="comment">#建议修改给客户端颁发证书的有效期,可适当减少,比如:90天 </span></span><br><span class="line"><span class="comment">#set_var EASYRSA_CERT_EXPIRE    825</span></span><br><span class="line"><span class="comment">#将上面行修改为下面</span></span><br><span class="line">set_var EASYRSA_CERT_EXPIRE 90 </span><br><span class="line"><span class="comment">#签发客户端证书</span></span><br><span class="line">[root@centos8 3]<span class="comment">#./easyrsa sign client USERNAME</span></span><br><span class="line">Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars </span><br><span class="line">Using SSL: openssl OpenSSL 1.1.1c FIPS  28 May 2019</span><br><span class="line">You are about to sign the following certificate.</span><br><span class="line">Please check over the details shown below <span class="keyword">for</span> accuracy. Note that this request </span><br><span class="line">has not been cryptographically verified. Please be sure it came from a trusted </span><br><span class="line"><span class="built_in">source</span> or that you have verified the request checksum with the sender.</span><br><span class="line">Request subject, to be signed as a client certificate <span class="keyword">for</span> 90 days: </span><br><span class="line">subject=</span><br><span class="line">    commonName                = USERNAME</span><br><span class="line">Type the word <span class="string">&#x27;yes&#x27;</span> to <span class="built_in">continue</span>, or any other input to abort.</span><br><span class="line">  Confirm request details: <span class="built_in">yes</span>                      <span class="comment">#输入yes后回车 </span></span><br><span class="line">Using configuration from /etc/openvpn/easy-rsa-server/3/pki/easy-rsa- </span><br><span class="line">3617.XN7fIU/tmp.P7NKo8</span><br><span class="line">Check that the request matches the signature </span><br><span class="line">Signature ok</span><br><span class="line">The Subject<span class="string">&#x27;s Distinguished Name is as follows </span></span><br><span class="line"><span class="string">commonName            :ASN.1 12:&#x27;</span>USERNAME<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Certificate is to be certified until Oct 31 15:38:15 2020 GMT (90 days) </span></span><br><span class="line"><span class="string">Write out database with 1 new entries</span></span><br><span class="line"><span class="string">Data Base Updated</span></span><br><span class="line"><span class="string">Certificate created at: /etc/openvpn/easy-rsa- </span></span><br><span class="line"><span class="string">server/3/pki/issued/USERNAME.crt #证书文件</span></span><br><span class="line"><span class="string">[root@centos8 3]#tree pki </span></span><br><span class="line"><span class="string">pki</span></span><br><span class="line"><span class="string">├── ca.crt</span></span><br><span class="line"><span class="string">├── certs_by_serial</span></span><br><span class="line"><span class="string">│   ├── 5FE114ACC4FE6AB89D17E1B0EECF2B78.pem </span></span><br><span class="line"><span class="string">│   └── EDAEBAB8D65066D307AE58ADC1A56682.pem </span></span><br><span class="line"><span class="string">├── dh.pem</span></span><br><span class="line"><span class="string">├── index.txt</span></span><br><span class="line"><span class="string">├── index.txt.attr </span></span><br><span class="line"><span class="string">├── index.txt.attr.old</span></span><br><span class="line"><span class="string">├── index.txt.old </span></span><br><span class="line"><span class="string">├── issued</span></span><br><span class="line"><span class="string">│   ├── server.crt</span></span><br><span class="line"><span class="string">│   └── USERNAME.crt          #生成客户端证书</span></span><br><span class="line"><span class="string">├── openssl-easyrsa.cnf</span></span><br><span class="line"><span class="string">├── private</span></span><br><span class="line"><span class="string">│   ├── ca.key </span></span><br><span class="line"><span class="string">│   └── server.key </span></span><br><span class="line"><span class="string">├── renewed</span></span><br><span class="line"><span class="string">│   ├── certs_by_serial </span></span><br><span class="line"><span class="string">│   ├── private_by_serial </span></span><br><span class="line"><span class="string">│   └── reqs_by_serial </span></span><br><span class="line"><span class="string">├── reqs</span></span><br><span class="line"><span class="string">│   ├── server.req</span></span><br><span class="line"><span class="string">│   └── USERNAME.req </span></span><br><span class="line"><span class="string">├── revoked</span></span><br><span class="line"><span class="string">│   ├── certs_by_serial </span></span><br><span class="line"><span class="string">│   ├── private_by_serial </span></span><br><span class="line"><span class="string">│   └── reqs_by_serial </span></span><br><span class="line"><span class="string">├── safessl-easyrsa.cnf </span></span><br><span class="line"><span class="string">├── serial</span></span><br><span class="line"><span class="string">└── serial.old</span></span><br><span class="line"><span class="string">12 directories, 18 files</span></span><br></pre></td></tr></table></figure><p>如果需要颁发的客户端证书较多,可以使用下面脚本实现客户端证书的批量颁发 </p><p><strong>客户端证书自动颁发脚本</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cat openvpn-user-crt.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="built_in">read</span> -p <span class="string">&quot;请输入用户的姓名拼音(如:<span class="variable">$&#123;NAME&#125;</span>): &quot;</span> NAME</span><br><span class="line"><span class="built_in">cd</span> /etc/openvpn/easy-rsa-client/3</span><br><span class="line">./easyrsa  gen-req <span class="variable">$&#123;NAME&#125;</span> nopass &lt;&lt;<span class="string">EOF </span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="built_in">cd</span> /etc/openvpn/easy-rsa-server/3</span><br><span class="line">./easyrsa import-req /etc/openvpn/easy-rsa-client/3/pki/reqs/<span class="variable">$&#123;NAME&#125;</span>.req <span class="variable">$&#123;NAME&#125;</span> </span><br><span class="line">./easyrsa sign client <span class="variable">$&#123;NAME&#125;</span> &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">yes</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h3 id="将CA和服务器证书相关文件复制到服务器相应的目录"><a href="#将CA和服务器证书相关文件复制到服务器相应的目录" class="headerlink" title="将CA和服务器证书相关文件复制到服务器相应的目录"></a>将CA和服务器证书相关文件复制到服务器相应的目录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#mkdir /etc/openvpn/certs</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cp /etc/openvpn/easy-rsa-server/3/pki/ca.crt /etc/openvpn/certs/</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cp /etc/openvpn/easy-rsa-server/3/pki/issued/server.crt /etc/openvpn/certs/</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cp /etc/openvpn/easy-rsa-server/3/pki/private/server.key /etc/openvpn/certs/        </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cp /etc/openvpn/easy-rsa-server/3/pki/dh.pem /etc/openvpn/certs/</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#ll /etc/openvpn/certs/ </span></span><br><span class="line">total 20</span><br><span class="line">-rw------- 1 root root 1204 Aug  3 20:34 ca.crt </span><br><span class="line">-rw------- 1 root root  424 Aug  3 20:35 dh.pem </span><br><span class="line">-rw------- 1 root root 4608 Aug  3 20:34 server.crt </span><br><span class="line">-rw------- 1 root root 1704 Aug  3 20:35 server.key</span><br></pre></td></tr></table></figure><h3 id="将客户端私钥与证书相关文件复制到服务器相关的目录"><a href="#将客户端私钥与证书相关文件复制到服务器相关的目录" class="headerlink" title="将客户端私钥与证书相关文件复制到服务器相关的目录"></a>将客户端私钥与证书相关文件复制到服务器相关的目录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#mkdir /etc/openvpn/client/USERNAME/</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#find /etc/openvpn/  -name &quot;USERNAME.key&quot; -o -name &quot;USERNAME.crt&quot; -o -name ca.crt</span></span><br><span class="line">/etc/openvpn/easy-rsa-client/3.0.7/pki/private/USERNAME.key </span><br><span class="line">/etc/openvpn/easy-rsa-server/3.0.7/pki/issued/USERNAME.crt </span><br><span class="line">/etc/openvpn/easy-rsa-server/3.0.7/pki/ca.crt </span><br><span class="line">/etc/openvpn/certs/ca.crt</span><br><span class="line">[root@centos8 ~]<span class="comment">#find /etc/openvpn/ \( -name &quot;USERNAME.key&quot; -o -name &quot;USERNAME.crt&quot; -o -name ca.crt \) -exec cp &#123;&#125; /etc/openvpn/client/USERNAME \;</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#ll /etc/openvpn/client/USERNAME/ </span></span><br><span class="line">total 16</span><br><span class="line">-rw------- 1 root root 1204 Aug  3 21:05 ca.crt</span><br><span class="line">-rw------- 1 root root 4506 Aug  3 21:05 USERNAME.crt </span><br><span class="line">-rw------- 1 root root 1704 Aug  3 21:05 USERNAME.key</span><br></pre></td></tr></table></figure><h3 id="准备-OpenVPN-服务器配置文件"><a href="#准备-OpenVPN-服务器配置文件" class="headerlink" title="准备 OpenVPN 服务器配置文件"></a>准备 OpenVPN 服务器配置文件</h3><p><strong>修改服务器端配置文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#vim /etc/openvpn/server.conf</span></span><br></pre></td></tr></table></figure><p><strong>服务器端配置文件说明</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#server.conf文件中以#或;开头的行都为注释</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#grep -Ev &quot;^#|^$&quot; /etc/openvpn/server.conf </span></span><br><span class="line">;<span class="built_in">local</span> a.b.c.d  <span class="comment">#本机监听IP,默认为本机所有IP</span></span><br><span class="line">port 1194       <span class="comment">#端口</span></span><br><span class="line">;proto tcp      <span class="comment">#协议,生产推荐使用TCP </span></span><br><span class="line">proto udp       <span class="comment">#默认协议</span></span><br><span class="line">;dev tap   <span class="comment">#创建一个以太网隧道，以太网使用tap,一个tap设备允许完整的以太网帧通过Openvpn隧道，可提供非ip协议的支持，比如IPX协议和AppleTalk协议,tap等同于一个以太网设备，它操作第二层数据包如以太网数据帧。</span></span><br><span class="line">dev tun    <span class="comment">#创建一个路由IP隧道，生产推存使用tun.互联网使用tun,一个tun设备大多时候，被用于基于IP协议的通讯。tun模拟了网络层设备，操作第三层数据包比如IP数据封包。</span></span><br><span class="line">;dev-node MyTap  <span class="comment">#TAP-Win32适配器。非windows不需要配置 </span></span><br><span class="line">ca  ca.crt       <span class="comment">#ca证书文件</span></span><br><span class="line">cert server.crt  <span class="comment">#服务器证书文件 </span></span><br><span class="line">key server.key   <span class="comment">#服务器私钥文件 </span></span><br><span class="line">dh dh2048.pem    <span class="comment">#dh参数文件 </span></span><br><span class="line">;topology subnet</span><br><span class="line">server 10.8.0.0 255.255.255.0  <span class="comment">#客户端连接后分配IP的地址池，服务器默认会占用第一个IP10.8.0.1将做为客户端的网关</span></span><br><span class="line">ifconfig-pool-persist ipp.txt  <span class="comment">#为客户端分配固定IP，不需要配置,建议注释</span></span><br><span class="line">;server-bridge 10.8.0.4 255.255.255.0 10.8.0.50 10.8.0.100  <span class="comment">#配置网桥模式，不需要配置,建议注释</span></span><br><span class="line">;server-bridge</span><br><span class="line">;push <span class="string">&quot;route 192.168.10.0 255.255.255.0&quot;</span>  <span class="comment">#给客户端生成的到达服务器后面网段的静态路由，下一跳为openvpn服务器的10.8.0.1</span></span><br><span class="line">;push <span class="string">&quot;route 192.168.20.0 255.255.255.0&quot;</span>  <span class="comment">#推送路由信息到客户端，以允许客户端能够连接到服务器背后的其它私有子网</span></span><br><span class="line">;client-config-dir ccd              <span class="comment">#为指定的客户端添加路由，此路由通常是客户端后面的内网网段而不是服务端的，也不需要设置</span></span><br><span class="line">;route 192.168.40.128 255.255.255.248 </span><br><span class="line">;client-config-dir ccd    </span><br><span class="line">;route 10.9.0.0 255.255.255.252</span><br><span class="line">;learn-address ./script                <span class="comment">#运行外部脚本，创建不同组的iptables规则，无需配置</span></span><br><span class="line">;push <span class="string">&quot;redirect-gateway def1 bypass-dhcp&quot;</span> <span class="comment">#启用后，客户端所有流量都将通过VPN服务器，因此生产一般无需配置此项</span></span><br><span class="line">;push <span class="string">&quot;dhcp-option DNS 208.67.222.222&quot;</span>   <span class="comment">#推送DNS服务器，不需要配置 </span></span><br><span class="line">;push <span class="string">&quot;dhcp-option DNS 208.67.220.220&quot;</span></span><br><span class="line">;client-to-client                       <span class="comment">#允许不同的client直接通信,不安全,生产环境一般无需要配置</span></span><br><span class="line">;duplicate-cn                           <span class="comment">#多个用户共用一个证书，一般用于测试环境，生产环境都是一个用户一个证书,无需开启</span></span><br><span class="line">keepalive 10 120         <span class="comment">#设置服务端检测的间隔和超时时间，默认为每10秒ping一次，如果120秒没有回应则认为对方已经down</span></span><br><span class="line">tls-auth ta.key 0       <span class="comment">#访止DoS等攻击的安全增强配置,可以使用以下命令来生成：openvpn -- </span></span><br><span class="line">genkey --secret ta.key <span class="comment">#服务器和每个客户端都需要拥有该密钥的一个拷贝。第二个参数在服务器端应该为’0’，在客户端应该为’1’</span></span><br><span class="line">cipher AES-256-CBC  <span class="comment">#加密算法</span></span><br><span class="line">;compress lz4-v2    <span class="comment">#启用Openvpn2.4.X新版压缩算法</span></span><br><span class="line">;push <span class="string">&quot;compress lz4-v2&quot;</span>   <span class="comment">#推送客户端使用新版压缩算法,和下面的comp-lzo不要同时使用</span></span><br><span class="line">;comp-lzo          <span class="comment">#旧户端兼容的压缩配置，需要客户端配置开启压缩,openvpn2.4.X等新版可以不用开启</span></span><br><span class="line">;max-clients 100   <span class="comment">#最大客户端数</span></span><br><span class="line">;user nobody         <span class="comment">#运行openvpn服务的用户和组 </span></span><br><span class="line">;group nobody</span><br><span class="line">persist-key          <span class="comment">#重启VPN服务时默认会重新读取key文件，开启此配置后保留使用第一次的key文件,生产环境无需开启</span></span><br><span class="line">persist-tun          <span class="comment">#启用此配置后,当重启vpn服务时，一直保持tun或者tap设备是up的，否则会先down然后再up,生产环境无需开启</span></span><br><span class="line">status openvpn-status.log <span class="comment">#openVPN状态记录文件，每分钟会记录一次</span></span><br><span class="line">;<span class="built_in">log</span>         openvpn.log   <span class="comment">#第一种日志记录方式,并指定日志路径，log会在openvpn启动的时候清空日志文件,不建议使用</span></span><br><span class="line">;log-append  openvpn.log   <span class="comment">#第二种日志记录方式,并指定日志路径，重启openvpn后在之前的日志后面追加新的日志,生产环境建议使用</span></span><br><span class="line">verb 3                   <span class="comment">#设置日志级别，0-9，级别越高记录的内容越详细,0 表示静默运行，只记录致命错误,4 表示合理的常规用法,5 和 6 可以帮助调试连接错误。9 表示极度冗余，输出非常详细的日志信息</span></span><br><span class="line">;mute 20                 <span class="comment">#相同类别的信息只有前20条会输出到日志文件中</span></span><br><span class="line">explicit-exit-notify 1   <span class="comment">#通知客户端，在服务端重启后自动重新连接，仅能用于udp模式，tcp模式不需要配置即可实现断开重新连接,且开启此项后tcp配置后将导致openvpn服务无法启动,所以tcp时必须不能开启此项</span></span><br></pre></td></tr></table></figure><p><strong>修改服务器端配置文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#vim /etc/openvpn/server.conf</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#grep &#x27;^[a-Z].*&#x27; /etc/openvpn/server.conf </span></span><br><span class="line">port 1194</span><br><span class="line">proto tcp</span><br><span class="line">dev tun</span><br><span class="line">ca /etc/openvpn/certs/ca.crt</span><br><span class="line">cert /etc/openvpn/certs/server.crt</span><br><span class="line">key /etc/openvpn/certs/server.key  <span class="comment"># This file should be kept secret</span></span><br><span class="line">dh /etc/openvpn/certs/dh.pem</span><br><span class="line">server 10.8.0.0 255.255.255.0</span><br><span class="line">push <span class="string">&quot;route 10.10.0.0 255.255.255.0&quot;</span></span><br><span class="line">keepalive 10 120</span><br><span class="line">cipher AES-256-CBC</span><br><span class="line">compress lz4-v2</span><br><span class="line">push <span class="string">&quot;compress lz4-v2&quot;</span></span><br><span class="line">max-clients 2048</span><br><span class="line">user openvpn</span><br><span class="line">group openvpn</span><br><span class="line">status /var/log/openvpn/openvpn-status.log</span><br><span class="line">log-append   /var/log/openvpn/openvpn.log</span><br><span class="line">verb 3</span><br><span class="line">mute 20</span><br><span class="line"><span class="comment">#准备目志相关目录</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#getent passwd openvpn</span></span><br><span class="line">openvpn:x:993:990:OpenVPN:/etc/openvpn:/sbin/nologin </span><br><span class="line">[root@centos8 ~]<span class="comment">#mkdir /var/log/openvpn</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#chown openvpn.openvpn /var/log/openvpn </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#ll -d /var/log/openvpn</span></span><br><span class="line">drwxr-xr-x 2 openvpn openvpn 6 Aug  3 23:07 /var/log/openvpn</span><br></pre></td></tr></table></figure><h3 id="准备-iptables-规则和内核参数"><a href="#准备-iptables-规则和内核参数" class="headerlink" title="准备 iptables 规则和内核参数"></a>准备 iptables 规则和内核参数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在服务器开启ip_forward转发功能</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#echo net.ipv4.ip_forward = 1 &gt;&gt; /etc/sysctl.conf </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#sysctl -p</span></span><br><span class="line">net.ipv4.ip_forward = 1 </span><br><span class="line"><span class="comment">#添加SNAT规则</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#echo &#x27;iptables -t nat -A POSTROUTING -s 10.10.0.0/24  -j MASQUERADE&#x27; &gt;&gt; /etc/rc.d/rc.local</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#chmod +x /etc/rc.d/rc.local </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#/etc/rc.d/rc.local</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#iptables -vnL</span></span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination </span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination </span><br><span class="line">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination</span><br><span class="line">[root@centos8 ~]<span class="comment">#iptables -vnL -t nat</span></span><br><span class="line">Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination </span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination </span><br><span class="line">Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination </span><br><span class="line">    0     0 MASQUERADE  all  --  *      *       10.10.0.0/24          0.0.0.0/0  </span><br><span class="line">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination</span><br></pre></td></tr></table></figure><h3 id="启动-OpenVPN-服务"><a href="#启动-OpenVPN-服务" class="headerlink" title="启动 OpenVPN 服务"></a>启动 OpenVPN 服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment">#rpm -ql openvpn|grep systemd </span></span><br><span class="line">/usr/lib/systemd/system/openvpn-client@.service </span><br><span class="line">/usr/lib/systemd/system/openvpn-server@.service </span><br><span class="line">/usr/lib/systemd/system/openvpn@.service </span><br><span class="line">/usr/share/doc/openvpn-2.4.9/README.systemd</span><br><span class="line"><span class="comment">#CentOS8 缺失unit文件,从CentOS7复制文件</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#rpm -ql openvpn|grep systemd </span></span><br><span class="line">/usr/lib/systemd/system/openvpn-client@.service </span><br><span class="line">/usr/lib/systemd/system/openvpn-server@.service </span><br><span class="line">/usr/share/doc/openvpn/README.systemd</span><br><span class="line">[root@centos7 ~]<span class="comment">#cat /usr/lib/systemd/system/openvpn@.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=OpenVPN Robust And Highly Flexible Tunneling Application On %I </span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=notify </span><br><span class="line">PrivateTmp=<span class="literal">true</span></span><br><span class="line">ExecStart=/usr/sbin/openvpn --<span class="built_in">cd</span> /etc/openvpn/ --config %i.conf </span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">[root@centos7 ~]<span class="comment">#scp /lib/systemd/system/openvpn@.service 10.10.0.81:/lib/systemd/system/</span></span><br><span class="line"><span class="comment">#启动OpenVPN服务,注意service名称和文件名不一致 </span></span><br><span class="line">[root@centos8 openvpn]<span class="comment">#systemctl daemon-reload</span></span><br><span class="line">[root@centos8 openvpn]<span class="comment">#systemctl enable --now openvpn@server</span></span><br></pre></td></tr></table></figure><h3 id="查看服务状态"><a href="#查看服务状态" class="headerlink" title="查看服务状态"></a>查看服务状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 openvpn]<span class="comment">#systemctl status openvpn@server</span></span><br><span class="line">● openvpn@server.service - OpenVPN Robust And Highly Flexible Tunneling Application On server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/openvpn@.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Thu 2022-05-19 16:25:43 CST; 3min 49s ago</span><br><span class="line"> Main PID: 7696 (openvpn)</span><br><span class="line">   Status: <span class="string">&quot;Initialization Sequence Completed&quot;</span></span><br><span class="line">    Tasks: 1 (<span class="built_in">limit</span>: 4724)</span><br><span class="line">   Memory: 2.0M</span><br><span class="line">   CGroup: /system.slice/system-openvpn.slice/openvpn@server.service</span><br><span class="line">           └─7696 /usr/sbin/openvpn --<span class="built_in">cd</span> /etc/openvpn/ --config server.conf</span><br><span class="line">Aug 04 00:30:12 centos8.localdomain systemd[1]: Starting OpenVPN Robust And Highly Flexible Tunneling Application &gt;</span><br><span class="line">Aug 04 00:30:12 centos8.localdomain systemd[1]: Started OpenVPN Robust And Highly Flexible Tunneling Application</span><br><span class="line"><span class="comment">#注意端口号</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#ss -ntlp</span></span><br><span class="line">State  Recv-Q  Send-Q   Local Address:Port   Peer Address:Port Process                                                   </span><br><span class="line">LISTEN 0       32             0.0.0.0:1194        0.0.0.0:*     <span class="built_in">users</span>:((<span class="string">&quot;openvpn&quot;</span>,pid=7696,fd=8))                        </span><br><span class="line">LISTEN 0       128            0.0.0.0:111         0.0.0.0:*     <span class="built_in">users</span>:((<span class="string">&quot;rpcbind&quot;</span>,pid=887,fd=4),(<span class="string">&quot;systemd&quot;</span>,pid=1,fd=34)) </span><br><span class="line">LISTEN 0       128            0.0.0.0:22          0.0.0.0:*     <span class="built_in">users</span>:((<span class="string">&quot;sshd&quot;</span>,pid=938,fd=4))                            </span><br><span class="line">LISTEN 0       128               [::]:111            [::]:*     <span class="built_in">users</span>:((<span class="string">&quot;rpcbind&quot;</span>,pid=887,fd=6),(<span class="string">&quot;systemd&quot;</span>,pid=1,fd=36)) </span><br><span class="line">LISTEN 0       128               [::]:22             [::]:*     <span class="built_in">users</span>:((<span class="string">&quot;sshd&quot;</span>,pid=938,fd=6))     </span><br><span class="line">[root@centos8 ~]<span class="comment">#ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 </span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever </span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:8a:51:21 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.0.0.8/24 brd 10.0.0.255 scope global noprefixroute eth0 </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fe8a:5121/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: tun0: &lt;POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state </span><br><span class="line">UNKNOWN group default qlen 100</span><br><span class="line">    <span class="built_in">link</span>/none</span><br><span class="line">    inet 10.8.0.1 peer 10.8.0.2/32 scope global tun0 </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::c8db:a8ca:b492:a3e0/64 scope <span class="built_in">link</span> stable-privacy </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[root@centos8 ~]<span class="comment">#route -n </span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         172.30.0.253    0.0.0.0         UG    100    0        0 eth0</span><br><span class="line">10.8.0.0        10.8.0.2        255.255.255.0   UG    0      0        0 tun0</span><br><span class="line">10.8.0.2        0.0.0.0         255.255.255.255 UH    0      0        0 tun0</span><br><span class="line">172.30.0.0      0.0.0.0         255.255.255.0   U     100    0        0 eth0</span><br></pre></td></tr></table></figure><h3 id="准备-OpenVPN-客户端配置文件"><a href="#准备-OpenVPN-客户端配置文件" class="headerlink" title="准备 OpenVPN 客户端配置文件"></a>准备 OpenVPN 客户端配置文件</h3><p><strong>客户端默认范例配置文件说明</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#grep &#x27;^[[:alpha:]].*&#x27; /usr/share/doc/openvpn/sample/sample-config-files/client.conf</span></span><br><span class="line">client     <span class="comment">#声明自己是个客户端</span></span><br><span class="line">dev tun    <span class="comment">#接口类型，必须和服务端保持一致 </span></span><br><span class="line">proto udp  <span class="comment">#协议类型，必须和服务端保持一致</span></span><br><span class="line">remote my-server-1 1194 <span class="comment">#server端的ip和端口，可以写域名但是需要可以解析成IP</span></span><br><span class="line">resolv-retry infinite   <span class="comment">#如果是写的server端的域名，那么就始终解析，如果域名发生变化，会重新连接到新的域名对应的IP</span></span><br><span class="line">nobind                  <span class="comment">#本机不绑定监听端口，客户端是随机打开端口连接到服务端的1194 </span></span><br><span class="line">persist-key</span><br><span class="line">persist-tun </span><br><span class="line">ca ca.crt </span><br><span class="line">cert client.crt </span><br><span class="line">key client.key</span><br><span class="line">remote-cert-tls server  <span class="comment">#指定采用服务器证书校验方式 </span></span><br><span class="line">tls-auth ta.key 1</span><br><span class="line">cipher AES-256-CBC </span><br><span class="line">verb 3</span><br></pre></td></tr></table></figure><p><strong>生成客户端用户的配置文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#生成客户端文件,文件后缀必须为.ovpn</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#grep &#x27;^[[:alpha:]].*&#x27; /usr/share/doc/openvpn/sample/sample-config-files/client.conf &gt; /etc/openvpn/client/USERNAME/client.ovpn</span></span><br><span class="line"><span class="comment">#修改配置文件,内容如下</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#vim /etc/openvpn/client/USERNAME/client.ovpn </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cat /etc/openvpn/client/USERNAME/client.ovpn </span></span><br><span class="line">client</span><br><span class="line">dev tun </span><br><span class="line">proto tcp</span><br><span class="line">remote  10.10.0.81  1194              <span class="comment">#生产中为OpenVPN公网IP </span></span><br><span class="line">resolv-retry infinite</span><br><span class="line">nobind</span><br><span class="line"><span class="comment">#persist-key </span></span><br><span class="line"><span class="comment">#persist-tun</span></span><br><span class="line">ca ca.crt</span><br><span class="line">cert USERNAME.crt </span><br><span class="line">key USERNAME.key </span><br><span class="line">remote-cert-tls server</span><br><span class="line"><span class="comment">#tls-auth ta.key 1</span></span><br><span class="line">cipher AES-256-CBC</span><br><span class="line">verb 3                              <span class="comment">#此值不能随意指定,否则无法通信</span></span><br><span class="line">compress lz4-v2                     <span class="comment">#此项在OpenVPN2.4.X版本使用,需要和服务器端保持一致,如不指定,默认使用comp-lz压缩</span></span><br></pre></td></tr></table></figure><h3 id="完整安装脚本"><a href="#完整安装脚本" class="headerlink" title="完整安装脚本"></a>完整安装脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#================================================================</span></span><br><span class="line"><span class="comment">#   </span></span><br><span class="line"><span class="comment">#   文件名称：openvpn-install.sh</span></span><br><span class="line"><span class="comment">#   创 建 者：Tdison</span></span><br><span class="line"><span class="comment">#   创建日期：2022年05月22日</span></span><br><span class="line"><span class="comment">#   描    述：</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#================================================================</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;正在运行openvpn安装脚本。&quot;</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line">sudo sed -i.bak <span class="string">&#x27;s/SELINUX=enforcing/SELINUX=disabled/&#x27;</span> /etc/selinux/config</span><br><span class="line">setenforce 0 &gt; /dev/null</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;net.ipv4.ip_forward = 1&#x27;</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line">yum install openvpn -y </span><br><span class="line">yum install easy-rsa -y </span><br><span class="line"></span><br><span class="line"><span class="comment">#修改服务端配置</span></span><br><span class="line"><span class="built_in">cp</span> /usr/share/doc/openvpn/sample/sample-config-files/server.conf /etc/openvpn/</span><br><span class="line"><span class="built_in">cp</span> -r /usr/share/easy-rsa/ /etc/openvpn/easy-rsa-server </span><br><span class="line"><span class="built_in">cp</span> /usr/share/doc/easy-rsa/vars.example /etc/openvpn/easy-rsa-server/3/vars</span><br><span class="line">sed -ri <span class="string">&#x27;s/#set_var EASYRSA_CA_EXPIRE[[:space:]]+3650/set_var EASYRSA_CA_EXPIRE       36500/&#x27;</span> /etc/openvpn/easy-rsa-server/3/vars</span><br><span class="line">sed -ri <span class="string">&#x27;s/#set_var EASYRSA_CERT_EXPIRE[[:space:]]+825/set_var EASYRSA_CERT_EXPIRE       3650/&#x27;</span> /etc/openvpn/easy-rsa-server/3/vars </span><br><span class="line"><span class="built_in">cd</span> /etc/openvpn/easy-rsa-server/3/ &amp;&amp; ./easyrsa init-pki &amp;&amp; ./easyrsa build-ca nopass &amp;&amp; ./easyrsa gen-req server nopass &amp;&amp; ./easyrsa sign server server &amp;&amp; ./easyrsa gen-dh &amp;&amp; ./easyrsa gen-crl</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改客户端配置</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">read</span> -p <span class="string">&quot;请输入用户名: &quot;</span> USERNAME</span><br><span class="line"><span class="built_in">cp</span> -r /usr/share/easy-rsa/ /etc/openvpn/easy-rsa-client </span><br><span class="line"><span class="built_in">cp</span> /usr/share/doc/easy-rsa/vars.example /etc/openvpn/easy-rsa-client/3/vars</span><br><span class="line"><span class="built_in">cd</span> /etc/openvpn/easy-rsa-client/3/ &amp;&amp; ./easyrsa init-pki &amp;&amp; ./easyrsa  gen-req <span class="variable">$USERNAME</span> nopass </span><br><span class="line"><span class="built_in">cd</span> /etc/openvpn/easy-rsa-server/3/ &amp;&amp; ./easyrsa import-req /etc/openvpn/easy-rsa-client/3/pki/reqs/<span class="variable">$USERNAME</span>.req <span class="variable">$USERNAME</span></span><br><span class="line">sed -ri <span class="string">&#x27;s/set_var EASYRSA_CERT_EXPIRE[[:space:]]+3650/set_var EASYRSA_CERT_EXPIRE       90/&#x27;</span> /etc/openvpn/easy-rsa-server/3/vars </span><br><span class="line"><span class="built_in">cd</span> /etc/openvpn/easy-rsa-server/3/ &amp;&amp; ./easyrsa sign client <span class="variable">$USERNAME</span> </span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> /etc/openvpn/certs</span><br><span class="line"><span class="built_in">cp</span> /etc/openvpn/easy-rsa-server/3/pki/ca.crt /etc/openvpn/certs/</span><br><span class="line"><span class="built_in">cp</span> /etc/openvpn/easy-rsa-server/3/pki/issued/server.crt /etc/openvpn/certs/</span><br><span class="line"><span class="built_in">cp</span> /etc/openvpn/easy-rsa-server/3/pki/private/server.key /etc/openvpn/certs/</span><br><span class="line"><span class="built_in">cp</span> /etc/openvpn/easy-rsa-server/3/pki/dh.pem /etc/openvpn/certs/</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> /etc/openvpn/client/<span class="variable">$USERNAME</span>/</span><br><span class="line">find /etc/openvpn/ \( -name <span class="string">&quot;<span class="variable">$USERNAME</span>.key&quot;</span> -o -name <span class="string">&quot;<span class="variable">$USERNAME</span>.crt&quot;</span> -o -name ca.crt \) -<span class="built_in">exec</span> <span class="built_in">cp</span> &#123;&#125; /etc/openvpn/client/<span class="variable">$USERNAME</span> \;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果系统只有一个IPv4，它将自动被选中。否则，请让用户选择。</span></span><br><span class="line"><span class="keyword">if</span> [[ $(ip -4 addr | grep inet | grep -vEc <span class="string">&#x27;127(\.[0-9]&#123;1,3&#125;)&#123;3&#125;&#x27;</span>) -eq 1 ]]; <span class="keyword">then</span></span><br><span class="line">  ip=$(ip -4 addr | grep inet | grep -vE <span class="string">&#x27;127(\.[0-9]&#123;1,3&#125;)&#123;3&#125;&#x27;</span> | <span class="built_in">cut</span> -d <span class="string">&#x27;/&#x27;</span> -f 1 | grep -oE <span class="string">&#x27;[0-9]&#123;1,3&#125;(\.[0-9]&#123;1,3&#125;)&#123;3&#125;&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  number_of_ip=$(ip -4 addr | grep inet | grep -vEc <span class="string">&#x27;127(\.[0-9]&#123;1,3&#125;)&#123;3&#125;&#x27;</span>)</span><br><span class="line">  <span class="built_in">echo</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;使用哪个公网IPv4地址？&quot;</span></span><br><span class="line">  ip -4 addr | grep inet | grep -vE <span class="string">&#x27;127(\.[0-9]&#123;1,3&#125;)&#123;3&#125;&#x27;</span> | <span class="built_in">cut</span> -d <span class="string">&#x27;/&#x27;</span> -f 1 | grep -oE <span class="string">&#x27;[0-9]&#123;1,3&#125;(\.[0-9]&#123;1,3&#125;)&#123;3&#125;&#x27;</span> | <span class="built_in">nl</span> -s <span class="string">&#x27;) &#x27;</span></span><br><span class="line">  <span class="built_in">read</span> -p <span class="string">&quot;IPv4 address [1]: &quot;</span> ip_number</span><br><span class="line">  until [[ -z <span class="string">&quot;<span class="variable">$ip_number</span>&quot;</span> || <span class="string">&quot;<span class="variable">$ip_number</span>&quot;</span> =~ ^[0-9]+$ &amp;&amp; <span class="string">&quot;<span class="variable">$ip_number</span>&quot;</span> -le <span class="string">&quot;<span class="variable">$number_of_ip</span>&quot;</span> ]]; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$ip_number</span>: invalid selection.&quot;</span></span><br><span class="line">    <span class="built_in">read</span> -p <span class="string">&quot;IPv4 address [1]: &quot;</span> ip_number</span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  [[ -z <span class="string">&quot;<span class="variable">$ip_number</span>&quot;</span> ]] &amp;&amp; ip_number=<span class="string">&quot;1&quot;</span></span><br><span class="line">  ip=$(ip -4 addr | grep inet | grep -vE <span class="string">&#x27;127(\.[0-9]&#123;1,3&#125;)&#123;3&#125;&#x27;</span> | <span class="built_in">cut</span> -d <span class="string">&#x27;/&#x27;</span> -f 1 | grep -oE <span class="string">&#x27;[0-9]&#123;1,3&#125;(\.[0-9]&#123;1,3&#125;)&#123;3&#125;&#x27;</span> | sed -n <span class="string">&quot;<span class="variable">$ip_number</span>&quot;</span>p)</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果系统只有一个网关，它将自动被选中。否则，请让用户选择。</span></span><br><span class="line"><span class="keyword">if</span> [[ $(route | <span class="built_in">cut</span> -d <span class="string">&#x27; &#x27;</span> -f 1 | grep -Ec <span class="string">&#x27;([0-9]&#123;1,3&#125;.)&#123;3&#125;[0-9]&#123;1,3&#125;&#x27;</span>) -eq 1 ]]; <span class="keyword">then</span></span><br><span class="line">  Genmask=$(route | awk -F<span class="string">&quot;[[:space:]]+&quot;</span> <span class="string">&#x27;&#123;print $3&#125;&#x27;</span> | grep -E <span class="string">&#x27;([0-9]&#123;1,3&#125;.)&#123;3&#125;[0^C]&#123;1,3&#125;&#x27;</span> | grep -vE <span class="string">&#x27;0.0.0.0&#x27;</span>)</span><br><span class="line">  Gateway=$(route | <span class="built_in">cut</span> -d <span class="string">&#x27; &#x27;</span> -f 1 | grep -E <span class="string">&#x27;([0-9]&#123;1,3&#125;.)&#123;3&#125;[0-9]&#123;1,3&#125;&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  number_of_Gateway=$(route | <span class="built_in">cut</span> -d <span class="string">&#x27; &#x27;</span> -f 1 | grep -Ec <span class="string">&#x27;([0-9]&#123;1,3&#125;.)&#123;3&#125;[0-9]&#123;1,3&#125;&#x27;</span>)</span><br><span class="line">  <span class="built_in">echo</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;使用哪个私网网关地址？&quot;</span></span><br><span class="line">  route | <span class="built_in">cut</span> -d <span class="string">&#x27; &#x27;</span> -f 1 | grep -E <span class="string">&#x27;([0-9]&#123;1,3&#125;.)&#123;3&#125;[0-9]&#123;1,3&#125;&#x27;</span> | <span class="built_in">cut</span> -d <span class="string">&#x27;/&#x27;</span> -f 1 | grep -oE <span class="string">&#x27;[0-9]&#123;1,3&#125;(\.[0-9]&#123;1,3&#125;)&#123;3&#125;&#x27;</span> | <span class="built_in">nl</span> -s <span class="string">&#x27;) &#x27;</span></span><br><span class="line">  <span class="built_in">read</span> -p <span class="string">&quot;Gateway [1]: &quot;</span> Gateway_number</span><br><span class="line">  until [[ -z <span class="string">&quot;<span class="variable">$Gateway_number</span>&quot;</span> || <span class="string">&quot;<span class="variable">$Gateway_number</span>&quot;</span> =~ ^[0-9]+$ &amp;&amp; <span class="string">&quot;<span class="variable">$Gateway_number</span>&quot;</span> -le <span class="string">&quot;<span class="variable">$number_of_Gateway</span>&quot;</span> ]]; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$Gateway_number</span>: invalid selection.&quot;</span></span><br><span class="line">    <span class="built_in">read</span> -p <span class="string">&quot;Gateway [1]: &quot;</span> Gateway_number</span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  [[ -z <span class="string">&quot;<span class="variable">$Gateway_number</span>&quot;</span> ]] &amp;&amp; Gateway_number=<span class="string">&quot;1&quot;</span></span><br><span class="line"></span><br><span class="line">  Genmask=$(route | awk -F<span class="string">&quot;[[:space:]]+&quot;</span> <span class="string">&#x27;&#123;print $3&#125;&#x27;</span> | grep -E <span class="string">&#x27;([0-9]&#123;1,3&#125;.)&#123;3&#125;[0^C]&#123;1,3&#125;&#x27;</span> | grep -vE <span class="string">&#x27;0.0.0.0&#x27;</span> | <span class="built_in">cut</span> -d <span class="string">&#x27;/&#x27;</span> -f 1 | grep -oE <span class="string">&#x27;[0-9]&#123;1,3&#125;(\.[0-9]&#123;1,3&#125;)&#123;3&#125;&#x27;</span> | sed -n <span class="string">&quot;<span class="variable">$Gateway_number</span>&quot;</span>p)</span><br><span class="line">  Gateway=$(route | <span class="built_in">cut</span> -d <span class="string">&#x27; &#x27;</span> -f 1 | grep -E <span class="string">&#x27;([0-9]&#123;1,3&#125;.)&#123;3&#125;[0-9]&#123;1,3&#125;&#x27;</span> | <span class="built_in">cut</span> -d <span class="string">&#x27;/&#x27;</span> -f 1 | grep -oE <span class="string">&#x27;[0-9]&#123;1,3&#125;(\.[0-9]&#123;1,3&#125;)&#123;3&#125;&#x27;</span> | sed -n <span class="string">&quot;<span class="variable">$Gateway_number</span>&quot;</span>p)</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#选择协议</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;OpenVPN应该使用哪种协议？&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;   1) UDP (推荐)&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;   2) TCP&quot;</span></span><br><span class="line"><span class="built_in">read</span> -p <span class="string">&quot;Protocol [1]: &quot;</span> protocol</span><br><span class="line">until [[ -z <span class="string">&quot;<span class="variable">$protocol</span>&quot;</span> || <span class="string">&quot;<span class="variable">$protocol</span>&quot;</span> =~ ^[12]$ ]]; <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$protocol</span>: 选择无效。&quot;</span></span><br><span class="line">  <span class="built_in">read</span> -p <span class="string">&quot;Protocol [1]: &quot;</span> protocol</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;<span class="variable">$protocol</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">  1|<span class="string">&quot;&quot;</span>) </span><br><span class="line">  protocol=udp</span><br><span class="line">  ;;</span><br><span class="line">  2) </span><br><span class="line">  protocol=tcp</span><br><span class="line">  ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#选择端口</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;OpenVPN应该监听哪个端口？&quot;</span></span><br><span class="line">  <span class="built_in">read</span> -p <span class="string">&quot;Port [1194]: &quot;</span> port</span><br><span class="line">  until [[ -z <span class="string">&quot;<span class="variable">$port</span>&quot;</span> || <span class="string">&quot;<span class="variable">$port</span>&quot;</span> =~ ^[0-9]+$ &amp;&amp; <span class="string">&quot;<span class="variable">$port</span>&quot;</span> -le 65535 ]]; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$port</span>: 端口无效。&quot;</span></span><br><span class="line">    <span class="built_in">read</span> -p <span class="string">&quot;Port [1194]: &quot;</span> port</span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  [[ -z <span class="string">&quot;<span class="variable">$port</span>&quot;</span> ]] &amp;&amp; port=<span class="string">&quot;1194&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;服务器配置文件&quot;</span></span><br><span class="line"><span class="built_in">tee</span> /etc/openvpn/server.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">port $port</span></span><br><span class="line"><span class="string">proto $protocol</span></span><br><span class="line"><span class="string">dev tun</span></span><br><span class="line"><span class="string">ca /etc/openvpn/certs/ca.crt</span></span><br><span class="line"><span class="string">cert /etc/openvpn/certs/server.crt</span></span><br><span class="line"><span class="string">key /etc/openvpn/certs/server.key  # This file should be kept secret</span></span><br><span class="line"><span class="string">dh /etc/openvpn/certs/dh.pem</span></span><br><span class="line"><span class="string">server 10.8.0.0 255.255.255.0</span></span><br><span class="line"><span class="string">push &quot;route $Gateway $Genmask&quot;</span></span><br><span class="line"><span class="string">keepalive 10 120</span></span><br><span class="line"><span class="string">cipher AES-256-CBC</span></span><br><span class="line"><span class="string">compress lz4-v2</span></span><br><span class="line"><span class="string">push &quot;compress lz4-v2&quot;</span></span><br><span class="line"><span class="string">max-clients 2048</span></span><br><span class="line"><span class="string">user openvpn</span></span><br><span class="line"><span class="string">group openvpn</span></span><br><span class="line"><span class="string">status /var/log/openvpn/openvpn-status.log</span></span><br><span class="line"><span class="string">log-append   /var/log/openvpn/openvpn.log</span></span><br><span class="line"><span class="string">verb 3</span></span><br><span class="line"><span class="string">mute 20</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line">yum install iptables-services iptables -y</span><br><span class="line">systemctl <span class="built_in">enable</span> iptables --now </span><br><span class="line">iptables -F</span><br><span class="line">iptables -X</span><br><span class="line">iptables -Z</span><br><span class="line">iptables -t nat -F</span><br><span class="line">iptables -t nat -X</span><br><span class="line">iptables -t nat -Z</span><br><span class="line">iptables -t nat -A POSTROUTING -s 10.8.0.0/16 -j MASQUERADE</span><br><span class="line">iptables -A INPUT -p TCP --dport 1194 -j ACCEPT</span><br><span class="line">iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line">service iptables save &gt;&gt; /dev/null</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> /var/log/openvpn</span><br><span class="line"><span class="built_in">chown</span> openvpn.openvpn /var/log/openvpn</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;客户端配置文件&quot;</span></span><br><span class="line"><span class="built_in">tee</span> /etc/openvpn/client/<span class="variable">$USERNAME</span>/client.ovpn &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">client</span></span><br><span class="line"><span class="string">dev tun </span></span><br><span class="line"><span class="string">proto $protocol</span></span><br><span class="line"><span class="string">remote  $ip  $port</span></span><br><span class="line"><span class="string">resolv-retry infinite</span></span><br><span class="line"><span class="string">nobind</span></span><br><span class="line"><span class="string">ca ca.crt</span></span><br><span class="line"><span class="string">cert $USERNAME.crt </span></span><br><span class="line"><span class="string">key $USERNAME.key </span></span><br><span class="line"><span class="string">remote-cert-tls server</span></span><br><span class="line"><span class="string">cipher AES-256-CBC</span></span><br><span class="line"><span class="string">verb 3</span></span><br><span class="line"><span class="string">compress lz4-v2</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;[Unit]</span></span><br><span class="line"><span class="string">Description=OpenVPN Robust And Highly Flexible Tunneling Application On %I </span></span><br><span class="line"><span class="string">After=network.target</span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Type=notify </span></span><br><span class="line"><span class="string">PrivateTmp=true</span></span><br><span class="line"><span class="string">ExecStart=/usr/sbin/openvpn --cd /etc/openvpn/ --config %i.conf </span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target&#x27;</span> &gt; /usr/lib/systemd/system/openvpn@.service </span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> --now openvpn@server </span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /etc/openvpn/client/<span class="variable">$USERNAME</span>/</span><br><span class="line">tar cf ~/<span class="variable">$USERNAME</span>.tar  ./ </span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;客户端配置在: ~/<span class="variable">$USERNAME</span>.tar&quot;</span></span><br></pre></td></tr></table></figure><h3 id="Windows-配置部署-OpenVPN-客户端"><a href="#Windows-配置部署-OpenVPN-客户端" class="headerlink" title="Windows 配置部署 OpenVPN 客户端"></a>Windows 配置部署 OpenVPN 客户端</h3><p>下载并安装OpenVPN 客户端：<a href="https://openvpn.net/community-downloads/">https://openvpn.net/community-downloads/</a></p><h3 id="Windows-客户端配置准备"><a href="#Windows-客户端配置准备" class="headerlink" title="Windows 客户端配置准备"></a>Windows 客户端配置准备</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在服务器打包证书并下载发送给windows客户端</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cd /etc/openvpn/client/USERNAME/ </span></span><br><span class="line">[root@centos8 USERNAME]<span class="comment">#tar cf USERNAME.tar  ./ </span></span><br><span class="line">tar: ./USERNAME.tar: file is the archive; not dumped </span><br><span class="line">[root@centos8 USERNAME]<span class="comment">#ll</span></span><br><span class="line">total 40</span><br><span class="line">-rw------- 1 root root  1204 Aug  3 21:05 ca.crt</span><br><span class="line">-rw-r--r-- 1 root root   231 Aug  3 23:31 client.ovpn</span><br><span class="line">-rw------- 1 root root  4506 Aug  3 21:05 USERNAME.crt </span><br><span class="line">-rw------- 1 root root  1704 Aug  3 21:05 USERNAME.key </span><br><span class="line">-rw-r--r-- 1 root root 20480 Aug  4 10:48 USERNAME.tar</span><br><span class="line">[root@centos8 USERNAME]<span class="comment">#tar tf USERNAME.tar </span></span><br><span class="line">./</span><br><span class="line">./USERNAME.key </span><br><span class="line">./USERNAME.crt </span><br><span class="line">./ca.crt</span><br><span class="line">./client.ovpn</span><br></pre></td></tr></table></figure><p>解压到windows客户端的<code>C:\Program Files\OpenVPN\config</code>目录下</p><h3 id="Windows-客户端建立OpenVPN连接"><a href="#Windows-客户端建立OpenVPN连接" class="headerlink" title="Windows 客户端建立OpenVPN连接"></a>Windows 客户端建立OpenVPN连接</h3><p>在windows 程序中打开<code>OpenVPN GUI</code>工具,右键状态栏图标,点连接</p>]]></content>
      
      
      <categories>
          
          <category> CentOS运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CENTOS </tag>
            
            <tag> OpenVPN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DNS测试和管理工具</title>
      <link href="/2022/05/21/DNS%E6%B5%8B%E8%AF%95%E5%92%8C%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/"/>
      <url>/2022/05/21/DNS%E6%B5%8B%E8%AF%95%E5%92%8C%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="安装工具包"><a href="#安装工具包" class="headerlink" title="安装工具包"></a>安装工具包</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y bind-utils</span><br></pre></td></tr></table></figure><h3 id="1-host"><a href="#1-host" class="headerlink" title="1. host"></a>1. host</h3><p>常用的分析域名查询工具</p><p>常见用法：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]# host www.baidu.com//查询域名信息，显示别名和ip</span><br><span class="line">www.baidu.com is an alias for www.a.shifen.com.</span><br><span class="line">www.a.shifen.com has address 110.242.68.4</span><br><span class="line">www.a.shifen.com has address 110.242.68.3</span><br><span class="line">[root@CentOS7 ~]# host -a www.baidu.com//查询域名的所有信息</span><br><span class="line">Trying &quot;www.baidu.com&quot;</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 31187</span><br><span class="line">;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;www.baidu.com.                 IN      ANY</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">www.baidu.com.          576     IN      CNAME   www.a.shifen.com.</span><br><span class="line"></span><br><span class="line">Received 58 bytes from 192.168.164.227#53 in 13 ms</span><br></pre></td></tr></table></figure><h3 id="2-dig"><a href="#2-dig" class="headerlink" title="2. dig"></a>2. dig</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig www.baidu.com</span><br></pre></td></tr></table></figure><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h20qhi3vbpj21540qsdm0.jpg"></p><p>第一部分显示 dig 命令的版本和输入的参数。<br>第二部分显示服务返回的一些技术详情，比较重要的是 status。如果 status 的值为 NOERROR 则说明本次查询成功结束。<br>第三部分中的 “QUESTION SECTION” 显示我们要查询的域名。<br>第四部分的 “ANSWER SECTION” 是查询到的结果。<br>第五部分则是本次查询的一些统计信息，比如用了多长时间，查询了哪个 DNS 服务器，在什么时间进行的查询等等。<br>参考：<a href="https://www.cnblogs.com/sparkdev/p/7777871.html">https://www.cnblogs.com/sparkdev/p/7777871.html</a></p><p>使用指定DNS查询</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig www.baidu.com @119.29.29.29</span><br></pre></td></tr></table></figure><p>使用119.29.29.29 DNS解析<a href="http://www.baidu.com/">www.baidu.com</a></p><h3 id="3-nslookup"><a href="#3-nslookup" class="headerlink" title="3. nslookup"></a>3. nslookup</h3><p>nslookup 可以支持交互和非交互式两种方式执行</p><p>非交互式：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]<span class="comment"># nslookup www.baidu.com       //使用默认dns解析域名</span></span><br><span class="line">Server:         223.5.5.5</span><br><span class="line">Address:        223.5.5.5<span class="comment">#53</span></span><br><span class="line"></span><br><span class="line">Non-authoritative answer:</span><br><span class="line">www.baidu.com   canonical name = www.a.shifen.com.</span><br><span class="line">Name:   www.a.shifen.com</span><br><span class="line">Address: 110.242.68.3</span><br><span class="line">Name:   www.a.shifen.com</span><br><span class="line">Address: 110.242.68.4</span><br><span class="line"></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># nslookup www.baidu.com 119.29.29.29       //使用指定dns解析域名</span></span><br><span class="line">Server:         119.29.29.29</span><br><span class="line">Address:        119.29.29.29<span class="comment">#53</span></span><br><span class="line"></span><br><span class="line">Non-authoritative answer:</span><br><span class="line">www.baidu.com   canonical name = www.a.shifen.com.</span><br><span class="line">Name:   www.a.shifen.com</span><br><span class="line">Address: 110.242.68.4</span><br><span class="line">Name:   www.a.shifen.com</span><br><span class="line">Address: 110.242.68.3</span><br></pre></td></tr></table></figure><p>交互式</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]# slookup </span><br><span class="line">&gt; www.baidu.com             //解析域名</span><br><span class="line">Server:         10.10.0.51</span><br><span class="line">Address:        10.10.0.51#53</span><br><span class="line"></span><br><span class="line">Non-authoritative answer:</span><br><span class="line">www.baidu.com   canonical name = www.a.shifen.com.</span><br><span class="line">Name:   www.a.shifen.com</span><br><span class="line">Address: 110.242.68.4</span><br><span class="line">Name:   www.a.shifen.com</span><br><span class="line">Address: 110.242.68.3</span><br><span class="line">&gt; server 119.29.29.29       //修改使用的dns</span><br><span class="line">Default server: 119.29.29.29</span><br><span class="line">Address: 119.29.29.29#53</span><br><span class="line">&gt; www.baidu.com             //解析域名</span><br><span class="line">Server:         119.29.29.29</span><br><span class="line">Address:        119.29.29.29#53</span><br><span class="line"></span><br><span class="line">Non-authoritative answer:</span><br><span class="line">www.baidu.com   canonical name = www.a.shifen.com.</span><br><span class="line">Name:   www.a.shifen.com</span><br><span class="line">Address: 110.242.68.3</span><br><span class="line">Name:   www.a.shifen.com</span><br><span class="line">Address: 110.242.68.4</span><br></pre></td></tr></table></figure><p>更多用法</p><ol><li>set type</li></ol><p>默认情况下，nslookup是查询域名所对应的A记录，而如果你想查询其他信息时，就需要专门设置type值。<br>常用type值：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">A：查看主机的IPv4地址</span><br><span class="line">AAAA：查看主机的IPv6地址</span><br><span class="line">ANY：查看关于主机域的所有信息</span><br><span class="line">CNAME：查找与别名对应的正式名字</span><br><span class="line">HINFO：查找主机的CPU与操作系统类型</span><br><span class="line">MINFO：查找邮箱信息</span><br><span class="line">MX：查找邮件交换信息</span><br><span class="line">NS：查找主机域的域名服务器</span><br><span class="line">PTR：查找与给定IP地址匹配的主机名</span><br><span class="line">RP：查找域负责人记录</span><br><span class="line">SOA：查找域内的SOA地址</span><br><span class="line">UINFO：查找用户信息</span><br></pre></td></tr></table></figure><p>范例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]# nslookup </span><br><span class="line">&gt; set type=MX</span><br><span class="line">&gt; www.baidu.com</span><br><span class="line">Server:         10.10.0.51</span><br><span class="line">Address:        10.10.0.51#53</span><br><span class="line"></span><br><span class="line">Non-authoritative answer:</span><br><span class="line">www.baidu.com   canonical name = www.a.shifen.com.</span><br><span class="line"></span><br><span class="line">Authoritative answers can be found from:</span><br><span class="line">a.shifen.com</span><br><span class="line">        origin = ns1.a.shifen.com</span><br><span class="line">        mail addr = baidu_dns_master.baidu.com</span><br><span class="line">        serial = 2205090004</span><br><span class="line">        refresh = 5</span><br><span class="line">        retry = 5</span><br><span class="line">        expire = 2592000</span><br><span class="line">        minimum = 3600</span><br><span class="line">&gt; exit</span><br><span class="line"></span><br><span class="line">[root@CentOS7 ~]# nslookup -type=MX www.baidu.com</span><br><span class="line">Server:         10.10.0.51</span><br><span class="line">Address:        10.10.0.51#53</span><br><span class="line"></span><br><span class="line">Non-authoritative answer:</span><br><span class="line">www.baidu.com   canonical name = www.a.shifen.com.</span><br><span class="line"></span><br><span class="line">Authoritative answers can be found from:</span><br><span class="line">a.shifen.com</span><br><span class="line">        origin = ns1.a.shifen.com</span><br><span class="line">        mail addr = baidu_dns_master.baidu.com</span><br><span class="line">        serial = 2205090004</span><br><span class="line">        refresh = 5</span><br><span class="line">        retry = 5</span><br><span class="line">        expire = 2592000</span><br><span class="line">        minimum = 3600</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol start="2"><li>set port</li></ol><p>如果需要更改DNS服务端口（默认的是53），可以通过本命令来设置</p><p>范例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]# nslookup -port=50 www.baidu.com</span><br><span class="line">Server:         10.10.0.51</span><br><span class="line">Address:        10.10.0.51#50</span><br><span class="line"></span><br><span class="line">Non-authoritative answer:</span><br><span class="line">www.baidu.com   canonical name = www.a.shifen.com.</span><br><span class="line">Name:   www.a.shifen.com</span><br><span class="line">Address: 110.242.68.4</span><br><span class="line">Name:   www.a.shifen.com</span><br><span class="line">Address: 110.242.68.3</span><br><span class="line"></span><br><span class="line">[root@CentOS7 ~]# nslookup</span><br><span class="line">&gt; set port=50</span><br><span class="line">&gt; www.baidu.com</span><br><span class="line">Server:         10.10.0.51</span><br><span class="line">Address:        10.10.0.51#50</span><br><span class="line"></span><br><span class="line">Non-authoritative answer:</span><br><span class="line">www.baidu.com   canonical name = www.a.shifen.com.</span><br><span class="line">Name:   www.a.shifen.com</span><br><span class="line">Address: 110.242.68.4</span><br><span class="line">Name:   www.a.shifen.com</span><br><span class="line">Address: 110.242.68.3</span><br></pre></td></tr></table></figure><ol start="3"><li>set all</li></ol><p>列出常用选项的当前设置值。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]# nslookup</span><br><span class="line">&gt; set all</span><br><span class="line">Default server: 10.10.0.51</span><br><span class="line">Address: 10.10.0.51#53</span><br><span class="line">Default server: 223.5.5.5</span><br><span class="line">Address: 223.5.5.5#53</span><br><span class="line"></span><br><span class="line">Set options:</span><br><span class="line">  novc                  nodebug         nod2</span><br><span class="line">  search                recurse</span><br><span class="line">  timeout = 0           retry = 3       port = 53       ndots = 1</span><br><span class="line">  querytype = A         class = IN</span><br><span class="line">  srchlist = localdomain</span><br></pre></td></tr></table></figure><h3 id="4-rndc"><a href="#4-rndc" class="headerlink" title="4. rndc"></a>4. rndc</h3><p>利用rndc工具可以实现管理DNS功能<br>rndc 监听端口: 953&#x2F;tcp</p><p>用法：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">rndc COMMAND</span><br><span class="line">COMMAND:</span><br><span class="line">    status: 查看状态</span><br><span class="line">    reload: 重载主配置文件和区域解析库文件 </span><br><span class="line">    reload zonename: 重载区域解析库文件</span><br><span class="line">    retransfer zonename: 手动启动区域传送，而不管序列号是否增加 </span><br><span class="line">    notify zonename: 重新对区域传送发通知</span><br><span class="line">    reconfig: 重载主配置文件</span><br><span class="line">    querylog: 开启或关闭查询日志文件/var/log/message </span><br><span class="line">    trace: 递增debug一个级别</span><br><span class="line">    trace LEVEL: 指定使用的级别 </span><br><span class="line">    notrace：将调试级别设置为 0</span><br><span class="line">    flush：清空DNS服务器的所有缓存记录</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CentOS运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CENTOS </tag>
            
            <tag> DNS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CentOS配置网卡文件</title>
      <link href="/2022/05/10/CentOS%E9%85%8D%E7%BD%AE%E7%BD%91%E5%8D%A1%E6%96%87%E4%BB%B6/"/>
      <url>/2022/05/10/CentOS%E9%85%8D%E7%BD%AE%E7%BD%91%E5%8D%A1%E6%96%87%E4%BB%B6/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="Linux网卡常用配置"><a href="#Linux网卡常用配置" class="headerlink" title="Linux网卡常用配置"></a>Linux网卡常用配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysconfig/network-scripts/ifcfg-eth0       //eth0修改成设备名</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">TYPE=Ethernet               //接口类型</span><br><span class="line">DEVICE=eth1                 //设备名</span><br><span class="line">NAME=eth1                   //此配置文件应用到的设备</span><br><span class="line">BOOTPROTO=static            //激活此设备时使用的地址配置协议，常用的dhcp, static, none, bootp</span><br><span class="line">IPADDR=10.10.0.51           //指明IP地址（dhcp可忽略）</span><br><span class="line">PREFIX=24                   //网络ID的位数, 如:24（dhcp可忽略）</span><br><span class="line">DNS1=10.0.0.1               //DNS服务器地址（dhcp可忽略）</span><br><span class="line">DNS2=223.5.5.5              //DNS服务器地址（dhcp可忽略）</span><br><span class="line">GATEWAY=10.10.0.1           //默认网关（dhcp可忽略）</span><br><span class="line">ONBOOT=yes                  //在系统引导时是否激活此设备</span><br><span class="line">UUID=cd3d4bc1-3499-397a-98f6-188560209932        //设备的惟一标识</span><br></pre></td></tr></table></figure><h3 id="UUID查询方法"><a href="#UUID查询方法" class="headerlink" title="UUID查询方法"></a>UUID查询方法</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]# nmcli connection </span><br><span class="line">NAME  UUID                                  TYPE      DEVICE </span><br><span class="line">eth0  48c87a52-20b1-308e-addd-386999dd94ed  ethernet  eth0   </span><br><span class="line">eth1  a8e6aa0e-0098-3ee8-82d1-99f12efb6aff  ethernet  eth1</span><br></pre></td></tr></table></figure><h3 id="使修改后的配置生效"><a href="#使修改后的配置生效" class="headerlink" title="使修改后的配置生效"></a>使修改后的配置生效</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]# nmcli connection reload</span><br><span class="line">[root@CentOS7 ~]# nmcli connection up eth0       //eth0修改成设备名</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CentOS运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CENTOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DNS服务器配置</title>
      <link href="/2022/05/10/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE/"/>
      <url>/2022/05/10/DNS%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="操作环境"><a href="#操作环境" class="headerlink" title="操作环境"></a>操作环境</h3><ol><li>3台CentOS7主机<ul><li>10.10.0.51   主DNS服务器</li><li>10.10.0.52   从DNS服务器</li><li>10.10.0.53   WEB服务器</li></ul></li><li>关闭SElinux </li><li>关闭防火墙 </li><li>时间同步</li></ol><h3 id="安装band软件"><a href="#安装band软件" class="headerlink" title="安装band软件"></a>安装band软件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]<span class="comment"># yum  -y install bind  bind-utils</span></span><br></pre></td></tr></table></figure><h3 id="主DNS服务器配置"><a href="#主DNS服务器配置" class="headerlink" title="主DNS服务器配置"></a>主DNS服务器配置</h3><p><strong>配置主配置文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]<span class="comment"># vim /etc/named.conf</span></span><br></pre></td></tr></table></figure><p>配置文件其中两行需要注释掉</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">options &#123;                                                                                                            </span><br><span class="line">//  listen-on port 53 &#123; 127.0.0.1; &#125;;       // 此行前面加注释</span><br><span class="line">    listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">    directory   <span class="string">&quot;/var/named&quot;</span>;</span><br><span class="line">    dump-file   <span class="string">&quot;/var/named/data/cache_dump.db&quot;</span>;</span><br><span class="line">    statistics-file <span class="string">&quot;/var/named/data/named_stats.txt&quot;</span>;</span><br><span class="line">    memstatistics-file <span class="string">&quot;/var/named/data/named_mem_stats.txt&quot;</span>;</span><br><span class="line">    recursing-file  <span class="string">&quot;/var/named/data/named.recursing&quot;</span>;</span><br><span class="line">    secroots-file   <span class="string">&quot;/var/named/data/named.secroots&quot;</span>;</span><br><span class="line">//  allow-query     &#123; localhost; &#125;;         // 此行前面加注释</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>修改配置文件<code>/etc/named.rfc1912.zones</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]<span class="comment"># vim /etc/named.rfc1912.zones</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#文本末尾加上下面内容</span></span><br><span class="line">zone <span class="string">&quot;tdison.local&quot;</span> IN &#123; </span><br><span class="line">    <span class="built_in">type</span> master;</span><br><span class="line">    file <span class="string">&quot;tdison.local.zone&quot;</span>; </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="修改DNS区域数据库文件"><a href="#修改DNS区域数据库文件" class="headerlink" title="修改DNS区域数据库文件"></a>修改DNS区域数据库文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]<span class="comment"># cp -p /var/named/named.localhost /var/named/tdison.local.zone</span></span><br><span class="line"><span class="comment">#需要加上-p选项保留所有者和所有组权限，如下所示。若没有添加-p选项，需要手动修改权限。</span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># ll /var/named/tdison.local.zone</span></span><br><span class="line">-rw-r----- 1 root named 152 Jun 21  2007 /var/named/tdison.local.zone</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]<span class="comment"># vim /var/named/tdison.local.zone</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$TTL</span> 1D</span><br><span class="line">@   IN SOA  master admin.tdison.local. (</span><br><span class="line">            2022050810  ; serial        //每次修改后需要更新此序号，建议使用日期+小时方式</span><br><span class="line">                    1D  ; refresh       //设置服务器同步拉取时间</span><br><span class="line">                    1H  ; retry         //设置拉取错误时的重试时间</span><br><span class="line">                    1W  ; expire        //设置从dns服务器的信息过期时间</span><br><span class="line">                    3H )    ; minimum   //设置错误查询记录缓存的保留时间</span><br><span class="line">            NS   master</span><br><span class="line">master      A    10.10.0.51      //此行作用将master.tdison.local解析成10.10.0.51</span><br><span class="line">www         A    10.10.0.53</span><br></pre></td></tr></table></figure><p>此条配置文件可以简写成</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$TTL</span> 1D</span><br><span class="line">@   IN SOA  master admin.tdison.local. (2022050810 1D 1H 1W 3H )</span><br><span class="line">NS   master</span><br><span class="line">master      A    10.10.0.51</span><br><span class="line">www         A    10.10.0.53</span><br></pre></td></tr></table></figure><p>区域解析库的记录类型：A, AAAA, PTR, SOA, NS, CNAME, MX</p><ul><li>SOA：Start Of Authority，起始授权记录；一个区域解析库有且仅能有一个SOA记录，<strong>必须位于解析库的第一条记录</strong></li><li>A：internet Address，作用：FQDN解析成IPv4地址 </li><li>AAAA：作用：FQDN解析成IPv6地址</li><li>PTR：PoinTeR，反向解析，IP –&gt; FQDN</li><li>NS：Name Server，专用于标明当前区域的DNS服务器 </li><li>CNAME ： Canonical Name，别名记录</li><li>MX：Mail eXchanger，邮件交换器</li><li>TXT：对域名进行标识和说明的一种方式，一般做验证记录时会使用此项，如：SPF（反垃圾邮件）记录，https验证等</li></ul><h3 id="检查配置文件和数据库文件格式，并启动服务"><a href="#检查配置文件和数据库文件格式，并启动服务" class="headerlink" title="检查配置文件和数据库文件格式，并启动服务"></a>检查配置文件和数据库文件格式，并启动服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]<span class="comment"># named-checkconf</span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># named-checkzone tdison.local /var/named/tdison.local.zone</span></span><br><span class="line">zone tdison.local/IN: loaded serial 2022050810</span><br><span class="line">OK</span><br><span class="line">[root@CentOS7 ~]<span class="comment"># systemctl start named     //第一次启动服务</span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># rndc reload               //不是第一次启动服务</span></span><br></pre></td></tr></table></figure><h3 id="启用DNS客户端缓存"><a href="#启用DNS客户端缓存" class="headerlink" title="启用DNS客户端缓存"></a>启用DNS客户端缓存</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]<span class="comment"># yum -y install nscd</span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># systemctl enable --now nscd</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看缓存统计信息</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># nscd -g</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#清除DNS客户端缓存</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># nscd -i hosts</span></span><br></pre></td></tr></table></figure><h3 id="实现从服务器"><a href="#实现从服务器" class="headerlink" title="实现从服务器"></a>实现从服务器</h3><p><strong>主DNS服务端配置</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/named.conf</span></span><br><span class="line">...</span><br><span class="line">options &#123;</span><br><span class="line">//  listen-on port 53 &#123; 127.0.0.1; &#125;;</span><br><span class="line">    listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">    directory   <span class="string">&quot;/var/named&quot;</span>;</span><br><span class="line">    dump-file   <span class="string">&quot;/var/named/data/cache_dump.db&quot;</span>;</span><br><span class="line">    statistics-file <span class="string">&quot;/var/named/data/named_stats.txt&quot;</span>;</span><br><span class="line">    memstatistics-file <span class="string">&quot;/var/named/data/named_mem_stats.txt&quot;</span>;</span><br><span class="line">    recursing-file  <span class="string">&quot;/var/named/data/named.recursing&quot;</span>;</span><br><span class="line">    secroots-file   <span class="string">&quot;/var/named/data/named.secroots&quot;</span>;</span><br><span class="line">//  allow-query     &#123; localhost; &#125;;</span><br><span class="line">    allow-transfer &#123; 10.10.0.52;&#125;;          //添加此行，仅允许该IP抓取dns数据库，IP修改成从dns服务器地址</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># vim /var/named/tdison.local.zone</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$TTL</span> 1D</span><br><span class="line">@   IN SOA  master admin.tdison.local. (</span><br><span class="line">            2022050810  ; serial</span><br><span class="line">                    1D  ; refresh</span><br><span class="line">                    1H  ; retry</span><br><span class="line">                    1W  ; expire</span><br><span class="line">                    3H )    ; minimum</span><br><span class="line">        NS  master</span><br><span class="line">        NS  slave//添加此行</span><br><span class="line">master  A   10.10.0.51</span><br><span class="line">slave   A   10.10.0.52//添加此行</span><br><span class="line">www     A   10.10.0.53</span><br><span class="line"></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># systemctl start named     //第一次启动服务</span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># rndc reload               //不是第一次启动服务</span></span><br></pre></td></tr></table></figure><p><strong>从DNS服务器配置</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]<span class="comment"># yum  -y install bind  bind-utils</span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># vim /etc/named.conf</span></span><br><span class="line">...</span><br><span class="line">options &#123;</span><br><span class="line">//  listen-on port 53 &#123; 127.0.0.1; &#125;;</span><br><span class="line">    listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">    directory   <span class="string">&quot;/var/named&quot;</span>;</span><br><span class="line">    dump-file   <span class="string">&quot;/var/named/data/cache_dump.db&quot;</span>;</span><br><span class="line">    statistics-file <span class="string">&quot;/var/named/data/named_stats.txt&quot;</span>;</span><br><span class="line">    memstatistics-file <span class="string">&quot;/var/named/data/named_mem_stats.txt&quot;</span>;</span><br><span class="line">    recursing-file  <span class="string">&quot;/var/named/data/named.recursing&quot;</span>;</span><br><span class="line">    secroots-file   <span class="string">&quot;/var/named/data/named.secroots&quot;</span>;</span><br><span class="line">//  allow-query     &#123; localhost; &#125;;</span><br><span class="line">    allow-transfer &#123; none;&#125;;  </span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># vim /etc/named.rfc1912.zones</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#文本末尾加上下面内容</span></span><br><span class="line">zone <span class="string">&quot;tdison.local&quot;</span> IN &#123;</span><br><span class="line">    <span class="built_in">type</span> slave;</span><br><span class="line">    masters &#123; 10.10.0.51;&#125;;//IP改成主DNS服务器地址</span><br><span class="line">    file <span class="string">&quot;slaves/tdison.local.zone&quot;</span>;                                                                                 </span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line"><span class="comment">#检查配置文件格式是否错误</span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># named-checkconf</span></span><br><span class="line"></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># systemctl start named          #第一次启动服务 </span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># rndc reload                    #不是第一次启动服务</span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># ls  /var/named/slaves/tdison.local.zone #查看区域数据库文件是否生成</span></span><br></pre></td></tr></table></figure><h3 id="WEB服务器上实现WEB服务"><a href="#WEB服务器上实现WEB服务" class="headerlink" title="WEB服务器上实现WEB服务"></a>WEB服务器上实现WEB服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装http服务</span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># yum install -y httpd                        </span></span><br><span class="line"><span class="comment">#配置主页面</span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># echo hello  &gt; /var/www/html/index.html </span></span><br><span class="line"><span class="comment">#启动服务</span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># systemctl start httpd                    </span></span><br></pre></td></tr></table></figure><h3 id="在客户端实现测试"><a href="#在客户端实现测试" class="headerlink" title="在客户端实现测试"></a>在客户端实现测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7 ~]<span class="comment"># vim /etc/sysconfig/network-scripts/ifcfg-eth0 </span></span><br><span class="line">...</span><br><span class="line">DNS1=10.10.0.51</span><br><span class="line">DNS2=10.10.0.52</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># nmcli con reload </span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># nmcli con up eth0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#测试DNS服务器</span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># dig www.tdison.local @10.10.0.51</span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># dig www.tdison.local @10.10.0.52</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#测试网页</span></span><br><span class="line">[root@CentOS7 ~]<span class="comment"># curl www.tdison.local</span></span><br><span class="line">hello</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CentOS运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CENTOS </tag>
            
            <tag> DNS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>建立CentOS局域网源并与清华源同步</title>
      <link href="/2022/05/04/%E5%BB%BA%E7%AB%8BCentOS%E5%B1%80%E5%9F%9F%E7%BD%91%E6%BA%90%E5%B9%B6%E4%B8%8E%E6%B8%85%E5%8D%8E%E6%BA%90%E5%90%8C%E6%AD%A5/"/>
      <url>/2022/05/04/%E5%BB%BA%E7%AB%8BCentOS%E5%B1%80%E5%9F%9F%E7%BD%91%E6%BA%90%E5%B9%B6%E4%B8%8E%E6%B8%85%E5%8D%8E%E6%BA%90%E5%90%8C%E6%AD%A5/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="禁止SELINUX"><a href="#禁止SELINUX" class="headerlink" title="禁止SELINUX"></a>禁止SELINUX</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sudo sed -i.bak &#x27;s/SELINUX=enforcing/SELINUX=disabled/&#x27; /etc/selinux/config</span></span><br><span class="line"><span class="comment"># setenforce 0</span></span><br></pre></td></tr></table></figure><h2 id="修改防火墙策略"><a href="#修改防火墙策略" class="headerlink" title="修改防火墙策略"></a>修改防火墙策略</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># firewall-cmd --zone=public --add-port=80/tcp --permanent //--permanent 永久生效，没有此参数重启后失效，默认为80端口。</span></span><br><span class="line"><span class="comment"># systemctl restart firewalld</span></span><br></pre></td></tr></table></figure><h2 id="安装httpd服务"><a href="#安装httpd服务" class="headerlink" title="安装httpd服务"></a>安装httpd服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum install -y httpd</span></span><br></pre></td></tr></table></figure><h2 id="创建目录"><a href="#创建目录" class="headerlink" title="创建目录"></a>创建目录</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /var/www/html/centos/&#123;6,7&#125;/os/x86_64/</span></span><br><span class="line"><span class="comment"># mkdir -p /var/www/html/centos/&#123;6,7&#125;/updates/x86_64/</span></span><br><span class="line"><span class="comment"># mkdir -p /var/www/html/centos/&#123;6,7&#125;/extras/x86_64/</span></span><br><span class="line"><span class="comment"># mkdir -p /var/www/html/centos-vault/8.5.2111/BaseOS/x86_64/os/</span></span><br><span class="line"><span class="comment"># mkdir -p /var/www/html/centos-vault/8.5.2111/extras/x86_64/os/</span></span><br><span class="line"><span class="comment"># mkdir -p /var/www/html/centos-vault/8.5.2111/AppStream/x86_64/os/</span></span><br><span class="line"><span class="comment"># mkdir -p /var/www/html/epel/&#123;6,7&#125;/x86_64</span></span><br><span class="line"><span class="comment"># mkdir -p /var/www/html/epel/8/Everything/x86_64/</span></span><br></pre></td></tr></table></figure><h2 id="同步镜像"><a href="#同步镜像" class="headerlink" title="同步镜像"></a>同步镜像</h2><p><strong>新建文件</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ cat /usr/local/local_mirror/exclude.list</span><br><span class="line"></span><br><span class="line">#填入以下内容</span><br><span class="line"></span><br><span class="line">SRPMS</span><br><span class="line">aarch64</span><br><span class="line">ppc64</span><br><span class="line">ppc64le</span><br><span class="line">debug</span><br><span class="line">repodata</span><br><span class="line">EFI</span><br><span class="line">LiveOS</span><br><span class="line">images</span><br><span class="line">isolinux</span><br><span class="line">CentOS_BuildTag</span><br><span class="line">EULA</span><br><span class="line">GPL</span><br><span class="line">drpms</span><br></pre></td></tr></table></figure><p><strong>新建运行脚本</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ cat /usr/local/sbin/sync.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">#</span><br><span class="line"># 此脚本用于同步&quot;http://mirrors.tuna.tsinghua.edu.cn&quot;的镜像到本地</span><br><span class="line"># 如果还需要其它系统那么直接往后面加上去</span><br><span class="line">#</span><br><span class="line">rsync -avrt --exclude-from=/usr/local/local_mirror/exclude.list rsync://mirrors.tuna.tsinghua.edu.cn/centos/RPM-GPG-KEY-* /var/www/html/centos/ &amp;&amp; \</span><br><span class="line">rsync -avrt --exclude-from=/usr/local/local_mirror/exclude.list rsync://mirrors.tuna.tsinghua.edu.cn/centos-vault/RPM-GPG-KEY-* /var/www/html/centos-vault/ &amp;&amp; \</span><br><span class="line">rsync -avrt --exclude-from=/usr/local/local_mirror/exclude.list rsync://mirrors.tuna.tsinghua.edu.cn/epel/RPM-GPG-KEY-* /var/www/html/epel/ &amp;&amp; \</span><br><span class="line">rsync -avrt --exclude-from=/usr/local/local_mirror/exclude.list rsync://mirrors.tuna.tsinghua.edu.cn/epel/7/x86_64/ /var/www/html/epel/7/x86_64/ &amp;&amp; \</span><br><span class="line">rsync -avrt --exclude-from=/usr/local/local_mirror/exclude.list rsync://mirrors.tuna.tsinghua.edu.cn/centos/7/extras/x86_64/ /var/www/html/centos/7/extras/x86_64 &amp;&amp; \</span><br><span class="line">rsync -avrt --exclude-from=/usr/local/local_mirror/exclude.list rsync://mirrors.tuna.tsinghua.edu.cn/centos/7/updates/x86_64/ /var/www/html/centos/7/updates/x86_64 &amp;&amp; \</span><br><span class="line">rsync -avrt --exclude-from=/usr/local/local_mirror/exclude.list rsync://mirrors.tuna.tsinghua.edu.cn/centos/7/os/x86_64/ /var/www/html/centos/7/os/x86_64 &amp;&amp; \</span><br><span class="line">rsync -avrt --exclude-from=/usr/local/local_mirror/exclude.list rsync://mirrors.tuna.tsinghua.edu.cn/centos-vault/8.5.2111/BaseOS/x86_64/os/ /var/www/html/centos-vault/8.5.2111/BaseOS/x86_64/os/ &amp;&amp; \</span><br><span class="line">rsync -avrt --exclude-from=/usr/local/local_mirror/exclude.list rsync://mirrors.tuna.tsinghua.edu.cn/centos-vault/8.5.2111/extras/x86_64/os/ /var/www/html/centos-vault/8.5.2111/extras/x86_64/os/ &amp;&amp; \</span><br><span class="line">rsync -avrt --exclude-from=/usr/local/local_mirror/exclude.list rsync://mirrors.tuna.tsinghua.edu.cn/centos-vault/8.5.2111/AppStream/x86_64/os/ /var/www/html/centos-vault/8.5.2111/AppStream/x86_64/os/ &amp;&amp; \</span><br><span class="line">rsync -avrt --exclude-from=/usr/local/local_mirror/exclude.list rsync://mirrors.tuna.tsinghua.edu.cn/epel/8/Everything/x86_64/ /var/www/html/epel/8/Everything/x86_64/ &amp;&amp; \</span><br><span class="line">rsync -avrt --exclude-from=/usr/local/local_mirror/exclude.list rsync://mirrors.tuna.tsinghua.edu.cn/centos-vault/6.10/extras/x86_64/ /var/www/html/centos/6/extras/x86_64 &amp;&amp; \</span><br><span class="line">rsync -avrt --exclude-from=/usr/local/local_mirror/exclude.list rsync://mirrors.tuna.tsinghua.edu.cn/centos-vault/6.10/updates/x86_64/ /var/www/html/centos/6/updates/x86_64 &amp;&amp; \</span><br><span class="line">rsync -avrt --exclude-from=/usr/local/local_mirror/exclude.list rsync://mirrors.tuna.tsinghua.edu.cn/centos-vault/6.10/os/x86_64/ /var/www/html/centos/6/os/x86_64</span><br></pre></td></tr></table></figure><h2 id="加入计划任务"><a href="#加入计划任务" class="headerlink" title="加入计划任务"></a>加入计划任务</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 1 * * * sh /usr/local/sbin/sync.sh &amp;&gt; /tmp/yum.log</span><br></pre></td></tr></table></figure><h2 id="客户端repo配置"><a href="#客户端repo配置" class="headerlink" title="客户端repo配置"></a>客户端repo配置</h2><p><strong>Centos-vault-6.10.repo</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># CentOS-Base.repo</span><br><span class="line">#</span><br><span class="line"># The mirror system uses the connecting IP address of the client and the</span><br><span class="line"># update status of each mirror to pick mirrors that are updated to and</span><br><span class="line"># geographically close to the client.  You should use this for CentOS updates</span><br><span class="line"># unless you are manually picking other mirrors.</span><br><span class="line">#</span><br><span class="line"># If the mirrorlist= does not work for you, as a fall back you can try the </span><br><span class="line"># remarked out baseurl= line instead.</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line"> </span><br><span class="line">[base]</span><br><span class="line">name=CentOS-vault-6.10 - Base - 10.10.0.2</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://10.10.0.2/centos-vault/6.10/os/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://10.10.0.2/centos-vault/RPM-GPG-KEY-CentOS-6</span><br><span class="line"> </span><br><span class="line">#released updates </span><br><span class="line">[updates]</span><br><span class="line">name=CentOS-vault-6.10 - Updates - 10.10.0.2</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://10.10.0.2/centos-vault/6.10/updates/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://10.10.0.2/centos-vault/RPM-GPG-KEY-CentOS-6</span><br><span class="line"> </span><br><span class="line">#additional packages that may be useful</span><br><span class="line">[extras]</span><br><span class="line">name=CentOS-vault-6.10 - Extras - 10.10.0.2</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://10.10.0.2/centos-vault/6.10/extras/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://10.10.0.2/centos-vault/RPM-GPG-KEY-CentOS-6</span><br></pre></td></tr></table></figure><p><strong>Centos-7.repo</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># CentOS-Base.repo</span><br><span class="line">#</span><br><span class="line"># The mirror system uses the connecting IP address of the client and the</span><br><span class="line"># update status of each mirror to pick mirrors that are updated to and</span><br><span class="line"># geographically close to the client.  You should use this for CentOS updates</span><br><span class="line"># unless you are manually picking other mirrors.</span><br><span class="line">#</span><br><span class="line"># If the mirrorlist= does not work for you, as a fall back you can try the </span><br><span class="line"># remarked out baseurl= line instead.</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line"> </span><br><span class="line">[base]</span><br><span class="line">name=CentOS-$releasever - Base - 10.10.0.2</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://10.10.0.2/centos/$releasever/os/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://10.10.0.2/centos/RPM-GPG-KEY-CentOS-7</span><br><span class="line"> </span><br><span class="line">#released updates </span><br><span class="line">[updates]</span><br><span class="line">name=CentOS-$releasever - Updates - 10.10.0.2</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://10.10.0.2/centos/$releasever/updates/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://10.10.0.2/centos/RPM-GPG-KEY-CentOS-7</span><br><span class="line"> </span><br><span class="line">#additional packages that may be useful</span><br><span class="line">[extras]</span><br><span class="line">name=CentOS-$releasever - Extras - 10.10.0.2</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://10.10.0.2/centos/$releasever/extras/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://10.10.0.2/centos/RPM-GPG-KEY-CentOS-7</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>Centos-vault-8.5.2111.repo</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># CentOS-Base.repo</span><br><span class="line">#</span><br><span class="line"># The mirror system uses the connecting IP address of the client and the</span><br><span class="line"># update status of each mirror to pick mirrors that are updated to and</span><br><span class="line"># geographically close to the client.  You should use this for CentOS updates</span><br><span class="line"># unless you are manually picking other mirrors.</span><br><span class="line">#</span><br><span class="line"># If the mirrorlist= does not work for you, as a fall back you can try the </span><br><span class="line"># remarked out baseurl= line instead.</span><br><span class="line">#</span><br><span class="line">#</span><br><span class="line"> </span><br><span class="line">[base]</span><br><span class="line">name=CentOS-8.5.2111 - Base - 10.10.0.2</span><br><span class="line">baseurl=http://10.10.0.2/centos-vault/8.5.2111/BaseOS/$basearch/os/</span><br><span class="line">gpgcheck=0</span><br><span class="line">gpgkey=http://10.10.0.2/centos/RPM-GPG-KEY-CentOS-Official</span><br><span class="line"> </span><br><span class="line">#additional packages that may be useful</span><br><span class="line">[extras]</span><br><span class="line">name=CentOS-8.5.2111 - Extras - 10.10.0.2</span><br><span class="line">baseurl=http://10.10.0.2/centos-vault/8.5.2111/extras/$basearch/os/</span><br><span class="line">gpgcheck=0</span><br><span class="line">gpgkey=http://10.10.0.2/centos/RPM-GPG-KEY-CentOS-Official</span><br><span class="line"></span><br><span class="line">[AppStream]</span><br><span class="line">name=CentOS-8.5.2111 - AppStream - 10.10.0.2</span><br><span class="line">baseurl=http://10.10.0.2/centos-vault/8.5.2111/AppStream/$basearch/os/</span><br><span class="line">gpgcheck=0</span><br><span class="line">gpgkey=http://10.10.0.2/centos/RPM-GPG-KEY-CentOS-Official</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>epel-7.repo</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[epel]</span><br><span class="line">name=Extra Packages for Enterprise Linux 7 - $basearch</span><br><span class="line">baseurl=http://10.10.0.2/epel/7/$basearch</span><br><span class="line">failovermethod=priority</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">gpgkey=http://10.10.0.2/epel/RPM-GPG-KEY-EPEL-7</span><br></pre></td></tr></table></figure><p><strong>epel-8.repo</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[epel]</span><br><span class="line">name=Extra Packages for Enterprise Linux $releasever - $basearch</span><br><span class="line"># It is much more secure to use the metalink, but if you wish to use a local mirror</span><br><span class="line"># place it&#x27;s address here.</span><br><span class="line">baseurl=https://10.10.0.2/epel/$releasever/Everything/$basearch</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">countme=1</span><br><span class="line">gpgkey=http://10.10.0.2/epel/RPM-GPG-KEY-EPEL-8</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CentOS运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CENTOS </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
